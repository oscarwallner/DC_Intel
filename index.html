<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NAIO Intelligence | Data Center Market Intelligence</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%230A1929'/%3E%3Ctext x='16' y='23' text-anchor='middle' font-family='Arial,sans-serif' font-weight='bold' font-size='20' fill='%2300BCD4'%3EN%3C/text%3E%3C/svg%3E"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            naio: {
              bg: '#0A1628',
              'bg-deep': '#0D1117',
              'bg-card': '#0F2237',
              'bg-card-hover': '#162A3E',
              'bg-surface': '#1A3350',
              cyan: '#00BCD4',
              'cyan-light': '#00C8E0',
              teal: '#00BFA6',
              green: '#00E676',
              orange: '#FF9800',
              'orange-light': '#FFB74D',
              red: '#FF5252',
              purple: '#AB47BC',
              blue: '#3B9FE3',
              'blue-light': '#4FC3F7',
              'text-primary': '#FFFFFF',
              'text-secondary': '#B0C4D8',
              'text-muted': '#6B8FA3',
              'text-dim': '#4A5568',
              border: '#1A3A5C',
              'border-light': '#2A4A6C',
            }
          },
          fontFamily: {
            sans: ['"Segoe UI"', 'Calibri', 'Arial', 'sans-serif'],
          }
        }
      }
    }
  </script>
  <style>
    body { background: #0A1628; color: #fff; margin: 0; }
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: #0D1117; }
    ::-webkit-scrollbar-thumb { background: #1A3A5C; border-radius: 99px; }
    ::-webkit-scrollbar-thumb:hover { background: #2A4A6C; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .animate-slide-in { animation: slideIn 0.2s ease-out; }
    .animate-fade-in { animation: fadeIn 0.15s ease-out; }
    .animate-pulse-custom { animation: pulse 2s ease-in-out infinite; }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236B8FA3' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 8px center; padding-right: 28px; }
    .glow-marker { filter: drop-shadow(0 0 8px currentColor); }
    .leaflet-container { background: #0D1117; }
    .leaflet-attribution { background: rgba(10, 22, 40, 0.8); color: #6B8FA3; font-size: 11px; }
    .leaflet-attribution a { color: #00BCD4; }
    .leaflet-control { background: #0F2237; border: 1px solid #1A3A5C; border-radius: 4px; }
    .leaflet-control-zoom-in, .leaflet-control-zoom-out { background: #0F2237; color: #00BCD4; font-weight: bold; border-radius: 4px; }
    .leaflet-control-zoom-in:hover, .leaflet-control-zoom-out:hover { background: #162A3E; }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useMemo, useCallback, useEffect, useRef } = React;

// ─── SUPABASE CONFIG ─────────────────────────────────────
const SUPABASE_URL = 'https://ymgyqoojzqnddeacybah.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltZ3lxb29qenFuZGRlYWN5YmFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MzUyMDksImV4cCI6MjA4NzAxMTIwOX0.pJpLiiRzqY1pYtmR_N7Hgui2AgvUisFidremcoslLaE';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ─── SEED DATA (FALLBACK) ────────────────────────────────
const fallbackData = [];

const fallbackCalendarEvents = [];

const fallbackMarketHeatmap = [];

const mapMarkets = [
  {id:"nova", label:"Northern Virginia", lat:38.9, lng:-77.4, score:0, mw:0, deals:0},
  {id:"dallas", label:"Dallas / Texas", lat:32.8, lng:-96.8, score:0, mw:0, deals:0},
  {id:"phoenix", label:"Phoenix / Arizona", lat:33.4, lng:-112.0, score:0, mw:0, deals:0},
  {id:"stockholm", label:"Stockholm / Nordics", lat:59.3, lng:18.1, score:0, mw:0, deals:0},
  {id:"lulea", label:"Luleå / Northern Sweden", lat:65.6, lng:22.1, score:0, mw:0, deals:0},
  {id:"frankfurt", label:"Frankfurt", lat:50.1, lng:8.7, score:0, mw:0, deals:0},
  {id:"paris", label:"Paris / France", lat:48.9, lng:2.3, score:0, mw:0, deals:0},
  {id:"spain", label:"Spain", lat:40.4, lng:-3.7, score:0, mw:0, deals:0},
  {id:"london", label:"London", lat:51.5, lng:-0.1, score:0, mw:0, deals:0},
  {id:"dublin", label:"Dublin", lat:53.3, lng:-6.3, score:0, mw:0, deals:0},
  {id:"amsterdam", label:"Amsterdam", lat:52.4, lng:4.9, score:0, mw:0, deals:0},
  {id:"tokyo", label:"Tokyo", lat:35.7, lng:139.7, score:0, mw:0, deals:0},
  {id:"singapore", label:"Singapore", lat:1.3, lng:103.8, score:0, mw:0, deals:0},
];

const fallbackFinancingComps = [];

// ─── DEMAND PIPELINE SEED DATA ──────────────────────────
const demandPipelineData = [];

// ─── HISTORICAL SEED DATA ────────────────────────────────
const historicalSeedItems = [];

// ─── SUPABASE DATA HOOK ──────────────────────────────────
function useSupabaseData() {
  const [data, setData] = useState(fallbackData);
  const [calendarEvents, setCalendarEvents] = useState(fallbackCalendarEvents);
  const [marketHeatmap, setMarketHeatmap] = useState(fallbackMarketHeatmap);
  const [financingComps, setFinancingComps] = useState(fallbackFinancingComps);
  const [loading, setLoading] = useState(true);
  const [dataSource, setDataSource] = useState('local');
  const [lastRefresh, setLastRefresh] = useState(null);
  const [refreshing, setRefreshing] = useState(false);
  const [error, setError] = useState(null);
  const [seeding, setSeeding] = useState(false);

  const seedHistory = useCallback(async () => {
    setSeeding(true);
    setError(null);
    try {
      let inserted = 0, skipped = 0;
      for (const item of historicalSeedItems) {
        const { data: existing } = await supabase
          .from('intelligence_items')
          .select('id')
          .eq('headline', item.headline)
          .maybeSingle();
        if (existing) { skipped++; continue; }
        const { error: insertErr } = await supabase.from('intelligence_items').insert([item]);
        if (insertErr) { console.error('Seed insert error:', item.headline, insertErr); skipped++; }
        else { inserted++; }
      }
      await fetchData();
      alert(`Historical data seeded! Inserted: ${inserted}, Skipped (already exists): ${skipped}`);
    } catch (err) {
      console.error('Seed error:', err);
      setError('Seed failed: ' + (err.message || 'Unknown error'));
    } finally {
      setSeeding(false);
    }
  }, []);

  const fetchData = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);

      const { data: items, error: itemsError } = await supabase
        .from('intelligence_items')
        .select('*')
        .order('date', { ascending: false });

      if (itemsError) throw itemsError;

      const { data: comps, error: compsError } = await supabase
        .from('financing_comps')
        .select('*')
        .order('date', { ascending: false });

      const { data: events, error: eventsError } = await supabase
        .from('events_calendar')
        .select('*')
        .order('start_date', { ascending: true });

      const { data: heatmap, error: heatmapError } = await supabase
        .from('market_heatmap')
        .select('*')
        .order('heat_score', { ascending: false });

      if (items && items.length > 0) {
        const transformed = items.map(item => ({
          ...item,
          id: item.id,
          tags: item.tags || [],
          companies: item.companies || [],
          full_data: item.full_data || {},
        }));
        setData(transformed);
        setDataSource('supabase');
      } else {
        setData(fallbackData);
        setDataSource('local');
      }

      if (comps && comps.length > 0) {
        const transformedComps = comps.map(c => ({
          issuer: c.company,
          type: c.event_subtype,
          amount: (c.currency === 'EUR' ? '€' : c.currency === 'GBP' ? '£' : '$') + (c.amount_usd >= 1e9 ? (c.amount_usd/1e9).toFixed(1)+'B' : (c.amount_usd/1e6).toFixed(0)+'M'),
          tenor: c.tenor_years ? c.tenor_years+'-year' : 'N/A',
          coupon: c.coupon_rate ? c.coupon_rate+'%' : (c.spread_bps ? 'SOFR+'+c.spread_bps : 'N/A'),
          spread_bps: c.spread_bps || 0,
          rating: [c.rating_moodys, c.rating_sp].filter(Boolean).join('/') || 'N/R',
          date: c.date,
        }));
        setFinancingComps(transformedComps);
      }

      // Hardcoded industry calendar — real, verified events with URLs
      const industryEvents = [
        {id:"ev-gtc26",event_type:"conference",title:"NVIDIA GTC 2026",description:"Premier AI conference — keynote by Jensen Huang, 700+ sessions on AI infrastructure, agentic AI, inference",company:"NVIDIA",location:"San Jose, CA (+ virtual)",start_date:"2026-03-16",end_date:"2026-03-19",url:"https://www.nvidia.com/gtc/"},
        {id:"ev-gdc26",event_type:"conference",title:"NVIDIA at GDC 2026",description:"GPU & AI innovation in gaming — RTX neural rendering, DLSS 4.5, AI-driven game development",company:"NVIDIA",location:"Moscone Center, San Francisco, CA",start_date:"2026-03-09",end_date:"2026-03-13",url:"https://www.nvidia.com/en-us/events/gdc/"},
        {id:"ev-dcw26",event_type:"conference",title:"Data Centre World 2026",description:"Europe's largest data center event — free to attend for qualified professionals",company:"Data Centre World",location:"ExCeL London, UK",start_date:"2026-03-04",end_date:"2026-03-05",url:"https://www.datacentreworld.com/"},
        {id:"ev-dcdnyc26",event_type:"conference",title:"DCD>Connect NYC 2026",description:"Data center design, operations & strategy for the US East Coast market",company:"DCD",location:"New York City",start_date:"2026-03-23",end_date:"2026-03-24",url:"https://www.datacenterdynamics.com/"},
        {id:"ev-dcworld26",event_type:"conference",title:"Data Center World (AFCOM) 2026",description:"Flagship US data center conference — operations, design, connectivity",company:"AFCOM",location:"Washington, D.C.",start_date:"2026-04-20",end_date:"2026-04-23",url:"https://www.datacenterworldshow.com/"},
        {id:"ev-datacloud26",event_type:"conference",title:"Datacloud Global Congress 2026",description:"C-suite European conference — AI infrastructure, cross-border investment, ESG, 6000+ delegates from 50+ countries",company:"Datacloud",location:"Cannes, France",start_date:"2026-06-02",end_date:"2026-06-04",url:"https://www.datacloudglobalcongress.com/"},
        {id:"ev-superint26",event_type:"conference",title:"SuperReturn International 2026",description:"Premier PE/infrastructure conference — 500+ speakers, LP/GP meetings, includes Energy Transition track",company:"SuperReturn",location:"InterContinental Berlin, Germany",start_date:"2026-06-08",end_date:"2026-06-12",url:"https://informaconnect.com/superreturn-international/"},
        {id:"ev-datacloudusa26",event_type:"conference",title:"Datacloud USA 2026",description:"Fifth year in Austin — co-located with Metro Connect Fall and Datacloud Energy USA",company:"Datacloud",location:"Austin Marriott Downtown, TX",start_date:"2026-09-02",end_date:"2026-09-03",url:"https://www.datacloudglobalcongress.com/"},
        {id:"ev-infra26",event_type:"conference",title:"infra/STRUCTURE Summit 2026",description:"Digital infrastructure investment & strategy — data centers, fiber, towers, edge",company:"infra/STRUCTURE",location:"Wynn, Las Vegas",start_date:"2026-10-06",end_date:"2026-10-08",url:"https://infrastrucsummit.com/"},
      ];

      // Merge DB events with hardcoded industry events
      const dbEvents = (events && events.length > 0) ? events.map(e => ({
          id: e.id,
          event_type: e.event_type,
          title: e.title,
          description: e.description,
          company: e.company,
          location: e.location,
          start_date: e.start_date,
          end_date: e.end_date,
          url: e.url || null,
        })) : [];
      // Deduplicate: if DB has an event with same title, skip the hardcoded one
      const dbTitles = new Set(dbEvents.map(e => e.title));
      const mergedEvents = [...dbEvents, ...industryEvents.filter(e => !dbTitles.has(e.title))];
      setCalendarEvents(mergedEvents);

      if (heatmap && heatmap.length > 0) {
        const transformedHeatmap = heatmap.map(h => ({
          region: h.region,
          news_count: h.news_count,
          deal_count: h.deal_count,
          total_mw: h.total_mw_announced,
          heat_score: h.heat_score,
        }));
        setMarketHeatmap(transformedHeatmap);
      }

      setLastRefresh(new Date());
    } catch (err) {
      console.error('Supabase fetch error:', err);
      setError(err.message);
    } finally {
      setLoading(false);
    }
  }, []);

  const triggerPipeline = useCallback(async () => {
    setRefreshing(true);
    setError(null);
    try {
      const { data: result, error: fnError } = await supabase.functions.invoke('refresh-pipeline', {
        body: { action: 'refresh' }
      });
      if (fnError) throw fnError;
      await fetchData();
    } catch (err) {
      console.error('Pipeline error:', err);
      setError('Pipeline: ' + (err.message || 'Edge Function not deployed yet. Run the seed SQL first, then deploy the Edge Function.'));
    } finally {
      setRefreshing(false);
    }
  }, [fetchData]);

  useEffect(() => { fetchData(); }, [fetchData]);

  return { data, calendarEvents, marketHeatmap, financingComps, loading, dataSource, lastRefresh, refreshing, error, fetchData, triggerPipeline, seeding, seedHistory };
}

// ─── HELPERS ─────────────────────────────────────────────
const layerLabels = {infrastructure:"Infrastructure",chip:"Chip / Compute",energy:"Energy",financing:"Financing",supply_chain:"Supply Chain","cross-layer":"Cross-Layer"};
const typeLabels = {news_summary:"News",deal_synopsis:"Deal",capex_announcement:"Capex",financing_event:"Financing",earnings_intelligence:"Earnings",regulatory_update:"Regulatory",power_demand_signal:"Power Demand",executive_move:"Exec Move",supply_chain_signal:"Supply Chain",briefing:"Briefing"};
const layerClass = {infrastructure:"bg-[#3B9FE3]/20 text-[#4FC3F7]",chip:"bg-[#AB47BC]/20 text-[#AB47BC]",energy:"bg-[#00E676]/20 text-[#00E676]",financing:"bg-[#FF9800]/20 text-[#FFB74D]",supply_chain:"bg-[#00BFA6]/20 text-[#00BFA6]","cross-layer":"bg-[#00BCD4]/20 text-[#00BCD4]"};
const impDot = {high:"bg-[#FF5252]",medium:"bg-[#FF9800]",low:"bg-[#6B8FA3]"};

const regionGroups = {
  "Nordics": ["Sweden", "Norway", "Finland", "Denmark", "Luleå", "Stockholm", "Rennesøy"],
  "Europe": ["Amsterdam", "Dublin", "Frankfurt", "London", "Ireland", "Netherlands", "Germany", "Europe"],
  "North America": ["United States", "Las Vegas", "Pennsylvania", "US", "Virginia", "Texas", "Arizona"],
  "Asia-Pacific": ["Tokyo", "Singapore"],
  "Global": ["Global"]
};

function getRegionGroup(region) {
  for(const [group, regions] of Object.entries(regionGroups)) {
    if(regions.some(r => region.toLowerCase().includes(r.toLowerCase()))) return group;
  }
  return "Other";
}

function relDate(d) {
  const now = new Date(); const dt = new Date(d+"T00:00:00");
  const diff = Math.floor((now-dt)/(864e5));
  if(diff===0) return "Today"; if(diff===1) return "Yesterday"; if(diff<7) return diff+"d ago"; if(diff<30) return Math.floor(diff/7)+"w ago";
  return dt.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"});
}
function fmtDate(d) { return new Date(d+"T00:00:00").toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}); }

// ─── SVG ICONS ───────────────────────────────────────────
const Icon = ({name, size=18, className=""}) => {
  const s = size;
  const icons = {
    Activity: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>,
    LayoutDashboard: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>,
    Newspaper: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 22h16a2 2 0 002-2V4a2 2 0 00-2-2H8a2 2 0 00-2 2v16a2 2 0 01-2 2zm0 0a2 2 0 01-2-2v-9c0-1.1.9-2 2-2h2"/><path d="M18 14h-8M15 18h-5M10 6h8v4h-8z"/></svg>,
    Building2: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 22V4a2 2 0 012-2h8a2 2 0 012 2v18z"/><path d="M6 12H4a2 2 0 00-2 2v6a2 2 0 002 2h2"/><path d="M18 9h2a2 2 0 012 2v9a2 2 0 01-2 2h-2"/><path d="M10 6h4M10 10h4M10 14h4M10 18h4"/></svg>,
    Cpu: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="4" y="4" width="16" height="16" rx="2"/><rect x="9" y="9" width="6" height="6"/><path d="M15 2v2M15 20v2M2 15h2M2 9h2M20 15h2M20 9h2M9 2v2M9 20v2"/></svg>,
    Zap: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
    Landmark: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="22" x2="21" y2="22"/><line x1="6" y1="18" x2="6" y2="11"/><line x1="10" y1="18" x2="10" y2="11"/><line x1="14" y1="18" x2="14" y2="11"/><line x1="18" y1="18" x2="18" y2="11"/><polygon points="12 2 20 7 4 7"/></svg>,
    Truck: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 3h15v13H1z"/><path d="M16 8h4l3 3v5h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>,
    Calendar: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
    Map: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>,
    Search: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
    ChevronRight: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>,
    X: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
    Trash2: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
    Plus: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
    AlertTriangle: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
    Handshake: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.42 4.58a5.4 5.4 0 00-7.65 0l-.77.78-.77-.78a5.4 5.4 0 00-7.65 0C1.46 6.7 1.33 10.28 4 13l8 8 8-8c2.67-2.72 2.54-6.3.42-8.42z"/></svg>,
    TrendingUp: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
    BarChart3: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9M13 17V5M8 17v-3"/></svg>,
    Scale: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 16l3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1zM2 16l3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1zM7 21h10M12 3v18M12 3l4 4M12 3L8 7"/></svg>,
    UserCheck: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>,
    FileText: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
    Globe: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>,
    ExternalLink: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
    MapPin: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>,
    Tag: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>,
    Menu: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="18" x2="20" y2="18"/></svg>,
    PanelLeftClose: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/><path d="M15 9l-3 3 3 3"/></svg>,
    RefreshCw: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
    LayoutList: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/></svg>,
    LayoutGrid: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
    Shield: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
    Users: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>,
    Atom: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="1"/><path d="M20.2 20.2c2.04-2.03.02-7.36-4.5-11.9-4.54-4.52-9.87-6.54-11.9-4.5-2.04 2.03-.02 7.36 4.5 11.9 4.54 4.52 9.87 6.54 11.9 4.5z"/><path d="M15.7 15.7c4.52-4.54 6.54-9.87 4.5-11.9-2.03-2.04-7.36-.02-11.9 4.5-4.52 4.54-6.54 9.87-4.5 11.9 2.03 2.04 7.36.02 11.9-4.5z"/></svg>,
  };
  return <span className={className}>{icons[name] || null}</span>;
};

const typeIconMap = {news_summary:"Newspaper",deal_synopsis:"Handshake",capex_announcement:"TrendingUp",financing_event:"Landmark",earnings_intelligence:"BarChart3",regulatory_update:"Scale",power_demand_signal:"Zap",executive_move:"UserCheck",supply_chain_signal:"Truck",briefing:"FileText"};

// ─── CHART COMPONENTS ────────────────────────────────────
function CapexTrajectoryChart() {
  const canvasRef = useRef(null);
  const chartRef = useRef(null);
  const [capexData, setCapexData] = useState(null);

  // Fetch capex data from Supabase
  useEffect(() => {
    const fetchCapex = async () => {
      try {
        const { data } = await supabase.from('capex_tracker').select('company, year, capex_usd_billions, is_estimate').order('year', { ascending: true });
        if (data && data.length > 0) setCapexData(data);
      } catch (e) { console.error('Capex fetch error:', e); }
    };
    fetchCapex();
  }, []);

  useEffect(() => {
    if(!canvasRef.current || !window.Chart) return;

    if(chartRef.current) chartRef.current.destroy();

    // Build combined capex by year from DB or use fallback
    const years = ['2020', '2021', '2022', '2023', '2024', '2025', '2026E'];
    let combinedData;
    if (capexData && capexData.length > 0) {
      combinedData = years.map(y => {
        const yr = parseInt(y);
        return capexData.filter(d => d.year === yr).reduce((sum, d) => sum + Number(d.capex_usd_billions), 0);
      });
    } else {
      combinedData = [105, 125, 145, 160, 245, 410, 660]; // Fallback (Big 4, deck figures)
    }

    const ctx = canvasRef.current.getContext('2d');
    chartRef.current = new Chart(ctx, {
      type: 'line',
      data: {
        labels: years,
        datasets: [{
          label: 'Big 5 Combined Capex ($B)',
          data: combinedData,
          borderColor: '#00BCD4',
          backgroundColor: 'rgba(0, 188, 212, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointBackgroundColor: '#00BCD4',
          pointBorderColor: '#FFF',
          pointBorderWidth: 2,
          pointRadius: 5,
          pointHoverRadius: 7
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true, labels: { color: '#B0C4D8', font: { size: 11 }, usePointStyle: true } },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            titleColor: '#00BCD4',
            bodyColor: '#FFF',
            borderColor: '#00BCD4',
            borderWidth: 1,
            padding: 12,
            titleFont: { size: 12, weight: 'bold' },
            bodyFont: { size: 11 },
            callbacks: { label: (ctx) => `$${ctx.parsed.y}B` }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 750,
            grid: { color: 'rgba(26, 58, 92, 0.3)' },
            ticks: { color: '#B0C4D8', font: { size: 11 }, callback: (v) => `$${v}B` }
          },
          x: {
            grid: { display: false },
            ticks: { color: '#B0C4D8', font: { size: 11 } }
          }
        }
      }
    });

    return () => { if(chartRef.current) chartRef.current.destroy(); };
  }, [capexData]);

  return <canvas ref={canvasRef}/>;
}

function CompanyCapexChart() {
  const canvasRef = useRef(null);
  const chartRef = useRef(null);
  const [capexData, setCapexData] = useState(null);

  // Fetch per-company capex from DB
  useEffect(() => {
    const fetchCapex = async () => {
      try {
        const { data } = await supabase.from('capex_tracker').select('company, year, capex_usd_billions, is_estimate').order('year', { ascending: true });
        if (data && data.length > 0) setCapexData(data);
      } catch (e) { console.error('Company capex fetch error:', e); }
    };
    fetchCapex();
  }, []);

  useEffect(() => {
    if(!canvasRef.current || !window.Chart) return;

    if(chartRef.current) chartRef.current.destroy();

    const years = ['2020', '2021', '2022', '2023', '2024', '2025', '2026E'];
    const companyColors = {
      'Amazon': '#FF9800', 'Microsoft': '#3B9FE3', 'Google': '#00E676',
      'Meta': '#00BCD4', 'Oracle': '#FF5252'
    };
    // Fallback data from 10-K/10-Q filings
    const fallbackCompanies = {
      'Amazon':    [40, 55, 58, 54, 83, 132, 200],
      'Microsoft': [18, 24, 28, 32, 44, 65, 125],
      'Google':    [22, 24, 31, 32, 52, 91, 180],
      'Meta':      [15, 19, 32, 28, 39, 71, 125],
      'Oracle':    [4, 5, 7, 9, 12, 17, 50],
    };

    let datasets;
    if (capexData && capexData.length > 0) {
      // Build datasets from DB data
      const companies = [...new Set(capexData.map(d => d.company))];
      datasets = companies.map(co => {
        const color = companyColors[co] || '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6,'0');
        const data = years.map(y => {
          const yr = parseInt(y);
          const match = capexData.find(d => d.company === co && d.year === yr);
          return match ? Number(match.capex_usd_billions) : 0;
        });
        return { label: co, data, backgroundColor: color, borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1 };
      });
    } else {
      datasets = Object.entries(fallbackCompanies).map(([co, data]) => ({
        label: co, data, backgroundColor: companyColors[co], borderColor: 'rgba(255,255,255,0.1)', borderWidth: 1
      }));
    }

    // Find max value for y-axis
    const maxVal = Math.max(...datasets.flatMap(ds => ds.data));
    const yMax = Math.ceil(maxVal / 50) * 50 + 50;

    const ctx = canvasRef.current.getContext('2d');
    chartRef.current = new Chart(ctx, {
      type: 'bar',
      data: { labels: years, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true, labels: { color: '#B0C4D8', font: { size: 11 }, usePointStyle: true } },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            titleColor: '#00BCD4',
            bodyColor: '#FFF',
            borderColor: '#00BCD4',
            borderWidth: 1,
            padding: 12,
            titleFont: { size: 12, weight: 'bold' },
            bodyFont: { size: 11 },
            callbacks: { label: (ctx) => `${ctx.dataset.label}: $${ctx.parsed.y}B` }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { color: '#B0C4D8', font: { size: 11 } }
          },
          y: {
            beginAtZero: true,
            max: yMax,
            grid: { color: 'rgba(26, 58, 92, 0.3)' },
            ticks: { color: '#B0C4D8', font: { size: 11 }, callback: (v) => `$${v}B` }
          }
        }
      }
    });

    return () => { if(chartRef.current) chartRef.current.destroy(); };
  }, [capexData]);

  return <canvas ref={canvasRef}/>;
}

// ── European Market Context Chart (Slide 9 data) ──
function EuropeanMarketChart() {
  const canvasRef = useRef(null);
  const chartRef = useRef(null);
  useEffect(() => {
    if(!canvasRef.current || !window.Chart) return;
    if(chartRef.current) chartRef.current.destroy();
    const ctx = canvasRef.current.getContext('2d');
    chartRef.current = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['IT Power\nCapacity (MW)', 'GDP\nContribution (€B)', 'Projected\nInvest. (€B)'],
        datasets: [
          { label: '2023/Current', data: [10539, 53, null], backgroundColor: 'rgba(0,188,212,0.5)', borderColor: '#00BCD4', borderWidth: 1 },
          { label: '2025/Projected', data: [14784, 137.5, 176], backgroundColor: 'rgba(0,230,118,0.5)', borderColor: '#00E676', borderWidth: 1 }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: true, labels: { color: '#B0C4D8', font: { size: 11 }, usePointStyle: true } },
          tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', titleColor: '#00BCD4', bodyColor: '#FFF', borderColor: '#00BCD4', borderWidth: 1, padding: 12,
            callbacks: { label: (c) => { const v=c.parsed.y; if(v===null) return null; return c.dataset.label+': '+(v>=1000?v.toLocaleString()+' MW':'€'+v+'B'); } }
          }
        },
        scales: {
          y: { display: false },
          x: { grid: { display: false }, ticks: { color: '#B0C4D8', font: { size: 10 }, maxRotation: 0 } }
        }
      }
    });
    return () => { if(chartRef.current) chartRef.current.destroy(); };
  }, []);
  return <canvas ref={canvasRef}/>;
}

// ── Confidence badge helper ──
function ConfBadge({level}) {
  const colors = { high: {bg:'rgba(0,230,118,0.15)',text:'#00E676',border:'rgba(0,230,118,0.3)'}, medium: {bg:'rgba(255,152,0,0.15)',text:'#FF9800',border:'rgba(255,152,0,0.3)'}, low: {bg:'rgba(255,82,82,0.15)',text:'#FF5252',border:'rgba(255,82,82,0.3)'} };
  const c = colors[level] || colors.medium;
  return <span className="text-[8px] px-1.5 py-0.5 rounded-full font-medium uppercase tracking-wider" style={{backgroundColor:c.bg,color:c.text,border:'1px solid '+c.border}}>{level}</span>;
}

// ── Footnote component ──
function Footnotes({notes}) {
  return (
    <div className="mt-3 pt-3 border-t border-naio-border/50">
      <div className="text-[10px] text-naio-text-dim space-y-1">
        {notes.map((n,i) => <div key={i}><span className="text-naio-cyan font-medium">[{i+1}]</span> {n}</div>)}
      </div>
    </div>
  );
}

// ── EU Key Stats Cards ──
function EUKeyStats() {
  const stats = [
    { label: 'EU IT Power (2025)', value: '14,784 MW', delta: '+40% vs 2023', src: 'EUDCA 2025', ref: 1, conf: 'high' },
    { label: 'EU Colocation Supply', value: '5,023 MW', delta: 'Q3 2025', src: 'GDCMR Q3 2025', ref: 2, conf: 'high' },
    { label: 'EMEA DC Pipeline', value: '24.4 GW', delta: '+43% YoY', src: 'Cushman & Wakefield H1 2025', ref: 3, conf: 'high' },
    { label: 'Projected Invest. 2026-31', value: '€176B', delta: '~$190B', src: 'EUDCA', ref: 1, conf: 'medium', uncertainty: 'Projection; actual depends on regulation & permitting' },
    { label: 'DC GDP Contribution', value: '€53B → €137.5B', delta: '2025 → 2031 est.', src: 'EUDCA', ref: 1, conf: 'medium', uncertainty: '2031 figure is a projection' },
    { label: 'Jobs Supported', value: '300,000+', delta: 'Direct, high-skilled', src: 'EUDCA', ref: 1, conf: 'medium', uncertainty: 'Industry self-reported' },
  ];
  return (
    <div>
      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
        {stats.map((s,i) => (
          <div key={i} className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-3 text-center relative group">
            <div className="text-[10px] text-naio-text-dim uppercase tracking-wider mb-1">{s.label}</div>
            <div className="text-lg font-bold text-naio-cyan">{s.value}</div>
            <div className="text-[10px] text-naio-text-muted mt-0.5">{s.delta}</div>
            <div className="flex items-center justify-center gap-1.5 mt-1.5">
              <ConfBadge level={s.conf}/>
              <span className="text-[8px] text-naio-text-dim">[{s.ref}]</span>
            </div>
            {s.uncertainty && <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1 bg-naio-bg-deep border border-naio-border rounded text-[9px] text-naio-text-muted whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">{s.uncertainty}</div>}
          </div>
        ))}
      </div>
    </div>
  );
}

// ── European Growth Hotspots Table (Slide 10 data) ──
function EuropeanHotspotsTable() {
  const markets = [
    { market: 'Nordics (SE, NO, FI)', status: 'Fastest growing', statusColor: '#00E676', advantages: '90%+ renewable, $0.03/kWh wind, cool climate, fast permitting', projects: 'Brookfield ~$10B (SE) [4], Stargate Norway [5], CoreWeave [6], TikTok (FI) [7]', conf: 'high' },
    { market: 'Spain', status: 'Fastest % (S. Europe)', statusColor: '#FF9800', advantages: 'Subsea cable hub, govt incentives, land availability', projects: 'MSFT Zaragoza €2.9B [8], Azora €1.1-2B [9], CoreWeave [6]', conf: 'high' },
    { market: 'UK', status: '523 DCs / 2,590 MW', statusColor: '#3B9FE3', advantages: 'London market (1 GW+), talent pool, AI Act-adjacent', projects: 'CoreWeave $1.3B [6], Nebius/Nscale Blackwell', conf: 'high' },
    { market: 'Germany (Frankfurt)', status: 'Constrained', statusColor: '#FF5252', advantages: 'Established hub, connectivity. Grid constraints.', projects: 'Google €5.5B [10]. Grid forcing westward migration.', conf: 'high' },
    { market: 'France', status: 'Paris #3 in Europe', statusColor: '#AB47BC', advantages: 'Sovereign cloud demand, Mistral ecosystem', projects: 'Brookfield/Data4 €20B [11], Mistral/NVIDIA 18K GPUs [12]', conf: 'high' },
    { market: 'Italy', status: 'Emerging', statusColor: '#FFD54F', advantages: 'Milan hub, S. Europe connectivity', projects: 'Microsoft $4.8B [13]', conf: 'high' },
    { market: 'Portugal', status: 'Emerging', statusColor: '#FFD54F', advantages: 'Subsea landing, renewable energy', projects: 'Microsoft $10B Sines [14], Start Campus 1.2 GW', conf: 'high' },
  ];
  return (
    <div className="overflow-x-auto">
      <table className="w-full text-sm">
        <thead>
          <tr className="border-b border-naio-border">
            <th className="text-left py-2 px-3 text-naio-text-dim font-medium text-xs">Market</th>
            <th className="text-left py-2 px-3 text-naio-text-dim font-medium text-xs">Status</th>
            <th className="text-left py-2 px-3 text-naio-text-dim font-medium text-xs hidden md:table-cell">Key Advantages</th>
            <th className="text-left py-2 px-3 text-naio-text-dim font-medium text-xs">Notable Projects</th>
            <th className="text-left py-2 px-3 text-naio-text-dim font-medium text-xs w-16">Conf.</th>
          </tr>
        </thead>
        <tbody>
          {markets.map((m,i) => (
            <tr key={i} className="border-b border-naio-border/50 hover:bg-naio-bg-surface/30 transition-colors">
              <td className="py-2.5 px-3 text-naio-text-primary font-medium whitespace-nowrap">{m.market}</td>
              <td className="py-2.5 px-3"><span className="text-xs px-2 py-0.5 rounded-full" style={{backgroundColor: m.statusColor+'20', color: m.statusColor, border: '1px solid '+m.statusColor+'40'}}>{m.status}</span></td>
              <td className="py-2.5 px-3 text-naio-text-secondary text-xs hidden md:table-cell">{m.advantages}</td>
              <td className="py-2.5 px-3 text-naio-text-secondary text-xs">{m.projects}</td>
              <td className="py-2.5 px-3"><ConfBadge level={m.conf}/></td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}

// ── Macro Context Charts (Slide 11 data) ──
function AIDCCapacityChart() {
  const canvasRef = useRef(null);
  const chartRef = useRef(null);
  useEffect(() => {
    if(!canvasRef.current || !window.Chart) return;
    if(chartRef.current) chartRef.current.destroy();
    const ctx = canvasRef.current.getContext('2d');
    chartRef.current = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['2024', '2025', '2034E'],
        datasets: [{
          label: 'AI DC Capacity (GW)',
          data: [7, 15, 82],
          backgroundColor: ['rgba(0,188,212,0.6)', 'rgba(0,188,212,0.7)', 'rgba(0,188,212,0.9)'],
          borderColor: '#00BCD4',
          borderWidth: 1,
          borderRadius: 4,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', titleColor: '#00BCD4', bodyColor: '#FFF', borderColor: '#00BCD4', borderWidth: 1, padding: 12,
            callbacks: { label: (c) => c.parsed.y+' GW' }
          }
        },
        scales: {
          y: { beginAtZero: true, max: 100, grid: { color: 'rgba(26,58,92,0.3)' }, ticks: { color: '#B0C4D8', font: { size: 11 }, callback: v=>v+'GW' } },
          x: { grid: { display: false }, ticks: { color: '#B0C4D8', font: { size: 11 } } }
        }
      }
    });
    return () => { if(chartRef.current) chartRef.current.destroy(); };
  }, []);
  return <canvas ref={canvasRef}/>;
}

function DCEquipmentChart() {
  const canvasRef = useRef(null);
  const chartRef = useRef(null);
  useEffect(() => {
    if(!canvasRef.current || !window.Chart) return;
    if(chartRef.current) chartRef.current.destroy();
    const ctx = canvasRef.current.getContext('2d');
    chartRef.current = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['2024', '2030E'],
        datasets: [{
          label: 'DC Equipment Spending ($B)',
          data: [290, 1000],
          backgroundColor: ['rgba(255,152,0,0.6)', 'rgba(255,152,0,0.9)'],
          borderColor: '#FF9800',
          borderWidth: 1,
          borderRadius: 4,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', titleColor: '#FF9800', bodyColor: '#FFF', borderColor: '#FF9800', borderWidth: 1, padding: 12,
            callbacks: { label: (c) => '$'+c.parsed.y+'B' }
          }
        },
        scales: {
          y: { beginAtZero: true, max: 1200, grid: { color: 'rgba(26,58,92,0.3)' }, ticks: { color: '#B0C4D8', font: { size: 11 }, callback: v=>'$'+v+'B' } },
          x: { grid: { display: false }, ticks: { color: '#B0C4D8', font: { size: 11 } } }
        }
      }
    });
    return () => { if(chartRef.current) chartRef.current.destroy(); };
  }, []);
  return <canvas ref={canvasRef}/>;
}

// ── Macro Key Stats ──
function MacroKeyStats() {
  const stats = [
    { label: 'Big 4 2026E Capex', value: '~$660B', note: 'Exceeds Israel GDP ($610B)', ref: 15, conf: 'high', uncertainty: 'Guided figures; actual may vary by ±10%' },
    { label: 'AI Share of Capex', value: '~75%', note: '$450B of $600B+ in 2026', ref: 16, conf: 'medium', uncertainty: 'Analyst estimate; AI/non-AI split is approximate' },
    { label: 'Capital Intensity', value: '45-57%', note: 'Capex / Revenue ratio', ref: 15, conf: 'high' },
    { label: 'Cost per 1 GW AI Infra', value: '$50-60B', note: 'Jensen Huang, 2025', ref: 17, conf: 'medium', uncertainty: 'Nvidia CEO estimate; Barclays range is $50-80B total' },
    { label: 'GPU Installed Base', value: '7M → 45M', note: '2024 → 2034E (Brookfield)', ref: 18, conf: 'medium', uncertainty: 'Brookfield proprietary projection; 10-year forecast' },
    { label: 'US DC Electricity', value: '4% → 8%+', note: 'Now → 2030 (Goldman Sachs)', ref: 19, conf: 'medium', uncertainty: 'Range: 8% (GS) to 12% (EPRI). Depends on buildout pace.' },
  ];
  return (
    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
      {stats.map((s,i) => (
        <div key={i} className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-3 text-center relative group">
          <div className="text-[10px] text-naio-text-dim uppercase tracking-wider mb-1">{s.label}</div>
          <div className="text-lg font-bold text-naio-cyan">{s.value}</div>
          <div className="text-[10px] text-naio-text-muted mt-0.5">{s.note}</div>
          <div className="flex items-center justify-center gap-1.5 mt-1.5">
            <ConfBadge level={s.conf}/>
            <span className="text-[8px] text-naio-text-dim">[{s.ref}]</span>
          </div>
          {s.uncertainty && <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1 bg-naio-bg-deep border border-naio-border rounded text-[9px] text-naio-text-muted whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">{s.uncertainty}</div>}
        </div>
      ))}
    </div>
  );
}

function FinancingChart() {
  const canvasRef = useRef(null);
  const chartRef = useRef(null);

  useEffect(() => {
    if(!canvasRef.current || !window.Chart) return;

    if(chartRef.current) chartRef.current.destroy();

    const ctx = canvasRef.current.getContext('2d');
    chartRef.current = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['DLR 7Y', 'DLR 12Y', 'EQX 10Y', 'Switch TL', 'QTS TLB'],
        datasets: [{
          label: 'Spread (bps)',
          data: [135, 155, 150, 250, 200],
          backgroundColor: ['#00E676', '#00E676', '#00E676', '#FF9800', '#FFB74D'],
          borderColor: 'rgba(255,255,255,0.1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            titleColor: '#00BCD4',
            bodyColor: '#FFF',
            borderColor: '#00BCD4',
            borderWidth: 1,
            padding: 12,
            titleFont: { size: 12, weight: 'bold' },
            bodyFont: { size: 11 },
            callbacks: {
              afterLabel: (ctx) => {
                if(ctx.parsed.y < 175) return 'IG';
                if(ctx.parsed.y <= 225) return 'HY/Supported';
                return 'High Yield';
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 300,
            grid: { color: 'rgba(26, 58, 92, 0.3)' },
            ticks: { color: '#B0C4D8', font: { size: 11 } }
          },
          x: {
            grid: { display: false },
            ticks: { color: '#B0C4D8', font: { size: 11 } }
          }
        }
      }
    });

    return () => { if(chartRef.current) chartRef.current.destroy(); };
  }, []);

  return <canvas ref={canvasRef}/>;
}

// ─── LEAFLET MAP COMPONENT ────────────────────────────────
function MarketMap({onMarketClick, mapHeight=500}) {
  const mapRef = useRef(null);
  const mapInstanceRef = useRef(null);

  const getMarkerColor = (score) => {
    if(score >= 80) return '#FF5252';
    if(score >= 60) return '#FF9800';
    return '#00BCD4';
  };

  useEffect(() => {
    if(!mapRef.current || !window.L) return;

    // Initialize map
    if(mapInstanceRef.current) {
      mapInstanceRef.current.remove();
    }

    const map = window.L.map(mapRef.current).setView([20, 0], 2);
    mapInstanceRef.current = map;

    // Add dark tile layer (CartoDB Dark Matter)
    window.L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '© OpenStreetMap, © CartoDB',
      maxZoom: 19,
      subdomains: 'abcd'
    }).addTo(map);

    // Add market markers
    mapMarkets.forEach(market => {
      const color = getMarkerColor(market.score);
      const radius = 8 + (market.score / 100) * 12;

      // Create custom circle marker
      const circleMarker = window.L.circleMarker([market.lat, market.lng], {
        radius: radius,
        fillColor: color,
        color: color,
        weight: 2,
        opacity: 0.7,
        fillOpacity: 0.7,
        className: 'market-marker'
      }).addTo(map);

      // Popup content
      const popupContent = `
        <div style="color: #fff; font-size: 12px; font-family: sans-serif;">
          <div style="font-weight: bold; color: #00BCD4; margin-bottom: 6px;">${market.label}</div>
          <div style="color: #B0C4D8;">
            <div>Heat Score: <span style="font-weight: bold;">${market.score}</span></div>
            <div>Capacity: <span style="font-weight: bold;">${market.mw.toLocaleString()} MW</span></div>
            <div>Deals: <span style="font-weight: bold;">${market.deals}</span></div>
          </div>
        </div>
      `;

      circleMarker.bindPopup(popupContent);

      // Click handler
      circleMarker.on('click', () => {
        onMarketClick(market);
      });

      // Hover effects
      circleMarker.on('mouseover', function() {
        this.setRadius(radius + 3);
        this.setStyle({ weight: 3, opacity: 1, fillOpacity: 0.9 });
      });

      circleMarker.on('mouseout', function() {
        this.setRadius(radius);
        this.setStyle({ weight: 2, opacity: 0.7, fillOpacity: 0.7 });
      });
    });

    // Fit bounds to show all markers
    if(mapMarkets.length > 0) {
      const bounds = window.L.latLngBounds(mapMarkets.map(m => [m.lat, m.lng]));
      map.fitBounds(bounds, { padding: [50, 50] });
    }

    return () => {
      if(mapInstanceRef.current) {
        mapInstanceRef.current.remove();
        mapInstanceRef.current = null;
      }
    };
  }, [onMarketClick]);

  return (
    <div
      ref={mapRef}
      style={{ height: mapHeight + 'px', borderRadius: '0.5rem' }}
      className="border border-naio-border"
    />
  );
}

// ─── COMPONENTS ──────────────────────────────────────────
const tabs = [
  {id:"dashboard",label:"Dashboard",icon:"LayoutDashboard"},
  {id:"news",label:"News Feed",icon:"Newspaper"},
  {id:"infrastructure",label:"Infrastructure",icon:"Building2"},
  {id:"chip",label:"Chip / Compute",icon:"Cpu"},
  {id:"energy",label:"Energy",icon:"Zap"},
  {id:"financing",label:"Financing",icon:"Landmark"},
  {id:"supply_chain",label:"Supply Chain",icon:"Truck"},
  {id:"demand_pipeline",label:"Demand Pipeline",icon:"Activity"},
  {id:"calendar",label:"Calendar",icon:"Calendar"},
  {id:"heatmap",label:"Market Heat",icon:"Map"},
  {id:"comps",label:"Comps Table",icon:"BarChart3"},
  {id:"reports",label:"Reports",icon:"FileText"},
  {id:"research",label:"News Search",icon:"Search"},
  {id:"market_research",label:"Market Research",icon:"TrendingUp"},
];

function ReportGenerator({data, calendarEvents=[], financingComps=[], marketHeatmap=[]}) {
  const [reportType, setReportType] = useState("Company Profile");
  const [selectedCompany, setSelectedCompany] = useState("");
  const [selectedGeography, setSelectedGeography] = useState("Nordics");
  const [selectedTheme, setSelectedTheme] = useState("AI Infrastructure Capex");
  const [generatedReport, setGeneratedReport] = useState(null);
  const [generating, setGenerating] = useState(false);
  const [error, setError] = useState(null);
  const [library, setLibrary] = useState([]);
  const [libraryLoading, setLibraryLoading] = useState(true);
  const reportRef = useRef(null);

  // Fetch report library on mount
  useEffect(() => {
    const fetchLibrary = async () => {
      try {
        const { data: reports, error: libErr } = await supabase
          .from("report_library")
          .select("id, report_type, subject, title, created_at")
          .order("created_at", { ascending: false })
          .limit(50);
        if (!libErr && reports) setLibrary(reports);
      } catch (e) { console.error("Library fetch error:", e); }
      finally { setLibraryLoading(false); }
    };
    fetchLibrary();
  }, []);

  // Load a saved report from library
  const loadReport = async (reportId) => {
    try {
      const { data: saved, error: loadErr } = await supabase
        .from("report_library")
        .select("*")
        .eq("id", reportId)
        .single();
      if (loadErr || !saved) throw new Error("Failed to load report");
      setGeneratedReport({
        success: true,
        reportType: saved.report_type,
        subject: saved.subject,
        report: saved.report_data,
        context: saved.context || {},
        generated_at: saved.created_at,
        report_id: saved.id,
      });
    } catch (e) { setError("Could not load report: " + e); }
  };

  // Delete a report from library
  const deleteReport = async (reportId, e) => {
    e.stopPropagation();
    if (!confirm("Delete this report? This cannot be undone.")) return;
    try {
      await supabase.from("report_library").delete().eq("id", reportId);
      setLibrary(prev => prev.filter(r => r.id !== reportId));
      if (generatedReport?.report_id === reportId) setGeneratedReport(null);
    } catch (e) { console.error("Delete error:", e); }
  };

  // Delete all reports from library
  const deleteAllReports = async () => {
    if (!confirm(`Delete all ${library.length} reports? This cannot be undone.`)) return;
    try {
      const ids = library.map(r => r.id);
      for (const id of ids) {
        await supabase.from("report_library").delete().eq("id", id);
      }
      setLibrary([]);
      setGeneratedReport(null);
    } catch (e) { console.error("Delete all error:", e); }
  };

  const uniqueCompanies = useMemo(() => {
    const comps = new Set();
    data.forEach(item => { (item.companies || []).forEach(c => comps.add(c)); });
    // Always include tracked companies so they appear in the dropdown even before news is fetched
    ["Equinix","Digital Realty","QTS","CyrusOne","CoreWeave","Vantage","Microsoft","Amazon","Google","Meta","Oracle",
     "EcoDataCenter","Evroc","NVIDIA","Vattenfall","Blackstone","KKR","Brookfield","DigitalBridge","EQT","OpenAI","xAI",
     "Switch","Aligned","DataBank","EdgeConneX","Stack Infrastructure","CloudHQ","Applied Digital","Crusoe Energy",
     "Compass Datacenters","Iron Mountain","NTT","Cyxtera","T5 Data Centers","Yondr","Scala Data Centers"].forEach(c => comps.add(c));
    return Array.from(comps).sort();
  }, [data]);

  const geographies = ["Nordics", "Europe", "North America", "Asia-Pacific", "Global"];
  const themes = ["AI Infrastructure Capex", "Financing & Credit", "Power & Energy", "Supply Chain", "Regulatory"];

  const generateReport = async () => {
    setGenerating(true);
    setError(null);
    setGeneratedReport(null);

    try {
      const payload = { reportType: "", subject: "", geography: "", theme: "" };
      if (reportType === "Company Profile") {
        if (!selectedCompany) { setError("Please select a company."); setGenerating(false); return; }
        payload.reportType = "company_profile";
        payload.subject = selectedCompany;
      } else if (reportType === "Geographic Market") {
        payload.reportType = "geographic_market";
        payload.geography = selectedGeography;
      } else if (reportType === "Thematic Brief") {
        payload.reportType = "thematic_brief";
        payload.theme = selectedTheme;
      } else {
        payload.reportType = "market_overview";
      }

      const resp = await fetch(`${SUPABASE_URL}/functions/v1/generate-report`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${SUPABASE_ANON_KEY}` },
        body: JSON.stringify(payload),
      });

      const result = await resp.json();
      if (result.error) throw new Error(result.error);
      setGeneratedReport(result);
      // Add to library list
      if (result.report_id) {
        const typeLabels = { company_profile: "Company Profile", geographic_market: "Geographic Market", thematic_brief: "Thematic Brief", market_overview: "Market Overview" };
        setLibrary(prev => [{
          id: result.report_id,
          report_type: result.reportType,
          subject: result.subject,
          title: `${typeLabels[result.reportType] || result.reportType} — ${result.subject}`,
          created_at: result.generated_at,
        }, ...prev]);
      }
    } catch (e) {
      setError(String(e));
    } finally {
      setGenerating(false);
    }
  };

  const exportPDF = async () => {
    if (!reportRef.current || !window.html2canvas || !window.jsPDF) { alert("PDF libraries not loaded."); return; }
    try {
      const canvas = await html2canvas(reportRef.current, { scale: 2, backgroundColor: '#FFFFFF' });
      const imgData = canvas.toDataURL('image/png');
      const pdf = new window.jsPDF.jsPDF('p', 'mm', 'a4');
      const imgWidth = 210;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      let heightLeft = imgHeight;
      let position = 0;
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= 297;
      while (heightLeft >= 0) { position = heightLeft - imgHeight; pdf.addPage(); pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight); heightLeft -= 297; }
      pdf.save(`NAIO_${reportType.replace(/\s+/g, "_")}_${selectedCompany || selectedGeography || selectedTheme || "Overview"}_${new Date().toISOString().split('T')[0]}.pdf`);
    } catch (e) { alert("PDF export failed: " + e); }
  };

  // ── Render helpers for different report types ──

  const renderMetricCard = (m, idx) => (
    <div key={idx} className="p-4 bg-gray-50 border border-gray-200 rounded-lg">
      <p className="text-[10px] text-gray-500 uppercase tracking-wider">{m.label}</p>
      <p className="text-xl font-bold text-gray-900 mt-1">{m.value}</p>
      {m.context && <p className="text-[10px] text-gray-500 mt-1">{m.context}</p>}
    </div>
  );

  const renderCompanyProfile = (r) => {
    const report = r.report;
    return (
      <div>
        <div className="flex items-center gap-2 mb-1">
          <div className="h-[3px] w-5 bg-cyan-500 rounded-full"/>
          <span className="text-[10px] font-bold tracking-[0.35em] text-gray-500 uppercase">NAIO Intelligence</span>
        </div>
        <div className="flex items-start justify-between mb-1">
          <div>
            <h1 className="text-2xl font-bold text-gray-900">Company Profile | {report.company_name || r.subject}</h1>
            <p className="text-sm text-gray-600 italic mt-1">{report.tagline}</p>
          </div>
          {report.heat_score && (
            <div className="flex-shrink-0 ml-4 text-center">
              <div className={`w-14 h-14 rounded-full flex items-center justify-center text-white font-bold text-lg ${report.heat_score >= 80 ? "bg-red-500" : report.heat_score >= 60 ? "bg-orange-500" : "bg-cyan-500"}`}>
                {report.heat_score}
              </div>
              <p className="text-[9px] text-gray-500 mt-1">Heat Score</p>
            </div>
          )}
        </div>
        <p className="text-[10px] text-gray-400 mb-6">Generated: {new Date(r.generated_at).toLocaleDateString("en-GB", {day:"numeric",month:"short",year:"numeric"})} | {r.context.items_in_db} intelligence items analyzed</p>

        {/* Overview + Differentiators side by side */}
        <div className="grid grid-cols-2 gap-6 mb-6">
          <div className="border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Company Overview</h2>
            {report.overview && (
              <div className="space-y-1.5 text-xs text-gray-700">
                {report.overview.founded && <p><span className="font-semibold">Founded:</span> {report.overview.founded} &nbsp;|&nbsp; <span className="font-semibold">HQ:</span> {report.overview.hq}</p>}
                {report.overview.ceo_leadership && <p><span className="font-semibold">Leadership:</span> {report.overview.ceo_leadership}</p>}
                {report.overview.ownership && <p><span className="font-semibold">Ownership:</span> {report.overview.ownership}</p>}
                {(report.overview.key_stats || []).map((s, i) => <p key={i} className="text-gray-600 pl-3 border-l-2 border-cyan-400">{s}</p>)}
              </div>
            )}
          </div>
          <div className="border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">{report.differentiators?.headline || "Key Differentiators"}</h2>
            <div className="space-y-1.5 text-xs text-gray-700">
              {(report.differentiators?.points || []).map((p, i) => <p key={i} className="pl-3 border-l-2 border-orange-400">{p}</p>)}
            </div>
          </div>
        </div>

        {/* Capital & Financing */}
        {report.capital_and_financing && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Capital & Financing</h2>
            <div className="grid grid-cols-3 gap-3 mb-3">
              {(report.capital_and_financing.metrics || []).map(renderMetricCard)}
            </div>
            {report.capital_and_financing.narrative && <p className="text-xs text-gray-600 leading-relaxed">{report.capital_and_financing.narrative}</p>}
          </div>
        )}

        {/* Market Intelligence */}
        {report.market_intelligence && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Market Intelligence</h2>
            <div className="space-y-2 mb-3">
              {(report.market_intelligence.recent_developments || []).map((d, i) => (
                <div key={i} className="flex items-start gap-2 text-xs">
                  <div className="w-1.5 h-1.5 rounded-full bg-cyan-500 mt-1.5 flex-shrink-0"/>
                  <p className="text-gray-700">{d}</p>
                </div>
              ))}
            </div>
            {report.market_intelligence.competitive_position && (
              <div className="bg-gray-50 rounded p-3 mb-2">
                <p className="text-[10px] font-semibold text-gray-500 uppercase mb-1">Competitive Position</p>
                <p className="text-xs text-gray-700">{report.market_intelligence.competitive_position}</p>
              </div>
            )}
            {report.market_intelligence.expansion_signals && (
              <div className="bg-gray-50 rounded p-3">
                <p className="text-[10px] font-semibold text-gray-500 uppercase mb-1">Expansion Signals</p>
                <p className="text-xs text-gray-700">{report.market_intelligence.expansion_signals}</p>
              </div>
            )}
          </div>
        )}

        {/* Customer Segments */}
        {report.customer_segments && report.customer_segments.length > 0 && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Customer Base</h2>
            <div className="grid grid-cols-4 gap-3">
              {report.customer_segments.map((seg, i) => (
                <div key={i} className="bg-gray-50 rounded-lg p-3 text-center">
                  <p className="text-xs font-bold text-gray-800">{seg.segment}</p>
                  <p className="text-[10px] text-gray-500 mt-1">{seg.description}</p>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Risk + Outlook */}
        <div className="grid grid-cols-2 gap-6 mb-6">
          {report.risk_factors && (
            <div className="border border-gray-200 rounded-lg p-4">
              <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Risk Factors</h2>
              <div className="space-y-1.5">
                {report.risk_factors.map((rf, i) => (
                  <div key={i} className="flex items-start gap-2 text-xs text-gray-700">
                    <span className="text-red-400 mt-0.5 flex-shrink-0">&#9679;</span>
                    <p>{rf}</p>
                  </div>
                ))}
              </div>
            </div>
          )}
          {report.outlook && (
            <div className="border border-gray-200 rounded-lg p-4">
              <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Outlook</h2>
              <p className="text-xs text-gray-700 leading-relaxed">{report.outlook}</p>
            </div>
          )}
        </div>
      </div>
    );
  };

  const renderGeographicReport = (r) => {
    const report = r.report;
    return (
      <div>
        <div className="flex items-center gap-2 mb-1">
          <div className="h-[3px] w-5 bg-cyan-500 rounded-full"/>
          <span className="text-[10px] font-bold tracking-[0.35em] text-gray-500 uppercase">NAIO Intelligence</span>
        </div>
        <h1 className="text-2xl font-bold text-gray-900">{report.region_name || r.subject} — Market Intelligence</h1>
        <p className="text-sm text-gray-600 italic mt-1">{report.tagline}</p>
        <p className="text-[10px] text-gray-400 mt-1 mb-6">Generated: {new Date(r.generated_at).toLocaleDateString("en-GB", {day:"numeric",month:"short",year:"numeric"})}</p>

        {/* Market Overview */}
        {report.market_overview && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Market Overview</h2>
            <div className="grid grid-cols-2 gap-3 mb-3">
              <div className="bg-gray-50 rounded p-3"><p className="text-[10px] text-gray-500 uppercase">Total Capacity</p><p className="text-lg font-bold text-gray-900">{report.market_overview.total_capacity_mw}</p></div>
              <div className="bg-gray-50 rounded p-3"><p className="text-[10px] text-gray-500 uppercase">Growth Rate</p><p className="text-lg font-bold text-gray-900">{report.market_overview.growth_rate}</p></div>
            </div>
            <div className="space-y-1.5">
              {(report.market_overview.key_stats || []).map((s, i) => <p key={i} className="text-xs text-gray-700 pl-3 border-l-2 border-cyan-400">{s}</p>)}
            </div>
          </div>
        )}

        {/* Key Players */}
        {report.key_players && report.key_players.length > 0 && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Key Players</h2>
            <table className="w-full text-xs">
              <thead><tr className="border-b border-gray-200"><th className="text-left py-2 text-gray-500 font-semibold">Company</th><th className="text-left py-2 text-gray-500 font-semibold">Presence</th><th className="text-right py-2 text-gray-500 font-semibold">Capacity</th></tr></thead>
              <tbody>
                {report.key_players.map((p, i) => (
                  <tr key={i} className="border-b border-gray-100"><td className="py-2 font-medium text-gray-900">{p.company}</td><td className="py-2 text-gray-600">{p.presence}</td><td className="py-2 text-right text-gray-600">{p.capacity_mw}</td></tr>
                ))}
              </tbody>
            </table>
          </div>
        )}

        {/* Supply Dynamics + Regulatory side by side */}
        <div className="grid grid-cols-2 gap-6 mb-6">
          {report.supply_dynamics && (
            <div className="border border-gray-200 rounded-lg p-4">
              <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Supply Dynamics</h2>
              <p className="text-xs text-gray-700 mb-2">{report.supply_dynamics.pipeline}</p>
              <p className="text-[10px] font-semibold text-gray-500 uppercase mt-2 mb-1">Constraints</p>
              {(report.supply_dynamics.constraints || []).map((c, i) => <p key={i} className="text-xs text-gray-600 pl-3 border-l-2 border-red-300">{c}</p>)}
              <p className="text-[10px] font-semibold text-gray-500 uppercase mt-2 mb-1">Power</p>
              <p className="text-xs text-gray-600">{report.supply_dynamics.power_situation}</p>
            </div>
          )}
          {report.regulatory_landscape && (
            <div className="border border-gray-200 rounded-lg p-4">
              <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Regulatory Landscape</h2>
              <p className="text-xs text-gray-700 mb-2">{report.regulatory_landscape.summary}</p>
              {(report.regulatory_landscape.key_policies || []).map((p, i) => <p key={i} className="text-xs text-gray-600 pl-3 border-l-2 border-orange-400">{p}</p>)}
              <p className="text-[10px] font-semibold text-gray-500 uppercase mt-2 mb-1">Outlook</p>
              <p className="text-xs text-gray-600">{report.regulatory_landscape.outlook}</p>
            </div>
          )}
        </div>

        {/* Financing + Demand Drivers */}
        {report.financing_environment && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Financing Environment</h2>
            <div className="grid grid-cols-2 gap-3 mb-2">
              <div className="bg-gray-50 rounded p-3"><p className="text-[10px] text-gray-500 uppercase">Spread Range</p><p className="text-sm font-bold text-gray-900">{report.financing_environment.spread_range}</p></div>
              <div className="bg-gray-50 rounded p-3"><p className="text-[10px] text-gray-500 uppercase">Investor Appetite</p><p className="text-xs text-gray-700">{report.financing_environment.investor_appetite}</p></div>
            </div>
            {(report.financing_environment.recent_deals || []).map((d, i) => (
              <div key={i} className="flex items-start gap-2 text-xs text-gray-700"><span className="text-cyan-500 mt-0.5">&#9679;</span><p>{d}</p></div>
            ))}
          </div>
        )}

        {/* Recent Developments */}
        {report.recent_developments && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Recent Developments</h2>
            <div className="space-y-2">
              {report.recent_developments.map((d, i) => (
                <div key={i} className="flex items-start gap-2 text-xs"><div className="w-1.5 h-1.5 rounded-full bg-cyan-500 mt-1.5 flex-shrink-0"/><p className="text-gray-700">{d}</p></div>
              ))}
            </div>
          </div>
        )}

        {/* Risk + Outlook */}
        <div className="grid grid-cols-2 gap-6 mb-6">
          <div className="border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Risk Factors</h2>
            {(report.risk_factors || []).map((rf, i) => <div key={i} className="flex items-start gap-2 text-xs text-gray-700 mb-1"><span className="text-red-400 mt-0.5">&#9679;</span><p>{rf}</p></div>)}
          </div>
          <div className="border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Outlook</h2>
            <p className="text-xs text-gray-700 leading-relaxed">{report.outlook}</p>
          </div>
        </div>
      </div>
    );
  };

  const renderThematicBrief = (r) => {
    const report = r.report;
    return (
      <div>
        <div className="flex items-center gap-2 mb-1">
          <div className="h-[3px] w-5 bg-cyan-500 rounded-full"/>
          <span className="text-[10px] font-bold tracking-[0.35em] text-gray-500 uppercase">NAIO Intelligence</span>
        </div>
        <h1 className="text-2xl font-bold text-gray-900">{report.theme_name || r.subject} — Thematic Brief</h1>
        <p className="text-sm text-gray-600 italic mt-1">{report.tagline}</p>
        <p className="text-[10px] text-gray-400 mt-1 mb-6">Generated: {new Date(r.generated_at).toLocaleDateString("en-GB", {day:"numeric",month:"short",year:"numeric"})}</p>

        {/* Executive Summary */}
        <div className="mb-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
          <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-2">Executive Summary</h2>
          <p className="text-sm text-gray-700 leading-relaxed">{report.executive_summary}</p>
        </div>

        {/* Key Metrics */}
        {report.key_metrics && (
          <div className="grid grid-cols-4 gap-3 mb-6">
            {report.key_metrics.map(renderMetricCard)}
          </div>
        )}

        {/* Key Developments */}
        {report.key_developments && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Key Developments</h2>
            <div className="space-y-3">
              {report.key_developments.map((d, i) => (
                <div key={i} className="flex gap-3 text-xs">
                  <div className="flex-shrink-0 w-20 text-gray-500 font-mono">{d.date}</div>
                  <div><p className="font-semibold text-gray-900">{d.headline}</p><p className="text-gray-600 mt-0.5">{d.detail}</p>{d.companies && <p className="text-[10px] text-cyan-600 mt-0.5">{d.companies.join(", ")}</p>}</div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Market Dynamics */}
        {report.market_dynamics && (
          <div className="grid grid-cols-3 gap-4 mb-6">
            <div className="border border-gray-200 rounded-lg p-4">
              <h2 className="text-xs font-bold text-green-700 uppercase tracking-wider mb-2">Trends</h2>
              {(report.market_dynamics.trends || []).map((t, i) => <p key={i} className="text-xs text-gray-700 mb-1 pl-3 border-l-2 border-green-400">{t}</p>)}
            </div>
            <div className="border border-gray-200 rounded-lg p-4">
              <h2 className="text-xs font-bold text-orange-700 uppercase tracking-wider mb-2">Challenges</h2>
              {(report.market_dynamics.challenges || []).map((c, i) => <p key={i} className="text-xs text-gray-700 mb-1 pl-3 border-l-2 border-orange-400">{c}</p>)}
            </div>
            <div className="border border-gray-200 rounded-lg p-4">
              <h2 className="text-xs font-bold text-cyan-700 uppercase tracking-wider mb-2">Opportunities</h2>
              {(report.market_dynamics.opportunities || []).map((o, i) => <p key={i} className="text-xs text-gray-700 mb-1 pl-3 border-l-2 border-cyan-400">{o}</p>)}
            </div>
          </div>
        )}

        {/* Company Positioning */}
        {report.company_positioning && report.company_positioning.length > 0 && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Company Positioning</h2>
            <div className="space-y-2">
              {report.company_positioning.map((cp, i) => (
                <div key={i} className="flex gap-3 text-xs"><span className="font-bold text-gray-900 flex-shrink-0 w-32">{cp.company}</span><span className="text-gray-600">{cp.position}</span></div>
              ))}
            </div>
          </div>
        )}

        {/* Risk + Outlook + Investment Implications */}
        <div className="grid grid-cols-2 gap-6 mb-6">
          <div className="border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Risk Factors</h2>
            {(report.risk_factors || []).map((rf, i) => <div key={i} className="flex items-start gap-2 text-xs text-gray-700 mb-1"><span className="text-red-400 mt-0.5">&#9679;</span><p>{rf}</p></div>)}
          </div>
          <div className="border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Outlook & Investment Implications</h2>
            <p className="text-xs text-gray-700 leading-relaxed mb-2">{report.outlook}</p>
            {report.investment_implications && <p className="text-xs text-gray-600 leading-relaxed bg-gray-50 rounded p-2 mt-2">{report.investment_implications}</p>}
          </div>
        </div>
      </div>
    );
  };

  const renderMarketOverview = (r) => {
    const report = r.report;
    return (
      <div>
        <div className="flex items-center gap-2 mb-1">
          <div className="h-[3px] w-5 bg-cyan-500 rounded-full"/>
          <span className="text-[10px] font-bold tracking-[0.35em] text-gray-500 uppercase">NAIO Intelligence</span>
        </div>
        <h1 className="text-2xl font-bold text-gray-900">{report.title || "Data Center Market Overview"}</h1>
        <p className="text-sm text-gray-600 italic mt-1">{report.tagline}</p>
        <p className="text-[10px] text-gray-400 mt-1 mb-6">Generated: {new Date(r.generated_at).toLocaleDateString("en-GB", {day:"numeric",month:"short",year:"numeric"})}</p>

        <div className="mb-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
          <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-2">Executive Summary</h2>
          <p className="text-sm text-gray-700 leading-relaxed">{report.executive_summary}</p>
        </div>

        {report.key_metrics && <div className="grid grid-cols-4 gap-3 mb-6">{report.key_metrics.map(renderMetricCard)}</div>}

        {/* Sector Heat */}
        {report.sector_heat && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Sector Heat</h2>
            <div className="space-y-2">
              {report.sector_heat.map((s, i) => (
                <div key={i} className="flex items-center gap-3">
                  <span className="text-xs font-semibold text-gray-700 w-28">{s.sector}</span>
                  <div className="flex-1 h-3 bg-gray-100 rounded-full overflow-hidden"><div className={`h-full rounded-full ${s.score >= 80 ? "bg-red-400" : s.score >= 60 ? "bg-orange-400" : "bg-cyan-400"}`} style={{width: s.score + "%"}}/></div>
                  <span className={`text-xs font-bold w-8 text-right ${s.score >= 80 ? "text-red-500" : s.score >= 60 ? "text-orange-500" : "text-cyan-500"}`}>{s.score}</span>
                  <span className="text-[10px] text-gray-500 flex-1">{s.assessment}</span>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Top Developments */}
        {report.top_developments && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Top Developments</h2>
            <div className="space-y-3">
              {report.top_developments.map((d, i) => (
                <div key={i} className="flex gap-3 text-xs">
                  <div className="flex-shrink-0 w-20 text-gray-500 font-mono">{d.date}</div>
                  <div className={`w-1 rounded-full flex-shrink-0 ${d.importance === "high" ? "bg-red-400" : "bg-orange-400"}`}/>
                  <div><p className="font-semibold text-gray-900">{d.headline}</p><p className="text-gray-600 mt-0.5">{d.detail}</p></div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Geographic Outlook */}
        {report.geographic_outlook && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Geographic Outlook</h2>
            <div className="space-y-2">
              {report.geographic_outlook.map((g, i) => (
                <div key={i} className="flex items-center gap-3 text-xs">
                  <span className="font-semibold text-gray-900 w-28">{g.region}</span>
                  <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white text-[10px] font-bold ${g.heat_score >= 80 ? "bg-red-500" : g.heat_score >= 60 ? "bg-orange-500" : "bg-cyan-500"}`}>{g.heat_score}</div>
                  <span className="text-gray-600 flex-1">{g.key_development}</span>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Financing + Catalysts */}
        <div className="grid grid-cols-2 gap-6 mb-6">
          {report.financing_conditions && (
            <div className="border border-gray-200 rounded-lg p-4">
              <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Financing Conditions</h2>
              <p className="text-xs text-gray-700 mb-2">{report.financing_conditions.summary}</p>
              <p className="text-xs text-gray-600">{report.financing_conditions.spread_environment}</p>
            </div>
          )}
          {report.upcoming_catalysts && (
            <div className="border border-gray-200 rounded-lg p-4">
              <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Upcoming Catalysts</h2>
              {report.upcoming_catalysts.map((c, i) => <div key={i} className="flex items-start gap-2 text-xs text-gray-700 mb-1"><span className="text-cyan-500 mt-0.5">&#9679;</span><p>{c}</p></div>)}
            </div>
          )}
        </div>

        <div className="grid grid-cols-2 gap-6 mb-6">
          <div className="border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Risk Factors</h2>
            {(report.risk_factors || []).map((rf, i) => <div key={i} className="flex items-start gap-2 text-xs text-gray-700 mb-1"><span className="text-red-400 mt-0.5">&#9679;</span><p>{rf}</p></div>)}
          </div>
          <div className="border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Outlook & Investment Implications</h2>
            <p className="text-xs text-gray-700 leading-relaxed mb-2">{report.outlook}</p>
            {report.investment_implications && <p className="text-xs text-gray-600 bg-gray-50 rounded p-2 mt-2">{report.investment_implications}</p>}
          </div>
        </div>
      </div>
    );
  };

  const renderReport = (r) => {
    if (!r || !r.report) return null;
    const rt = r.reportType;
    if (rt === "company_profile") return renderCompanyProfile(r);
    if (rt === "geographic_market") return renderGeographicReport(r);
    if (rt === "thematic_brief") return renderThematicBrief(r);
    return renderMarketOverview(r);
  };

  const typeIcons = { company_profile: "Building2", geographic_market: "Map", thematic_brief: "Layers", market_overview: "LayoutDashboard" };
  const typeColors = { company_profile: "text-naio-cyan", geographic_market: "text-naio-teal", thematic_brief: "text-naio-orange", market_overview: "text-naio-purple" };

  // Group library by type
  const libraryGrouped = useMemo(() => {
    const groups = {};
    library.forEach(r => {
      const label = { company_profile: "Company Profiles", geographic_market: "Geographic Markets", thematic_brief: "Thematic Briefs", market_overview: "Market Overviews" }[r.report_type] || "Other";
      if (!groups[label]) groups[label] = [];
      groups[label].push(r);
    });
    return groups;
  }, [library]);

  return (
    <div className="flex gap-6">
      {/* Main content */}
      <div className="flex-1 min-w-0 space-y-6">
      {/* Controls */}
      <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-6">
        <h2 className="text-sm font-semibold text-naio-cyan uppercase tracking-wider mb-4">AI Report Generator</h2>
        <p className="text-xs text-naio-text-muted mb-4">Select a report type and subject. NAIO will analyze your intelligence database and generate a comprehensive sell-side research-style report using AI.</p>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label className="text-xs text-naio-text-muted uppercase tracking-wider block mb-2">Report Type</label>
            <select value={reportType} onChange={e => setReportType(e.target.value)} className="w-full px-3 py-2 bg-naio-bg-surface border border-naio-border rounded-md text-sm text-naio-text-primary focus:outline-none focus:border-naio-cyan/50 appearance-none cursor-pointer">
              <option value="Company Profile">Company Profile</option>
              <option value="Geographic Market">Geographic Market</option>
              <option value="Thematic Brief">Thematic Brief</option>
              <option value="Market Overview">Market Overview</option>
            </select>
          </div>
          {reportType === "Company Profile" && (
            <div>
              <label className="text-xs text-naio-text-muted uppercase tracking-wider block mb-2">Company</label>
              <select value={selectedCompany} onChange={e => setSelectedCompany(e.target.value)} className="w-full px-3 py-2 bg-naio-bg-surface border border-naio-border rounded-md text-sm text-naio-text-primary focus:outline-none focus:border-naio-cyan/50 appearance-none cursor-pointer">
                <option value="">Select a company...</option>
                {uniqueCompanies.map(c => <option key={c} value={c}>{c}</option>)}
              </select>
            </div>
          )}
          {reportType === "Geographic Market" && (
            <div>
              <label className="text-xs text-naio-text-muted uppercase tracking-wider block mb-2">Region</label>
              <select value={selectedGeography} onChange={e => setSelectedGeography(e.target.value)} className="w-full px-3 py-2 bg-naio-bg-surface border border-naio-border rounded-md text-sm text-naio-text-primary focus:outline-none focus:border-naio-cyan/50 appearance-none cursor-pointer">
                {geographies.map(g => <option key={g} value={g}>{g}</option>)}
              </select>
            </div>
          )}
          {reportType === "Thematic Brief" && (
            <div>
              <label className="text-xs text-naio-text-muted uppercase tracking-wider block mb-2">Theme</label>
              <select value={selectedTheme} onChange={e => setSelectedTheme(e.target.value)} className="w-full px-3 py-2 bg-naio-bg-surface border border-naio-border rounded-md text-sm text-naio-text-primary focus:outline-none focus:border-naio-cyan/50 appearance-none cursor-pointer">
                {themes.map(t => <option key={t} value={t}>{t}</option>)}
              </select>
            </div>
          )}
        </div>
        <button onClick={generateReport} disabled={generating} className={`px-5 py-2.5 rounded-md text-sm font-semibold transition-colors flex items-center gap-2 ${generating ? "bg-naio-bg-surface text-naio-text-muted cursor-not-allowed" : "bg-naio-cyan text-naio-bg hover:bg-naio-cyan-light"}`}>
          {generating ? (
            <React.Fragment><svg className="animate-spin h-4 w-4" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>Generating with AI...</React.Fragment>
          ) : (
            <React.Fragment><Icon name="FileText" size={14}/>Generate Report</React.Fragment>
          )}
        </button>
        {error && <p className="mt-3 text-xs text-naio-red">{error}</p>}
      </div>

      {/* Generating state */}
      {generating && (
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-12 text-center">
          <svg className="animate-spin h-8 w-8 text-naio-cyan mx-auto mb-4" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
          <p className="text-sm text-naio-text-secondary">Analyzing intelligence database and generating report...</p>
          <p className="text-xs text-naio-text-muted mt-2">This typically takes 15-30 seconds</p>
        </div>
      )}

      {/* Generated Report */}
      {generatedReport && !generating && (
        <div>
          <div ref={reportRef} className="bg-white text-gray-900 rounded-lg overflow-hidden p-8">
            {renderReport(generatedReport)}
            <div className="text-center pt-6 mt-6 border-t border-gray-200">
              <p className="text-[9px] text-gray-400 uppercase tracking-wider">Confidential — For internal use only</p>
              <p className="text-[9px] text-gray-400 mt-1">Generated by NAIO Intelligence | {new Date(generatedReport.generated_at).toLocaleDateString("en-GB", {day:"numeric",month:"short",year:"numeric"})}</p>
            </div>
          </div>
          <div className="flex gap-3 mt-6">
            <button onClick={exportPDF} className="px-4 py-2 bg-naio-cyan text-naio-bg rounded-md text-sm font-semibold hover:bg-naio-cyan-light transition-colors flex items-center gap-2">
              <Icon name="FileText" size={14}/>Export as PDF
            </button>
            <button onClick={() => setGeneratedReport(null)} className="px-4 py-2 bg-naio-bg-surface border border-naio-border text-naio-text-secondary rounded-md text-sm hover:text-naio-text-primary transition-colors">
              Clear Report
            </button>
          </div>
        </div>
      )}
      </div>

      {/* Report Library sidebar */}
      <div className="w-64 flex-shrink-0">
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg overflow-hidden sticky top-6">
          <div className="px-4 py-3 border-b border-naio-border">
            <div className="flex items-center justify-between">
              <h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider flex items-center gap-2">
                <Icon name="Archive" size={14}/>
                Report Library
              </h3>
              {library.length > 0 && <button onClick={deleteAllReports} className="text-[10px] text-naio-text-dim hover:text-naio-red transition-colors" title="Delete all reports">Clear all</button>}
            </div>
            <p className="text-[10px] text-naio-text-dim mt-1">{library.length} saved report{library.length !== 1 ? "s" : ""}</p>
          </div>
          <div className="max-h-[calc(100vh-220px)] overflow-y-auto">
            {libraryLoading ? (
              <div className="p-4 text-center"><p className="text-xs text-naio-text-muted animate-pulse-custom">Loading...</p></div>
            ) : library.length === 0 ? (
              <div className="p-4 text-center"><p className="text-xs text-naio-text-muted">No reports yet.</p><p className="text-[10px] text-naio-text-dim mt-1">Generate your first report above.</p></div>
            ) : (
              Object.entries(libraryGrouped).map(([groupLabel, reports]) => (
                <div key={groupLabel}>
                  <div className="px-4 py-2 bg-naio-bg-deep/50">
                    <p className="text-[10px] font-semibold text-naio-text-dim uppercase tracking-wider">{groupLabel}</p>
                  </div>
                  {reports.map(r => (
                    <button key={r.id} onClick={() => loadReport(r.id)}
                      className={`w-full text-left px-4 py-2.5 border-b border-naio-border/50 hover:bg-naio-bg-card-hover transition-colors group ${generatedReport?.report_id === r.id ? "bg-naio-bg-surface" : ""}`}>
                      <div className="flex items-start justify-between gap-1">
                        <div className="min-w-0">
                          <div className="flex items-center gap-1.5">
                            <span className={typeColors[r.report_type] || "text-naio-text-muted"}><Icon name={typeIcons[r.report_type] || "FileText"} size={12}/></span>
                            <p className="text-xs text-naio-text-primary font-medium truncate">{r.subject}</p>
                          </div>
                          <p className="text-[10px] text-naio-text-dim mt-0.5">{new Date(r.created_at).toLocaleDateString("en-GB", {day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})}</p>
                        </div>
                        <button onClick={(e) => deleteReport(r.id, e)} className="opacity-0 group-hover:opacity-100 text-naio-red/60 hover:text-naio-red transition-all flex-shrink-0 mt-0.5 p-0.5" title="Delete report">
                          <Icon name="Trash2" size={12}/>
                        </button>
                      </div>
                    </button>
                  ))}
                </div>
              ))
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

function Sidebar({activeTab, onTabChange}) {
  return (
    <aside className="w-56 min-w-[14rem] h-full bg-naio-bg-deep border-r border-naio-border flex flex-col flex-shrink-0">
      <div className="px-5 py-5 border-b border-naio-border">
        <div className="flex items-center gap-2">
          <div className="h-[3px] w-5 bg-naio-cyan rounded-full"/>
          <span className="text-sm font-bold tracking-[0.35em] text-naio-text-primary">N A I O</span>
        </div>
        <p className="text-[10px] text-naio-text-muted mt-1.5 tracking-wider uppercase">Market Intelligence</p>
      </div>
      <nav className="flex-1 py-3 px-3 space-y-0.5 overflow-y-auto">
        {tabs.map(t => (
          <button key={t.id} onClick={()=>onTabChange(t.id)}
            className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-sm transition-all duration-150 ${activeTab===t.id ? "bg-naio-bg-card text-naio-cyan border border-naio-border" : "text-naio-text-secondary hover:text-naio-text-primary hover:bg-naio-bg-card/50 border border-transparent"}`}>
            <span className={activeTab===t.id?"text-naio-cyan":"text-naio-text-muted"}><Icon name={t.icon} size={18}/></span>
            {t.label}
          </button>
        ))}
      </nav>
      <div className="px-4 py-3 border-t border-naio-border">
        <div className="flex items-center gap-2">
          <div className="w-2 h-2 rounded-full bg-naio-green animate-pulse-custom"/>
          <span className="text-[10px] text-naio-text-muted">Pipeline active</span>
        </div>
        <p className="text-[10px] text-naio-text-dim mt-1">Powered by Claude API</p>
      </div>
    </aside>
  );
}

function StatsBar({items}) {
  const stats = [
    {label:"Total Items",value:items.length,icon:"FileText",color:"text-naio-cyan"},
    {label:"High Priority",value:items.filter(i=>i.importance==="high").length,icon:"AlertTriangle",color:"text-naio-red"},
    {label:"Deals",value:items.filter(i=>i.type==="deal_synopsis").length,icon:"Handshake",color:"text-naio-blue-light"},
    {label:"Financing",value:items.filter(i=>i.type==="financing_event").length,icon:"Landmark",color:"text-naio-orange"},
    {label:"Power Signals",value:items.filter(i=>i.type==="power_demand_signal").length,icon:"Zap",color:"text-naio-green"},
  ];
  return (
    <div className="grid grid-cols-5 gap-4">
      {stats.map(s => (
        <div key={s.label} className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4">
          <div className="flex items-center justify-between">
            <span className={s.color}><Icon name={s.icon} size={16}/></span>
            <span className="text-3xl font-bold text-naio-text-primary">{s.value}</span>
          </div>
          <p className="text-xs uppercase tracking-wider text-naio-text-muted mt-1">{s.label}</p>
        </div>
      ))}
    </div>
  );
}

function IntelCard({item, onClick}) {
  return (
    <button onClick={onClick} className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4 text-left w-full hover:bg-naio-bg-card-hover hover:border-naio-border-light transition-all duration-200 group">
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center gap-2">
          <span className={`px-2 py-0.5 rounded-full text-[10px] font-semibold uppercase tracking-wider ${layerClass[item.layer]||""}`}>{layerLabels[item.layer]}</span>
          <span className="flex items-center gap-1.5 text-[11px] text-naio-text-muted"><Icon name={typeIconMap[item.type]} size={13}/>{typeLabels[item.type]}</span>
        </div>
        <div className="flex items-center gap-2">
          <div className={`w-1.5 h-1.5 rounded-full ${impDot[item.importance]}`}/>
          <span className="text-[11px] text-naio-text-dim">{relDate(item.date)}</span>
        </div>
      </div>
      <h3 className="text-sm font-semibold text-naio-text-primary leading-snug mb-1.5 group-hover:text-naio-cyan transition-colors">{item.headline}</h3>
      <p className="text-xs text-naio-text-secondary leading-relaxed line-clamp-2 mb-3">{item.summary}</p>
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2 flex-wrap">
          {item.companies.slice(0,3).map(c => <span key={c} className="px-2 py-0.5 rounded bg-naio-bg-surface text-[10px] text-naio-text-secondary">{c}</span>)}
          {item.companies.length>3 && <span className="text-[10px] text-naio-text-dim">+{item.companies.length-3}</span>}
          <span className="text-[10px] text-naio-text-dim ml-1">{item.region}</span>
        </div>
        <span className="text-naio-text-dim group-hover:text-naio-cyan transition-colors"><Icon name="ChevronRight" size={14}/></span>
      </div>
    </button>
  );
}

function IntelTable({items, onItemClick}) {
  const [tableSortCol, setTableSortCol] = useState("date");
  const [tableSortDir, setTableSortDir] = useState("desc");

  const sorted = useMemo(() => {
    let sorted = [...items];
    sorted.sort((a, b) => {
      let aVal, bVal;
      if (tableSortCol === "date") {
        aVal = new Date(a.date); bVal = new Date(b.date);
      } else if (tableSortCol === "importance") {
        const impOrder = {high: 3, medium: 2, low: 1};
        aVal = impOrder[a.importance] || 0; bVal = impOrder[b.importance] || 0;
      } else if (tableSortCol === "type") {
        aVal = a.type; bVal = b.type;
      } else if (tableSortCol === "region") {
        aVal = a.region; bVal = b.region;
      } else if (tableSortCol === "companies") {
        aVal = (a.companies || [])[0] || ""; bVal = (b.companies || [])[0] || "";
      } else {
        aVal = a[tableSortCol] || ""; bVal = b[tableSortCol] || "";
      }
      if (tableSortDir === "asc") return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
      return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
    });
    return sorted;
  }, [items, tableSortCol, tableSortDir]);

  const toggleSort = (col) => {
    if (tableSortCol === col) setTableSortDir(d => d === "asc" ? "desc" : "asc");
    else { setTableSortCol(col); setTableSortDir("desc"); }
  };

  const cols = [
    {key: "date", label: "Date", w: "w-24"},
    {key: "headline", label: "Headline", w: "flex-1"},
    {key: "type", label: "Type", w: "w-28"},
    {key: "importance", label: "Priority", w: "w-20"},
    {key: "region", label: "Region", w: "w-36"},
    {key: "companies", label: "Companies", w: "w-36"},
  ];

  const impBadge = {
    high: "bg-[#FF5252]/20 text-[#FF5252]",
    medium: "bg-[#FF9800]/20 text-[#FFB74D]",
    low: "bg-[#6B8FA3]/20 text-[#6B8FA3]"
  };

  return (
    <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg overflow-hidden">
      <div className="overflow-x-auto">
        <table className="w-full text-sm">
          <thead>
            <tr className="bg-[#122640] border-b border-naio-border">
              {cols.map(col => (
                <th key={col.key}
                  className={`px-4 py-3 text-left text-naio-cyan font-semibold text-[11px] uppercase tracking-wider cursor-pointer hover:bg-naio-bg-card/50 transition-colors ${col.w}`}
                  onClick={() => toggleSort(col.key)}>
                  <div className="flex items-center gap-1.5">
                    {col.label}
                    {tableSortCol === col.key && <span className="text-[10px]">{tableSortDir === "asc" ? "↑" : "↓"}</span>}
                  </div>
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {sorted.map((item, idx) => (
              <tr key={item.id}
                className={`border-b border-naio-border/50 cursor-pointer transition-colors ${idx % 2 === 0 ? "bg-[#0F2237]" : "bg-[#0D1F33]"} hover:bg-naio-bg-card-hover`}
                onClick={() => onItemClick(item)}>
                <td className="px-4 py-2.5 text-naio-text-dim text-xs font-mono whitespace-nowrap">{fmtDate(item.date)}</td>
                <td className="px-4 py-2.5">
                  <p className="text-naio-text-primary text-xs font-medium line-clamp-2">{item.headline}</p>
                </td>
                <td className="px-4 py-2.5">
                  <span className={`inline-block px-2 py-0.5 rounded text-[10px] font-semibold ${layerClass[item.layer] || "bg-naio-bg-surface text-naio-text-muted"}`}>
                    {typeLabels[item.type] || item.type}
                  </span>
                </td>
                <td className="px-4 py-2.5">
                  <span className={`inline-block px-2 py-0.5 rounded text-[10px] font-semibold capitalize ${impBadge[item.importance] || ""}`}>
                    {item.importance}
                  </span>
                </td>
                <td className="px-4 py-2.5 text-naio-text-muted text-xs">{item.region}</td>
                <td className="px-4 py-2.5 text-naio-text-muted text-[11px]">{(item.companies || []).slice(0, 2).join(", ")}{item.companies?.length > 2 ? ` +${item.companies.length - 2}` : ""}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      {sorted.length === 0 && <div className="text-center py-12 text-naio-text-muted"><p>No items match your filters.</p></div>}
    </div>
  );
}

function DetailRow({label,value}) { if(!value) return null; return <div className="flex items-start gap-3"><span className="text-[11px] text-naio-text-muted w-28 flex-shrink-0 pt-0.5">{label}</span><span className="text-sm text-naio-text-secondary">{value}</span></div>; }
function RatingBadge({agency,rating}) { return <div className="text-center"><p className="text-[10px] text-naio-text-dim">{agency}</p><p className="text-sm font-bold text-naio-text-primary">{rating}</p></div>; }

function DetailModal({item, onClose}) {
  const fd = item.full_data;
  useEffect(() => { const h = e => { if(e.key==="Escape") onClose(); }; document.addEventListener("keydown",h); return ()=>document.removeEventListener("keydown",h); }, [onClose]);

  return (
    <div className="fixed inset-0 z-50 flex items-start justify-end animate-fade-in">
      <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}/>
      <div className="relative w-full max-w-2xl h-full bg-naio-bg-deep border-l border-naio-border overflow-y-auto animate-slide-in">
        <div className="h-[2px] bg-gradient-to-r from-naio-cyan via-naio-teal to-transparent"/>
        <div className="sticky top-0 bg-naio-bg-deep/95 backdrop-blur-sm z-10 px-6 py-4 border-b border-naio-border">
          <div className="flex items-start justify-between">
            <div className="flex-1 mr-4">
              <div className="flex items-center gap-2 mb-2">
                <span className={`px-2 py-0.5 rounded-full text-[10px] font-semibold uppercase tracking-wider ${layerClass[item.layer]}`}>{layerLabels[item.layer]}</span>
                <span className="text-[11px] text-naio-text-muted">{typeLabels[item.type]}</span>
                <div className={`w-1.5 h-1.5 rounded-full ${impDot[item.importance]}`}/>
                <span className="text-[11px] text-naio-text-dim capitalize">{item.importance} priority</span>
              </div>
              <h2 className="text-lg font-semibold text-naio-text-primary leading-snug">{item.headline}</h2>
            </div>
            <button onClick={onClose} className="p-1.5 rounded hover:bg-naio-bg-card text-naio-text-muted hover:text-naio-text-primary transition-colors"><Icon name="X" size={18}/></button>
          </div>
        </div>
        <div className="px-6 py-5 space-y-6">
          <div className="flex flex-wrap gap-4 text-xs text-naio-text-muted">
            <span className="flex items-center gap-1"><Icon name="Calendar" size={12}/> {fmtDate(item.date)}</span>
            <span className="flex items-center gap-1"><Icon name="MapPin" size={12}/> {item.region}</span>
            <span className="flex items-center gap-1"><Icon name="Building2" size={12}/> {item.companies.join(", ")}</span>
          </div>
          <div><h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-2">Summary</h3><p className="text-sm text-naio-text-secondary leading-relaxed">{item.summary}</p></div>
          <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4">
            <h3 className="text-xs font-semibold text-naio-orange uppercase tracking-wider mb-2">Why This Matters</h3>
            <p className="text-sm text-naio-text-secondary">{item.importance_rationale}</p>
          </div>

          {item.type==="deal_synopsis" && fd.parties && <div>
            <h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-2">Deal Details</h3>
            <div className="space-y-2">
              <DetailRow label="Deal Type" value={fd.deal_type}/>
              <DetailRow label="Value" value={fd.deal_value}/>
              {fd.capacity_mw && <DetailRow label="Capacity" value={fd.capacity_mw+" MW"}/>}
              <div className="mt-3"><p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Parties</p>
                <div className="flex flex-wrap gap-2">{fd.parties.map((p,i)=><span key={i} className="px-2 py-1 rounded bg-naio-bg-card text-xs text-naio-text-secondary border border-naio-border">{p.name} <span className="text-naio-text-dim">({p.role})</span></span>)}</div>
              </div>
            </div>
          </div>}

          {item.type==="financing_event" && <div>
            <h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-2">Terms</h3>
            <div className="space-y-2">
              <DetailRow label="Type" value={fd.event_subtype}/>
              <DetailRow label="Amount" value={fd.amount}/>
              <DetailRow label="Tenor" value={fd.tenor_maturity}/>
              <DetailRow label="Coupon" value={fd.coupon_rate}/>
              <DetailRow label="Spread" value={fd.spread}/>
              {fd.rating && <div className="mt-3 bg-naio-bg-card/80 border border-naio-border rounded-lg p-3">
                <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-2">Credit Ratings</p>
                <div className="flex gap-4">{fd.rating.moodys&&<RatingBadge agency="Moody's" rating={fd.rating.moodys}/>}{fd.rating.sp&&<RatingBadge agency="S&P" rating={fd.rating.sp}/>}{fd.rating.fitch&&<RatingBadge agency="Fitch" rating={fd.rating.fitch}/>}</div>
                {fd.rating.outlook&&<p className="text-xs text-naio-text-muted mt-2">Outlook: <span className="text-naio-text-secondary capitalize">{fd.rating.outlook}</span></p>}
              </div>}
              <DetailRow label="Use of Proceeds" value={fd.use_of_proceeds}/>
              {fd.lead_arrangers&&<DetailRow label="Lead Arrangers" value={fd.lead_arrangers.join(", ")}/>}
            </div>
          </div>}

          {item.type==="capex_announcement" && fd.breakdown && <div>
            <h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-2">Capex Breakdown</h3>
            <div className="space-y-2">
              <DetailRow label="Total Spend" value={fd.announced_spend}/>
              <DetailRow label="Time Horizon" value={fd.time_horizon}/>
              <DetailRow label="Self-Build" value={fd.breakdown.self_build}/>
              <DetailRow label="Colo / Leasing" value={fd.breakdown.colo_leasing}/>
              <DetailRow label="Funding Source" value={fd.funding_source}/>
            </div>
            {fd.colo_signal && <div className="mt-3 bg-naio-bg-card/80 border border-naio-border rounded-lg p-3 border-l-2 border-l-naio-orange">
              <p className="text-[10px] text-naio-orange uppercase tracking-wider mb-1">Colo Signal</p>
              <p className="text-xs text-naio-text-secondary">{fd.colo_signal}</p>
            </div>}
          </div>}

          {item.type==="earnings_intelligence" && fd.key_metrics && <div>
            <h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-2">Key Metrics — {fd.period}</h3>
            <div className="grid grid-cols-2 gap-2">
              {Object.entries(fd.key_metrics).map(([k,v])=>v?<div key={k} className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-3"><p className="text-[10px] text-naio-text-muted uppercase">{k.replace(/_/g," ")}</p><p className="text-sm text-naio-text-primary font-medium mt-0.5">{v}</p></div>:null)}
            </div>
            {fd.demand_signals&&<div className="mt-3"><DetailRow label="Demand Signals" value={fd.demand_signals}/></div>}
            {fd.geographic_color&&<div className="mt-2"><DetailRow label="Geographic Color" value={fd.geographic_color}/></div>}
          </div>}

          {item.type==="power_demand_signal" && <div>
            <h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-2">Power Demand Details</h3>
            <div className="space-y-2">
              <DetailRow label="Utility / Grid" value={fd.utility_or_grid_operator}/>
              <DetailRow label="Signal Type" value={fd.signal_type}/>
              {fd.requested_capacity_mw&&<DetailRow label="Capacity" value={fd.requested_capacity_mw+" MW"}/>}
              <DetailRow label="DC Operator" value={fd.associated_dc_operator||fd.dc_operator}/>
              <DetailRow label="Timeline" value={fd.timeline}/>
            </div>
            {fd.utility_opportunity&&<div className="mt-3 bg-naio-bg-card/80 border border-naio-border rounded-lg p-3 border-l-2 border-l-naio-green">
              <p className="text-[10px] text-naio-green uppercase tracking-wider mb-1">Utility Opportunity</p>
              <p className="text-xs text-naio-text-secondary">{fd.utility_opportunity}</p>
            </div>}
          </div>}

          {item.type==="regulatory_update" && <div>
            <h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-2">Regulatory Details</h3>
            <div className="space-y-2">
              <DetailRow label="Jurisdiction" value={fd.jurisdiction}/>
              <DetailRow label="Body" value={fd.regulatory_body}/>
              <DetailRow label="Action" value={fd.action_type}/>
              <DetailRow label="Status" value={fd.status}/>
              {fd.affected_capacity_mw&&<DetailRow label="Affected Capacity" value={fd.affected_capacity_mw+" MW"}/>}
            </div>
          </div>}

          {fd.implications&&<div><h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-2">Market Implications</h3><p className="text-sm text-naio-text-secondary leading-relaxed">{fd.implications}</p></div>}
          {fd.comparable_context&&<div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4 border-l-2 border-l-naio-blue"><h3 className="text-xs font-semibold text-naio-blue-light uppercase tracking-wider mb-2">Comparable Context</h3><p className="text-sm text-naio-text-secondary leading-relaxed">{fd.comparable_context}</p></div>}
          {fd.credit_commentary&&<div><h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-2">Credit Commentary</h3><p className="text-sm text-naio-text-secondary leading-relaxed">{fd.credit_commentary}</p></div>}

          <div className="flex items-center gap-1.5 flex-wrap pt-2 border-t border-naio-border">
            <Icon name="Tag" size={12} className="text-naio-text-dim"/>
            {item.tags.map(t=><span key={t} className="px-2 py-0.5 rounded-full bg-naio-bg-card text-[10px] text-naio-text-muted border border-naio-border">{t}</span>)}
          </div>
          <a href={item.source_url || "#"} target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-xs text-naio-cyan hover:text-naio-cyan-light transition-colors">
            <Icon name="ExternalLink" size={12}/>
            <span>View source: {item.source_name} →</span>
          </a>
        </div>
      </div>
    </div>
  );
}

function TabAnalytics({items, layer}) {
  const chartRef = useRef(null);
  const chartInstance = useRef(null);

  // Aggregate items by month
  const monthlyData = useMemo(() => {
    const months = {};
    items.forEach(item => {
      const d = new Date(item.date + "T00:00:00");
      const key = d.toLocaleDateString("en-US", {month: "short", year: "2-digit"});
      if (!months[key]) months[key] = {total: 0, high: 0, types: {}};
      months[key].total++;
      if (item.importance === "high") months[key].high++;
      const t = typeLabels[item.type] || item.type;
      months[key].types[t] = (months[key].types[t] || 0) + 1;
    });
    // Sort by date
    const sorted = Object.entries(months).sort((a, b) => {
      const da = new Date("01 " + a[0]); const db = new Date("01 " + b[0]);
      return da - db;
    });
    return sorted;
  }, [items]);

  // Type distribution
  const typeDistribution = useMemo(() => {
    const dist = {};
    items.forEach(i => {
      const t = typeLabels[i.type] || i.type;
      dist[t] = (dist[t] || 0) + 1;
    });
    return Object.entries(dist).sort((a, b) => b[1] - a[1]);
  }, [items]);

  // Region distribution
  const regionDistribution = useMemo(() => {
    const dist = {};
    items.forEach(i => {
      const rg = getRegionGroup(i.region);
      dist[rg] = (dist[rg] || 0) + 1;
    });
    return Object.entries(dist).sort((a, b) => b[1] - a[1]);
  }, [items]);

  // Importance breakdown
  const importanceBreakdown = useMemo(() => {
    const high = items.filter(i => i.importance === "high").length;
    const medium = items.filter(i => i.importance === "medium").length;
    const low = items.filter(i => i.importance === "low").length;
    return {high, medium, low};
  }, [items]);

  // Extract quantitative data from full_data where available
  const quantData = useMemo(() => {
    let totalMW = 0;
    let totalDeals = 0;
    let totalFinancing = 0;
    let companies = new Set();
    items.forEach(i => {
      const fd = i.full_data || {};
      if (fd.capacity_mw) totalMW += Number(fd.capacity_mw) || 0;
      if (i.type === "deal_synopsis" || i.type === "capex_announcement") totalDeals++;
      if (fd.deal_value) {
        const val = String(fd.deal_value).replace(/[^0-9.]/g, "");
        if (val) totalFinancing += parseFloat(val) || 0;
      }
      (i.companies || []).forEach(c => companies.add(c));
    });
    return {totalMW, totalDeals, totalFinancing, companyCount: companies.size};
  }, [items]);

  // Timeline chart
  useEffect(() => {
    if (!chartRef.current || monthlyData.length === 0) return;
    if (chartInstance.current) chartInstance.current.destroy();

    const ctx = chartRef.current.getContext("2d");
    chartInstance.current = new Chart(ctx, {
      type: "bar",
      data: {
        labels: monthlyData.map(d => d[0]),
        datasets: [
          {
            label: "High Priority",
            data: monthlyData.map(d => d[1].high),
            backgroundColor: "rgba(255, 82, 82, 0.7)",
            borderRadius: 3,
          },
          {
            label: "Other",
            data: monthlyData.map(d => d[1].total - d[1].high),
            backgroundColor: "rgba(0, 188, 212, 0.4)",
            borderRadius: 3,
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: "top", labels: { color: "#6B8FA3", font: {size: 10}, boxWidth: 12, padding: 12 }},
          tooltip: { backgroundColor: "#0F2237", borderColor: "#1A3A5C", borderWidth: 1, titleColor: "#fff", bodyColor: "#B0C4D8" }
        },
        scales: {
          x: { stacked: true, grid: {display: false}, ticks: {color: "#6B8FA3", font: {size: 10}} },
          y: { stacked: true, grid: {color: "#1A3A5C"}, ticks: {color: "#6B8FA3", font: {size: 10}, stepSize: 1} }
        }
      }
    });

    return () => { if (chartInstance.current) chartInstance.current.destroy(); };
  }, [monthlyData]);

  const layerColors = {
    infrastructure: "#3B9FE3", chip: "#AB47BC", energy: "#00E676",
    financing: "#FF9800", supply_chain: "#00BFA6"
  };
  const accentColor = layerColors[layer] || "#00BCD4";

  return (
    <div className="mb-6">
      {/* Stats row */}
      <div className="grid grid-cols-4 gap-3 mb-4">
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-3">
          <p className="text-[10px] text-naio-text-dim uppercase tracking-wider">Total Items</p>
          <p className="text-xl font-bold text-naio-text-primary mt-1">{items.length}</p>
        </div>
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-3">
          <p className="text-[10px] text-naio-text-dim uppercase tracking-wider">High Priority</p>
          <p className="text-xl font-bold text-naio-red mt-1">{importanceBreakdown.high}</p>
        </div>
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-3">
          <p className="text-[10px] text-naio-text-dim uppercase tracking-wider">{quantData.totalMW > 0 ? "Tracked MW" : "Companies"}</p>
          <p className="text-xl font-bold mt-1" style={{color: accentColor}}>{quantData.totalMW > 0 ? quantData.totalMW.toLocaleString() + " MW" : quantData.companyCount}</p>
        </div>
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-3">
          <p className="text-[10px] text-naio-text-dim uppercase tracking-wider">Deals / Announcements</p>
          <p className="text-xl font-bold text-naio-text-primary mt-1">{quantData.totalDeals}</p>
        </div>
      </div>

      {/* Charts row */}
      <div className="grid grid-cols-3 gap-4">
        {/* Timeline */}
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4 col-span-1">
          <h3 className="text-[10px] text-naio-text-dim uppercase tracking-wider mb-3">Items Over Time</h3>
          <div className="h-36"><canvas ref={chartRef}/></div>
        </div>

        {/* Type Distribution */}
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4">
          <h3 className="text-[10px] text-naio-text-dim uppercase tracking-wider mb-3">By Type</h3>
          <div className="space-y-1.5">
            {typeDistribution.slice(0, 6).map(([type, count]) => {
              const pct = items.length > 0 ? (count / items.length) * 100 : 0;
              return (
                <div key={type} className="flex items-center gap-2">
                  <span className="text-[10px] text-naio-text-muted w-24 truncate">{type}</span>
                  <div className="flex-1 h-2 bg-naio-bg-surface rounded-full overflow-hidden">
                    <div className="h-full rounded-full" style={{width: pct + "%", backgroundColor: accentColor, opacity: 0.7}}/>
                  </div>
                  <span className="text-[10px] text-naio-text-dim w-6 text-right">{count}</span>
                </div>
              );
            })}
          </div>
        </div>

        {/* Region Distribution */}
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4">
          <h3 className="text-[10px] text-naio-text-dim uppercase tracking-wider mb-3">By Region</h3>
          <div className="space-y-1.5">
            {regionDistribution.slice(0, 6).map(([region, count]) => {
              const pct = items.length > 0 ? (count / items.length) * 100 : 0;
              return (
                <div key={region} className="flex items-center gap-2">
                  <span className="text-[10px] text-naio-text-muted w-24 truncate">{region}</span>
                  <div className="flex-1 h-2 bg-naio-bg-surface rounded-full overflow-hidden">
                    <div className="h-full rounded-full bg-naio-teal" style={{width: pct + "%", opacity: 0.7}}/>
                  </div>
                  <span className="text-[10px] text-naio-text-dim w-6 text-right">{count}</span>
                </div>
              );
            })}
          </div>
        </div>
      </div>
    </div>
  );
}

function HeatmapView({data}) {
  if (data.length === 0) {
    return (
      <div className="p-12 text-center bg-naio-bg-card/80 border border-naio-border rounded-lg">
        <p className="text-naio-text-secondary mb-4">No market heatmap data available yet.</p>
        <p className="text-sm text-naio-text-muted">Use Update Intelligence to populate heatmap data from Supabase.</p>
      </div>
    );
  }

  const max = Math.max(...data.map(d=>d.heat_score));
  return (
    <div className="space-y-3">
      {[...data].sort((a,b)=>b.heat_score-a.heat_score).map(m => {
        const pct = (m.heat_score/max)*100;
        const c = m.heat_score>=80?"from-[#FF5252]/40 to-[#FF9800]/20":m.heat_score>=60?"from-[#FF9800]/30 to-[#FF9800]/10":"from-[#00BCD4]/20 to-[#00BCD4]/5";
        const tc = m.heat_score>=80?"text-naio-red":m.heat_score>=60?"text-naio-orange":"text-naio-cyan";
        return (
          <div key={m.region} className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4">
            <div className="flex items-center justify-between mb-2">
              <div className="flex items-center gap-3"><h3 className="text-sm font-semibold text-naio-text-primary">{m.region}</h3><span className={`text-xs font-bold ${tc}`}>{m.heat_score}</span></div>
              <div className="flex items-center gap-4 text-[11px] text-naio-text-muted"><span>{m.news_count} news</span><span>{m.deal_count} deals</span><span>{m.total_mw.toLocaleString()} MW</span></div>
            </div>
            <div className="h-1.5 rounded-full bg-naio-bg-surface overflow-hidden"><div className={`h-full rounded-full bg-gradient-to-r ${c} transition-all duration-500`} style={{width:pct+"%"}}/></div>
          </div>
        );
      })}
    </div>
  );
}

function CompsTable({data, allData=[], fetchData}) {
  const [sortCol, setSortCol] = useState("date");
  const [sortDir, setSortDir] = useState("desc");
  const [selectedDeal, setSelectedDeal] = useState(null);
  const [showAddForm, setShowAddForm] = useState(false);
  const [saving, setSaving] = useState(false);
  const [formData, setFormData] = useState({
    company: "", event_subtype: "Bond", amount_usd: "", currency: "USD",
    tenor_years: "", coupon_rate: "", spread_bps: "",
    rating_moodys: "", rating_sp: "", date: new Date().toISOString().split("T")[0],
    source_url: "", notes: "",
  });

  const handleSave = async () => {
    if (!formData.company || !formData.amount_usd) return;
    setSaving(true);
    try {
      const { error } = await supabase.from("financing_comps").insert({
        company: formData.company,
        event_subtype: formData.event_subtype,
        amount_usd: parseFloat(formData.amount_usd) * (formData.amount_usd.toString().includes(".") ? 1 : 1e6),
        currency: formData.currency,
        tenor_years: formData.tenor_years ? parseInt(formData.tenor_years) : null,
        coupon_rate: formData.coupon_rate ? parseFloat(formData.coupon_rate) : null,
        spread_bps: formData.spread_bps ? parseInt(formData.spread_bps) : null,
        rating_moodys: formData.rating_moodys || null,
        rating_sp: formData.rating_sp || null,
        date: formData.date,
        use_of_proceeds: formData.notes || null,
      });
      if (error) throw error;
      setFormData({ company: "", event_subtype: "Bond", amount_usd: "", currency: "USD", tenor_years: "", coupon_rate: "", spread_bps: "", rating_moodys: "", rating_sp: "", date: new Date().toISOString().split("T")[0], source_url: "", notes: "" });
      setShowAddForm(false);
      if (fetchData) await fetchData();
    } catch (e) { alert("Error saving comp: " + e.message); }
    finally { setSaving(false); }
  };

  const deleteComp = async (comp) => {
    if (!confirm(`Delete ${comp.issuer} ${comp.type} comp?`)) return;
    try {
      // Find and delete from DB by matching fields
      const { data: matches } = await supabase.from("financing_comps")
        .select("id").eq("company", comp.issuer).eq("date", comp.date).limit(1);
      if (matches && matches.length > 0) {
        await supabase.from("financing_comps").delete().eq("id", matches[0].id);
        if (fetchData) await fetchData();
      }
    } catch (e) { console.error("Delete comp error:", e); }
  };

  const sorted = useMemo(() => {
    let items = [...data];
    items.sort((a, b) => {
      let aVal = a[sortCol];
      let bVal = b[sortCol];
      if(typeof aVal === 'string') {
        aVal = aVal.toLowerCase();
        bVal = bVal.toLowerCase();
      }
      if(sortDir === "asc") return aVal > bVal ? 1 : -1;
      return aVal < bVal ? 1 : -1;
    });
    return items;
  }, [sortCol, sortDir, data]);

  const toggleSort = (col) => {
    if(sortCol === col) {
      setSortDir(sortDir === "asc" ? "desc" : "asc");
    } else {
      setSortCol(col);
      setSortDir("asc");
    }
  };

  const getSpreadColor = (bps) => {
    if(bps < 175) return "text-naio-green";
    if(bps <= 225) return "text-naio-orange-light";
    return "text-naio-orange";
  };

  const getIntelligenceItem = (issuer) => {
    return allData.find(item =>
      item.type === "financing_event" &&
      (item.companies || []).some(c => c.toLowerCase() === issuer.toLowerCase())
    );
  };

  const columns = [
    {key: "issuer", label: "Issuer"},
    {key: "type", label: "Type"},
    {key: "amount", label: "Amount"},
    {key: "tenor", label: "Tenor"},
    {key: "coupon", label: "Coupon"},
    {key: "spread_bps", label: "Spread (bps)"},
    {key: "rating", label: "Rating"},
    {key: "date", label: "Date"},
    {key: "source", label: "Source"},
  ];

  const addFormUI = (
    <div className={`${showAddForm ? "block" : "hidden"} bg-naio-bg-deep border border-naio-border rounded-lg p-5 mb-4`}>
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider">Add Financing Comp</h3>
        <button onClick={() => setShowAddForm(false)} className="text-naio-text-dim hover:text-naio-text-primary"><Icon name="X" size={16}/></button>
      </div>
      <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
        <div>
          <label className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1 block">Issuer *</label>
          <input type="text" value={formData.company} onChange={e => setFormData({...formData, company: e.target.value})} placeholder="e.g. Equinix" className="w-full px-3 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-primary placeholder-naio-text-dim focus:outline-none focus:border-naio-cyan/50"/>
        </div>
        <div>
          <label className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1 block">Type</label>
          <select value={formData.event_subtype} onChange={e => setFormData({...formData, event_subtype: e.target.value})} className="w-full px-3 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-secondary focus:outline-none focus:border-naio-cyan/50">
            <option value="Bond">Bond</option><option value="Term Loan">Term Loan</option><option value="Credit Facility">Credit Facility</option><option value="Green Bond">Green Bond</option><option value="Convertible">Convertible</option><option value="Equity">Equity</option><option value="Private Placement">Private Placement</option>
          </select>
        </div>
        <div>
          <label className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1 block">Amount (M) *</label>
          <div className="flex gap-1">
            <select value={formData.currency} onChange={e => setFormData({...formData, currency: e.target.value})} className="w-16 px-1 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-secondary focus:outline-none focus:border-naio-cyan/50">
              <option value="USD">$</option><option value="EUR">€</option><option value="GBP">£</option>
            </select>
            <input type="number" value={formData.amount_usd} onChange={e => setFormData({...formData, amount_usd: e.target.value})} placeholder="500" className="flex-1 px-3 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-primary placeholder-naio-text-dim focus:outline-none focus:border-naio-cyan/50"/>
          </div>
        </div>
        <div>
          <label className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1 block">Date</label>
          <input type="date" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} className="w-full px-3 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-primary focus:outline-none focus:border-naio-cyan/50"/>
        </div>
        <div>
          <label className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1 block">Tenor (years)</label>
          <input type="number" value={formData.tenor_years} onChange={e => setFormData({...formData, tenor_years: e.target.value})} placeholder="7" className="w-full px-3 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-primary placeholder-naio-text-dim focus:outline-none focus:border-naio-cyan/50"/>
        </div>
        <div>
          <label className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1 block">Coupon (%)</label>
          <input type="number" step="0.01" value={formData.coupon_rate} onChange={e => setFormData({...formData, coupon_rate: e.target.value})} placeholder="5.25" className="w-full px-3 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-primary placeholder-naio-text-dim focus:outline-none focus:border-naio-cyan/50"/>
        </div>
        <div>
          <label className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1 block">Spread (bps)</label>
          <input type="number" value={formData.spread_bps} onChange={e => setFormData({...formData, spread_bps: e.target.value})} placeholder="175" className="w-full px-3 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-primary placeholder-naio-text-dim focus:outline-none focus:border-naio-cyan/50"/>
        </div>
        <div>
          <label className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1 block">Rating (Moody's / S&P)</label>
          <div className="flex gap-1">
            <input type="text" value={formData.rating_moodys} onChange={e => setFormData({...formData, rating_moodys: e.target.value})} placeholder="Baa2" className="flex-1 px-2 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-primary placeholder-naio-text-dim focus:outline-none focus:border-naio-cyan/50"/>
            <input type="text" value={formData.rating_sp} onChange={e => setFormData({...formData, rating_sp: e.target.value})} placeholder="BBB" className="flex-1 px-2 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-primary placeholder-naio-text-dim focus:outline-none focus:border-naio-cyan/50"/>
          </div>
        </div>
      </div>
      <div className="mb-4">
        <label className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1 block">Notes / Use of Proceeds</label>
        <input type="text" value={formData.notes} onChange={e => setFormData({...formData, notes: e.target.value})} placeholder="e.g. Fund DC development in EMEA" className="w-full px-3 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-primary placeholder-naio-text-dim focus:outline-none focus:border-naio-cyan/50"/>
      </div>
      <div className="flex justify-end gap-3">
        <button onClick={() => setShowAddForm(false)} className="px-4 py-2 text-sm text-naio-text-muted hover:text-naio-text-primary transition-colors">Cancel</button>
        <button onClick={handleSave} disabled={saving || !formData.company || !formData.amount_usd} className="px-5 py-2 bg-naio-cyan/10 border border-naio-cyan/30 rounded-md text-sm text-naio-cyan hover:bg-naio-cyan/20 transition-colors disabled:opacity-50">
          {saving ? "Saving..." : "Add Comp"}
        </button>
      </div>
    </div>
  );

  if (data.length === 0) {
    return (
      <div>
        <div className="flex justify-end mb-3">
          <button onClick={() => setShowAddForm(true)} className="px-4 py-2 bg-naio-cyan/10 border border-naio-cyan/30 rounded-md text-xs text-naio-cyan hover:bg-naio-cyan/20 transition-colors flex items-center gap-1.5">
            <Icon name="Plus" size={14}/> Add Comp
          </button>
        </div>
        {addFormUI}
        <div className="p-12 text-center bg-naio-bg-card/80 border border-naio-border rounded-lg">
          <p className="text-naio-text-secondary mb-4">No financing comparables yet.</p>
          <p className="text-sm text-naio-text-muted">Add comps manually or use News Search to pull financing events from real articles.</p>
        </div>
      </div>
    );
  }

  return (
    <>
      <div className="flex justify-end mb-3">
        <button onClick={() => setShowAddForm(true)} className="px-4 py-2 bg-naio-cyan/10 border border-naio-cyan/30 rounded-md text-xs text-naio-cyan hover:bg-naio-cyan/20 transition-colors flex items-center gap-1.5">
          <Icon name="Plus" size={14}/> Add Comp
        </button>
      </div>
      {addFormUI}
      <div className="overflow-x-auto">
        <table className="w-full text-sm">
          <thead>
            <tr className="bg-[#122640] border-b border-naio-border">
              {columns.map(col => (
                <th key={col.key} className="px-4 py-3 text-left text-naio-cyan font-semibold text-xs uppercase tracking-wider cursor-pointer hover:bg-naio-bg-card/50 transition-colors"
                  onClick={() => toggleSort(col.key)}>
                  <div className="flex items-center gap-2">
                    {col.label}
                    {sortCol === col.key && (
                      <span className="text-[10px]">{sortDir === "asc" ? "↑" : "↓"}</span>
                    )}
                  </div>
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {sorted.map((row, idx) => (
              <tr key={idx} className={`border-b border-naio-border ${idx % 2 === 0 ? "bg-[#0F2237]" : "bg-[#0D1F33]"} hover:bg-naio-bg-card-hover transition-colors cursor-pointer group`}
                onClick={() => setSelectedDeal(row)}>
                <td className="px-4 py-3 text-naio-text-primary font-medium">{row.issuer}</td>
                <td className="px-4 py-3 text-naio-text-secondary text-xs">{row.type}</td>
                <td className="px-4 py-3 text-naio-text-secondary">{row.amount}</td>
                <td className="px-4 py-3 text-naio-text-muted text-xs">{row.tenor}</td>
                <td className="px-4 py-3 text-naio-text-secondary font-mono">{row.coupon}</td>
                <td className={`px-4 py-3 font-bold ${getSpreadColor(row.spread_bps)}`}>{row.spread_bps}</td>
                <td className="px-4 py-3 text-naio-text-muted text-xs">{row.rating}</td>
                <td className="px-4 py-3 text-naio-text-dim text-xs">{fmtDate(row.date)}</td>
                <td className="px-4 py-3 text-xs">
                  {row.source_url ? (
                    <a href={row.source_url} target="_blank" rel="noopener noreferrer" onClick={(e) => e.stopPropagation()} className="text-naio-cyan hover:text-naio-cyan-light flex items-center gap-1">
                      <Icon name="ExternalLink" size={12}/>
                      {row.source_name || "View"}
                    </a>
                  ) : <span className="text-naio-text-dim">Manual</span>}
                </td>
                <td className="px-2 py-3 text-xs">
                  <button onClick={(e) => { e.stopPropagation(); deleteComp(row); }} className="text-naio-text-dim hover:text-naio-red transition-colors p-1 opacity-0 group-hover:opacity-100" title="Delete">
                    <Icon name="Trash2" size={12}/>
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* Deal card modal */}
      {selectedDeal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center animate-fade-in">
          <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setSelectedDeal(null)}/>
          <div className="relative max-w-2xl w-11/12 bg-naio-bg-deep border border-naio-border rounded-lg overflow-hidden animate-slide-in max-h-[80vh] overflow-y-auto">
            <div className="h-[2px] bg-gradient-to-r from-naio-cyan via-naio-teal to-transparent"/>
            <div className="sticky top-0 bg-naio-bg-deep/95 backdrop-blur-sm z-10 px-6 py-4 border-b border-naio-border flex items-start justify-between">
              <div className="flex-1">
                <h2 className="text-lg font-semibold text-naio-text-primary">{selectedDeal.issuer}</h2>
                <p className="text-xs text-naio-text-muted mt-1">{selectedDeal.type} | {selectedDeal.amount}</p>
              </div>
              <button onClick={() => setSelectedDeal(null)} className="p-1.5 rounded hover:bg-naio-bg-card text-naio-text-muted flex-shrink-0"><Icon name="X" size={18}/></button>
            </div>
            <div className="px-6 py-5 space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Amount</p>
                  <p className="text-sm font-bold text-naio-cyan">{selectedDeal.amount}</p>
                </div>
                <div>
                  <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Type</p>
                  <p className="text-sm text-naio-text-secondary">{selectedDeal.type}</p>
                </div>
                <div>
                  <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Tenor</p>
                  <p className="text-sm text-naio-text-secondary">{selectedDeal.tenor}</p>
                </div>
                <div>
                  <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Coupon</p>
                  <p className="text-sm text-naio-text-secondary font-mono">{selectedDeal.coupon}</p>
                </div>
                <div>
                  <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Spread</p>
                  <p className={`text-sm font-bold ${getSpreadColor(selectedDeal.spread_bps)}`}>{selectedDeal.spread_bps} bps</p>
                </div>
                <div>
                  <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Rating</p>
                  <p className="text-sm text-naio-text-secondary">{selectedDeal.rating}</p>
                </div>
              </div>
              <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-3">
                <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-2">Date</p>
                <p className="text-sm text-naio-text-secondary">{fmtDate(selectedDeal.date)}</p>
              </div>
              <div>
                <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-2">Source</p>
                <a href={selectedDeal.source_url || "#"} target="_blank" rel="noopener noreferrer" className="text-sm text-naio-cyan hover:text-naio-cyan-light flex items-center gap-1">
                  <Icon name="ExternalLink" size={14}/>
                  {selectedDeal.source_name || "View source"}
                </a>
              </div>
            </div>
          </div>
        </div>
      )}
    </>
  );
}

const eventTypeConfig = {conference:{icon:"Globe",color:"text-naio-cyan"},earnings:{icon:"BarChart3",color:"text-naio-orange"},regulatory_deadline:{icon:"Scale",color:"text-naio-red"},bond_maturity:{icon:"Landmark",color:"text-naio-purple"},ipo:{icon:"Landmark",color:"text-naio-green"},other:{icon:"Calendar",color:"text-naio-text-muted"}};

function CalendarView({events}) {
  if (events.length === 0) {
    return (
      <div className="p-12 text-center bg-naio-bg-card/80 border border-naio-border rounded-lg">
        <p className="text-naio-text-secondary mb-4">No calendar events available yet.</p>
        <p className="text-sm text-naio-text-muted">Use Update Intelligence to populate events from Supabase.</p>
      </div>
    );
  }

  const sorted = [...events].sort((a,b)=>new Date(a.start_date)-new Date(b.start_date));
  const grouped = {};
  sorted.forEach(e=>{const m=new Date(e.start_date+"T00:00:00").toLocaleDateString("en-US",{month:"long",year:"numeric"});if(!grouped[m])grouped[m]=[];grouped[m].push(e);});
  return (
    <div className="space-y-8">
      {Object.entries(grouped).map(([month,evts])=>(
        <div key={month}>
          <h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-3">{month}</h2>
          <div className="space-y-2">{evts.map(ev=>{
            const cfg=eventTypeConfig[ev.event_type]||eventTypeConfig.other;
            const Wrapper = ev.url ? 'a' : 'div';
            const wrapperProps = ev.url ? {href:ev.url, target:"_blank", rel:"noopener noreferrer"} : {};
            return (
              <Wrapper key={ev.id} {...wrapperProps} className={`block bg-naio-bg-card/80 border border-naio-border rounded-lg p-4 flex items-start gap-4 hover:bg-naio-bg-card-hover hover:border-naio-border-light transition-all duration-200 ${ev.url?'cursor-pointer group':''}`}>
                <div className="w-14 text-center flex-shrink-0"><p className="text-2xl font-bold text-naio-text-primary">{new Date(ev.start_date+"T00:00:00").getDate()}</p><p className="text-[10px] text-naio-text-muted uppercase">{new Date(ev.start_date+"T00:00:00").toLocaleDateString("en-US",{weekday:"short"})}</p></div>
                <div className="flex-1">
                  <div className="flex items-center gap-2 mb-1"><span className={cfg.color}><Icon name={cfg.icon} size={14}/></span><span className="text-[10px] uppercase tracking-wider text-naio-text-dim">{ev.event_type.replace(/_/g," ")}</span>{ev.company&&<span className="text-[10px] text-naio-text-dim">• {ev.company}</span>}</div>
                  <h3 className="text-sm font-semibold text-naio-text-primary group-hover:text-naio-cyan transition-colors">{ev.title}{ev.url&&<span className="inline-block ml-1.5 opacity-50 group-hover:opacity-100"><Icon name="ExternalLink" size={12}/></span>}</h3>
                  <p className="text-xs text-naio-text-muted mt-0.5">{ev.description}</p>
                  <div className="flex items-center gap-3 mt-1.5">
                    {ev.location&&<span className="text-[10px] text-naio-text-dim flex items-center gap-1"><Icon name="MapPin" size={10}/>{ev.location}</span>}
                    {ev.end_date&&ev.end_date!==ev.start_date&&<span className="text-[10px] text-naio-text-dim">{fmtDate(ev.start_date)} – {fmtDate(ev.end_date)}</span>}
                  </div>
                </div>
              </Wrapper>
            );
          })}</div>
        </div>
      ))}
    </div>
  );
}

// ─── COMPANY RESEARCH COMPONENT ────────────────────────
// ── Market Research Dashboard Widget (summary with "View All" link) ──
function ResearchSummaryWidget({onViewAll}) {
  const [recentPoints, setRecentPoints] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchRecent = async () => {
      const { data } = await supabase
        .from('market_research')
        .select('metric_name, value, confidence, region, company, updated_at, change_direction, category')
        .order('updated_at', { ascending: false })
        .limit(6);
      if (data) setRecentPoints(data);
      setLoading(false);
    };
    fetchRecent();
  }, []);

  if (loading) return <div className="animate-pulse bg-naio-bg-card/80 border border-naio-border rounded-lg h-32"/>;
  if (recentPoints.length === 0) return null; // Don't show if no data yet

  const confColors = { high: '#00E676', medium: '#FF9800', low: '#FF5252' };

  return (
    <div>
      <div className="flex items-center justify-between mb-3">
        <h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider">Latest Market Research</h2>
        <button onClick={onViewAll} className="text-xs text-naio-cyan hover:text-naio-cyan-light transition-colors flex items-center gap-1">
          View all <Icon name="ChevronRight" size={12}/>
        </button>
      </div>
      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
        {recentPoints.map((d,i) => (
          <div key={i} className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-3 text-center hover:border-naio-cyan/30 transition-colors cursor-pointer" onClick={onViewAll}>
            <div className="text-[10px] text-naio-text-dim uppercase tracking-wider mb-1 truncate">{d.metric_name}</div>
            <div className="text-base font-bold text-naio-cyan flex items-center justify-center gap-1">
              {d.value}
              {d.change_direction === 'up' && <span className="text-green-400 text-xs">▲</span>}
              {d.change_direction === 'down' && <span className="text-red-400 text-xs">▼</span>}
            </div>
            <div className="flex items-center justify-center gap-1 mt-1">
              <ConfBadge level={d.confidence}/>
              {d.region && <span className="text-[8px] text-naio-text-dim">{d.region}</span>}
            </div>
          </div>
        ))}
      </div>
      <p className="text-[9px] text-naio-text-dim mt-2 text-right">Auto-scanned from news sources · Updated {recentPoints[0]?.updated_at ? new Date(recentPoints[0].updated_at).toLocaleDateString() : '—'}</p>
    </div>
  );
}

// ── Supply Chain Bottleneck Widget ──
function SupplyChainWidget() {
  const items = [
    { component: 'Switchgear (HV)', lead: '~151 wk', weeks: 151, trend: 'up', severity: 'critical', src: 'Uptime Institute' },
    { component: 'Power Transformers', lead: '80-128 wk', weeks: 128, trend: 'up', severity: 'critical', src: 'Wood Mackenzie', url: 'https://www.powermag.com/transformers-in-2026-shortage-scramble-or-self-inflicted-crisis/' },
    { component: 'HV Cables', lead: '24+ mo', weeks: 104, trend: 'stable', severity: 'high', src: 'Prysmian / Nexans' },
    { component: 'Gas Turbines', lead: '60-80 wk', weeks: 70, trend: 'stable', severity: 'high', src: 'Caterpillar / Cummins' },
    { component: 'Diesel Gensets', lead: '40-60 wk', weeks: 50, trend: 'down', severity: 'medium', src: 'Caterpillar / Cummins' },
    { component: 'Cooling (Chillers)', lead: '40-50 wk', weeks: 45, trend: 'down', severity: 'medium', src: 'Vertiv / Schneider' },
    { component: 'UPS Systems', lead: '26-40 wk', weeks: 33, trend: 'down', severity: 'low', src: 'Vertiv / Eaton' },
    { component: 'Liquid Cooling (DLC)', lead: '20-30 wk', weeks: 25, trend: 'stable', severity: 'low', src: "Dell'Oro Group" },
    { component: 'GPUs (H100/H200)', lead: '4-8 wk', weeks: 6, trend: 'down', severity: 'low', src: 'NVIDIA / Channel' },
  ];
  const sevColors = { critical: '#FF5252', high: '#FF9800', medium: '#FFB74D', low: '#00E676' };
  const maxWk = 160;
  return (
    <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-5">
      <div className="flex items-center gap-2 mb-4">
        <Icon name="AlertTriangle" size={16} className="text-naio-orange"/>
        <h3 className="text-sm font-semibold text-naio-text-primary">Supply Chain Lead Times</h3>
        <span className="text-[10px] text-naio-text-dim ml-auto">Source: Uptime Institute, Wood Mackenzie, OEMs (2025)</span>
      </div>
      <div className="space-y-2">
        {items.map((it,i) => (
          <div key={i} className="flex items-center gap-3 group" title={it.src ? 'Source: ' + it.src : ''}>
            <div className="w-36 text-xs text-naio-text-secondary truncate">{it.url ? <a href={it.url} target="_blank" rel="noopener" className="hover:text-naio-cyan transition-colors">{it.component}</a> : it.component}</div>
            <div className="flex-1 bg-naio-bg/50 rounded-full h-5 relative overflow-hidden">
              <div className="h-full rounded-full flex items-center px-2 transition-all" style={{width: Math.max(8, (it.weeks/maxWk)*100)+'%', backgroundColor: sevColors[it.severity]+'40', borderRight: '2px solid '+sevColors[it.severity]}}>
                <span className="text-[10px] font-semibold whitespace-nowrap" style={{color:sevColors[it.severity]}}>{it.lead}</span>
              </div>
            </div>
            <span className="text-xs w-6 text-center">{it.trend==='up'?'▲':it.trend==='down'?'▼':'→'}</span>
            <span className="text-[9px] text-naio-text-dim w-24 hidden group-hover:block truncate">{it.src}</span>
          </div>
        ))}
      </div>
      <div className="flex gap-4 mt-3 text-[10px] text-naio-text-dim">
        <span><span className="inline-block w-2 h-2 rounded-full mr-1" style={{backgroundColor:'#FF5252'}}/>Critical (>100wk)</span>
        <span><span className="inline-block w-2 h-2 rounded-full mr-1" style={{backgroundColor:'#FF9800'}}/>High (60-100wk)</span>
        <span><span className="inline-block w-2 h-2 rounded-full mr-1" style={{backgroundColor:'#FFB74D'}}/>Medium (30-60wk)</span>
        <span><span className="inline-block w-2 h-2 rounded-full mr-1" style={{backgroundColor:'#00E676'}}/>Improving ({'<'}30wk)</span>
      </div>
    </div>
  );
}

// ── Regulatory Tracker Widget ──
function RegulatoryTracker() {
  const regs = [
    { reg: 'EU EED — PUE/WUE Reporting', status: 'Active', date: 'Jan 2025', region: 'EU-wide', impact: 'high', detail: 'DCs >500kW must report PUE, WUE, renewable share annually', color: '#FF5252', url: 'https://energy.ec.europa.eu/topics/energy-efficiency/energy-efficiency-targets-directive-and-rules/energy-efficiency-directive_en' },
    { reg: 'EU EED — Waste Heat Assessment', status: 'Active', date: 'Oct 2025', region: 'EU-wide', impact: 'high', detail: 'All new DCs >1MW must assess and report waste heat recovery', color: '#FF5252', url: 'https://energy.ec.europa.eu/topics/energy-efficiency/energy-efficiency-targets-directive-and-rules/energy-efficiency-directive_en' },
    { reg: 'Germany EnEfG — PUE ≤ 1.2 (new)', status: 'Upcoming', date: 'Jul 2026', region: 'Germany', impact: 'high', detail: 'New DCs. Existing: ≤1.3 by Jul 2027, ≤1.2 by Jul 2030', color: '#FF9800' },
    { reg: 'Germany — 100% Renewable (DCs)', status: 'Active', date: '2027', region: 'Germany', impact: 'high', detail: 'New DCs 100% renewable. Existing: 50% by 2024, 100% by 2027.', color: '#FF5252' },
    { reg: 'Finland — DC Electricity Tax Hike', status: 'Upcoming', date: 'Jul 2026', region: 'Finland', impact: 'medium', detail: '0.05→2.24 c/kWh. New support model autumn 2026.', color: '#FF9800' },
    { reg: 'Ireland — Moratorium Lifted', status: 'Active', date: 'Dec 2025', region: 'Ireland', impact: 'medium', detail: 'Partially lifted with conditions: must bring own generation/PPAs', color: '#00E676' },
    { reg: 'Netherlands — Hyperscale Ban', status: 'Active', date: '2024-2026', region: 'Netherlands', impact: 'high', detail: 'DCs >70MW banned. Amsterdam ban extended through 2030.', color: '#FF5252' },
    { reg: 'EU AI Act — Compute Transparency', status: 'Upcoming', date: '2026', region: 'EU-wide', impact: 'medium', detail: 'Large AI providers must disclose compute/energy used in training', color: '#FF9800' },
    { reg: 'Spain — Strategic Sector Fast-Track', status: 'Active', date: '2025', region: 'Spain', impact: 'low', detail: 'PERTE chip/DC ecosystem. Tax incentives for green DCs.', color: '#00E676' },
  ];
  const statusColors = { 'Active': '#00E676', 'Upcoming': '#FF9800', 'Proposed': '#4FC3F7' };
  return (
    <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-5">
      <div className="flex items-center gap-2 mb-4">
        <Icon name="Shield" size={16} className="text-naio-purple"/>
        <h3 className="text-sm font-semibold text-naio-text-primary">Regulatory Tracker</h3>
        <span className="text-[10px] text-naio-text-dim ml-auto">EU & National DC Regulations</span>
      </div>
      <div className="overflow-x-auto">
        <table className="w-full text-sm">
          <thead>
            <tr className="border-b border-naio-border">
              <th className="text-left py-2 px-2 text-naio-text-dim font-medium text-xs">Regulation</th>
              <th className="text-left py-2 px-2 text-naio-text-dim font-medium text-xs w-20">Status</th>
              <th className="text-left py-2 px-2 text-naio-text-dim font-medium text-xs w-24">Effective</th>
              <th className="text-left py-2 px-2 text-naio-text-dim font-medium text-xs hidden md:table-cell">Region</th>
              <th className="text-left py-2 px-2 text-naio-text-dim font-medium text-xs hidden lg:table-cell">Detail</th>
            </tr>
          </thead>
          <tbody>
            {regs.map((r,i) => (
              <tr key={i} className="border-b border-naio-border/30 hover:bg-naio-bg-surface/30" title={r.detail}>
                <td className="py-2 px-2 text-xs font-medium">{r.url ? <a href={r.url} target="_blank" rel="noopener" className="text-naio-text-primary hover:text-naio-cyan transition-colors flex items-center gap-1">{r.reg} <Icon name="ExternalLink" size={9} className="text-naio-text-dim"/></a> : <span className="text-naio-text-primary">{r.reg}</span>}</td>
                <td className="py-2 px-2"><span className="text-[10px] px-2 py-0.5 rounded-full font-medium" style={{backgroundColor:statusColors[r.status]+'20', color:statusColors[r.status], border:'1px solid '+statusColors[r.status]+'40'}}>{r.status}</span></td>
                <td className="py-2 px-2 text-xs text-naio-text-secondary">{r.date}</td>
                <td className="py-2 px-2 text-xs text-naio-text-secondary hidden md:table-cell">{r.region}</td>
                <td className="py-2 px-2 text-[10px] text-naio-text-muted hidden lg:table-cell max-w-[250px] truncate">{r.detail}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

// ── Nuclear / SMR / Fusion Dashboard Widget ──
function NuclearSMRWidget() {
  const smrProjects = [
    { name: 'Rolls-Royce SMR (Wylfa, UK)', capacity: '1,410 MW', timeline: '2031', status: 'Progressing', type: 'SMR', conf: 'high', url: 'https://www.rolls-royce-smr.com/' },
    { name: 'Rolls-Royce ČEZ (Czech Rep.)', capacity: '3,000 MW', timeline: '2030s', status: 'MoU Signed', type: 'SMR', conf: 'medium', url: 'https://www.rolls-royce-smr.com/' },
    { name: 'BWRX-300 (Darlington, Canada)', capacity: '300 MW', timeline: '2029', status: 'Construction', type: 'SMR', conf: 'high', url: 'https://www.opg.com/powering-ontario/our-generation/small-modular-reactors/' },
    { name: 'Vattenfall (Ringhals, Sweden)', capacity: '1,500 MW', timeline: 'mid-2030s', status: 'Evaluating', type: 'SMR', conf: 'medium', url: 'https://group.vattenfall.com/press-and-media/newsroom/2024/vattenfall-takes-a-new-step-towards-new-nuclear-at-ringhals' },
    { name: 'Equinix/ULC-Energy (Netherlands)', capacity: '250 MW', timeline: '2030', status: 'MoU', type: 'Micro', conf: 'medium' },
    { name: 'EU SMR Alliance', capacity: '101 units by 2050', timeline: '2024-2050', status: 'Launched', type: 'Policy', conf: 'high', url: 'https://energy.ec.europa.eu/topics/nuclear-energy/small-modular-reactors_en' },
  ];
  const fusionProjects = [
    { name: 'CFS — SPARC Tokamak', milestone: 'First HTS magnet Dec 2025', funding: '$2B+', timeline: '~2035', conf: 'medium', url: 'https://cfs.energy/' },
    { name: 'Google + CFS PPA', milestone: '200 MW fusion PPA', funding: 'N/A', timeline: '~2035', conf: 'medium', url: 'https://cfs.energy/' },
    { name: 'Helion + Microsoft PPA', milestone: '50 MW target', funding: '$577M', timeline: '2028 (ambitious)', conf: 'low', url: 'https://www.helionenergy.com/' },
    { name: 'TAE Technologies', milestone: 'Copernicus reactor planned', funding: '$6B (TMTG)', timeline: 'TBD', conf: 'low', url: 'https://tae.com/' },
  ];
  const statusCol = { 'Progressing':'#00E676', 'Construction':'#00E676', 'MoU Signed':'#FF9800', 'MoU':'#FF9800', 'Evaluating':'#4FC3F7', 'Launched':'#00BCD4' };
  return (
    <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-5">
      <div className="flex items-center gap-2 mb-4">
        <Icon name="Atom" size={16} className="text-naio-green"/>
        <h3 className="text-sm font-semibold text-naio-text-primary">Nuclear / SMR / Fusion Pipeline</h3>
      </div>
      <div className="mb-4">
        <h4 className="text-xs text-naio-cyan font-semibold uppercase tracking-wider mb-2">SMR Projects</h4>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
          {smrProjects.map((p,i) => (
            <div key={i} className="bg-naio-bg/50 border border-naio-border/50 rounded-lg p-3 hover:border-naio-cyan/30 transition-colors">
              <div className="flex items-start justify-between mb-1">
                {p.url ? <a href={p.url} target="_blank" rel="noopener" className="text-xs font-semibold text-naio-text-primary hover:text-naio-cyan transition-colors flex items-center gap-1">{p.name} <Icon name="ExternalLink" size={9} className="text-naio-text-dim"/></a> : <span className="text-xs font-semibold text-naio-text-primary">{p.name}</span>}
                <ConfBadge level={p.conf}/>
              </div>
              <div className="text-sm font-bold text-naio-cyan">{p.capacity}</div>
              <div className="flex items-center gap-2 mt-1">
                <span className="text-[10px] px-1.5 py-0.5 rounded-full" style={{backgroundColor:(statusCol[p.status]||'#888')+'20', color:statusCol[p.status]||'#888', border:'1px solid '+(statusCol[p.status]||'#888')+'40'}}>{p.status}</span>
                <span className="text-[10px] text-naio-text-dim">{p.timeline}</span>
              </div>
            </div>
          ))}
        </div>
      </div>
      <div>
        <h4 className="text-xs text-naio-purple font-semibold uppercase tracking-wider mb-2">Fusion Ventures <span className="text-naio-text-dim font-normal">($15B+ total industry funding)</span></h4>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
          {fusionProjects.map((p,i) => (
            <div key={i} className="bg-naio-bg/50 border border-naio-border/50 rounded-lg p-3 flex items-start gap-3 hover:border-naio-purple/30 transition-colors">
              <div className="flex-1">
                {p.url ? <a href={p.url} target="_blank" rel="noopener" className="text-xs font-semibold text-naio-text-primary hover:text-naio-purple transition-colors flex items-center gap-1">{p.name} <Icon name="ExternalLink" size={9} className="text-naio-text-dim"/></a> : <span className="text-xs font-semibold text-naio-text-primary">{p.name}</span>}
                <div className="text-[11px] text-naio-text-secondary mt-0.5">{p.milestone}</div>
                <div className="flex items-center gap-2 mt-1">
                  <span className="text-[10px] text-naio-text-dim">Funding: {p.funding}</span>
                  <span className="text-[10px] text-naio-text-dim">Target: {p.timeline}</span>
                </div>
              </div>
              <ConfBadge level={p.conf}/>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

// ── Demand vs Supply Gap Widget ──
function DemandSupplyGapWidget() {
  const gapData = [
    { metric: 'EU DC Capacity Needed by 2030', current: '~10 GW', target: '35 GW', gap: '~25 GW shortfall', pctAchievable: 65, source: 'McKinsey' },
    { metric: 'Investment Committed vs Needed', current: '~$150B', target: '$250-300B', gap: '$100-150B gap', pctAchievable: 55, source: 'McKinsey / IEA' },
    { metric: 'Growth Achievable vs Planned', current: '70%', target: '200%', gap: '130% gap', pctAchievable: 35, source: 'IEA' },
    { metric: 'Grid Investment Covered', current: '~40%', target: '€600B+', gap: '€360B+ unfunded', pctAchievable: 40, source: 'ENTSOE' },
    { metric: 'Skilled Workers Available', current: '~270K', target: '300K+', gap: '~30K short by 2027', pctAchievable: 90, source: 'Uptime Institute' },
  ];
  const flapd = [
    { market: 'Frankfurt', vacancy: '1.4%', preLease: '90%' },
    { market: 'London', vacancy: '2.1%', preLease: '85%' },
    { market: 'Dublin', vacancy: '1.8%', preLease: '88%' },
    { market: 'Amsterdam', vacancy: '2.8%', preLease: '82%' },
    { market: 'Paris', vacancy: '3.2%', preLease: '78%' },
  ];
  return (
    <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-5">
      <div className="flex items-center gap-2 mb-4">
        <Icon name="TrendingUp" size={16} className="text-naio-red"/>
        <h3 className="text-sm font-semibold text-naio-text-primary">Europe: Demand vs Supply Gap Analysis</h3>
        <span className="text-[10px] text-naio-text-dim ml-auto">Sources: McKinsey, IEA, CBRE (2025)</span>
      </div>
      <div className="space-y-3 mb-5">
        {gapData.map((d,i) => {
          const barColor = d.pctAchievable > 80 ? '#00E676' : d.pctAchievable > 50 ? '#FF9800' : '#FF5252';
          return (
            <div key={i}>
              <div className="flex items-center justify-between mb-1">
                <span className="text-xs text-naio-text-secondary">{d.metric}</span>
                <span className="text-[10px] text-naio-text-dim">{d.source}</span>
              </div>
              <div className="flex items-center gap-3">
                <div className="flex-1 bg-naio-bg/50 rounded-full h-4 relative overflow-hidden">
                  <div className="h-full rounded-full transition-all" style={{width: d.pctAchievable+'%', backgroundColor: barColor+'40', borderRight: '2px solid '+barColor}}/>
                  <div className="absolute inset-0 flex items-center justify-between px-2">
                    <span className="text-[9px] font-semibold text-naio-text-primary">{d.current}</span>
                    <span className="text-[9px] font-semibold" style={{color:barColor}}>{d.target}</span>
                  </div>
                </div>
                <span className="text-[10px] font-semibold w-28 text-right" style={{color:barColor}}>{d.gap}</span>
              </div>
            </div>
          );
        })}
      </div>
      <div>
        <h4 className="text-xs text-naio-cyan font-semibold uppercase tracking-wider mb-2">FLAP-D Vacancy Rates (Record Lows)</h4>
        <div className="grid grid-cols-5 gap-2">
          {flapd.map((m,i) => (
            <div key={i} className="bg-naio-bg/50 border border-naio-border/50 rounded-lg p-2 text-center">
              <div className="text-[10px] text-naio-text-dim uppercase">{m.market}</div>
              <div className="text-sm font-bold text-naio-red">{m.vacancy}</div>
              <div className="text-[9px] text-naio-text-muted">{m.preLease} pre-leased</div>
            </div>
          ))}
        </div>
        <div className="mt-2 p-2 bg-red-900/10 border border-red-700/20 rounded-lg">
          <p className="text-[10px] text-red-400/80"><span className="font-semibold">Key insight:</span> Europe's share of global DC capacity has dropped from 25% (2015) to 15% (2024). With vacancy at record lows and 80%+ pre-leasing, the supply-demand imbalance will intensify — creating pricing power for operators and premium opportunities for utilities offering fast grid connection.</p>
        </div>
      </div>
    </div>
  );
}

// ── Utility Competitor Landscape Widget ──
function UtilityCompetitorWidget() {
  const utilities = [
    { name: 'Fortum', hq: 'Finland', strategy: 'Waste heat leadership + nuclear baseload', strengths: ['Largest DC heat recovery globally', '~4.5 GW nuclear fleet', 'Microsoft partnership'], dcRevenue: 'Growing', moat: 'Waste heat + DH network', color: '#00BCD4' },
    { name: 'Vattenfall', hq: 'Sweden', strategy: 'SMR + dedicated DC power corridors', strengths: ['Ringhals SMR site (1.5 GW planned)', 'Bundled grid+generation', 'Owned nuclear fleet'], dcRevenue: 'Scaling', moat: 'Nuclear + grid access', color: '#4FC3F7' },
    { name: 'Statkraft', hq: 'Norway', strategy: '24/7 hourly-matched clean PPAs', strengths: ['Market leader in 24/7 CFE', 'Hydro + wind portfolio', '€2B DC target by 2030'], dcRevenue: '€2B target', moat: 'Hydro flexibility', color: '#00E676' },
    { name: 'Ørsted', hq: 'Denmark', strategy: 'Onshore wind/solar PPAs for DCs', strengths: ['Google partnership', 'Shifting to onshore+solar', '24/7 CFE focus'], dcRevenue: 'Growing', moat: 'RE development pipeline', color: '#AB47BC' },
    { name: 'EDF', hq: 'France', strategy: 'Nuclear-backed DC PPAs', strengths: ['56 reactor fleet', 'Carbon-free baseload', 'Competing with RE on price'], dcRevenue: 'Entering', moat: '56 nuclear reactors', color: '#FF9800' },
    { name: 'Enel', hq: 'Italy', strategy: 'Behind-the-meter solar + storage', strengths: ['Co-located solar for DCs', 'Spain + Italy focus', 'Storage integration'], dcRevenue: 'Entering', moat: 'Solar+storage', color: '#FFB74D' },
  ];
  return (
    <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-5">
      <div className="flex items-center gap-2 mb-4">
        <Icon name="Users" size={16} className="text-naio-blue"/>
        <h3 className="text-sm font-semibold text-naio-text-primary">Utility Competitor Landscape</h3>
        <span className="text-[10px] text-naio-text-dim ml-auto">European utilities serving DC sector</span>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
        {utilities.map((u,i) => (
          <div key={i} className="bg-naio-bg/50 border border-naio-border/50 rounded-lg p-3" style={{borderLeftColor: u.color, borderLeftWidth: '3px'}}>
            <div className="flex items-center justify-between mb-1">
              <span className="text-xs font-bold text-naio-text-primary">{u.name}</span>
              <span className="text-[9px] text-naio-text-dim">{u.hq}</span>
            </div>
            <div className="text-[11px] text-naio-text-secondary mb-2">{u.strategy}</div>
            <div className="space-y-0.5">
              {u.strengths.map((s,j) => (
                <div key={j} className="text-[10px] text-naio-text-muted flex items-start gap-1">
                  <span className="mt-0.5" style={{color:u.color}}>•</span> {s}
                </div>
              ))}
            </div>
            <div className="flex items-center justify-between mt-2 pt-2 border-t border-naio-border/30">
              <span className="text-[9px] text-naio-text-dim">Moat: {u.moat}</span>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// ── Forward Price Comparison Widget ──
function ForwardPriceWidget() {
  const prices = [
    { region: 'Nordic System', p2026: 41, p2027: 39, advantage: '53% cheaper than DE', color: '#00E676' },
    { region: 'Finland (FI)', p2026: 42, p2027: 40, advantage: 'Stable baseload (nuclear)', color: '#00BCD4' },
    { region: 'Sweden (SE1-2)', p2026: 38, p2027: 36, advantage: 'Cheapest in EU', color: '#4FC3F7' },
    { region: 'Germany', p2026: 88, p2027: 85, advantage: 'Reference (highest)', color: '#FF5252' },
    { region: 'France', p2026: 72, p2027: 68, advantage: 'Nuclear baseload', color: '#FF9800' },
    { region: 'UK', p2026: 78, p2027: 75, advantage: 'Post-gas transition', color: '#FFB74D' },
  ];
  const maxPrice = 100;
  return (
    <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-5">
      <div className="flex items-center gap-2 mb-4">
        <Icon name="Zap" size={16} className="text-naio-green"/>
        <h3 className="text-sm font-semibold text-naio-text-primary">Electricity Forward Prices (€/MWh)</h3>
        <span className="text-[10px] text-naio-text-dim ml-auto">Nordic forward market, indicative (2025)</span>
      </div>
      <div className="space-y-2">
        {prices.map((p,i) => (
          <div key={i} className="flex items-center gap-3">
            <div className="w-28 text-xs text-naio-text-secondary">{p.region}</div>
            <div className="flex-1 flex gap-1">
              <div className="flex-1 bg-naio-bg/50 rounded h-5 relative overflow-hidden">
                <div className="h-full rounded transition-all flex items-center px-2" style={{width:(p.p2026/maxPrice)*100+'%', backgroundColor:p.color+'30', borderRight:'2px solid '+p.color}}>
                  <span className="text-[10px] font-semibold" style={{color:p.color}}>€{p.p2026}</span>
                </div>
              </div>
              <div className="flex-1 bg-naio-bg/50 rounded h-5 relative overflow-hidden">
                <div className="h-full rounded transition-all flex items-center px-2" style={{width:(p.p2027/maxPrice)*100+'%', backgroundColor:p.color+'20', borderRight:'2px solid '+p.color+'80'}}>
                  <span className="text-[10px] font-semibold" style={{color:p.color+'CC'}}>€{p.p2027}</span>
                </div>
              </div>
            </div>
            <div className="w-40 text-[10px] text-naio-text-muted hidden lg:block">{p.advantage}</div>
          </div>
        ))}
      </div>
      <div className="flex gap-6 mt-2 text-[10px] text-naio-text-dim">
        <span>■ 2026 Forward</span>
        <span style={{opacity:0.6}}>■ 2027 Forward</span>
      </div>
      <Footnotes notes={['Forward prices are indicative and based on Fortum hedge prices / Nordic power exchange data. Actual prices vary by zone, profile, and contract structure. Subscription to EEX/Montel required for live data.']}/>
    </div>
  );
}

// ── Market Research Detail Panel ──
function ResearchDetailPanel({item, onClose, onNext, onPrev, related}) {
  if (!item) return null;
  const confColors = { high: {bg:'rgba(0,230,118,0.12)', text:'#00E676', border:'rgba(0,230,118,0.3)'}, medium: {bg:'rgba(255,152,0,0.12)', text:'#FF9800', border:'rgba(255,152,0,0.3)'}, low: {bg:'rgba(255,82,82,0.12)', text:'#FF5252', border:'rgba(255,82,82,0.3)'} };
  const cc = confColors[item.confidence] || confColors.medium;
  return (
    <div className="fixed inset-0 z-50 flex items-start justify-end" onClick={onClose}>
      <div className="absolute inset-0 bg-black/60"/>
      <div className="relative w-full max-w-lg h-full bg-naio-bg-deep border-l border-naio-border overflow-y-auto animate-slide-in" onClick={e=>e.stopPropagation()}>
        {/* Header */}
        <div className="sticky top-0 bg-naio-bg-deep/95 backdrop-blur border-b border-naio-border p-4 flex items-start gap-3 z-10">
          <div className="flex-1">
            <div className="flex items-center gap-2 mb-1">
              <ConfBadge level={item.confidence}/>
              {item.company && <span className="text-[10px] px-2 py-0.5 rounded-full bg-naio-bg-surface text-naio-text-secondary border border-naio-border">{item.company}</span>}
              {item.region && <span className="text-[10px] text-naio-text-dim">{item.region}</span>}
            </div>
            <h2 className="text-base font-semibold text-naio-text-primary leading-tight">{item.metric_name}</h2>
          </div>
          <div className="flex items-center gap-1">
            {onPrev && <button onClick={onPrev} className="p-1.5 rounded hover:bg-naio-bg-surface text-naio-text-dim hover:text-naio-text-primary transition-colors" title="Previous"><Icon name="ChevronRight" size={14} className="rotate-180"/></button>}
            {onNext && <button onClick={onNext} className="p-1.5 rounded hover:bg-naio-bg-surface text-naio-text-dim hover:text-naio-text-primary transition-colors" title="Next"><Icon name="ChevronRight" size={14}/></button>}
            <button onClick={onClose} className="p-1.5 rounded hover:bg-naio-bg-surface text-naio-text-dim hover:text-naio-text-primary transition-colors ml-1"><Icon name="X" size={16}/></button>
          </div>
        </div>

        {/* Value highlight */}
        <div className="p-4">
          <div className="bg-naio-bg-card border border-naio-border rounded-lg p-5 text-center mb-4">
            <div className="text-3xl font-bold text-naio-cyan mb-1">
              {item.value}
              {item.change_direction === 'up' && <span className="text-green-400 ml-2 text-lg">▲</span>}
              {item.change_direction === 'down' && <span className="text-red-400 ml-2 text-lg">▼</span>}
            </div>
            {item.unit && <div className="text-xs text-naio-text-muted">{item.unit}</div>}
            {item.previous_value && (
              <div className="text-xs text-naio-text-dim mt-1">Previously: {item.previous_value}</div>
            )}
          </div>

          {/* Detail fields */}
          <div className="space-y-3">
            <div className="grid grid-cols-2 gap-3">
              <div className="bg-naio-bg-card/60 border border-naio-border/50 rounded-lg p-3">
                <div className="text-[10px] text-naio-text-dim uppercase tracking-wider mb-1">Period</div>
                <div className="text-sm text-naio-text-primary font-medium">{item.period || '—'}</div>
              </div>
              <div className="bg-naio-bg-card/60 border border-naio-border/50 rounded-lg p-3">
                <div className="text-[10px] text-naio-text-dim uppercase tracking-wider mb-1">Category</div>
                <div className="text-sm text-naio-text-primary font-medium">{item.category?.replace(/_/g, ' ') || '—'}</div>
              </div>
            </div>

            {/* Source with link */}
            <div className="bg-naio-bg-card/60 border border-naio-border/50 rounded-lg p-3">
              <div className="text-[10px] text-naio-text-dim uppercase tracking-wider mb-1">Source</div>
              <div className="flex items-center gap-2">
                <span className="text-sm text-naio-text-primary font-medium">{item.source_name || '—'}</span>
                {item.source_date && <span className="text-[10px] text-naio-text-dim">({new Date(item.source_date).toLocaleDateString()})</span>}
              </div>
              {item.source_url && (
                <a href={item.source_url} target="_blank" rel="noopener noreferrer" className="mt-2 flex items-center gap-1.5 text-xs text-naio-cyan hover:text-naio-cyan-light transition-colors group">
                  <Icon name="ExternalLink" size={12}/>
                  <span className="group-hover:underline truncate">{item.source_url.replace(/^https?:\/\/(www\.)?/, '').split('/')[0]}</span>
                  <span className="text-[9px] text-naio-text-dim ml-1">Open source</span>
                </a>
              )}
            </div>

            {/* Confidence detail */}
            <div className="rounded-lg p-3" style={{backgroundColor: cc.bg, border: '1px solid ' + cc.border}}>
              <div className="flex items-center gap-2 mb-1">
                <ConfBadge level={item.confidence}/>
                <span className="text-xs font-medium" style={{color: cc.text}}>
                  {item.confidence === 'high' ? 'Verified from official sources' : item.confidence === 'medium' ? 'Based on press/analyst reports' : 'Preliminary or unverified'}
                </span>
              </div>
              {item.uncertainty_note && (
                <p className="text-xs mt-1" style={{color: cc.text + 'CC'}}>{item.uncertainty_note}</p>
              )}
            </div>

            {/* Tags */}
            {item.tags && item.tags.length > 0 && (
              <div>
                <div className="text-[10px] text-naio-text-dim uppercase tracking-wider mb-1.5">Tags</div>
                <div className="flex flex-wrap gap-1.5">
                  {item.tags.map((t,i) => (
                    <span key={i} className="text-[10px] px-2 py-0.5 rounded-full bg-naio-bg-surface text-naio-text-secondary border border-naio-border">{t}</span>
                  ))}
                </div>
              </div>
            )}

            {/* Timestamps */}
            <div className="grid grid-cols-2 gap-3 text-[10px] text-naio-text-dim">
              <div>Created: {item.created_at ? new Date(item.created_at).toLocaleString() : '—'}</div>
              <div>Updated: {item.updated_at ? new Date(item.updated_at).toLocaleString() : '—'}</div>
            </div>

            {/* Related data points */}
            {related && related.length > 0 && (
              <div className="mt-4 pt-4 border-t border-naio-border/50">
                <div className="text-[10px] text-naio-text-dim uppercase tracking-wider mb-2">Related Data Points</div>
                <div className="space-y-1.5">
                  {related.map((r,i) => (
                    <div key={i} className="flex items-center justify-between p-2 bg-naio-bg-card/40 border border-naio-border/30 rounded hover:border-naio-cyan/30 transition-colors cursor-pointer text-xs" onClick={()=>{/* will be handled by parent */}}>
                      <div className="flex-1 min-w-0">
                        <span className="text-naio-text-primary truncate block">{r.metric_name}</span>
                        <span className="text-[10px] text-naio-text-dim">{r.region} · {r.period}</span>
                      </div>
                      <div className="flex items-center gap-2 ml-2">
                        <span className="text-naio-cyan font-semibold whitespace-nowrap">{r.value}</span>
                        <ConfBadge level={r.confidence}/>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Quick action: open source */}
            {item.source_url && (
              <div className="mt-4">
                <a href={item.source_url} target="_blank" rel="noopener noreferrer"
                  className="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-naio-cyan/10 border border-naio-cyan/30 rounded-lg text-sm text-naio-cyan hover:bg-naio-cyan/20 transition-colors">
                  <Icon name="ExternalLink" size={14}/>
                  View Full Source
                </a>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

// ── Market Research Tab ──
function MarketResearchTab() {
  const [dataPoints, setDataPoints] = useState([]);
  const [loading, setLoading] = useState(true);
  const [categoryFilter, setCategoryFilter] = useState('all');
  const [regionFilter, setRegionFilter] = useState('all');
  const [confFilter, setConfFilter] = useState('all');
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedDP, setSelectedDP] = useState(null);

  useEffect(() => {
    const fetchData = async () => {
      setLoading(true);
      const { data, error } = await supabase
        .from('market_research')
        .select('*')
        .order('updated_at', { ascending: false });
      if (data) setDataPoints(data);
      setLoading(false);
    };
    fetchData();
  }, []);

  const categories = [...new Set(dataPoints.map(d => d.category))].sort();
  const regions = [...new Set(dataPoints.map(d => d.region).filter(Boolean))].sort();

  const filtered = dataPoints.filter(d => {
    if (categoryFilter !== 'all' && d.category !== categoryFilter) return false;
    if (regionFilter !== 'all' && d.region !== regionFilter) return false;
    if (confFilter !== 'all' && d.confidence !== confFilter) return false;
    if (searchTerm && !d.metric_name.toLowerCase().includes(searchTerm.toLowerCase()) &&
        !(d.company||'').toLowerCase().includes(searchTerm.toLowerCase()) &&
        !(d.source_name||'').toLowerCase().includes(searchTerm.toLowerCase())) return false;
    return true;
  });

  // Group by category
  const grouped = {};
  filtered.forEach(d => {
    const cat = d.category || 'other';
    if (!grouped[cat]) grouped[cat] = [];
    grouped[cat].push(d);
  });

  // For navigation in detail panel
  const flatFiltered = Object.values(grouped).flat();
  const selectedIdx = selectedDP ? flatFiltered.findIndex(d => d.id === selectedDP.id) : -1;
  const handleNext = selectedIdx >= 0 && selectedIdx < flatFiltered.length - 1 ? () => setSelectedDP(flatFiltered[selectedIdx + 1]) : null;
  const handlePrev = selectedIdx > 0 ? () => setSelectedDP(flatFiltered[selectedIdx - 1]) : null;

  // Find related items (same category or same company or same region, excluding current)
  const getRelated = (item) => {
    if (!item) return [];
    return dataPoints.filter(d =>
      d.id !== item.id && (
        (item.company && d.company === item.company) ||
        (d.category === item.category && d.region === item.region)
      )
    ).slice(0, 5);
  };

  const categoryLabels = {
    european_market: 'European Market',
    macro_structural: 'Macro & Structural',
    hotspot_project: 'Hotspot Projects',
    capacity: 'Capacity & Power',
    investment: 'Investment & Capex',
    power: 'Power & Energy',
    waste_heat: 'Waste Heat & District Heating',
    regulatory: 'Regulatory & Policy',
    utility_competitor: 'Utility Competitors',
    nuclear_smr: 'Nuclear / SMR / Fusion',
    supply_chain: 'Supply Chain',
    demand_supply_gap: 'Demand vs Supply Gap',
    other: 'Other',
  };

  const confColors = { high: '#00E676', medium: '#FF9800', low: '#FF5252' };

  if (loading) return (
    <div className="flex items-center justify-center py-20">
      <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-naio-cyan"/>
    </div>
  );

  if (dataPoints.length === 0) return (
    <div className="text-center py-20">
      <Icon name="TrendingUp" size={48} className="mx-auto text-naio-text-dim mb-4"/>
      <h3 className="text-lg text-naio-text-secondary mb-2">No market research data yet</h3>
      <p className="text-sm text-naio-text-muted mb-4">Market research data points are collected automatically during each pipeline run.</p>
      <p className="text-xs text-naio-text-dim">Run the pipeline once after creating the market_research table in Supabase, or wait for the daily 06:00 UTC auto-run.</p>
    </div>
  );

  return (
    <div>
      {/* Filters */}
      <div className="flex items-center gap-3 flex-wrap mb-5">
        <div className="relative flex-1 min-w-[180px] max-w-xs">
          <span className="absolute left-3 top-1/2 -translate-y-1/2 text-naio-text-dim"><Icon name="Search" size={14}/></span>
          <input type="text" placeholder="Search metrics, companies, sources..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)}
            className="w-full pl-9 pr-3 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-primary placeholder-naio-text-dim focus:outline-none focus:border-naio-cyan/50"/>
        </div>
        <select value={categoryFilter} onChange={e=>setCategoryFilter(e.target.value)} className="px-3 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-secondary focus:outline-none focus:border-naio-cyan/50 appearance-none cursor-pointer">
          <option value="all">All Categories</option>
          {categories.map(c => <option key={c} value={c}>{categoryLabels[c]||c}</option>)}
        </select>
        <select value={regionFilter} onChange={e=>setRegionFilter(e.target.value)} className="px-3 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-secondary focus:outline-none focus:border-naio-cyan/50 appearance-none cursor-pointer">
          <option value="all">All Regions</option>
          {regions.map(r => <option key={r} value={r}>{r}</option>)}
        </select>
        <select value={confFilter} onChange={e=>setConfFilter(e.target.value)} className="px-3 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-secondary focus:outline-none focus:border-naio-cyan/50 appearance-none cursor-pointer">
          <option value="all">All Confidence</option>
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
        </select>
        <div className="text-xs text-naio-text-dim">{filtered.length} data points</div>
      </div>

      {/* Stats summary */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-3 text-center">
          <div className="text-[10px] text-naio-text-dim uppercase tracking-wider mb-1">Total Data Points</div>
          <div className="text-xl font-bold text-naio-cyan">{dataPoints.length}</div>
        </div>
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-3 text-center">
          <div className="text-[10px] text-naio-text-dim uppercase tracking-wider mb-1">High Confidence</div>
          <div className="text-xl font-bold text-green-400">{dataPoints.filter(d=>d.confidence==='high').length}</div>
        </div>
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-3 text-center">
          <div className="text-[10px] text-naio-text-dim uppercase tracking-wider mb-1">With Source Links</div>
          <div className="text-xl font-bold text-naio-blue">{dataPoints.filter(d=>d.source_url).length}</div>
        </div>
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-3 text-center">
          <div className="text-[10px] text-naio-text-dim uppercase tracking-wider mb-1">Last Updated</div>
          <div className="text-sm font-bold text-naio-cyan">{dataPoints[0]?.updated_at ? new Date(dataPoints[0].updated_at).toLocaleDateString() : '—'}</div>
        </div>
      </div>

      {/* Grouped data points */}
      {Object.entries(grouped).map(([cat, items]) => (
        <div key={cat} className="mb-6">
          <h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-3 flex items-center gap-2">
            <span className="h-px flex-1 bg-naio-border"/>{categoryLabels[cat]||cat} ({items.length})<span className="h-px flex-1 bg-naio-border"/>
          </h3>
          <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg overflow-hidden">
            <table className="w-full text-sm">
              <thead>
                <tr className="border-b border-naio-border">
                  <th className="text-left py-2 px-3 text-naio-text-dim font-medium text-xs">Metric</th>
                  <th className="text-left py-2 px-3 text-naio-text-dim font-medium text-xs">Value</th>
                  <th className="text-left py-2 px-3 text-naio-text-dim font-medium text-xs hidden md:table-cell">Period</th>
                  <th className="text-left py-2 px-3 text-naio-text-dim font-medium text-xs hidden md:table-cell">Region</th>
                  <th className="text-left py-2 px-3 text-naio-text-dim font-medium text-xs hidden lg:table-cell">Source</th>
                  <th className="text-left py-2 px-3 text-naio-text-dim font-medium text-xs w-16">Conf.</th>
                </tr>
              </thead>
              <tbody>
                {items.map((d,i) => (
                  <tr key={d.id||i} className="border-b border-naio-border/50 hover:bg-naio-bg-surface/30 transition-colors cursor-pointer" onClick={()=>setSelectedDP(d)}>
                    <td className="py-2 px-3 text-naio-text-primary font-medium">
                      <div className="flex items-center gap-1.5">
                        {d.source_url && <Icon name="ExternalLink" size={10} className="text-naio-cyan flex-shrink-0"/>}
                        <span>{d.metric_name}</span>
                      </div>
                      {d.company && <span className="text-[10px] text-naio-text-dim ml-1">({d.company})</span>}
                    </td>
                    <td className="py-2 px-3 text-naio-cyan font-semibold whitespace-nowrap">
                      {d.value}
                      {d.change_direction === 'up' && <span className="text-green-400 ml-1 text-xs">▲</span>}
                      {d.change_direction === 'down' && <span className="text-red-400 ml-1 text-xs">▼</span>}
                    </td>
                    <td className="py-2 px-3 text-naio-text-secondary text-xs hidden md:table-cell">{d.period || '—'}</td>
                    <td className="py-2 px-3 text-naio-text-secondary text-xs hidden md:table-cell">{d.region || '—'}</td>
                    <td className="py-2 px-3 text-xs hidden lg:table-cell">
                      {d.source_url ? <span className="text-naio-cyan">{d.source_name}</span> : <span className="text-naio-text-secondary">{d.source_name}</span>}
                    </td>
                    <td className="py-2 px-3"><ConfBadge level={d.confidence}/></td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      ))}

      {/* Legend / methodology note */}
      <div className="mt-6 p-3 bg-naio-bg-card/40 border border-naio-border/50 rounded-lg">
        <h4 className="text-[10px] font-semibold text-naio-text-dim uppercase tracking-wider mb-2">Methodology & Confidence Levels</h4>
        <div className="flex flex-wrap gap-4 text-[10px] text-naio-text-muted">
          <div className="flex items-center gap-1"><ConfBadge level="high"/> Official filings, audited reports, direct company statements</div>
          <div className="flex items-center gap-1"><ConfBadge level="medium"/> Press reports, analyst estimates, industry association data</div>
          <div className="flex items-center gap-1"><ConfBadge level="low"/> Rumors, unverified sources, long-range projections</div>
        </div>
        <p className="text-[10px] text-naio-text-dim mt-2">Click any row to see full details, source links, uncertainty notes, and related data points.</p>
      </div>

      {/* Detail slide-out panel */}
      {selectedDP && <ResearchDetailPanel item={selectedDP} onClose={()=>setSelectedDP(null)} onNext={handleNext} onPrev={handlePrev} related={getRelated(selectedDP)}/>}
    </div>
  );
}

function CompanyResearch({data=[], fetchData}) {
  const [companyName, setCompanyName] = useState("");
  const [researching, setResearching] = useState(false);
  const [result, setResult] = useState(null);
  const [researchError, setResearchError] = useState(null);
  const [researchHistory, setResearchHistory] = useState([]);

  // Load research history from DB on mount — group by source
  useEffect(() => {
    const loadHistory = async () => {
      const { data: items } = await supabase
        .from('intelligence_items')
        .select('companies, date, source_name, source_url')
        .order('date', { ascending: false })
        .limit(200);
      if (items) {
        const companyMap = {};
        items.forEach(item => {
          (item.companies || []).forEach(c => {
            if (!companyMap[c]) companyMap[c] = { company: c, lastResearched: item.date, count: 0, hasUrl: false };
            companyMap[c].count++;
            if (item.source_url) companyMap[c].hasUrl = true;
          });
        });
        setResearchHistory(Object.values(companyMap).sort((a, b) => new Date(b.lastResearched) - new Date(a.lastResearched)));
      }
    };
    loadHistory();
  }, [result]);

  // Get unique companies from existing data for suggestions
  const knownCompanies = useMemo(() => {
    const compSet = new Set();
    data.forEach(item => (item.companies || []).forEach(c => compSet.add(c)));
    // Also add tracked companies as suggestions
    ["Equinix","Digital Realty","QTS","CyrusOne","CoreWeave","Vantage","Microsoft","Amazon","Google","Meta","Oracle",
     "EcoDataCenter","Evroc","NVIDIA","Vattenfall","Blackstone","KKR","Brookfield","DigitalBridge","EQT","OpenAI","xAI",
     "Switch","Aligned","DataBank","EdgeConneX","Stack Infrastructure","CloudHQ","Applied Digital","Crusoe Energy",
     "Compass Datacenters","Iron Mountain","NTT","Cyxtera","T5 Data Centers","Yondr","Scala Data Centers"].forEach(c => compSet.add(c));
    return [...compSet].sort();
  }, [data]);

  const [showSuggestions, setShowSuggestions] = useState(false);
  const filteredSuggestions = useMemo(() => {
    if (!companyName.trim()) return knownCompanies.slice(0, 10);
    const q = companyName.toLowerCase();
    return knownCompanies.filter(c => c.toLowerCase().includes(q)).slice(0, 8);
  }, [companyName, knownCompanies]);

  const handleResearch = async () => {
    if (!companyName.trim()) return;
    setResearching(true);
    setResearchError(null);
    setResult(null);
    try {
      // Use the refresh-pipeline Edge Function with a company parameter
      // This searches NewsAPI for REAL articles about this company
      const resp = await fetch(`${SUPABASE_URL}/functions/v1/refresh-pipeline`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${SUPABASE_ANON_KEY}` },
        body: JSON.stringify({ company: companyName.trim() }),
      });
      const data = await resp.json();
      if (data.error) throw new Error(data.error);
      setResult(data);
      setCompanyName("");
      if (fetchData) await fetchData();
    } catch (err) {
      console.error('Research error:', err);
      setResearchError(err.message || 'Research failed. Make sure the refresh-pipeline Edge Function is deployed.');
    } finally {
      setResearching(false);
    }
  };

  return (
    <div className="max-w-4xl mx-auto">
      {/* Header */}
      <div className="mb-8">
        <h2 className="text-xl font-semibold text-naio-text-primary mb-2">Company News Search</h2>
        <p className="text-sm text-naio-text-muted">Search for real, published news about any company. Pulls articles from NewsAPI, processes them through Claude for structured intelligence, and stores them with verifiable source URLs.</p>
        <div className="mt-4 bg-naio-green/10 border border-naio-green/30 rounded-lg p-3">
          <p className="text-xs text-naio-green"><span className="font-semibold">Verified sources:</span> Every item is sourced from a real published article. Click any source URL to verify.</p>
        </div>
      </div>

      {/* Search Input */}
      <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-6 mb-6">
        <div className="flex gap-3 items-start">
          <div className="flex-1 relative">
            <label className="text-xs text-naio-text-muted uppercase tracking-wider mb-2 block">Company Name</label>
            <input
              type="text"
              value={companyName}
              onChange={e => { setCompanyName(e.target.value); setShowSuggestions(true); }}
              onFocus={() => setShowSuggestions(true)}
              onBlur={() => setTimeout(() => setShowSuggestions(false), 200)}
              onKeyDown={e => { if (e.key === 'Enter' && companyName.trim() && !researching) handleResearch(); }}
              placeholder="e.g. Equinix, CoreWeave, Brookfield..."
              className="w-full px-4 py-3 bg-naio-bg-deep border border-naio-border rounded-md text-naio-text-primary placeholder-naio-text-dim focus:outline-none focus:border-naio-cyan/50 transition-colors text-sm"
              disabled={researching}
            />
            {showSuggestions && filteredSuggestions.length > 0 && companyName.length > 0 && (
              <div className="absolute z-20 w-full mt-1 bg-naio-bg-deep border border-naio-border rounded-md shadow-lg max-h-48 overflow-y-auto">
                {filteredSuggestions.map(c => (
                  <button key={c} onClick={() => { setCompanyName(c); setShowSuggestions(false); }}
                    className="w-full text-left px-4 py-2 text-sm text-naio-text-secondary hover:bg-naio-bg-card hover:text-naio-text-primary transition-colors">
                    {c}
                  </button>
                ))}
              </div>
            )}
          </div>
          <div className="pt-6">
            <button
              onClick={handleResearch}
              disabled={researching || !companyName.trim()}
              className="px-6 py-3 bg-naio-cyan/10 border border-naio-cyan/30 rounded-md text-sm text-naio-cyan hover:bg-naio-cyan/20 transition-colors disabled:opacity-50 flex items-center gap-2 whitespace-nowrap"
            >
              {researching ? (
                <>
                  <div className="w-4 h-4 border-2 border-naio-cyan border-t-transparent rounded-full animate-spin"/>
                  Researching...
                </>
              ) : (
                <>
                  <Icon name="Search" size={16}/>
                  Research Company
                </>
              )}
            </button>
          </div>
        </div>

        {researching && (
          <div className="mt-4 flex items-center gap-3 text-sm text-naio-text-muted">
            <div className="w-3 h-3 border-2 border-naio-cyan border-t-transparent rounded-full animate-spin"/>
            <span>Searching for real news about {companyName}... This takes 30-60 seconds.</span>
          </div>
        )}

        {researchError && (
          <div className="mt-4 bg-naio-red/10 border border-naio-red/30 rounded-md p-3 text-sm text-naio-red">
            <p className="font-medium">Research failed</p>
            <p className="text-xs mt-1 opacity-80">{researchError}</p>
          </div>
        )}

        {result && (
          <div className="mt-4 bg-naio-green/10 border border-naio-green/30 rounded-md p-4">
            <div className="flex items-center gap-2 mb-1">
              <Icon name="CheckCircle" size={16} className="text-naio-green"/>
              <p className="text-sm font-medium text-naio-green">{result.message || `Search complete`}</p>
            </div>
            <p className="text-xs text-naio-text-muted mt-1">{result.processed || 0} real articles found and processed. {result.total_from_api || 0} articles from NewsAPI, {result.deduplicated || 0} unique. Switch to any tab to see the new data.</p>
          </div>
        )}
      </div>

      {/* Research History */}
      <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-6">
        <h3 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-4">Companies in Database</h3>
        {researchHistory.length === 0 ? (
          <p className="text-sm text-naio-text-dim">No companies researched yet. Enter a company name above to get started.</p>
        ) : (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
            {researchHistory.map(h => (
              <div key={h.company} className="bg-naio-bg-deep border border-naio-border rounded-md p-3 hover:border-naio-border-light transition-colors">
                <p className="text-sm font-medium text-naio-text-primary">{h.company}</p>
                <div className="flex items-center justify-between mt-1">
                  <span className="text-[10px] text-naio-text-dim">{h.count} items</span>
                  <span className="text-[10px] text-naio-text-dim">Last: {fmtDate(h.lastResearched)}</span>
                </div>
                <button
                  onClick={() => { setCompanyName(h.company); window.scrollTo(0, 0); }}
                  className="mt-2 text-[10px] text-naio-cyan hover:text-naio-cyan-light transition-colors"
                >
                  Research again
                </button>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* How it works */}
      <div className="mt-6 bg-naio-bg-card/50 border border-naio-border/50 rounded-lg p-5">
        <h3 className="text-xs font-semibold text-naio-text-muted uppercase tracking-wider mb-3">How it works</h3>
        <div className="grid grid-cols-1 sm:grid-cols-4 gap-4 text-xs text-naio-text-dim">
          <div className="flex items-start gap-2">
            <span className="text-naio-cyan font-bold">1.</span>
            <span>Enter a company name (DC operator, hyperscaler, PE firm, utility, chip maker, etc.)</span>
          </div>
          <div className="flex items-start gap-2">
            <span className="text-naio-cyan font-bold">2.</span>
            <span>NewsAPI searches for real, published articles about the company (last 7 days)</span>
          </div>
          <div className="flex items-start gap-2">
            <span className="text-naio-cyan font-bold">3.</span>
            <span>Claude extracts structured intelligence from each real article — deals, financing, capex, etc.</span>
          </div>
          <div className="flex items-start gap-2">
            <span className="text-naio-cyan font-bold">4.</span>
            <span>Every item has a verifiable source URL. Items appear across all tabs.</span>
          </div>
        </div>
      </div>
    </div>
  );
}

// ─── DEMAND PIPELINE COMPONENT ─────────────────────────
function DemandPipeline() {
  const [pipelineData, setPipelineData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [sortCol, setSortCol] = useState("capacity_mw");
  const [sortDir, setSortDir] = useState("desc");
  const [selectedDeal, setSelectedDeal] = useState(null);
  const [showAddForm, setShowAddForm] = useState(false);
  const [hoveredRow, setHoveredRow] = useState(null);
  const [formData, setFormData] = useState({
    region: "", operator: "", capacity_mw: "", status: "Announced",
    ppa_terms: "", grid: "", timeline: "", source: "Manual", source_url: "", notes: "",
  });
  const chartRef = useRef(null);
  const ppaChartRef = useRef(null);
  const chartInstance = useRef(null);
  const ppaChartInstance = useRef(null);

  // Fetch from Supabase
  const fetchPipeline = async () => {
    try {
      const { data, error } = await supabase.from('demand_pipeline').select('*').order('capacity_mw', { ascending: false });
      if (data && !error) setPipelineData(data);
    } catch (e) { console.error('Demand pipeline fetch error:', e); }
    setLoading(false);
  };

  useEffect(() => { fetchPipeline(); }, []);

  const handleSave = async () => {
    if (!formData.region || !formData.operator || !formData.capacity_mw) return;
    const { error } = await supabase.from('demand_pipeline').insert({
      region: formData.region, operator: formData.operator,
      capacity_mw: parseInt(formData.capacity_mw), status: formData.status,
      ppa_terms: formData.ppa_terms, grid: formData.grid,
      timeline: formData.timeline, source: formData.source || "Manual",
      source_url: formData.source_url, notes: formData.notes,
      date: new Date().toISOString().split("T")[0],
    });
    if (!error) {
      setFormData({ region: "", operator: "", capacity_mw: "", status: "Announced", ppa_terms: "", grid: "", timeline: "", source: "Manual", source_url: "", notes: "" });
      setShowAddForm(false);
      fetchPipeline();
    }
  };

  const deleteDeal = async (deal, e) => {
    e.stopPropagation();
    if (!confirm(`Delete ${deal.operator} — ${deal.capacity_mw} MW in ${deal.region}?`)) return;
    await supabase.from('demand_pipeline').delete().eq('id', deal.id);
    fetchPipeline();
  };

  const sorted = useMemo(() => {
    let items = [...pipelineData];
    items.sort((a, b) => {
      let aVal = a[sortCol]; let bVal = b[sortCol];
      if(typeof aVal === 'string') { aVal = (aVal||'').toLowerCase(); bVal = (bVal||'').toLowerCase(); }
      if(sortDir === "asc") return aVal > bVal ? 1 : -1;
      return aVal < bVal ? 1 : -1;
    });
    return items;
  }, [sortCol, sortDir, pipelineData]);

  const toggleSort = (col) => {
    if(sortCol === col) setSortDir(sortDir === "asc" ? "desc" : "asc");
    else { setSortCol(col); setSortDir("asc"); }
  };

  const totalMW = useMemo(() => pipelineData.reduce((sum, item) => sum + (Number(item.capacity_mw) || 0), 0), [pipelineData]);
  const uniqueRegions = useMemo(() => new Set(pipelineData.map(d => d.region)).size, [pipelineData]);
  const avgPrice = useMemo(() => {
    const prices = pipelineData.map(d => { const m = (d.ppa_terms||'').match(/\$(\d+)|€(\d+)|£(\d+)/); return m ? parseInt(m[1] || m[2] || m[3]) : null; }).filter(Boolean);
    return prices.length > 0 ? Math.round(prices.reduce((a, b) => a + b, 0) / prices.length) : 0;
  }, [pipelineData]);

  const capacityByRegion = useMemo(() => {
    const data = {};
    pipelineData.forEach(item => {
      if (!data[item.region]) data[item.region] = {Announced: 0, "Under Construction": 0, Delivered: 0, Planning: 0};
      data[item.region][item.status] = (data[item.region][item.status] || 0) + (Number(item.capacity_mw) || 0);
    });
    return Object.entries(data).sort((a, b) => {
      const totalA = Object.values(a[1]).reduce((sum, v) => sum + v, 0);
      const totalB = Object.values(b[1]).reduce((sum, v) => sum + v, 0);
      return totalB - totalA;
    });
  }, [pipelineData]);

  const ppaPricingData = useMemo(() => {
    const types = {Nuclear: [], Renewable: [], Gas: [], Hydro: [], Solar: [], Wind: [], Mixed: []};
    pipelineData.forEach(item => {
      const terms = item.ppa_terms || '';
      let type = "Mixed";
      if(terms.includes("Nuclear")) type = "Nuclear";
      else if(terms.includes("Hydro")) type = "Hydro";
      else if(terms.includes("Solar")) type = "Solar";
      else if(terms.includes("Wind")) type = "Wind";
      else if(terms.includes("Renewable")) type = "Renewable";
      else if(terms.includes("Gas")) type = "Gas";
      const m = terms.match(/\$(\d+)|€(\d+)|£(\d+)/);
      if (m) { const price = parseInt(m[1] || m[2] || m[3]); if(!types[type]) types[type] = []; types[type].push(price); }
    });
    return Object.entries(types).filter(([_, p]) => p.length > 0).map(([type, prices]) => ({ type, avg: Math.round(prices.reduce((a, b) => a + b, 0) / prices.length), count: prices.length })).sort((a, b) => a.avg - b.avg);
  }, [pipelineData]);

  useEffect(() => {
    if (!chartRef.current || capacityByRegion.length === 0) return;
    if (chartInstance.current) chartInstance.current.destroy();
    const ctx = chartRef.current.getContext('2d');
    const regions = capacityByRegion.map(r => r[0]);
    const statuses = ["Announced", "Under Construction", "Delivered"];
    const colors = {Announced: "#3B9FE3", "Under Construction": "#FF9800", Delivered: "#00E676"};
    const datasets = statuses.map(status => ({ label: status, data: capacityByRegion.map(r => r[1][status] || 0), backgroundColor: colors[status], borderRadius: 0, borderWidth: 0 }));
    chartInstance.current = new Chart(ctx, { type: 'bar', data: {labels: regions, datasets}, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: {display: true, position: "top", labels: {color: "#B0C4D8", font: {size: 10}, padding: 12}}, tooltip: {backgroundColor: "#0F2237", borderColor: "#1A3A5C", borderWidth: 1, titleColor: "#fff", bodyColor: "#B0C4D8", callbacks: {label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.x} MW`}} }, scales: { x: {stacked: true, grid: {color: "#1A3A5C"}, ticks: {color: "#B0C4D8", font: {size: 10}, callback: v => v + " MW"}}, y: {stacked: true, grid: {display: false}, ticks: {color: "#B0C4D8", font: {size: 10}}} } } });
    return () => {if (chartInstance.current) chartInstance.current.destroy();};
  }, [capacityByRegion]);

  useEffect(() => {
    if (!ppaChartRef.current || ppaPricingData.length === 0) return;
    if (ppaChartInstance.current) ppaChartInstance.current.destroy();
    const ctx = ppaChartRef.current.getContext('2d');
    ppaChartInstance.current = new Chart(ctx, { type: 'bar', data: { labels: ppaPricingData.map(d => d.type), datasets: [{ label: 'Avg Price ($/MWh equiv)', data: ppaPricingData.map(d => d.avg), backgroundColor: ppaPricingData.map(d => { if(d.type === "Nuclear") return "#FF5252"; if(["Renewable","Hydro","Solar","Wind"].includes(d.type)) return "#00E676"; return "#FF9800"; }), borderRadius: 3, borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false}, tooltip: {backgroundColor: "#0F2237", borderColor: "#1A3A5C", borderWidth: 1, titleColor: "#fff", bodyColor: "#B0C4D8", callbacks: {label: (ctx) => `$${ctx.parsed.y}/MWh`}} }, scales: { x: {grid: {display: false}, ticks: {color: "#B0C4D8", font: {size: 10}}}, y: {beginAtZero: true, max: 70, grid: {color: "#1A3A5C"}, ticks: {color: "#B0C4D8", font: {size: 10}, callback: v => `$${v}`}} } } });
    return () => {if (ppaChartInstance.current) ppaChartInstance.current.destroy();};
  }, [ppaPricingData]);

  const getStatusColor = (status) => {
    if(status === "Announced") return "bg-naio-blue/20 text-naio-blue-light";
    if(status === "Under Construction") return "bg-naio-orange/20 text-naio-orange-light";
    if(status === "Delivered") return "bg-naio-green/20 text-naio-green";
    if(status === "Planning") return "bg-purple-500/20 text-purple-300";
    return "bg-naio-text-muted/20 text-naio-text-muted";
  };

  const columns = [
    {key: "region", label: "Region"}, {key: "operator", label: "Operator"},
    {key: "capacity_mw", label: "Capacity (MW)"}, {key: "status", label: "Status"},
    {key: "ppa_terms", label: "PPA Terms"}, {key: "grid", label: "Grid Connection"},
    {key: "timeline", label: "Timeline"}, {key: "source", label: "Source"},
  ];

  const inputCls = "w-full bg-[#0D1F33] border border-naio-border rounded px-3 py-2 text-sm text-naio-text-primary focus:border-naio-cyan focus:outline-none";

  if (loading) return <div className="text-center p-12 text-naio-text-muted">Loading demand pipeline...</div>;

  return (
    <div className="space-y-6">
      {/* Summary stats */}
      <div className="grid grid-cols-4 gap-3">
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4">
          <p className="text-[10px] text-naio-text-dim uppercase tracking-wider">Total MW Tracked</p>
          <p className="text-2xl font-bold text-naio-cyan mt-1">{totalMW.toLocaleString()}</p>
        </div>
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4">
          <p className="text-[10px] text-naio-text-dim uppercase tracking-wider">Markets Covered</p>
          <p className="text-2xl font-bold text-naio-teal mt-1">{uniqueRegions}</p>
        </div>
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4">
          <p className="text-[10px] text-naio-text-dim uppercase tracking-wider">Avg PPA Price</p>
          <p className="text-2xl font-bold text-naio-orange-light mt-1">{avgPrice > 0 ? `$${avgPrice}/MWh` : "—"}</p>
        </div>
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4">
          <p className="text-[10px] text-naio-text-dim uppercase tracking-wider">Operators</p>
          <p className="text-2xl font-bold text-naio-green mt-1">{new Set(pipelineData.map(d => d.operator)).size}</p>
        </div>
      </div>

      {/* Charts — only show if data exists */}
      {pipelineData.length > 0 && (
        <div className="grid grid-cols-2 gap-6">
          <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4">
            <h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-3">Capacity by Region (MW)</h3>
            <div className="h-96"><canvas ref={chartRef}/></div>
          </div>
          <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4">
            <h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-3">PPA Pricing Trends ($/MWh)</h3>
            <div className="h-96"><canvas ref={ppaChartRef}/></div>
          </div>
        </div>
      )}

      {/* Demand Pipeline Table */}
      <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg overflow-hidden">
        <div className="px-6 py-4 border-b border-naio-border flex items-center justify-between">
          <h3 className="text-sm font-semibold text-naio-cyan uppercase tracking-wider">Demand Pipeline Table</h3>
          <button onClick={() => setShowAddForm(!showAddForm)} className="flex items-center gap-1.5 px-3 py-1.5 bg-naio-cyan/20 hover:bg-naio-cyan/30 text-naio-cyan rounded text-xs font-semibold transition-colors">
            <Icon name="Plus" size={14}/> Add Deal
          </button>
        </div>

        {/* Add Deal Form */}
        {showAddForm && (
          <div className="px-6 py-4 border-b border-naio-border bg-[#0A1929]">
            <div className="grid grid-cols-4 gap-3 mb-3">
              <div><label className="text-[10px] text-naio-text-muted uppercase">Region *</label><input className={inputCls} value={formData.region} onChange={e => setFormData({...formData, region: e.target.value})} placeholder="e.g. Northern Virginia"/></div>
              <div><label className="text-[10px] text-naio-text-muted uppercase">Operator *</label><input className={inputCls} value={formData.operator} onChange={e => setFormData({...formData, operator: e.target.value})} placeholder="e.g. Amazon / AWS"/></div>
              <div><label className="text-[10px] text-naio-text-muted uppercase">Capacity (MW) *</label><input className={inputCls} type="number" value={formData.capacity_mw} onChange={e => setFormData({...formData, capacity_mw: e.target.value})} placeholder="e.g. 500"/></div>
              <div><label className="text-[10px] text-naio-text-muted uppercase">Status</label>
                <select className={inputCls} value={formData.status} onChange={e => setFormData({...formData, status: e.target.value})}>
                  <option>Announced</option><option>Planning</option><option>Under Construction</option><option>Delivered</option>
                </select>
              </div>
            </div>
            <div className="grid grid-cols-4 gap-3 mb-3">
              <div><label className="text-[10px] text-naio-text-muted uppercase">PPA Terms</label><input className={inputCls} value={formData.ppa_terms} onChange={e => setFormData({...formData, ppa_terms: e.target.value})} placeholder="e.g. Nuclear $40/MWh"/></div>
              <div><label className="text-[10px] text-naio-text-muted uppercase">Grid Connection</label><input className={inputCls} value={formData.grid} onChange={e => setFormData({...formData, grid: e.target.value})} placeholder="e.g. Dominion 500kV"/></div>
              <div><label className="text-[10px] text-naio-text-muted uppercase">Timeline</label><input className={inputCls} value={formData.timeline} onChange={e => setFormData({...formData, timeline: e.target.value})} placeholder="e.g. Q3 2027"/></div>
              <div><label className="text-[10px] text-naio-text-muted uppercase">Source</label><input className={inputCls} value={formData.source} onChange={e => setFormData({...formData, source: e.target.value})} placeholder="e.g. Bloomberg"/></div>
            </div>
            <div className="grid grid-cols-2 gap-3 mb-3">
              <div><label className="text-[10px] text-naio-text-muted uppercase">Source URL</label><input className={inputCls} value={formData.source_url} onChange={e => setFormData({...formData, source_url: e.target.value})} placeholder="https://..."/></div>
              <div><label className="text-[10px] text-naio-text-muted uppercase">Notes</label><input className={inputCls} value={formData.notes} onChange={e => setFormData({...formData, notes: e.target.value})} placeholder="Additional context..."/></div>
            </div>
            <div className="flex gap-2">
              <button onClick={handleSave} className="px-4 py-2 bg-naio-cyan text-white rounded text-xs font-semibold hover:bg-naio-cyan/80">Save Deal</button>
              <button onClick={() => setShowAddForm(false)} className="px-4 py-2 bg-naio-bg-card border border-naio-border rounded text-xs text-naio-text-muted hover:bg-naio-bg-card-hover">Cancel</button>
            </div>
          </div>
        )}

        {pipelineData.length === 0 ? (
          <div className="p-12 text-center">
            <p className="text-naio-text-secondary mb-2">No demand pipeline data yet.</p>
            <p className="text-sm text-naio-text-muted">Add deals manually or run Update Intelligence to auto-populate from news articles.</p>
          </div>
        ) : (
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="bg-[#122640] border-b border-naio-border">
                  {columns.map(col => (
                    <th key={col.key} className="px-4 py-3 text-left text-naio-cyan font-semibold text-xs uppercase tracking-wider cursor-pointer hover:bg-naio-bg-card/50 transition-colors"
                      onClick={() => toggleSort(col.key)}>
                      <div className="flex items-center gap-2">
                        {col.label}
                        {sortCol === col.key && <span className="text-[10px]">{sortDir === "asc" ? "↑" : "↓"}</span>}
                      </div>
                    </th>
                  ))}
                  <th className="px-2 py-3 w-8"></th>
                </tr>
              </thead>
              <tbody>
                {sorted.map((row, idx) => (
                  <tr key={row.id || idx} className={`border-b border-naio-border ${idx % 2 === 0 ? "bg-[#0F2237]" : "bg-[#0D1F33]"} hover:bg-naio-bg-card-hover transition-colors cursor-pointer`}
                    onClick={() => setSelectedDeal(row)} onMouseEnter={() => setHoveredRow(row.id)} onMouseLeave={() => setHoveredRow(null)}>
                    <td className="px-4 py-3 text-naio-text-primary font-medium text-xs">{row.region}</td>
                    <td className="px-4 py-3 text-naio-text-secondary text-xs">{row.operator}</td>
                    <td className="px-4 py-3 text-naio-text-secondary font-bold">{Number(row.capacity_mw).toLocaleString()}</td>
                    <td className="px-4 py-3">
                      <span className={`inline-block px-2 py-0.5 rounded text-[10px] font-semibold ${getStatusColor(row.status)}`}>{row.status}</span>
                    </td>
                    <td className="px-4 py-3 text-naio-text-muted text-xs">{row.ppa_terms || "—"}</td>
                    <td className="px-4 py-3 text-naio-text-muted text-xs">{row.grid || "—"}</td>
                    <td className="px-4 py-3 text-naio-text-dim text-xs">{row.timeline || "—"}</td>
                    <td className="px-4 py-3 text-naio-text-dim text-xs">{row.source_url ? <a href={row.source_url} target="_blank" rel="noopener noreferrer" className="text-naio-cyan hover:underline" onClick={e => e.stopPropagation()}>{row.source || "Link"}</a> : (row.source || "—")}</td>
                    <td className="px-2 py-3">
                      {hoveredRow === row.id && <button onClick={(e) => deleteDeal(row, e)} className="p-1 text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded transition-colors"><Icon name="Trash2" size={14}/></button>}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>

      {/* Deal detail modal */}
      {selectedDeal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center animate-fade-in">
          <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setSelectedDeal(null)}/>
          <div className="relative max-w-2xl w-11/12 bg-naio-bg-deep border border-naio-border rounded-lg overflow-hidden animate-slide-in">
            <div className="h-[2px] bg-gradient-to-r from-naio-cyan via-naio-teal to-transparent"/>
            <div className="px-6 py-4 border-b border-naio-border flex items-start justify-between">
              <div>
                <h2 className="text-lg font-semibold text-naio-text-primary">{selectedDeal.region} — {selectedDeal.operator}</h2>
                <p className="text-xs text-naio-text-muted mt-1">{Number(selectedDeal.capacity_mw).toLocaleString()} MW | {selectedDeal.status}</p>
              </div>
              <button onClick={() => setSelectedDeal(null)} className="p-1.5 rounded hover:bg-naio-bg-card text-naio-text-muted"><Icon name="X" size={18}/></button>
            </div>
            <div className="px-6 py-5 space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Capacity</p>
                  <p className="text-lg font-bold text-naio-cyan">{Number(selectedDeal.capacity_mw).toLocaleString()} MW</p>
                </div>
                <div>
                  <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Status</p>
                  <p className={`text-sm font-semibold px-2 py-0.5 rounded inline-block ${getStatusColor(selectedDeal.status)}`}>{selectedDeal.status}</p>
                </div>
                <div>
                  <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">PPA Terms</p>
                  <p className="text-sm text-naio-text-secondary">{selectedDeal.ppa_terms || "—"}</p>
                </div>
                <div>
                  <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Grid Connection</p>
                  <p className="text-sm text-naio-text-secondary">{selectedDeal.grid || "—"}</p>
                </div>
              </div>
              <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-3">
                <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Timeline</p>
                <p className="text-sm text-naio-text-secondary">{selectedDeal.timeline || "—"}</p>
              </div>
              {selectedDeal.notes && <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-3">
                <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Notes</p>
                <p className="text-sm text-naio-text-secondary">{selectedDeal.notes}</p>
              </div>}
              <div>
                <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-2">Source</p>
                {selectedDeal.source_url ? (
                  <a href={selectedDeal.source_url} target="_blank" rel="noopener noreferrer" className="text-xs text-naio-cyan hover:text-naio-cyan-light flex items-center gap-1">
                    <Icon name="ExternalLink" size={12}/> {selectedDeal.source || "View source"}
                  </a>
                ) : (
                  <p className="text-xs text-naio-text-muted">{selectedDeal.source || "Manual entry"}</p>
                )}
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ─── MAIN APP ────────────────────────────────────────────
function App() {
  const { data: liveData, calendarEvents, marketHeatmap, financingComps, loading, dataSource, lastRefresh, refreshing, error, fetchData, triggerPipeline } = useSupabaseData();
  const [activeTab, setActiveTab] = useState("dashboard");
  const [sidebarOpen, setSidebarOpen] = useState(window.innerWidth > 768);
  const [selectedItem, setSelectedItem] = useState(null);
  const [impFilter, setImpFilter] = useState("all");
  const [typeFilter, setTypeFilter] = useState("all");
  const [search, setSearch] = useState("");
  const [sortBy, setSortBy] = useState("recently_added");
  const [regionFilter, setRegionFilter] = useState("");
  const [viewMode, setViewMode] = useState("table");

  const tabTitles = {dashboard:"Dashboard",news:"News Feed",infrastructure:"DC Infrastructure",chip:"Chip / Compute",energy:"Energy",financing:"Financing & Credit",supply_chain:"Supply Chain",demand_pipeline:"Demand Pipeline",calendar:"Events & Earnings Calendar",heatmap:"Market Heatmap",comps:"Financing Comps",reports:"Reports",research:"Company News Search",market_research:"Market Research"};
  const tabDescs = {dashboard:"High-priority intelligence across all layers",demand_pipeline:"DC power demand by region and operator",calendar:"Upcoming conferences, earnings, and regulatory deadlines",heatmap:"Activity density by geographic market",comps:"Recent financing transactions and comparables",reports:"Custom market intelligence reports",research:"Add a company and generate 90 days of AI-powered intelligence"};

  const filtered = useMemo(()=>{
    let items = [...liveData];
    if(activeTab!=="dashboard"&&activeTab!=="news"&&activeTab!=="calendar"&&activeTab!=="heatmap"&&activeTab!=="comps"&&activeTab!=="reports"&&activeTab!=="demand_pipeline"&&activeTab!=="research"&&activeTab!=="market_research") items=items.filter(i=>i.layer===activeTab||i.layer==="cross-layer");
    if(impFilter!=="all") items=items.filter(i=>i.importance===impFilter);
    if(typeFilter!=="all") items=items.filter(i=>i.type===typeFilter);
    if(regionFilter) items=items.filter(i=>i.region.toLowerCase().includes(regionFilter.toLowerCase()));
    if(search.trim()){const q=search.toLowerCase();items=items.filter(i=>i.headline.toLowerCase().includes(q)||i.summary.toLowerCase().includes(q)||i.companies.some(c=>c.toLowerCase().includes(q))||i.region.toLowerCase().includes(q)||i.tags.some(t=>t.toLowerCase().includes(q)));}

    // Apply sorting
    if(sortBy === "date_newest") {
      items.sort((a,b)=>new Date(b.date)-new Date(a.date) || new Date(b.created_at||b.date)-new Date(a.created_at||a.date));
    } else if(sortBy === "recently_added") {
      items.sort((a,b)=>new Date(b.created_at||b.date)-new Date(a.created_at||a.date));
    } else if(sortBy === "date_oldest") {
      items.sort((a,b)=>new Date(a.date)-new Date(b.date) || new Date(a.created_at||a.date)-new Date(b.created_at||b.date));
    } else if(sortBy === "importance") {
      const impOrder = {high:0, medium:1, low:2};
      items.sort((a,b)=>(impOrder[a.importance]||3)-(impOrder[b.importance]||3) || new Date(b.date)-new Date(a.date));
    } else if(sortBy === "region") {
      items.sort((a,b)=>a.region.localeCompare(b.region));
    } else if(sortBy === "company") {
      items.sort((a,b)=>(a.companies[0]||"").localeCompare(b.companies[0]||""));
    }

    return items;
  },[liveData,activeTab,impFilter,typeFilter,search,sortBy,regionFilter]);

  // Group by region if region sort is selected
  const groupedItems = useMemo(()=>{
    if(sortBy !== "region") return {ungrouped: filtered};
    const grouped = {};
    filtered.forEach(item => {
      const group = getRegionGroup(item.region);
      if(!grouped[group]) grouped[group] = [];
      grouped[group].push(item);
    });
    return grouped;
  }, [filtered, sortBy]);

  const highPriority = useMemo(()=>liveData.filter(i=>i.importance==="high").sort((a,b)=>new Date(b.date)-new Date(a.date)),[liveData]);

  const handleMarketClick = (market) => {
    setRegionFilter(market.label);
    setActiveTab("news");
  };

  return (
    <div className="flex h-screen overflow-hidden font-sans">
      {/* Overlay for mobile when sidebar is open */}
      {sidebarOpen && <div className="fixed inset-0 bg-black/50 z-40 md:hidden" onClick={()=>setSidebarOpen(false)}/>}
      <aside className={`fixed inset-y-0 left-0 z-50 md:relative md:z-auto transition-all duration-200 ease-in-out ${sidebarOpen ? 'w-56' : 'w-0'} overflow-hidden flex-shrink-0`}>
        <Sidebar activeTab={activeTab} onTabChange={t=>{setActiveTab(t);setImpFilter("all");setTypeFilter("all");setSearch("");setSortBy("recently_added");setRegionFilter("");if(window.innerWidth<=768)setSidebarOpen(false);}}/>
      </aside>
      <main className="flex-1 overflow-hidden flex flex-col min-w-0">
        <div className="h-[2px] bg-gradient-to-r from-naio-cyan via-naio-teal to-transparent"/>
        <header className="px-4 sm:px-6 py-4 border-b border-naio-border flex items-center justify-between flex-shrink-0">
          <div className="flex items-center gap-3">
            <button onClick={()=>setSidebarOpen(!sidebarOpen)} className="p-1.5 rounded-md hover:bg-naio-bg-card text-naio-text-secondary hover:text-naio-cyan transition-colors" title={sidebarOpen?"Hide menu":"Show menu"}>
              <Icon name={sidebarOpen?"PanelLeftClose":"Menu"} size={20}/>
            </button>
            <div>
              <h1 className="text-lg font-semibold text-naio-text-primary">{tabTitles[activeTab]}</h1>
              <p className="text-xs text-naio-text-muted mt-0.5">{tabDescs[activeTab]||filtered.length+" items"}</p>
            </div>
          </div>
          <div className="flex items-center gap-3">
            {error && <div className="text-[10px] text-naio-red bg-naio-red/10 px-2 py-1 rounded">{error}</div>}
            <div className="flex items-center gap-1.5 text-[10px] text-naio-text-dim">
              <div className={`w-2 h-2 rounded-full ${dataSource==='supabase'?'bg-naio-green':'bg-naio-orange'}`}/>
              <span>{dataSource==='supabase'?'Live':'Local'}</span>
            </div>
            <div className="text-[10px] text-naio-text-dim uppercase tracking-widest">
              {lastRefresh ? lastRefresh.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"}) : '--:--'}
            </div>
            <button
              onClick={fetchData}
              disabled={loading}
              className="p-1.5 text-naio-text-dim hover:text-naio-cyan transition-colors disabled:opacity-50"
              title="Reload data from database"
            >
              <Icon name="RefreshCw" size={14} className={loading?'animate-spin':''}/>
            </button>
            <button
              onClick={triggerPipeline}
              disabled={refreshing}
              className="px-3 py-1.5 bg-naio-cyan/10 border border-naio-cyan/30 rounded-md text-xs text-naio-cyan hover:bg-naio-cyan/20 transition-colors disabled:opacity-50 flex items-center gap-1.5"
              title="Fetch new articles, process through AI, and update the database"
            >
              <Icon name="Zap" size={12} className={refreshing?'animate-pulse':''}/>
              {refreshing ? 'Updating...' : 'Update Intelligence'}
            </button>
          </div>
        </header>
        <div className="flex-1 overflow-y-auto">
          {loading && !liveData.length && (
            <div className="flex items-center justify-center h-full">
              <div className="text-center">
                <div className="w-8 h-8 border-2 border-naio-cyan border-t-transparent rounded-full animate-spin mx-auto mb-4"/>
                <p className="text-naio-text-secondary text-sm">Connecting to Supabase...</p>
                <p className="text-naio-text-dim text-xs mt-1">Falling back to local data if unavailable</p>
              </div>
            </div>
          )}
          {activeTab==="dashboard" && <div className="p-6">
            <StatsBar items={liveData}/>
            <div className="mt-6"><h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-4">Big 5 Hyperscaler Combined Capex Trajectory</h2>
              <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-6 h-72">
                <CapexTrajectoryChart/>
              </div>
              <p className="text-xs text-naio-text-dim mt-2">Source: Amazon, Microsoft, Alphabet, Meta, Oracle 10-K/10-Q filings & earnings calls. 2026E = consensus estimates. Total capex incl. non-DC spend.</p>
            </div>
            <div className="mt-6"><h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-4">Individual Company Capex (2020-2026E)</h2>
              <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-6 h-72">
                <CompanyCapexChart/>
              </div>
              <p className="text-xs text-naio-text-dim mt-2">Source: Company 10-K/10-Q filings & earnings calls. 2025 = guidance/actuals, 2026E = consensus estimates. Total capex incl. non-DC spend.</p>
            </div>
            {/* ── European Market Context (Slide 9) ── */}
            <div className="mt-8">
              <h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-4">European Data Center Market</h2>
              <EUKeyStats/>
              <Footnotes notes={[
                'EUDCA, "State of European Data Centres" (2025). Industry association report; figures may reflect member-submitted data.',
                'Global Data Center Market Report, Q3 2025. Colocation supply only; excludes enterprise/hyperscale self-built.',
                'Cushman & Wakefield, "EMEA Data Centre Update H1 2025". Pipeline = operational + under construction + planned. Not all planned capacity will be built.',
              ]}/>
            </div>

            {/* ── European Growth Hotspots (Slide 10) ── */}
            <div className="mt-8">
              <h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-4">European Growth Hotspots</h2>
              <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg overflow-hidden">
                <EuropeanHotspotsTable/>
              </div>
              <div className="mt-2 p-3 bg-naio-bg-card/40 border border-naio-border/50 rounded-lg">
                <p className="text-[10px] text-naio-text-muted italic mb-2">Power is the binding constraint. Frankfurt grid forcing operators 30-40mi west. Germany mandates PUE 1.2 for new DCs from 2026. Nordics offer 40-60% lower energy cost vs Western Europe.</p>
                <Footnotes notes={[
                  'Brookfield: ~$10B (SEK 95B) in Strängnäs, Sweden. Deck cites $9.8B — minor FX variance. Press release Jan 2025.',
                  'OpenAI Stargate Norway: Narvik, 230MW, ~100K GPUs. Partners: Nscale + Aker. Announced 2025.',
                  'CoreWeave: $1.3B UK + $2.2B continental Europe (NO, SE, ES). Multiple press releases 2025.',
                  'TikTok Project Clover: €1B+ hyperscale DC in Finland. Confirmed by company.',
                  'Microsoft Spain: €2.9B Zaragoza campus, part of ~€10B Aragón commitment.',
                  'Azora/Tillion: €1.1B initial, scaling to €2B. 150-300MW in Villamayor de Gállego.',
                  'Google Germany: €5.5B across Dietzenbach + Hanau, 2026-2029.',
                  'Brookfield + Data4: €20B French AI infra over 5 years, incl. €10B first AI factory.',
                  'Mistral + NVIDIA: 18,000 Grace Blackwell GPUs (phase 1). Announced 2025.',
                  'Microsoft Italy: $4.8B (~€4.3B) in northern Italy.',
                  'Microsoft Portugal: $10B in Sines, 12,600 NVIDIA GPUs. Launch 2026.',
                ]}/>
              </div>
            </div>

            {/* ── Macro Context & Structural Data (Slide 11) ── */}
            <div className="mt-8">
              <h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-4">Macro Context & Structural Data</h2>
              <MacroKeyStats/>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div>
                  <h3 className="text-xs font-medium text-naio-text-dim mb-2">AI DC Capacity Trajectory (GW) — Brookfield [18]</h3>
                  <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4 h-56">
                    <AIDCCapacityChart/>
                  </div>
                </div>
                <div>
                  <h3 className="text-xs font-medium text-naio-text-dim mb-2">DC Equipment Spending ($B) — IoT Analytics [20]</h3>
                  <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4 h-56">
                    <DCEquipmentChart/>
                  </div>
                </div>
              </div>
              <Footnotes notes={[
                'Company 10-K/10-Q filings & earnings calls Q4 2025. 2026E = upper-end guidance. Actual spend may be 10-15% lower.',
                'Goldman Sachs estimate. AI/non-AI capex split is approximate; companies do not fully disaggregate.',
                'Jensen Huang, Nvidia earnings call Aug 2025. Barclays estimates $50-80B total per GW. Debate ongoing.',
                'Brookfield Asset Management proprietary projection (2024). 10-year forecast; significant uncertainty at tail end.',
                'Goldman Sachs, "AI & Data Center Power Demand" (2025). EPRI estimates 9-12% by 2030. Range reflects methodological differences.',
                'IoT Analytics, DC Equipment Market Report 2025. $290B actual, $1T is a 2030 projection assuming current growth trajectory.',
              ]}/>
              <div className="mt-2 p-2 bg-yellow-900/10 border border-yellow-700/20 rounded-lg">
                <p className="text-[10px] text-yellow-600/80"><span className="font-semibold">Uncertainty note:</span> GPU-as-a-Service forecast ($30B → $250B+) is Brookfield's bullish proprietary estimate. Third-party research firms estimate $5-32B by 2034. Debt issuance need of $1.5T over 5yr is JP Morgan/Morgan Stanley estimate.</p>
              </div>
            </div>

            {/* ── Market Research Summary Widget ── */}
            <div className="mt-8">
              <ResearchSummaryWidget onViewAll={()=>setActiveTab('market_research')}/>
            </div>

            {/* ── Demand vs Supply Gap ── */}
            <div className="mt-8">
              <h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-4">Demand vs Supply Gap</h2>
              <DemandSupplyGapWidget/>
            </div>

            {/* ── Forward Prices & Supply Chain ── */}
            <div className="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-4">Forward Price Comparison</h2>
                <ForwardPriceWidget/>
              </div>
              <div>
                <h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-4">Supply Chain Bottlenecks</h2>
                <SupplyChainWidget/>
              </div>
            </div>

            {/* ── Regulatory Tracker ── */}
            <div className="mt-8">
              <h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-4">Regulatory Tracker</h2>
              <RegulatoryTracker/>
            </div>

            {/* ── Nuclear / SMR / Fusion ── */}
            <div className="mt-8">
              <h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-4">Nuclear / SMR / Fusion Pipeline</h2>
              <NuclearSMRWidget/>
            </div>

            {/* ── Utility Competitor Landscape ── */}
            <div className="mt-8">
              <h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-4">Utility Competitor Landscape</h2>
              <UtilityCompetitorWidget/>
            </div>

            <div className="mt-8"><h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-4">High Priority</h2>
              {highPriority.length === 0 ? (
                <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-8 text-center">
                  <p className="text-naio-text-secondary mb-2">No intelligence items yet.</p>
                  <p className="text-sm text-naio-text-muted">Click "Update Intelligence" to fetch real news and data.</p>
                </div>
              ) : (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">{highPriority.map(i=><IntelCard key={i.id} item={i} onClick={()=>setSelectedItem(i)}/>)}</div>
              )}
            </div>
            <div className="mt-8"><h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-4">Market Activity</h2>
              <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-6 mb-6">
                <MarketMap onMarketClick={handleMarketClick} mapHeight={300}/>
              </div>
            </div>
          </div>}
          {activeTab==="calendar" && <div className="p-6"><CalendarView events={calendarEvents}/></div>}
          {activeTab==="demand_pipeline" && <div className="p-6"><DemandPipeline/></div>}
          {activeTab==="heatmap" && <div className="p-6">
            <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-6 mb-6">
              <MarketMap onMarketClick={handleMarketClick}/>
            </div>
            <div><h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-4">Regional Heat Index</h2><HeatmapView data={marketHeatmap}/></div>
          </div>}
          {activeTab==="comps" && <div className="p-6">
            <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg overflow-hidden">
              <CompsTable data={financingComps} allData={liveData} fetchData={fetchData}/>
            </div>
          </div>}
          {activeTab==="reports" && <div className="p-6"><ReportGenerator data={liveData} calendarEvents={calendarEvents} financingComps={financingComps} marketHeatmap={marketHeatmap}/></div>}
          {activeTab==="research" && <div className="p-6"><CompanyResearch data={liveData} fetchData={fetchData}/></div>}
          {activeTab==="market_research" && <div className="p-6"><MarketResearchTab/></div>}
          {activeTab!=="dashboard"&&activeTab!=="calendar"&&activeTab!=="heatmap"&&activeTab!=="comps"&&activeTab!=="reports"&&activeTab!=="research"&&activeTab!=="market_research" && <div className="p-6">
            <div className="flex items-center gap-3 flex-wrap mb-4">
              <div className="relative flex-1 min-w-[200px] max-w-sm"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-naio-text-dim"><Icon name="Search" size={14}/></span><input type="text" placeholder="Search companies, regions, tags..." value={search} onChange={e=>setSearch(e.target.value)} className="w-full pl-9 pr-3 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-primary placeholder-naio-text-dim focus:outline-none focus:border-naio-cyan/50 transition-colors"/></div>
              <select value={impFilter} onChange={e=>setImpFilter(e.target.value)} className="px-3 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-secondary focus:outline-none focus:border-naio-cyan/50 appearance-none cursor-pointer"><option value="all">All Priority</option><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select>
              <select value={typeFilter} onChange={e=>setTypeFilter(e.target.value)} className="px-3 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-secondary focus:outline-none focus:border-naio-cyan/50 appearance-none cursor-pointer"><option value="all">All Types</option><option value="news_summary">News</option><option value="deal_synopsis">Deals</option><option value="capex_announcement">Capex</option><option value="financing_event">Financing</option><option value="earnings_intelligence">Earnings</option><option value="regulatory_update">Regulatory</option><option value="power_demand_signal">Power Demand</option><option value="executive_move">Exec Moves</option><option value="supply_chain_signal">Supply Chain</option></select>
              <select value={sortBy} onChange={e=>setSortBy(e.target.value)} className="px-3 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-secondary focus:outline-none focus:border-naio-cyan/50 appearance-none cursor-pointer"><option value="date_newest">Article Date (newest)</option><option value="recently_added">Recently Added</option><option value="date_oldest">Article Date (oldest)</option><option value="importance">Importance (high → low)</option><option value="region">Region (A-Z)</option><option value="company">Company (A-Z)</option></select>
              {regionFilter && <div className="flex items-center gap-2 px-3 py-2 bg-naio-bg-surface border border-naio-border rounded-md text-sm"><span className="text-naio-text-secondary">Filtered: {regionFilter}</span><button onClick={()=>setRegionFilter("")} className="text-naio-text-dim hover:text-naio-text-primary"><Icon name="X" size={14}/></button></div>}
              <div className="flex items-center bg-naio-bg-card border border-naio-border rounded-md overflow-hidden">
                <button onClick={() => setViewMode("table")} className={`px-2.5 py-2 text-xs flex items-center gap-1 transition-colors ${viewMode === "table" ? "bg-naio-bg-surface text-naio-cyan" : "text-naio-text-dim hover:text-naio-text-secondary"}`}><Icon name="LayoutList" size={14}/></button>
                <button onClick={() => setViewMode("cards")} className={`px-2.5 py-2 text-xs flex items-center gap-1 transition-colors ${viewMode === "cards" ? "bg-naio-bg-surface text-naio-cyan" : "text-naio-text-dim hover:text-naio-text-secondary"}`}><Icon name="LayoutGrid" size={14}/></button>
              </div>
            </div>
            <TabAnalytics items={filtered} layer={activeTab}/>
            {viewMode === "table" ? (
              <IntelTable items={filtered} onItemClick={(i) => setSelectedItem(i)}/>
            ) : (
            <div className="space-y-6">
              {sortBy === "region" ? (
                Object.entries(groupedItems).map(([group, items]) => (
                  <div key={group}>
                    <h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-3 mt-6 flex items-center gap-2"><span className="h-px flex-1 bg-naio-border"/>{group} ({items.length})<span className="h-px flex-1 bg-naio-border"/></h3>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                      {items.map(i=><IntelCard key={i.id} item={i} onClick={()=>setSelectedItem(i)}/>)}
                    </div>
                  </div>
                ))
              ) : (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                  {filtered.map(i=><IntelCard key={i.id} item={i} onClick={()=>setSelectedItem(i)}/>)}
                </div>
              )}
              {filtered.length===0 && <div className="text-center py-20 text-naio-text-muted"><p className="text-lg">No intelligence items match your filters.</p><p className="text-sm mt-2">Try adjusting your search or filter criteria.</p></div>}
            </div>
            )}
          </div>}
        </div>
      </main>
      {selectedItem && <DetailModal item={selectedItem} onClose={()=>setSelectedItem(null)}/>}
    </div>
  );
}

ReactDOM.render(<App/>, document.getElementById("root"));
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NAIO Intelligence | Data Center Market Intelligence</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            naio: {
              bg: '#0A1628',
              'bg-deep': '#0D1117',
              'bg-card': '#0F2237',
              'bg-card-hover': '#162A3E',
              'bg-surface': '#1A3350',
              cyan: '#00BCD4',
              'cyan-light': '#00C8E0',
              teal: '#00BFA6',
              green: '#00E676',
              orange: '#FF9800',
              'orange-light': '#FFB74D',
              red: '#FF5252',
              purple: '#AB47BC',
              blue: '#3B9FE3',
              'blue-light': '#4FC3F7',
              'text-primary': '#FFFFFF',
              'text-secondary': '#B0C4D8',
              'text-muted': '#6B8FA3',
              'text-dim': '#4A5568',
              border: '#1A3A5C',
              'border-light': '#2A4A6C',
            }
          },
          fontFamily: {
            sans: ['"Segoe UI"', 'Calibri', 'Arial', 'sans-serif'],
          }
        }
      }
    }
  </script>
  <style>
    body { background: #0A1628; color: #fff; margin: 0; }
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: #0D1117; }
    ::-webkit-scrollbar-thumb { background: #1A3A5C; border-radius: 99px; }
    ::-webkit-scrollbar-thumb:hover { background: #2A4A6C; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .animate-slide-in { animation: slideIn 0.2s ease-out; }
    .animate-fade-in { animation: fadeIn 0.15s ease-out; }
    .animate-pulse-custom { animation: pulse 2s ease-in-out infinite; }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236B8FA3' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 8px center; padding-right: 28px; }
    .glow-marker { filter: drop-shadow(0 0 8px currentColor); }
    .leaflet-container { background: #0D1117; }
    .leaflet-attribution { background: rgba(10, 22, 40, 0.8); color: #6B8FA3; font-size: 11px; }
    .leaflet-attribution a { color: #00BCD4; }
    .leaflet-control { background: #0F2237; border: 1px solid #1A3A5C; border-radius: 4px; }
    .leaflet-control-zoom-in, .leaflet-control-zoom-out { background: #0F2237; color: #00BCD4; font-weight: bold; border-radius: 4px; }
    .leaflet-control-zoom-in:hover, .leaflet-control-zoom-out:hover { background: #162A3E; }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useMemo, useCallback, useEffect, useRef } = React;

// ─── SUPABASE CONFIG ─────────────────────────────────────
const SUPABASE_URL = 'https://ymgyqoojzqnddeacybah.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltZ3lxb29qenFuZGRlYWN5YmFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MzUyMDksImV4cCI6MjA4NzAxMTIwOX0.pJpLiiRzqY1pYtmR_N7Hgui2AgvUisFidremcoslLaE';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ─── SEED DATA (FALLBACK) ────────────────────────────────
const fallbackData = [
  {
    id:"1", type:"deal_synopsis",
    headline:"Microsoft signs 500MW colo deal with Equinix in Stockholm",
    summary:"Microsoft has signed a 500MW colocation agreement with Equinix for a new hyperscale campus in Stockholm, Sweden. The deal is one of the largest colo agreements in the Nordics and signals accelerating hyperscaler demand in the region. Construction is expected to begin Q3 2026 with first capacity online by Q1 2028.",
    layer:"infrastructure", importance:"high",
    importance_rationale:"Largest colo deal in the Nordics — signals hyperscaler commitment to the region and validates Sweden's power advantage.",
    region:"Stockholm, Sweden", date:"2026-02-15", source_name:"Datacenter Dynamics", source_url:"https://www.datacenterdynamics.com",
    tags:["colo","nordics","hyperscaler","microsoft","equinix"],
    companies:["Microsoft","Equinix"],
    full_data:{
      deal_type:"colo_agreement", deal_value:"undisclosed", capacity_mw:500,
      parties:[{name:"Microsoft",role:"tenant"},{name:"Equinix",role:"landlord"}],
      implications:"Validates Sweden as a tier-1 hyperscale market. Equinix secures long-term anchor tenant for Nordic expansion. Competitors (DigiPlex, Green Mountain) may face increased land/power competition.",
      comparable_context:"Compares to Microsoft's 300MW deal with Digital Realty in Dublin (Q4 2025) and AWS's 400MW AirTrunk lease in Tokyo (Q1 2026)."
    }
  },
  {
    id:"2", type:"financing_event",
    headline:"Digital Realty prices €1.5B green bond at T+145bps",
    summary:"Digital Realty priced a €1.5 billion dual-tranche green bond, with €750M 7-year at T+135bps and €750M 12-year at T+155bps. Proceeds will fund green-certified DC development in Europe. The deal was 3.8x oversubscribed.",
    layer:"financing", importance:"high",
    importance_rationale:"Largest DC green bond in 2026 — pricing signals strong investor appetite for DC credit in Europe.",
    region:"Europe", date:"2026-02-14", source_name:"IFR", source_url:"https://www.reuters.com/finance",
    tags:["green-bond","digital-realty","europe","debt"],
    companies:["Digital Realty"],
    full_data:{
      event_subtype:"green_bond", amount:"€1.5B", currency:"EUR",
      tenor_maturity:"7-year and 12-year tranches", coupon_rate:"3.25% / 3.75%",
      spread:"T+135bps / T+155bps",
      rating:{moodys:"Baa2",sp:"BBB",fitch:"BBB",outlook:"stable"},
      use_of_proceeds:"Green-certified DC development in Frankfurt and Amsterdam.",
      lead_arrangers:["BNP Paribas","Deutsche Bank","J.P. Morgan","Barclays"],
      credit_commentary:"Strong oversubscription (3.8x) confirms robust investor demand for DC credit. Pricing is 10-15bps tighter than DLR's last EUR issuance (Oct 2025), reflecting improved market conditions and sector momentum.",
      comparable_context:"Equinix priced a €1B 10Y at T+150bps in January. DLR's tighter spread reflects similar credit quality but shorter weighted average life."
    }
  },
  {
    id:"3", type:"capex_announcement",
    headline:"Meta raises 2026 DC capex guidance to $65B, up 40% YoY",
    summary:"Meta Platforms raised its 2026 data center capital expenditure guidance to $65 billion, a 40% increase from 2025 spending. CEO Mark Zuckerberg cited AI infrastructure demands as the primary driver. Approximately 30% of the spend is expected to flow to third-party colocation providers.",
    layer:"cross-layer", importance:"high",
    importance_rationale:"Massive capex increase with significant colo allocation — directly benefits Equinix, Digital Realty, and QTS.",
    region:"Global", date:"2026-02-12", source_name:"Reuters", source_url:"https://www.reuters.com",
    tags:["capex","meta","ai","colo-signal","hyperscaler"],
    companies:["Meta"],
    full_data:{
      announced_spend:"$65B", time_horizon:"FY2026",
      breakdown:{self_build:"~70%",colo_leasing:"~30% ($19.5B)",land_power:"Included in self-build"},
      funding_source:"Operating cash flow and existing credit facilities.",
      colo_signal:"Yes — ~$19.5B expected to flow to colo/third-party operators. Meta has historically used Equinix, QTS, and EdgeConnex for rapid market entry. This allocation represents the largest single-year colo spend by any hyperscaler."
    }
  },
  {
    id:"4", type:"regulatory_update",
    headline:"Amsterdam lifts partial DC moratorium, caps new builds at 67MW",
    summary:"The City of Amsterdam has partially lifted its data center moratorium, allowing new builds up to 67MW per facility in designated zones outside the city center. Projects must demonstrate 100% renewable energy sourcing and waste heat recovery plans. The policy takes effect April 1, 2026.",
    layer:"infrastructure", importance:"high",
    importance_rationale:"Reopens one of Europe's most constrained DC markets — significant for operators with land positions in Amsterdam metro.",
    region:"Amsterdam, Netherlands", date:"2026-02-13", source_name:"Dutch News", source_url:"https://www.dutchnews.nl",
    tags:["regulation","moratorium","amsterdam","europe"],
    companies:["Equinix","Digital Realty","Interxion"],
    full_data:{
      jurisdiction:"Amsterdam, Netherlands", regulatory_body:"City of Amsterdam",
      action_type:"moratorium", status:"approved", affected_capacity_mw:67,
      implications:"Releases pent-up demand but with strict environmental conditions. Operators with existing land and grid connections in AMS metro (Equinix/Interxion, Microsoft via its Agriport campus) benefit most. New entrants face 100% renewable + waste heat requirements, raising project costs by an estimated 15-20%."
    }
  },
  {
    id:"5", type:"power_demand_signal",
    headline:"Vattenfall reports 2.4GW of DC interconnection requests in northern Sweden",
    summary:"Vattenfall disclosed that it has received data center interconnection requests totaling 2.4GW across northern Sweden, primarily in the Luleå-Boden corridor. The utility is accelerating grid reinforcement programs but warns that delivery timelines for new connections extend to 2029-2030.",
    layer:"energy", importance:"high",
    importance_rationale:"2.4GW pipeline in northern Sweden alone — signals massive demand concentration and potential grid bottleneck in the Nordics.",
    region:"Luleå, Sweden", date:"2026-02-11", source_name:"Energinyheter", source_url:"https://www.energinyheter.se",
    tags:["power","nordics","vattenfall","grid","interconnection"],
    companies:["Vattenfall","EcoDataCenter","Evroc"],
    full_data:{
      utility_or_grid_operator:"Vattenfall", signal_type:"interconnection_request",
      requested_capacity_mw:2400, timeline:"2029-2030 for new connections",
      associated_dc_operator:"Multiple — includes EcoDataCenter, Evroc, and unnamed hyperscalers",
      utility_opportunity:"Massive growth opportunity for Vattenfall, but grid reinforcement investment required is estimated at SEK 15-20B. Timeline risk is significant — 3-4 year connection wait could redirect demand to Norway or Finland."
    }
  },
  {
    id:"6", type:"deal_synopsis",
    headline:"Blackstone acquires 60% stake in Aligned Data Centers for $3.2B",
    summary:"Blackstone Infrastructure Partners has agreed to acquire a 60% stake in Aligned Data Centers, valuing the company at approximately $5.3 billion. Aligned operates 12 hyperscale campuses across the US with 450MW of capacity. The deal includes a $2B commitment to fund new campus development.",
    layer:"infrastructure", importance:"high",
    importance_rationale:"Third major PE acquisition in DC sector in 6 months — confirms sustained institutional appetite for DC assets at premium valuations.",
    region:"United States", date:"2026-02-10", source_name:"Bloomberg", source_url:"https://www.bloomberg.com",
    tags:["m&a","pe","aligned-dc","blackstone","hyperscale"],
    companies:["Blackstone","Aligned Data Centers"],
    full_data:{
      deal_type:"acquisition", deal_value:"$3.2B (60% stake; $5.3B enterprise value)", capacity_mw:450,
      parties:[{name:"Blackstone Infrastructure Partners",role:"buyer"},{name:"Aligned Data Centers",role:"seller"}],
      implications:"Validates DC as a core infrastructure asset class. Implied valuation of ~$11.8M/MW is a premium to recent comparables. Blackstone's $2B development commitment signals aggressive expansion, likely targeting 1GW+ total capacity.",
      comparable_context:"Compares to KKR's acquisition of CyrusOne at ~$10M/MW (2025) and DigitalBridge's Vantage recapitalization at ~$9.5M/MW (H2 2025). Blackstone paying a 20% premium reflects Aligned's cooling IP and hyperscaler backlog."
    }
  },
  {
    id:"7", type:"supply_chain_signal",
    headline:"Schneider Electric announces 18-month wait for HV transformers in Europe",
    summary:"Schneider Electric has confirmed that lead times for high-voltage transformers in Europe have extended to 18 months, up from 12 months a year ago. The company is investing €500M in new manufacturing capacity in Poland and Spain but says relief won't materialize until late 2027.",
    layer:"supply_chain", importance:"medium",
    importance_rationale:"Transformer lead times directly constrain DC build timelines — any operator planning 2027 delivery without orders placed is at risk.",
    region:"Europe", date:"2026-02-09", source_name:"Energy Monitor", source_url:"https://www.energymonitor.ai",
    tags:["supply-chain","transformers","schneider","lead-times"],
    companies:["Schneider Electric"],
    full_data:{equipment_type:"transformer",signal_type:"lead_time_change",lead_time:"18 months (was 12 months in Q1 2025)",region_affected:"Europe"}
  },
  {
    id:"8", type:"earnings_intelligence",
    headline:"Equinix Q4 2025: Revenue up 12% YoY, raises 2026 capex to $4.2B",
    summary:"Equinix reported Q4 2025 revenue of $2.3B (+12% YoY) with AFFO/share of $9.45. Management raised 2026 capex guidance to $4.2B from $3.8B, citing strong hyperscaler demand, particularly in EMEA. Occupancy remained at 79% globally, with EMEA at 83%.",
    layer:"cross-layer", importance:"high",
    importance_rationale:"Bellwether DC REIT raising capex significantly — confirms sector-wide demand acceleration.",
    region:"Global", date:"2026-02-08", source_name:"Equinix IR", source_url:"https://investor.equinix.com",
    tags:["earnings","equinix","reit","capex","hyperscaler-demand"],
    companies:["Equinix"],
    full_data:{
      period:"Q4 2025",
      key_metrics:{revenue:"$2.3B (+12% YoY)",ebitda:"$1.12B (48.7% margin)",ffo_affo:"AFFO/share: $9.45 (+8% YoY)",capex:"$4.2B guidance (raised from $3.8B)",utilization_occupancy:"79% global, 83% EMEA",bookings_leasing:"$185M in new leasing (record quarter)",backlog:"$1.4B signed-not-commenced",net_debt_leverage:"5.1x Net Debt/EBITDA"},
      guidance_update:"Raised 2026 revenue guidance to $9.4-9.6B (from $9.1-9.3B). Capex raised to $4.2B.",
      capex_commentary:"Management indicated 60% of incremental capex is allocated to EMEA, with new campuses in Stockholm, Madrid, and Warsaw.",
      demand_signals:"Hyperscaler bookings up 35% YoY. Enterprise demand stable. AI-related demand now represents 25% of new bookings.",
      geographic_color:"EMEA strongest region — Stockholm, Frankfurt, and London leading. US secondary markets (Dallas, Phoenix) accelerating. Asia-Pacific steady with Singapore reopening providing tailwind."
    }
  },
  {
    id:"9", type:"news_summary",
    headline:"Crusoe Energy secures $600M Series D to expand AI-optimized DC fleet",
    summary:"Crusoe Energy Systems has closed a $600M Series D funding round led by Fidelity and Valor Equity Partners. The company plans to deploy capital toward expanding its fleet of AI-optimized data centers powered by stranded natural gas and renewable energy.",
    layer:"infrastructure", importance:"medium",
    importance_rationale:"Validates the energy-first DC model and AI-optimized design approach — Crusoe is a key player to watch in the design-sovereign segment.",
    region:"United States", date:"2026-02-07", source_name:"TechCrunch", source_url:"https://techcrunch.com",
    tags:["funding","crusoe","ai","energy","series-d"],
    companies:["Crusoe Energy Systems"],
    full_data:{}
  },
  {
    id:"10", type:"power_demand_signal",
    headline:"Constellation Energy signs 1GW nuclear PPA with AWS for DC campus",
    summary:"Constellation Energy has signed a 15-year power purchase agreement with Amazon Web Services for 1GW of nuclear-sourced power from its Susquehanna facility. The PPA will support AWS's planned 1.2GW data center campus near Berwick, Pennsylvania.",
    layer:"energy", importance:"high",
    importance_rationale:"Largest single nuclear PPA for DC use — sets pricing benchmark and validates nuclear as baseload for hyperscale.",
    region:"Pennsylvania, United States", date:"2026-02-06", source_name:"Utility Dive", source_url:"https://www.utilitydive.com",
    tags:["nuclear","ppa","aws","constellation","energy"],
    companies:["Constellation Energy","Amazon/AWS"],
    full_data:{
      utility_or_grid_operator:"Constellation Energy", signal_type:"ppa_signing",
      requested_capacity_mw:1000, dc_operator:"Amazon Web Services",
      timeline:"15-year term, delivery beginning 2027",
      utility_opportunity:"Validates nuclear as premium baseload for DC. At estimated pricing of $45-55/MWh, Constellation achieves significant premium to wholesale market. Sets precedent for other nuclear operators (Vistra, Talen) to pursue similar structures."
    }
  },
  {
    id:"11", type:"executive_move",
    headline:"Former Fortum VP of Grid joins EcoDataCenter as COO",
    summary:"EcoDataCenter has hired Mats Lindqvist, formerly VP of Grid Development at Fortum, as its new Chief Operating Officer. The hire signals EcoDataCenter's focus on securing grid capacity in the Nordics as competition for power connections intensifies.",
    layer:"infrastructure", importance:"medium",
    importance_rationale:"Signals EcoDataCenter's strategic priority on grid access — the key bottleneck in Nordic DC development.",
    region:"Sweden", date:"2026-02-05", source_name:"Data Economy", source_url:"https://www.dataeconomy.com",
    tags:["executive","ecodatacenter","nordics","grid"],
    companies:["EcoDataCenter","Fortum"],
    full_data:{person:"Mats Lindqvist",from_company:"Fortum",from_role:"VP of Grid Development",to_company:"EcoDataCenter",to_role:"Chief Operating Officer"}
  },
  {
    id:"12", type:"financing_event",
    headline:"Switch closes $2.1B credit facility for Las Vegas campus expansion",
    summary:"Switch Inc. has closed a $2.1 billion senior secured credit facility with a syndicate led by Goldman Sachs and Morgan Stanley. The facility includes a $1.5B term loan and $600M revolving credit facility, both maturing in 2031.",
    layer:"financing", importance:"medium",
    importance_rationale:"Large credit facility for a single-site operator — pricing will be watched as a benchmark for non-investment-grade DC credit.",
    region:"Las Vegas, United States", date:"2026-02-04", source_name:"LCD", source_url:"https://www.lcdmarkets.com",
    tags:["debt","switch","credit-facility","las-vegas"],
    companies:["Switch"],
    full_data:{
      event_subtype:"revolving_credit", amount:"$2.1B", currency:"USD",
      tenor_maturity:"due 2031", coupon_rate:"SOFR + 250bps", spread:"SOFR+250bps",
      rating:{moodys:"Ba2",sp:"BB",fitch:null,outlook:"stable"},
      use_of_proceeds:"SUPERNAP campus expansion in Las Vegas — 200MW incremental capacity.",
      lead_arrangers:["Goldman Sachs","Morgan Stanley"],
      credit_commentary:"Pricing at SOFR+250bps is ~75bps wider than investment-grade DC peers, reflecting Switch's higher leverage and single-market concentration risk. Management targets IG rating by 2028.",
      comparable_context:"QTS (Blackstone) priced a $1.8B TLB at SOFR+200bps in Q4 2025 — 50bps tighter, reflecting Blackstone's implicit credit support."
    }
  },
  {
    id:"13", type:"regulatory_update",
    headline:"Ireland introduces DC water usage cap of 500,000 litres/day per facility",
    summary:"The Irish government has introduced a new regulation capping water usage for data center cooling at 500,000 litres per day per facility, effective January 2027. Facilities exceeding the cap must implement closed-loop or air-cooling systems.",
    layer:"infrastructure", importance:"medium",
    importance_rationale:"Adds operational cost and design constraints for Dublin-area DCs — benefits operators already using air-cooling.",
    region:"Dublin, Ireland", date:"2026-02-03", source_name:"Irish Times", source_url:"https://www.irishtimes.com",
    tags:["regulation","ireland","water","cooling"],
    companies:["Equinix","Microsoft","Digital Realty"],
    full_data:{
      jurisdiction:"Ireland", regulatory_body:"Department of Environment",
      action_type:"water_use_restriction", status:"approved",
      implications:"Forces operators to invest in closed-loop or air cooling. Estimated 10-15% increase in cooling capex for non-compliant facilities. Benefits Nordic operators marketing cold-climate cooling as an alternative."
    }
  },
  {
    id:"14", type:"deal_synopsis",
    headline:"Evroc secures €800M from EQT for sovereign cloud DC network in Europe",
    summary:"Swedish startup Evroc has closed €800M in funding from EQT Infrastructure to build a network of sovereign cloud data centers across Europe. Initial sites are planned in Sweden, Finland, and Germany.",
    layer:"infrastructure", importance:"high",
    importance_rationale:"Major bet on European digital sovereignty — directly competes with hyperscaler public cloud offerings for government contracts.",
    region:"Europe (Sweden, Finland, Germany)", date:"2026-02-01", source_name:"Financial Times", source_url:"https://www.ft.com",
    tags:["evroc","sovereign-cloud","eqt","nordics","europe"],
    companies:["Evroc","EQT"],
    full_data:{
      deal_type:"investment", deal_value:"€800M",
      parties:[{name:"EQT Infrastructure",role:"investor"},{name:"Evroc",role:"recipient"}],
      implications:"Validates European sovereign cloud as a distinct market segment. Evroc's Nordic-first approach leverages cheap renewable power and GDPR compliance.",
      comparable_context:"Compares to OVHcloud's €350M IPO (2021) and Ionos's PE backing. EQT's commitment is significantly larger, reflecting higher conviction in the sovereign thesis post-US Cloud Act concerns."
    }
  },
  {
    id:"15", type:"supply_chain_signal",
    headline:"Vertiv reports record $8.2B backlog, 30-week lead times on cooling units",
    summary:"Vertiv Holdings reported a record $8.2 billion backlog in its Q4 earnings, driven by surging DC demand. Lead times for large-scale cooling units have extended to 30 weeks.",
    layer:"supply_chain", importance:"medium",
    importance_rationale:"Record backlog and extended lead times confirm supply chain remains a bottleneck for DC build timelines globally.",
    region:"Global", date:"2026-01-30", source_name:"Vertiv IR", source_url:"https://investor.vertiv.com",
    tags:["supply-chain","vertiv","cooling","backlog"],
    companies:["Vertiv"],
    full_data:{equipment_type:"cooling_system",signal_type:"order_backlog",lead_time:"30 weeks",region_affected:"Global"}
  },
  {
    id:"16", type:"news_summary",
    headline:"Green Mountain opens 40MW underground DC in Rennesøy, Norway",
    summary:"Green Mountain has opened its newest data center facility inside a former NATO ammunition storage facility on the island of Rennesøy in western Norway. The 40MW facility uses fjord water cooling and is powered entirely by Norwegian hydropower.",
    layer:"infrastructure", importance:"low",
    importance_rationale:"Niche but notable — demonstrates the Nordics' unique advantage in repurposing existing infrastructure for sustainable DC operations.",
    region:"Rennesøy, Norway", date:"2026-01-28", source_name:"Datacenter Dynamics", source_url:"https://www.datacenterdynamics.com",
    tags:["green-mountain","norway","nordics","sustainable","hydro"],
    companies:["Green Mountain"],
    full_data:{}
  },
  {
    id:"17", type:"deal_synopsis",
    headline:"KKR closes CyrusOne acquisition, completes $10M/MW integration",
    summary:"KKR has successfully closed its acquisition of CyrusOne for $15B, establishing the firm as a major DC platform operator. The deal closure includes full integration of CyrusOne's 650MW portfolio across 50+ facilities.",
    layer:"infrastructure", importance:"high",
    importance_rationale:"Validates PE appetite for DC consolidation and establishes $10M/MW as a key market valuation benchmark.",
    region:"United States", date:"2025-08-15", source_name:"Bloomberg", source_url:"https://www.bloomberg.com",
    tags:["m&a","pe","kkr","cyrusone","consolidation"],
    companies:["KKR","CyrusOne"],
    full_data:{deal_type:"acquisition",deal_value:"$15B",capacity_mw:650,parties:[{name:"KKR",role:"buyer"},{name:"CyrusOne",role:"seller"}],implications:"Signals strong institutional capital deployment. KKR's value-add strategy focuses on operational efficiencies and capex for hyperscaler buildout."}
  },
  {
    id:"18", type:"deal_synopsis",
    headline:"DigitalBridge completes $2B Vantage Data Centers recapitalization",
    summary:"DigitalBridge has completed a $2B recapitalization of Vantage Data Centers, marking one of the largest DC secondary transactions. The transaction values Vantage at approximately $9.5B enterprise value.",
    layer:"infrastructure", importance:"high",
    importance_rationale:"Major secondary transaction signals sustained PE appetite for mature DC platforms with strong credit profiles.",
    region:"Global", date:"2025-09-08", source_name:"DealFlow", source_url:"https://www.dealflow.com",
    tags:["recapitalization","digitalbridge","vantage","pe"],
    companies:["DigitalBridge","Vantage Data Centers"],
    full_data:{deal_type:"recapitalization",deal_value:"$2B",partners:[{name:"DigitalBridge",role:"investor"},{name:"Vantage Data Centers",role:"recipient"}],implications:"Unlocks capital for Vantage growth while establishing DigitalBridge as a lead DC investor."}
  },
  {
    id:"19", type:"capex_announcement",
    headline:"CoreWeave IPO prices at $23B valuation amid AI GPU demand surge",
    summary:"CoreWeave completed its IPO at a $23B valuation, pricing above initial guidance. The AI-optimized infrastructure provider's first-day trading saw valuations surge to approximately $30B as investors bet on sustained GPU capacity demand.",
    layer:"chip", importance:"high",
    importance_rationale:"CoreWeave's public market entry validates demand for specialized AI infrastructure and sets valuation precedent for compute-focused DC operators.",
    region:"United States", date:"2025-09-18", source_name:"Reuters", source_url:"https://www.reuters.com",
    tags:["ipo","coreweave","ai","gpu","infrastructure"],
    companies:["CoreWeave"],
    full_data:{event_subtype:"ipo",valuation:"$23B IPO, $30B+ trading",first_day_trading:"+30%"}
  },
  {
    id:"20", type:"financing_event",
    headline:"Equinix prices €1B 10-year bond at T+150bps amid strong demand",
    summary:"Equinix has priced a €1B senior unsecured 10-year bond at T+150bps, with strong institutional demand. The bond was 2.5x oversubscribed.",
    layer:"financing", importance:"high",
    importance_rationale:"REIT-rated bond pricing remains favorable despite rate environment; confirms steady capital access for tier-1 operators.",
    region:"Europe", date:"2025-10-05", source_name:"IFR", source_url:"https://www.reuters.com/finance",
    tags:["green-bond","equinix","europe","debt","reit"],
    companies:["Equinix"],
    full_data:{event_subtype:"senior_notes",amount:"€1B",tenor_maturity:"10-year",spread:"T+150bps",rating:{moodys:"Baa3",sp:"BBB-"},use_of_proceeds:"European expansion including Stockholm campus development."}
  },
  {
    id:"21", type:"financing_event",
    headline:"QTS (Blackstone) closes $1.8B term loan at SOFR+200bps",
    summary:"QTS Realty Trust, backed by Blackstone, has closed a $1.8B term loan B facility at SOFR+200bps, maturing in 2032. The financing supports 250MW of incremental capacity deployment.",
    layer:"financing", importance:"high",
    importance_rationale:"HY-rated facility demonstrates sponsor support; 200bps spread reflects improving credit conditions vs peers.",
    region:"United States", date:"2025-10-20", source_name:"LCD", source_url:"https://www.lcdmarkets.com",
    tags:["debt","qts","blackstone","tlb","infrastructure"],
    companies:["QTS Realty Trust","Blackstone"],
    full_data:{event_subtype:"term_loan_b",amount:"$1.8B",tenor_maturity:"2032",coupon_rate:"SOFR+200",spread:"SOFR+200bps",rating:{moodys:"Ba1",sp:"BB+"},use_of_proceeds:"Incremental hyperscaler capacity expansion across Tier 1 markets."}
  },
  {
    id:"22", type:"capex_announcement",
    headline:"Brookfield announces $9.8B Sweden AI data center facility",
    summary:"Brookfield Asset Management has announced a $9.8B investment to develop a major AI-focused data center campus in Sweden. The facility will span 500MW+ of capacity and is expected to complete by 2027.",
    layer:"cross-layer", importance:"high",
    importance_rationale:"Brookfield's Nordic investment validates region's position as a tier-1 AI infrastructure hub; $20M/MW implies premium for power economics.",
    region:"Sweden", date:"2025-11-02", source_name:"Bloomberg", source_url:"https://www.bloomberg.com",
    tags:["capex","brookfield","ai","nordics","hyperscale"],
    companies:["Brookfield Asset Management"],
    full_data:{announced_spend:"$9.8B",capacity_mw:500,timeline:"2027 completion",funding_source:"Brookfield Growth Fund capital and project finance"}
  },
  {
    id:"23", type:"capex_announcement",
    headline:"Microsoft announces $10B Portugal data center complex in Sines",
    summary:"Microsoft has committed $10B to develop a large-scale data center complex in Sines, Portugal. The facility will target 250MW of capacity and prioritize renewable energy integration with local wind and solar assets.",
    layer:"cross-layer", importance:"high",
    importance_rationale:"Major Western European capacity addition by hyperscaler; signals shift away from constrained markets like Frankfurt and Amsterdam.",
    region:"Sines, Portugal", date:"2025-11-08", source_name:"Datacenter Dynamics", source_url:"https://www.datacenterdynamics.com",
    tags:["capex","microsoft","europe","hyperscaler","renewable"],
    companies:["Microsoft"],
    full_data:{announced_spend:"$10B",capacity_mw:250,timeline:"2028 first phase",power_sourcing:"100% renewable via wind and solar PPAs"}
  },
  {
    id:"24", type:"capex_announcement",
    headline:"Google commits €5.5B to Germany expansion amid Frankfurt constraints",
    summary:"Google has announced a €5.5B investment to expand its data center footprint in Germany, focusing on sites outside Frankfurt to bypass city-level congestion. The phased expansion targets 150MW of incremental capacity.",
    layer:"cross-layer", importance:"high",
    importance_rationale:"Major hyperscaler re-routing around Frankfurt moratorium; validates market-wide capacity constraints and valuation benefits for alternative sites.",
    region:"Germany", date:"2025-11-15", source_name:"Tech in Europe", source_url:"https://www.techineurope.com",
    tags:["capex","google","germany","hyperscaler","expansion"],
    companies:["Google"],
    full_data:{announced_spend:"€5.5B",capacity_mw:150,timeline:"phased 2027-2029",geographic_focus:"Bavaria, Düsseldorf, Hamburg"}
  },
  {
    id:"25", type:"capex_announcement",
    headline:"Stargate (OpenAI-Nvidia) announces multi-billion Norway hydro facility",
    summary:"The Stargate consortium has revealed plans for a multi-GW data center facility powered by hydroelectric capacity in Norway. Initial announcements suggest $5B+ investment and 500MW+ capacity targeting 2027-2028 delivery.",
    layer:"chip", importance:"high",
    importance_rationale:"Stargate's Nordic footprint signals confidence in region's power advantage for AI compute; validates hyperscaler northern migration thesis.",
    region:"Norway", date:"2025-12-02", source_name:"Financial Times", source_url:"https://www.ft.com",
    tags:["stargate","ai","compute","nordic","hydropower"],
    companies:["Stargate Consortium","OpenAI","NVIDIA"],
    full_data:{funding_source:"Stargate Consortium (OpenAI, SoftBank, NVIDIA, others)",capacity_mw:500,power_source:"Norwegian hydro",timeline:"2027-2028 ramp"}
  },
  {
    id:"26", type:"power_demand_signal",
    headline:"Amazon FCF concerns emerge; analysts flag $17-28B annual deficit risk",
    summary:"Investment analysts have raised concerns about Amazon's free cash flow sustainability amid massive data center capex acceleration. Some estimates project Amazon could face $17-28B annual FCF deficits through 2027 if capex continues at current pace.",
    layer:"energy", importance:"high",
    importance_rationale:"FCF concerns for largest hyperscaler could signal moderation in capex acceleration; affects DC contractor and equipment vendor revenues.",
    region:"Global", date:"2025-12-15", source_name:"Goldman Sachs Equity Research", source_url:"https://www.gs.com",
    tags:["amazon","fcf","capex","hyperscaler","risk"],
    companies:["Amazon/AWS"],
    full_data:{analyst_projection:"$17-28B annual FCF deficit",time_horizon:"2026-2027",key_driver:"DC capex spending"}
  },
  {
    id:"27", type:"deal_synopsis",
    headline:"CoreWeave expands UK presence with $1.3B dual-facility announcement",
    summary:"Following its IPO success, CoreWeave has announced $1.3B in new UK data center capacity, targeting 60MW across two facilities in London and Manchester. The facilities will emphasize AI-GPU optimization.",
    layer:"infrastructure", importance:"medium",
    importance_rationale:"Post-IPO capital deployment signals CoreWeave aggressively pursuing European AI DC market; validates UK demand.",
    region:"London and Manchester, UK", date:"2026-01-05", source_name:"VentureBeat", source_url:"https://www.venturebeat.com",
    tags:["coreweave","uk","ai","expansion"],
    companies:["CoreWeave"],
    full_data:{investment_amount:"$1.3B",capacity_mw:60,facilities:2,target_market:"AI and GPU-optimized infrastructure"}
  },
  {
    id:"28", type:"deal_synopsis",
    headline:"KKR and Oak Hill Advisors announce €2B pan-European DC platform",
    summary:"KKR and Oak Hill Advisors have partnered to form a pan-European data center platform with approximately $2B in committed capital. The platform targets acquisition and development of 300+ MW across Nordics, Germany, and Benelux.",
    layer:"infrastructure", importance:"high",
    importance_rationale:"KKR's second major DC platform signals commitment to geographic diversification; €2B platform supports 200+ MW buildout.",
    region:"Europe (Nordics, Germany, Benelux)", date:"2026-01-08", source_name:"Bloomberg", source_url:"https://www.bloomberg.com",
    tags:["kkr","oak-hill","pe","europe","platform"],
    companies:["KKR","Oak Hill Advisors"],
    full_data:{deal_value:"€2B",parties:[{name:"KKR",role:"lead investor"},{name:"Oak Hill Advisors",role:"co-investor"}],target_capacity_mw:300,geographic_focus:"Nordic, German, Benelux markets"}
  },
  {
    id:"29", type:"capex_announcement",
    headline:"TikTok announces €1B+ Finland hyperscale DC investment",
    summary:"TikTok has unveiled a €1B+ commitment to develop hyperscale data center capacity in Finland as part of its European digital sovereignty strategy. The facility will target 80MW+ capacity and 100% renewable energy sourcing.",
    layer:"cross-layer", importance:"high",
    importance_rationale:"Major tech company bet on Finnish infrastructure; validates Nordic data residency value amid regulatory uncertainty.",
    region:"Finland", date:"2026-01-12", source_name:"Reuters", source_url:"https://www.reuters.com",
    tags:["tiktok","capex","finland","nordics","sovereignty"],
    companies:["TikTok"],
    full_data:{investment:"€1B+",capacity_mw:80,power_source:"100% renewable energy",regulatory_driver:"EU digital sovereignty and data residency requirements"}
  },
  {
    id:"30", type:"regulatory_update",
    headline:"Frankfurt grid constraints force operators 30-40 miles west to alternative sites",
    summary:"Frankfurt's grid infrastructure has reached effective capacity limits, forcing major data center operators to route new projects 30-40 miles west to Darmstadt and Wiesbaden. Local utilities confirm no new large-capacity connections available through 2027.",
    layer:"energy", importance:"high",
    importance_rationale:"Hard capacity constraints in Frankfurt are accelerating decentralization of German DC market; benefits alternative hubs.",
    region:"Frankfurt, Germany", date:"2026-01-15", source_name:"Energy Monitor", source_url:"https://www.energymonitor.ai",
    tags:["grid","frankfurt","constraint","germany","capacity"],
    companies:["Mainova","NetCologne"],
    full_data:{jurisdiction:"Frankfurt, Germany",action_type:"capacity_exhaustion",affected_capacity_mw:"no new >30MW connections available",implications:"Operators forced to develop outside Frankfurt metropolitan area; supports alternative hubs like Darmstadt, Mainz."}
  },
  {
    id:"31", type:"regulatory_update",
    headline:"Germany Energy Efficiency Act mandates PUE 1.2 for new DC facilities",
    summary:"Germany's revised Energy Efficiency Act has mandated that all new data center facilities achieve a Power Usage Effectiveness (PUE) ratio of 1.2 or better, effective January 2026. Facilities exceeding this threshold face escalating energy taxes.",
    layer:"infrastructure", importance:"high",
    importance_rationale:"Strict PUE mandate raises capex for new German builds by estimated 15-25%; benefits operators with efficient cooling IP.",
    region:"Germany", date:"2026-01-18", source_name:"Bundesanzeiger", source_url:"https://www.bundesanzeiger.de",
    tags:["regulation","germany","pue","energy-efficiency"],
    companies:["Equinix","Digital Realty","Interxion"],
    full_data:{jurisdiction:"Germany",regulatory_body:"Federal Government",action_type:"pue_mandate",status:"effective",required_pue:1.2,implications:"Raises capex by 15-25% for new builds; penalizes inefficient cooling. Benefits vendors like Schneider, Vertiv with advanced cooling."}
  },
  {
    id:"32", type:"deal_synopsis",
    headline:"Brookfield and Data4 announce €20B France AI infrastructure partnership",
    summary:"Brookfield and Data4 have entered a partnership to develop €20B worth of AI-focused data center infrastructure across France. The program targets 1,000+ MW of capacity by 2029, focusing on Paris, Lyon, and Marseille.",
    layer:"cross-layer", importance:"high",
    importance_rationale:"Brookfield-Data4 partnership signals massive Western Europe AI capacity buildout; €20B scale unprecedented for single-country program.",
    region:"Paris, Lyon, Marseille, France", date:"2026-01-20", source_name:"Financial Times", source_url:"https://www.ft.com",
    tags:["brookfield","data4","france","ai","partnership"],
    companies:["Brookfield","Data4"],
    full_data:{investment:"€20B",target_capacity_mw:1000,timeline:"2029 completion",geographic_focus:"Paris region (40%), Lyon (35%), Marseille (25%)",power_strategy:"1.5GW+ renewable energy PPAs"}
  },
  {
    id:"33", type:"capex_announcement",
    headline:"Mistral AI partners with NVIDIA to deploy 18K Grace Blackwell GPUs in France",
    summary:"Mistral AI, Europe's leading AI startup, has announced a partnership with NVIDIA to deploy approximately 18,000 Grace Blackwell GPUs across French data centers. The deployment requires 250MW+ of dedicated power capacity.",
    layer:"chip", importance:"high",
    importance_rationale:"European AI champion's GPU investment signals accelerating demand for local AI compute infrastructure; validates French DC market thesis.",
    region:"France", date:"2026-01-23", source_name:"VentureBeat", source_url:"https://www.venturebeat.com",
    tags:["mistral","nvidia","ai","gpu","france"],
    companies:["Mistral AI","NVIDIA"],
    full_data:{gpu_count:18000,power_requirement_mw:250,deployment_timeframe:"2026-2027",licensing:"NVIDIA Grace Blackwell"}
  },
  {
    id:"34", type:"news_summary",
    headline:"Big tech market cap loss hits $900B across Feb 3-7 amid AI capex concerns",
    summary:"Major technology companies experienced significant market cap declines from February 3-7, 2026, as investors reassessed AI infrastructure capex trajectories and FCF impacts. Combined losses across the Magnificent 7 reached approximately $900B.",
    layer:"cross-layer", importance:"high",
    importance_rationale:"Market repricing of tech capex creates valuation opportunity for DC operators; signals moderation in growth expectations.",
    region:"Global", date:"2026-02-07", source_name:"Bloomberg", source_url:"https://www.bloomberg.com",
    tags:["market","tech","capex","valuation"],
    companies:["Microsoft","Google","Amazon","Meta","Apple","NVIDIA","Tesla"],
    full_data:{market_cap_loss_usd:"$900B",time_period:"Feb 3-7, 2026",key_driver:"AI capex deceleration concerns"}
  },
  {
    id:"35", type:"capex_announcement",
    headline:"Stargate consortium releases $100B initial deployment plan",
    summary:"The Stargate consortium (OpenAI, SoftBank, NVIDIA, others) has released details of its initial $100B deployment plan, targeting 5+ GW of AI compute capacity across US, Europe, and Asia by 2030. First phase focuses on US and Nordic facilities.",
    layer:"chip", importance:"high",
    importance_rationale:"Stargate's $100B program represents largest single AI infrastructure commitment; validates decades of DC demand.",
    region:"Global", date:"2026-02-08", source_name:"Wall Street Journal", source_url:"https://www.wsj.com",
    tags:["stargate","capex","ai","compute","consortium"],
    companies:["Stargate Consortium","OpenAI","SoftBank","NVIDIA"],
    full_data:{total_commitment:"$100B",target_capacity_gw:5,timeline:"2030 completion",geographic_focus:"US (50%), Europe (30%), Asia (20%)"}
  },
  {
    id:"36", type:"capex_announcement",
    headline:"xAI reveals Colossus Memphis facility: 2GW capacity, 555K H100 GPUs",
    summary:"Elon Musk's xAI has revealed technical specifications for its Colossus Memphis data center facility. The 2GW hyperscale facility will house approximately 555,000 H100 GPUs and will serve as xAI's primary training compute hub for large language models.",
    layer:"chip", importance:"high",
    importance_rationale:"xAI's massive GPU deployment signals competitive dynamics in AI infrastructure; validates Memphis as emerging compute hub.",
    region:"Memphis, Tennessee", date:"2026-02-12", source_name:"TechCrunch", source_url:"https://techcrunch.com",
    tags:["xai","gpu","memphis","hyperscale","ai"],
    companies:["xAI"],
    full_data:{facility_name:"Colossus Memphis",power_capacity_gw:2,gpu_count:555000,gpu_type:"H100",power_source:"TVA nuclear and renewable partnerships"}
  }
];

const fallbackCalendarEvents = [
  {id:"e1",event_type:"conference",title:"DCD>Connect Stockholm",description:"Nordic DC conference",location:"Stockholm, Sweden",start_date:"2026-03-12",end_date:"2026-03-13"},
  {id:"e2",event_type:"earnings",title:"Equinix Q1 2026 Earnings",description:"Q1 results",company:"Equinix",start_date:"2026-04-24"},
  {id:"e3",event_type:"earnings",title:"Digital Realty Q1 2026 Earnings",description:"Q1 results",company:"Digital Realty",start_date:"2026-04-28"},
  {id:"e4",event_type:"conference",title:"Datacloud Global Congress",description:"Monaco",location:"Monaco",start_date:"2026-06-02",end_date:"2026-06-04"},
  {id:"e5",event_type:"conference",title:"RE+ 2026",description:"Renewable energy + storage",location:"Anaheim, CA",start_date:"2026-09-08",end_date:"2026-09-11"},
  {id:"e6",event_type:"regulatory_deadline",title:"Amsterdam moratorium partial lift",description:"New DC builds up to 67MW allowed in designated zones",location:"Amsterdam",start_date:"2026-04-01"},
  {id:"e7",event_type:"bond_maturity",title:"Switch $800M Senior Notes maturity",company:"Switch",start_date:"2026-09-15",description:"7.5% Senior Notes due Sept 2026"},
  {id:"e8",event_type:"earnings",title:"NVIDIA Q1 FY2027 Earnings",description:"Q1 results",company:"NVIDIA",start_date:"2026-05-21"},
];

const fallbackMarketHeatmap = [
  {region:"Northern Virginia",news_count:24,deal_count:8,total_mw:1200,heat_score:95},
  {region:"Stockholm / Nordics",news_count:22,deal_count:6,total_mw:1100,heat_score:92},
  {region:"Frankfurt",news_count:15,deal_count:4,total_mw:650,heat_score:82},
  {region:"Dallas / Texas",news_count:14,deal_count:6,total_mw:800,heat_score:80},
  {region:"Paris / France",news_count:18,deal_count:6,total_mw:500,heat_score:75},
  {region:"Dublin",news_count:12,deal_count:3,total_mw:400,heat_score:72},
  {region:"Spain",news_count:8,deal_count:3,total_mw:450,heat_score:72},
  {region:"London",news_count:11,deal_count:3,total_mw:350,heat_score:70},
  {region:"Phoenix / Arizona",news_count:9,deal_count:4,total_mw:550,heat_score:68},
  {region:"Amsterdam",news_count:10,deal_count:2,total_mw:200,heat_score:65},
  {region:"Tokyo",news_count:7,deal_count:3,total_mw:400,heat_score:60},
  {region:"Singapore",news_count:8,deal_count:2,total_mw:180,heat_score:55},
];

const mapMarkets = [
  {id:"nova", label:"Northern Virginia", lat:38.9, lng:-77.4, score:95, mw:1200, deals:8},
  {id:"dallas", label:"Dallas / Texas", lat:32.8, lng:-96.8, score:80, mw:800, deals:6},
  {id:"phoenix", label:"Phoenix / Arizona", lat:33.4, lng:-112.0, score:68, mw:550, deals:4},
  {id:"stockholm", label:"Stockholm / Nordics", lat:59.3, lng:18.1, score:92, mw:1100, deals:6},
  {id:"lulea", label:"Luleå / Northern Sweden", lat:65.6, lng:22.1, score:78, mw:2400, deals:4},
  {id:"frankfurt", label:"Frankfurt", lat:50.1, lng:8.7, score:82, mw:650, deals:4},
  {id:"paris", label:"Paris / France", lat:48.9, lng:2.3, score:75, mw:500, deals:4},
  {id:"spain", label:"Spain", lat:40.4, lng:-3.7, score:72, mw:450, deals:3},
  {id:"london", label:"London", lat:51.5, lng:-0.1, score:70, mw:350, deals:3},
  {id:"dublin", label:"Dublin", lat:53.3, lng:-6.3, score:72, mw:400, deals:3},
  {id:"amsterdam", label:"Amsterdam", lat:52.4, lng:4.9, score:65, mw:200, deals:2},
  {id:"tokyo", label:"Tokyo", lat:35.7, lng:139.7, score:60, mw:400, deals:3},
  {id:"singapore", label:"Singapore", lat:1.3, lng:103.8, score:55, mw:180, deals:2},
];

const fallbackFinancingComps = [
  {issuer:"Digital Realty",type:"Green Bond (7Y)",amount:"€750M",tenor:"7-year",coupon:"3.25%",spread_bps:135,rating:"Baa2/BBB",date:"2026-02-14",source_name:"IFR/Reuters",source_url:"https://www.reuters.com/finance"},
  {issuer:"Digital Realty",type:"Green Bond (12Y)",amount:"€750M",tenor:"12-year",coupon:"3.75%",spread_bps:155,rating:"Baa2/BBB",date:"2026-02-14",source_name:"IFR/Reuters",source_url:"https://www.reuters.com/finance"},
  {issuer:"Equinix",type:"Senior Notes (10Y)",amount:"€1.0B",tenor:"10-year",coupon:"3.50%",spread_bps:150,rating:"Baa3/BBB-",date:"2026-01-22",source_name:"Equinix IR",source_url:"https://investor.equinix.com"},
  {issuer:"Switch",type:"Term Loan B",amount:"$1.5B",tenor:"5-year",coupon:"SOFR+250",spread_bps:250,rating:"Ba2/BB",date:"2026-02-04",source_name:"LCD Markets",source_url:"https://www.lcdmarkets.com"},
  {issuer:"Switch",type:"Revolver",amount:"$600M",tenor:"5-year",coupon:"SOFR+250",spread_bps:250,rating:"Ba2/BB",date:"2026-02-04",source_name:"LCD Markets",source_url:"https://www.lcdmarkets.com"},
  {issuer:"QTS (Blackstone)",type:"Term Loan B",amount:"$1.8B",tenor:"7-year",coupon:"SOFR+200",spread_bps:200,rating:"Ba1/BB+",date:"2025-11-15",source_name:"Bloomberg",source_url:"https://www.bloomberg.com"},
  {issuer:"CyrusOne",type:"Senior Notes",amount:"$1.2B",tenor:"8-year",coupon:"4.50%",spread_bps:180,rating:"Baa3/BBB-",date:"2025-10-01",source_name:"IFR",source_url:"https://www.reuters.com"},
  {issuer:"Vantage",type:"Project Finance",amount:"$2.0B",tenor:"10-year",coupon:"SOFR+175",spread_bps:175,rating:"N/R",date:"2025-09-20",source_name:"PFI",source_url:"https://www.pfie.com"},
];

// ─── DEMAND PIPELINE SEED DATA ──────────────────────────
const demandPipelineData = [
  {region:"Northern Virginia",operator:"AWS",capacity_mw:600,status:"Under Construction",ppa_terms:"Nuclear PPA, ~$50/MWh",grid:"Connected",timeline:"Q3 2027",source:"AWS press release"},
  {region:"Northern Virginia",operator:"Microsoft",capacity_mw:500,status:"Announced",ppa_terms:"Renewable PPA, ~$35/MWh",grid:"In Queue",timeline:"2028",source:"Bloomberg"},
  {region:"Northern Virginia",operator:"Google",capacity_mw:400,status:"Under Construction",ppa_terms:"Mixed, ~$45/MWh",grid:"Connected",timeline:"Q1 2027",source:"Datacenter Dynamics"},
  {region:"Dallas, TX",operator:"Meta",capacity_mw:800,status:"Announced",ppa_terms:"Solar+Storage, ~$30/MWh",grid:"Pending",timeline:"2028-2029",source:"Reuters"},
  {region:"Dallas, TX",operator:"QTS (Blackstone)",capacity_mw:300,status:"Under Construction",ppa_terms:"Grid, market rate",grid:"Connected",timeline:"Q4 2026",source:"QTS IR"},
  {region:"Phoenix, AZ",operator:"Microsoft",capacity_mw:500,status:"Announced",ppa_terms:"Solar, ~$28/MWh",grid:"In Queue",timeline:"2028",source:"AZ Republic"},
  {region:"Phoenix, AZ",operator:"Apple",capacity_mw:200,status:"Delivered",ppa_terms:"Solar+Storage, ~$32/MWh",grid:"Connected",timeline:"Operational",source:"Apple sustainability report"},
  {region:"Chicago, IL",operator:"Equinix",capacity_mw:250,status:"Under Construction",ppa_terms:"Wind PPA, ~$38/MWh",grid:"Connected",timeline:"Q2 2027",source:"Equinix IR"},
  {region:"Stockholm, Sweden",operator:"Microsoft",capacity_mw:500,status:"Announced",ppa_terms:"Hydro, ~€25/MWh",grid:"In Queue",timeline:"2028",source:"Datacenter Dynamics"},
  {region:"Stockholm, Sweden",operator:"Equinix",capacity_mw:200,status:"Under Construction",ppa_terms:"Hydro, ~€28/MWh",grid:"Connected",timeline:"Q4 2027",source:"Equinix IR"},
  {region:"Luleå, Sweden",operator:"EcoDataCenter",capacity_mw:150,status:"Under Construction",ppa_terms:"Hydro+Wind, ~€22/MWh",grid:"Pending",timeline:"2027",source:"EcoDataCenter PR"},
  {region:"Luleå, Sweden",operator:"Evroc",capacity_mw:200,status:"Announced",ppa_terms:"TBD",grid:"In Queue",timeline:"2028-2029",source:"Financial Times"},
  {region:"Dublin, Ireland",operator:"Microsoft",capacity_mw:300,status:"Under Construction",ppa_terms:"Offshore wind, ~€55/MWh",grid:"Connected",timeline:"Q1 2027",source:"Irish Times"},
  {region:"Dublin, Ireland",operator:"AWS",capacity_mw:200,status:"Announced",ppa_terms:"Wind, ~€48/MWh",grid:"Pending",timeline:"2028",source:"Bloomberg"},
  {region:"Frankfurt, Germany",operator:"Digital Realty",capacity_mw:200,status:"Under Construction",ppa_terms:"Solar+Grid, ~€45/MWh",grid:"Connected",timeline:"Q3 2027",source:"DLR IR"},
  {region:"Amsterdam, Netherlands",operator:"Equinix",capacity_mw:67,status:"Announced",ppa_terms:"Wind, ~€42/MWh",grid:"Pending",timeline:"2028",source:"Dutch News"},
  {region:"London, UK",operator:"Vantage",capacity_mw:150,status:"Under Construction",ppa_terms:"Grid+Wind, ~£50/MWh",grid:"Connected",timeline:"Q2 2027",source:"Vantage PR"},
  {region:"Singapore",operator:"AWS",capacity_mw:100,status:"Announced",ppa_terms:"Solar import, ~$65/MWh",grid:"Pending",timeline:"2028",source:"Straits Times"},
  {region:"Pennsylvania, US",operator:"AWS",capacity_mw:1200,status:"Announced",ppa_terms:"Nuclear PPA, ~$50/MWh",grid:"In Queue",timeline:"2027-2029",source:"Utility Dive"},
  {region:"Tokyo, Japan",operator:"AWS",capacity_mw:400,status:"Under Construction",ppa_terms:"Grid+Solar, ~¥12,000/MWh",grid:"Connected",timeline:"Q4 2027",source:"Nikkei"},
];

// ─── HISTORICAL SEED DATA ────────────────────────────────
const historicalSeedItems = [
  {headline:"KKR closes CyrusOne acquisition for $15B at $10M/MW valuation",summary:"KKR successfully closed its acquisition of CyrusOne, establishing the firm as a major data center platform operator. The $15B deal valued the company at approximately $10M per megawatt, setting an important market benchmark.",type:"deal_synopsis",layer:"infrastructure",importance:"high",importance_rationale:"Validates PE appetite for DC consolidation and establishes $10M/MW as a key market valuation benchmark.",region:"United States",date:"2025-08-15",source_name:"Bloomberg",source_url:"https://www.bloomberg.com",tags:["m&a","pe","kkr","cyrusone","consolidation"],companies:["KKR","CyrusOne"],full_data:{deal_type:"acquisition",deal_value:"$15B",capacity_mw:650,parties:[{name:"KKR",role:"buyer"},{name:"CyrusOne",role:"seller"}],implications:"Signals strong institutional capital deployment. KKR's value-add strategy focuses on operational efficiencies and capex for hyperscaler buildout."}},
  {headline:"DigitalBridge completes $2B Vantage Data Centers recapitalization",summary:"DigitalBridge has completed a $2B recapitalization of Vantage Data Centers, marking one of the largest DC secondary transactions. The transaction values Vantage at approximately $9.5B enterprise value.",type:"deal_synopsis",layer:"infrastructure",importance:"high",importance_rationale:"Major secondary transaction signals sustained PE appetite for mature DC platforms with strong credit profiles.",region:"Global",date:"2025-09-08",source_name:"DealFlow",source_url:"https://www.dealflow.com",tags:["recapitalization","digitalbridge","vantage","pe"],companies:["DigitalBridge","Vantage Data Centers"],full_data:{deal_type:"recapitalization",deal_value:"$2B",implications:"Unlocks capital for Vantage growth while establishing DigitalBridge as a lead DC investor."}},
  {headline:"CoreWeave IPO prices at $23B valuation amid AI GPU demand surge",summary:"CoreWeave completed its IPO at a $23B valuation, pricing above initial guidance. The AI-optimized infrastructure provider's first-day trading saw valuations surge to approximately $30B as investors bet on sustained GPU capacity demand.",type:"capex_announcement",layer:"chip",importance:"high",importance_rationale:"CoreWeave's public market entry validates demand for specialized AI infrastructure and sets valuation precedent for compute-focused DC operators.",region:"United States",date:"2025-09-18",source_name:"Reuters",source_url:"https://www.reuters.com",tags:["ipo","coreweave","ai","gpu","infrastructure"],companies:["CoreWeave"],full_data:{event_subtype:"ipo",valuation:"$23B IPO, $30B+ trading",first_day_trading:"+30%"}},
  {headline:"Equinix prices €1B 10-year bond at T+150bps amid strong demand",summary:"Equinix has priced a €1B senior unsecured 10-year bond at T+150bps, with strong institutional demand. The bond was 2.5x oversubscribed.",type:"financing_event",layer:"financing",importance:"high",importance_rationale:"REIT-rated bond pricing remains favorable despite rate environment; confirms steady capital access for tier-1 operators.",region:"Europe",date:"2025-10-05",source_name:"IFR",source_url:"https://www.reuters.com/finance",tags:["green-bond","equinix","europe","debt","reit"],companies:["Equinix"],full_data:{event_subtype:"senior_notes",amount:"€1B",tenor_maturity:"10-year",spread:"T+150bps",rating:{moodys:"Baa3",sp:"BBB-"},use_of_proceeds:"European expansion including Stockholm campus development."}},
  {headline:"QTS (Blackstone) closes $1.8B term loan at SOFR+200bps",summary:"QTS Realty Trust, backed by Blackstone, has closed a $1.8B term loan B facility at SOFR+200bps, maturing in 2032. The financing supports 250MW of incremental capacity deployment.",type:"financing_event",layer:"financing",importance:"high",importance_rationale:"HY-rated facility demonstrates sponsor support; 200bps spread reflects improving credit conditions vs peers.",region:"United States",date:"2025-10-20",source_name:"LCD",source_url:"https://www.lcdmarkets.com",tags:["debt","qts","blackstone","tlb","infrastructure"],companies:["QTS Realty Trust","Blackstone"],full_data:{event_subtype:"term_loan_b",amount:"$1.8B",tenor_maturity:"2032",coupon_rate:"SOFR+200",spread:"SOFR+200bps",rating:{moodys:"Ba1",sp:"BB+"},use_of_proceeds:"Incremental hyperscaler capacity expansion across Tier 1 markets."}},
  {headline:"Brookfield announces $9.8B Sweden AI data center facility",summary:"Brookfield Asset Management has announced a $9.8B investment to develop a major AI-focused data center campus in Sweden. The facility will span 500MW+ of capacity and is expected to complete by 2027.",type:"capex_announcement",layer:"cross-layer",importance:"high",importance_rationale:"Brookfield's Nordic investment validates region's position as a tier-1 AI infrastructure hub; $20M/MW implies premium for power economics.",region:"Sweden",date:"2025-11-02",source_name:"Bloomberg",source_url:"https://www.bloomberg.com",tags:["capex","brookfield","ai","nordics","hyperscale"],companies:["Brookfield Asset Management"],full_data:{announced_spend:"$9.8B",capacity_mw:500,timeline:"2027 completion"}},
  {headline:"Microsoft announces $10B Portugal data center complex in Sines",summary:"Microsoft has committed $10B to develop a large-scale data center complex in Sines, Portugal. The facility will target 250MW of capacity and prioritize renewable energy integration with local wind and solar assets.",type:"capex_announcement",layer:"cross-layer",importance:"high",importance_rationale:"Major Western European capacity addition by hyperscaler; signals shift away from constrained markets like Frankfurt and Amsterdam.",region:"Sines, Portugal",date:"2025-11-08",source_name:"Datacenter Dynamics",source_url:"https://www.datacenterdynamics.com",tags:["capex","microsoft","europe","hyperscaler","renewable"],companies:["Microsoft"],full_data:{announced_spend:"$10B",capacity_mw:250,timeline:"2028 first phase",power_sourcing:"100% renewable via wind and solar PPAs"}},
  {headline:"Google commits €5.5B to Germany expansion amid Frankfurt constraints",summary:"Google has announced a €5.5B investment to expand its data center footprint in Germany, focusing on sites outside Frankfurt to bypass city-level congestion. The phased expansion targets 150MW of incremental capacity.",type:"capex_announcement",layer:"cross-layer",importance:"high",importance_rationale:"Major hyperscaler re-routing around Frankfurt moratorium; validates market-wide capacity constraints.",region:"Germany",date:"2025-11-15",source_name:"Tech in Europe",source_url:"https://www.techineurope.com",tags:["capex","google","germany","hyperscaler","expansion"],companies:["Google"],full_data:{announced_spend:"€5.5B",capacity_mw:150,timeline:"phased 2027-2029",geographic_focus:"Bavaria, Düsseldorf, Hamburg"}},
  {headline:"Stargate (OpenAI-Nvidia) announces multi-billion Norway hydro facility",summary:"The Stargate consortium has revealed plans for a multi-GW data center facility powered by hydroelectric capacity in Norway. Initial announcements suggest $5B+ investment and 500MW+ capacity targeting 2027-2028 delivery.",type:"capex_announcement",layer:"chip",importance:"high",importance_rationale:"Stargate's Nordic footprint signals confidence in region's power advantage for AI compute.",region:"Norway",date:"2025-12-02",source_name:"Financial Times",source_url:"https://www.ft.com",tags:["stargate","ai","compute","nordic","hydropower"],companies:["Stargate Consortium","OpenAI","NVIDIA"],full_data:{capacity_mw:500,power_source:"Norwegian hydro",timeline:"2027-2028 ramp"}},
  {headline:"Amazon FCF concerns emerge; analysts flag $17-28B annual deficit risk",summary:"Investment analysts have raised concerns about Amazon's free cash flow sustainability amid massive data center capex acceleration. Some estimates project Amazon could face $17-28B annual FCF deficits through 2027.",type:"news_summary",layer:"energy",importance:"high",importance_rationale:"FCF concerns for largest hyperscaler could signal moderation in capex acceleration.",region:"Global",date:"2025-12-15",source_name:"Goldman Sachs",source_url:"https://www.gs.com",tags:["amazon","fcf","capex","hyperscaler","risk"],companies:["Amazon/AWS"],full_data:{analyst_projection:"$17-28B annual FCF deficit",time_horizon:"2026-2027"}},
  {headline:"CoreWeave expands UK presence with $1.3B dual-facility announcement",summary:"Following its IPO success, CoreWeave has announced $1.3B in new UK data center capacity, targeting 60MW across two facilities in London and Manchester.",type:"capex_announcement",layer:"infrastructure",importance:"medium",importance_rationale:"Post-IPO capital deployment signals CoreWeave aggressively pursuing European AI DC market.",region:"London and Manchester, UK",date:"2026-01-05",source_name:"VentureBeat",source_url:"https://www.venturebeat.com",tags:["coreweave","uk","ai","expansion"],companies:["CoreWeave"],full_data:{investment_amount:"$1.3B",capacity_mw:60,facilities:2}},
  {headline:"KKR and Oak Hill Advisors announce €2B pan-European DC platform",summary:"KKR and Oak Hill Advisors have partnered to form a pan-European data center platform with approximately $2B in committed capital targeting 300+ MW across Nordics, Germany, and Benelux.",type:"deal_synopsis",layer:"infrastructure",importance:"high",importance_rationale:"KKR's second major DC platform signals commitment to geographic diversification.",region:"Europe (Nordics, Germany, Benelux)",date:"2026-01-08",source_name:"Bloomberg",source_url:"https://www.bloomberg.com",tags:["kkr","oak-hill","pe","europe","platform"],companies:["KKR","Oak Hill Advisors"],full_data:{deal_value:"€2B",target_capacity_mw:300,geographic_focus:"Nordic, German, Benelux markets"}},
  {headline:"TikTok announces €1B+ Finland hyperscale DC investment",summary:"TikTok has unveiled a €1B+ commitment to develop hyperscale data center capacity in Finland as part of its European digital sovereignty strategy. The facility will target 80MW+ capacity.",type:"capex_announcement",layer:"cross-layer",importance:"high",importance_rationale:"Major tech company bet on Finnish infrastructure; validates Nordic data residency value.",region:"Finland",date:"2026-01-12",source_name:"Reuters",source_url:"https://www.reuters.com",tags:["tiktok","capex","finland","nordics","sovereignty"],companies:["TikTok"],full_data:{investment:"€1B+",capacity_mw:80,power_source:"100% renewable energy"}},
  {headline:"Frankfurt grid constraints force operators 30-40 miles west to alternative sites",summary:"Frankfurt's grid infrastructure has reached effective capacity limits, forcing major data center operators to route new projects 30-40 miles west to Darmstadt and Wiesbaden.",type:"regulatory_update",layer:"energy",importance:"high",importance_rationale:"Hard capacity constraints in Frankfurt are accelerating decentralization of German DC market.",region:"Frankfurt, Germany",date:"2026-01-15",source_name:"Energy Monitor",source_url:"https://www.energymonitor.ai",tags:["grid","frankfurt","constraint","germany","capacity"],companies:["Mainova","NetCologne"],full_data:{jurisdiction:"Frankfurt, Germany",action_type:"capacity_exhaustion",implications:"Operators forced to develop outside Frankfurt metropolitan area."}},
  {headline:"Germany Energy Efficiency Act mandates PUE 1.2 for new DC facilities",summary:"Germany's revised Energy Efficiency Act has mandated that all new data center facilities achieve a PUE of 1.2 or better, effective January 2026. Facilities exceeding this face escalating energy taxes.",type:"regulatory_update",layer:"infrastructure",importance:"high",importance_rationale:"Strict PUE mandate raises capex for new German builds by estimated 15-25%.",region:"Germany",date:"2026-01-18",source_name:"Bundesanzeiger",source_url:"https://www.bundesanzeiger.de",tags:["regulation","germany","pue","energy-efficiency"],companies:["Equinix","Digital Realty","Interxion"],full_data:{jurisdiction:"Germany",regulatory_body:"Federal Government",action_type:"pue_mandate",required_pue:1.2}},
  {headline:"Brookfield and Data4 announce €20B France AI infrastructure partnership",summary:"Brookfield and Data4 have entered a partnership to develop €20B worth of AI-focused data center infrastructure across France targeting 1,000+ MW by 2029.",type:"deal_synopsis",layer:"cross-layer",importance:"high",importance_rationale:"Brookfield-Data4 partnership signals massive Western Europe AI capacity buildout.",region:"Paris, Lyon, Marseille, France",date:"2026-01-20",source_name:"Financial Times",source_url:"https://www.ft.com",tags:["brookfield","data4","france","ai","partnership"],companies:["Brookfield","Data4"],full_data:{investment:"€20B",target_capacity_mw:1000,timeline:"2029 completion"}},
  {headline:"Mistral AI partners with NVIDIA to deploy 18K Grace Blackwell GPUs in France",summary:"Mistral AI has announced a partnership with NVIDIA to deploy approximately 18,000 Grace Blackwell GPUs across French data centers, requiring 250MW+ of dedicated power capacity.",type:"capex_announcement",layer:"chip",importance:"high",importance_rationale:"European AI champion's GPU investment signals accelerating demand for local AI compute infrastructure.",region:"France",date:"2026-01-23",source_name:"VentureBeat",source_url:"https://www.venturebeat.com",tags:["mistral","nvidia","ai","gpu","france"],companies:["Mistral AI","NVIDIA"],full_data:{gpu_count:18000,power_requirement_mw:250,deployment_timeframe:"2026-2027"}},
  {headline:"Big tech market cap loss hits $900B across Feb 3-7 amid AI capex concerns",summary:"Major technology companies experienced significant market cap declines from February 3-7, 2026, as investors reassessed AI infrastructure capex trajectories. Combined losses across the Magnificent 7 reached approximately $900B.",type:"news_summary",layer:"cross-layer",importance:"high",importance_rationale:"Market repricing of tech capex creates valuation opportunity for DC operators.",region:"Global",date:"2026-02-07",source_name:"Bloomberg",source_url:"https://www.bloomberg.com",tags:["market","tech","capex","valuation"],companies:["Microsoft","Google","Amazon","Meta","Apple","NVIDIA","Tesla"],full_data:{market_cap_loss_usd:"$900B",time_period:"Feb 3-7, 2026"}},
  {headline:"Stargate consortium releases $100B initial deployment plan",summary:"The Stargate consortium (OpenAI, SoftBank, NVIDIA, others) has released details of its initial $100B deployment plan, targeting 5+ GW of AI compute capacity across US, Europe, and Asia by 2030.",type:"capex_announcement",layer:"chip",importance:"high",importance_rationale:"Stargate's $100B program represents largest single AI infrastructure commitment.",region:"Global",date:"2026-02-08",source_name:"Wall Street Journal",source_url:"https://www.wsj.com",tags:["stargate","capex","ai","compute","consortium"],companies:["Stargate Consortium","OpenAI","SoftBank","NVIDIA"],full_data:{total_commitment:"$100B",target_capacity_gw:5,timeline:"2030 completion"}},
  {headline:"xAI reveals Colossus Memphis facility: 2GW capacity, 555K H100 GPUs",summary:"Elon Musk's xAI has revealed technical specifications for its Colossus Memphis data center facility. The 2GW hyperscale facility will house approximately 555,000 H100 GPUs.",type:"capex_announcement",layer:"chip",importance:"high",importance_rationale:"xAI's massive GPU deployment signals competitive dynamics in AI infrastructure.",region:"Memphis, Tennessee",date:"2026-02-12",source_name:"TechCrunch",source_url:"https://techcrunch.com",tags:["xai","gpu","memphis","hyperscale","ai"],companies:["xAI"],full_data:{facility_name:"Colossus Memphis",power_capacity_gw:2,gpu_count:555000,gpu_type:"H100"}},
];

// ─── SUPABASE DATA HOOK ──────────────────────────────────
function useSupabaseData() {
  const [data, setData] = useState(fallbackData);
  const [calendarEvents, setCalendarEvents] = useState(fallbackCalendarEvents);
  const [marketHeatmap, setMarketHeatmap] = useState(fallbackMarketHeatmap);
  const [financingComps, setFinancingComps] = useState(fallbackFinancingComps);
  const [loading, setLoading] = useState(true);
  const [dataSource, setDataSource] = useState('local');
  const [lastRefresh, setLastRefresh] = useState(null);
  const [refreshing, setRefreshing] = useState(false);
  const [error, setError] = useState(null);
  const [seeding, setSeeding] = useState(false);

  const seedHistory = useCallback(async () => {
    setSeeding(true);
    setError(null);
    try {
      let inserted = 0, skipped = 0;
      for (const item of historicalSeedItems) {
        const { data: existing } = await supabase
          .from('intelligence_items')
          .select('id')
          .eq('headline', item.headline)
          .maybeSingle();
        if (existing) { skipped++; continue; }
        const { error: insertErr } = await supabase.from('intelligence_items').insert([item]);
        if (insertErr) { console.error('Seed insert error:', item.headline, insertErr); skipped++; }
        else { inserted++; }
      }
      await fetchData();
      alert(`Historical data seeded! Inserted: ${inserted}, Skipped (already exists): ${skipped}`);
    } catch (err) {
      console.error('Seed error:', err);
      setError('Seed failed: ' + (err.message || 'Unknown error'));
    } finally {
      setSeeding(false);
    }
  }, []);

  const fetchData = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);

      const { data: items, error: itemsError } = await supabase
        .from('intelligence_items')
        .select('*')
        .order('date', { ascending: false });

      if (itemsError) throw itemsError;

      const { data: comps, error: compsError } = await supabase
        .from('financing_comps')
        .select('*')
        .order('date', { ascending: false });

      const { data: events, error: eventsError } = await supabase
        .from('events_calendar')
        .select('*')
        .order('start_date', { ascending: true });

      const { data: heatmap, error: heatmapError } = await supabase
        .from('market_heatmap')
        .select('*')
        .order('heat_score', { ascending: false });

      if (items && items.length > 0) {
        const transformed = items.map(item => ({
          ...item,
          id: item.id,
          tags: item.tags || [],
          companies: item.companies || [],
          full_data: item.full_data || {},
        }));
        setData(transformed);
        setDataSource('supabase');
      } else {
        setData(fallbackData);
        setDataSource('local');
      }

      if (comps && comps.length > 0) {
        const transformedComps = comps.map(c => ({
          issuer: c.company,
          type: c.event_subtype,
          amount: (c.currency === 'EUR' ? '€' : c.currency === 'GBP' ? '£' : '$') + (c.amount_usd >= 1e9 ? (c.amount_usd/1e9).toFixed(1)+'B' : (c.amount_usd/1e6).toFixed(0)+'M'),
          tenor: c.tenor_years ? c.tenor_years+'-year' : 'N/A',
          coupon: c.coupon_rate ? c.coupon_rate+'%' : (c.spread_bps ? 'SOFR+'+c.spread_bps : 'N/A'),
          spread_bps: c.spread_bps || 0,
          rating: [c.rating_moodys, c.rating_sp].filter(Boolean).join('/') || 'N/R',
          date: c.date,
        }));
        setFinancingComps(transformedComps);
      }

      if (events && events.length > 0) {
        const transformedEvents = events.map(e => ({
          id: e.id,
          event_type: e.event_type,
          title: e.title,
          description: e.description,
          company: e.company,
          location: e.location,
          start_date: e.start_date,
          end_date: e.end_date,
        }));
        setCalendarEvents(transformedEvents);
      }

      if (heatmap && heatmap.length > 0) {
        const transformedHeatmap = heatmap.map(h => ({
          region: h.region,
          news_count: h.news_count,
          deal_count: h.deal_count,
          total_mw: h.total_mw_announced,
          heat_score: h.heat_score,
        }));
        setMarketHeatmap(transformedHeatmap);
      }

      setLastRefresh(new Date());
    } catch (err) {
      console.error('Supabase fetch error:', err);
      setError(err.message);
    } finally {
      setLoading(false);
    }
  }, []);

  const triggerPipeline = useCallback(async () => {
    setRefreshing(true);
    setError(null);
    try {
      const { data: result, error: fnError } = await supabase.functions.invoke('refresh-pipeline', {
        body: { action: 'refresh' }
      });
      if (fnError) throw fnError;
      await fetchData();
    } catch (err) {
      console.error('Pipeline error:', err);
      setError('Pipeline: ' + (err.message || 'Edge Function not deployed yet. Run the seed SQL first, then deploy the Edge Function.'));
    } finally {
      setRefreshing(false);
    }
  }, [fetchData]);

  useEffect(() => { fetchData(); }, [fetchData]);

  return { data, calendarEvents, marketHeatmap, financingComps, loading, dataSource, lastRefresh, refreshing, error, fetchData, triggerPipeline, seeding, seedHistory };
}

// ─── HELPERS ─────────────────────────────────────────────
const layerLabels = {infrastructure:"Infrastructure",chip:"Chip / Compute",energy:"Energy",financing:"Financing",supply_chain:"Supply Chain","cross-layer":"Cross-Layer"};
const typeLabels = {news_summary:"News",deal_synopsis:"Deal",capex_announcement:"Capex",financing_event:"Financing",earnings_intelligence:"Earnings",regulatory_update:"Regulatory",power_demand_signal:"Power Demand",executive_move:"Exec Move",supply_chain_signal:"Supply Chain",briefing:"Briefing"};
const layerClass = {infrastructure:"bg-[#3B9FE3]/20 text-[#4FC3F7]",chip:"bg-[#AB47BC]/20 text-[#AB47BC]",energy:"bg-[#00E676]/20 text-[#00E676]",financing:"bg-[#FF9800]/20 text-[#FFB74D]",supply_chain:"bg-[#00BFA6]/20 text-[#00BFA6]","cross-layer":"bg-[#00BCD4]/20 text-[#00BCD4]"};
const impDot = {high:"bg-[#FF5252]",medium:"bg-[#FF9800]",low:"bg-[#6B8FA3]"};

const regionGroups = {
  "Nordics": ["Sweden", "Norway", "Finland", "Denmark", "Luleå", "Stockholm", "Rennesøy"],
  "Europe": ["Amsterdam", "Dublin", "Frankfurt", "London", "Ireland", "Netherlands", "Germany", "Europe"],
  "North America": ["United States", "Las Vegas", "Pennsylvania", "US", "Virginia", "Texas", "Arizona"],
  "Asia-Pacific": ["Tokyo", "Singapore"],
  "Global": ["Global"]
};

function getRegionGroup(region) {
  for(const [group, regions] of Object.entries(regionGroups)) {
    if(regions.some(r => region.toLowerCase().includes(r.toLowerCase()))) return group;
  }
  return "Other";
}

function relDate(d) {
  const now = new Date(); const dt = new Date(d+"T00:00:00");
  const diff = Math.floor((now-dt)/(864e5));
  if(diff===0) return "Today"; if(diff===1) return "Yesterday"; if(diff<7) return diff+"d ago"; if(diff<30) return Math.floor(diff/7)+"w ago";
  return dt.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"});
}
function fmtDate(d) { return new Date(d+"T00:00:00").toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}); }

// ─── SVG ICONS ───────────────────────────────────────────
const Icon = ({name, size=18, className=""}) => {
  const s = size;
  const icons = {
    Activity: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>,
    LayoutDashboard: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>,
    Newspaper: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 22h16a2 2 0 002-2V4a2 2 0 00-2-2H8a2 2 0 00-2 2v16a2 2 0 01-2 2zm0 0a2 2 0 01-2-2v-9c0-1.1.9-2 2-2h2"/><path d="M18 14h-8M15 18h-5M10 6h8v4h-8z"/></svg>,
    Building2: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 22V4a2 2 0 012-2h8a2 2 0 012 2v18z"/><path d="M6 12H4a2 2 0 00-2 2v6a2 2 0 002 2h2"/><path d="M18 9h2a2 2 0 012 2v9a2 2 0 01-2 2h-2"/><path d="M10 6h4M10 10h4M10 14h4M10 18h4"/></svg>,
    Cpu: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="4" y="4" width="16" height="16" rx="2"/><rect x="9" y="9" width="6" height="6"/><path d="M15 2v2M15 20v2M2 15h2M2 9h2M20 15h2M20 9h2M9 2v2M9 20v2"/></svg>,
    Zap: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
    Landmark: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="22" x2="21" y2="22"/><line x1="6" y1="18" x2="6" y2="11"/><line x1="10" y1="18" x2="10" y2="11"/><line x1="14" y1="18" x2="14" y2="11"/><line x1="18" y1="18" x2="18" y2="11"/><polygon points="12 2 20 7 4 7"/></svg>,
    Truck: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 3h15v13H1z"/><path d="M16 8h4l3 3v5h-7V8z"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>,
    Calendar: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
    Map: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>,
    Search: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
    ChevronRight: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>,
    X: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
    AlertTriangle: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
    Handshake: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.42 4.58a5.4 5.4 0 00-7.65 0l-.77.78-.77-.78a5.4 5.4 0 00-7.65 0C1.46 6.7 1.33 10.28 4 13l8 8 8-8c2.67-2.72 2.54-6.3.42-8.42z"/></svg>,
    TrendingUp: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
    BarChart3: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9M13 17V5M8 17v-3"/></svg>,
    Scale: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 16l3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1zM2 16l3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1zM7 21h10M12 3v18M12 3l4 4M12 3L8 7"/></svg>,
    UserCheck: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>,
    FileText: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
    Globe: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>,
    ExternalLink: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
    MapPin: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>,
    Tag: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>,
    RefreshCw: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
    LayoutList: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/></svg>,
    LayoutGrid: <svg width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
  };
  return <span className={className}>{icons[name] || null}</span>;
};

const typeIconMap = {news_summary:"Newspaper",deal_synopsis:"Handshake",capex_announcement:"TrendingUp",financing_event:"Landmark",earnings_intelligence:"BarChart3",regulatory_update:"Scale",power_demand_signal:"Zap",executive_move:"UserCheck",supply_chain_signal:"Truck",briefing:"FileText"};

// ─── CHART COMPONENTS ────────────────────────────────────
function CapexTrajectoryChart() {
  const canvasRef = useRef(null);
  const chartRef = useRef(null);

  useEffect(() => {
    if(!canvasRef.current || !window.Chart) return;

    if(chartRef.current) chartRef.current.destroy();

    const ctx = canvasRef.current.getContext('2d');
    chartRef.current = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['2015', '2020', '2021', '2022', '2023', '2024', '2025', '2026E'],
        datasets: [{
          label: 'Big 4 Combined Capex ($B)',
          data: [24, 105, 125, 145, 160, 245, 410, 660],
          borderColor: '#00BCD4',
          backgroundColor: 'rgba(0, 188, 212, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointBackgroundColor: '#00BCD4',
          pointBorderColor: '#FFF',
          pointBorderWidth: 2,
          pointRadius: 5,
          pointHoverRadius: 7
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true, labels: { color: '#B0C4D8', font: { size: 11 }, usePointStyle: true } },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            titleColor: '#00BCD4',
            bodyColor: '#FFF',
            borderColor: '#00BCD4',
            borderWidth: 1,
            padding: 12,
            titleFont: { size: 12, weight: 'bold' },
            bodyFont: { size: 11 },
            callbacks: { label: (ctx) => `$${ctx.parsed.y}B` }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 700,
            grid: { color: 'rgba(26, 58, 92, 0.3)' },
            ticks: { color: '#B0C4D8', font: { size: 11 }, callback: (v) => `$${v}B` }
          },
          x: {
            grid: { display: false },
            ticks: { color: '#B0C4D8', font: { size: 11 } }
          }
        }
      }
    });

    return () => { if(chartRef.current) chartRef.current.destroy(); };
  }, []);

  return <canvas ref={canvasRef}/>;
}

function CompanyCapexChart() {
  const canvasRef = useRef(null);
  const chartRef = useRef(null);

  useEffect(() => {
    if(!canvasRef.current || !window.Chart) return;

    if(chartRef.current) chartRef.current.destroy();

    const ctx = canvasRef.current.getContext('2d');
    chartRef.current = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['2020', '2021', '2022', '2023', '2024', '2025', '2026E'],
        datasets: [
          {
            label: 'Amazon',
            data: [40, 55, 58, 54, 83, 132, 200],
            backgroundColor: '#FF9800',
            borderColor: 'rgba(255,255,255,0.1)',
            borderWidth: 1
          },
          {
            label: 'Microsoft',
            data: [18, 24, 28, 32, 44, 65, 125],
            backgroundColor: '#3B9FE3',
            borderColor: 'rgba(255,255,255,0.1)',
            borderWidth: 1
          },
          {
            label: 'Google',
            data: [22, 24, 31, 32, 52, 91, 180],
            backgroundColor: '#00E676',
            borderColor: 'rgba(255,255,255,0.1)',
            borderWidth: 1
          },
          {
            label: 'Meta',
            data: [15, 19, 32, 28, 39, 71, 125],
            backgroundColor: '#00BCD4',
            borderColor: 'rgba(255,255,255,0.1)',
            borderWidth: 1
          },
          {
            label: 'Oracle',
            data: [4, 5, 7, 9, 12, 17, 50],
            backgroundColor: '#FF5252',
            borderColor: 'rgba(255,255,255,0.1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true, labels: { color: '#B0C4D8', font: { size: 11 }, usePointStyle: true } },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            titleColor: '#00BCD4',
            bodyColor: '#FFF',
            borderColor: '#00BCD4',
            borderWidth: 1,
            padding: 12,
            titleFont: { size: 12, weight: 'bold' },
            bodyFont: { size: 11 },
            callbacks: { label: (ctx) => `${ctx.dataset.label}: $${ctx.parsed.y}B` }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { color: '#B0C4D8', font: { size: 11 } }
          },
          y: {
            beginAtZero: true,
            max: 250,
            grid: { color: 'rgba(26, 58, 92, 0.3)' },
            ticks: { color: '#B0C4D8', font: { size: 11 }, callback: (v) => `$${v}B` }
          }
        }
      }
    });

    return () => { if(chartRef.current) chartRef.current.destroy(); };
  }, []);

  return <canvas ref={canvasRef}/>;
}

function FinancingChart() {
  const canvasRef = useRef(null);
  const chartRef = useRef(null);

  useEffect(() => {
    if(!canvasRef.current || !window.Chart) return;

    if(chartRef.current) chartRef.current.destroy();

    const ctx = canvasRef.current.getContext('2d');
    chartRef.current = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['DLR 7Y', 'DLR 12Y', 'EQX 10Y', 'Switch TL', 'QTS TLB'],
        datasets: [{
          label: 'Spread (bps)',
          data: [135, 155, 150, 250, 200],
          backgroundColor: ['#00E676', '#00E676', '#00E676', '#FF9800', '#FFB74D'],
          borderColor: 'rgba(255,255,255,0.1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            titleColor: '#00BCD4',
            bodyColor: '#FFF',
            borderColor: '#00BCD4',
            borderWidth: 1,
            padding: 12,
            titleFont: { size: 12, weight: 'bold' },
            bodyFont: { size: 11 },
            callbacks: {
              afterLabel: (ctx) => {
                if(ctx.parsed.y < 175) return 'IG';
                if(ctx.parsed.y <= 225) return 'HY/Supported';
                return 'High Yield';
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 300,
            grid: { color: 'rgba(26, 58, 92, 0.3)' },
            ticks: { color: '#B0C4D8', font: { size: 11 } }
          },
          x: {
            grid: { display: false },
            ticks: { color: '#B0C4D8', font: { size: 11 } }
          }
        }
      }
    });

    return () => { if(chartRef.current) chartRef.current.destroy(); };
  }, []);

  return <canvas ref={canvasRef}/>;
}

// ─── LEAFLET MAP COMPONENT ────────────────────────────────
function MarketMap({onMarketClick, mapHeight=500}) {
  const mapRef = useRef(null);
  const mapInstanceRef = useRef(null);

  const getMarkerColor = (score) => {
    if(score >= 80) return '#FF5252';
    if(score >= 60) return '#FF9800';
    return '#00BCD4';
  };

  useEffect(() => {
    if(!mapRef.current || !window.L) return;

    // Initialize map
    if(mapInstanceRef.current) {
      mapInstanceRef.current.remove();
    }

    const map = window.L.map(mapRef.current).setView([20, 0], 2);
    mapInstanceRef.current = map;

    // Add dark tile layer (CartoDB Dark Matter)
    window.L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '© OpenStreetMap, © CartoDB',
      maxZoom: 19,
      subdomains: 'abcd'
    }).addTo(map);

    // Add market markers
    mapMarkets.forEach(market => {
      const color = getMarkerColor(market.score);
      const radius = 8 + (market.score / 100) * 12;

      // Create custom circle marker
      const circleMarker = window.L.circleMarker([market.lat, market.lng], {
        radius: radius,
        fillColor: color,
        color: color,
        weight: 2,
        opacity: 0.7,
        fillOpacity: 0.7,
        className: 'market-marker'
      }).addTo(map);

      // Popup content
      const popupContent = `
        <div style="color: #fff; font-size: 12px; font-family: sans-serif;">
          <div style="font-weight: bold; color: #00BCD4; margin-bottom: 6px;">${market.label}</div>
          <div style="color: #B0C4D8;">
            <div>Heat Score: <span style="font-weight: bold;">${market.score}</span></div>
            <div>Capacity: <span style="font-weight: bold;">${market.mw.toLocaleString()} MW</span></div>
            <div>Deals: <span style="font-weight: bold;">${market.deals}</span></div>
          </div>
        </div>
      `;

      circleMarker.bindPopup(popupContent);

      // Click handler
      circleMarker.on('click', () => {
        onMarketClick(market);
      });

      // Hover effects
      circleMarker.on('mouseover', function() {
        this.setRadius(radius + 3);
        this.setStyle({ weight: 3, opacity: 1, fillOpacity: 0.9 });
      });

      circleMarker.on('mouseout', function() {
        this.setRadius(radius);
        this.setStyle({ weight: 2, opacity: 0.7, fillOpacity: 0.7 });
      });
    });

    // Fit bounds to show all markers
    if(mapMarkets.length > 0) {
      const bounds = window.L.latLngBounds(mapMarkets.map(m => [m.lat, m.lng]));
      map.fitBounds(bounds, { padding: [50, 50] });
    }

    return () => {
      if(mapInstanceRef.current) {
        mapInstanceRef.current.remove();
        mapInstanceRef.current = null;
      }
    };
  }, [onMarketClick]);

  return (
    <div
      ref={mapRef}
      style={{ height: mapHeight + 'px', borderRadius: '0.5rem' }}
      className="border border-naio-border"
    />
  );
}

// ─── COMPONENTS ──────────────────────────────────────────
const tabs = [
  {id:"dashboard",label:"Dashboard",icon:"LayoutDashboard"},
  {id:"news",label:"News Feed",icon:"Newspaper"},
  {id:"infrastructure",label:"Infrastructure",icon:"Building2"},
  {id:"chip",label:"Chip / Compute",icon:"Cpu"},
  {id:"energy",label:"Energy",icon:"Zap"},
  {id:"financing",label:"Financing",icon:"Landmark"},
  {id:"supply_chain",label:"Supply Chain",icon:"Truck"},
  {id:"demand_pipeline",label:"Demand Pipeline",icon:"Activity"},
  {id:"calendar",label:"Calendar",icon:"Calendar"},
  {id:"heatmap",label:"Market Heat",icon:"Map"},
  {id:"comps",label:"Comps Table",icon:"BarChart3"},
  {id:"reports",label:"Reports",icon:"FileText"},
  {id:"research",label:"Company Research",icon:"Search"},
];

function ReportGenerator({data, calendarEvents=[], financingComps=[], marketHeatmap=[]}) {
  const [reportType, setReportType] = useState("Company Profile");
  const [selectedCompany, setSelectedCompany] = useState("");
  const [selectedGeography, setSelectedGeography] = useState("Nordics");
  const [selectedTheme, setSelectedTheme] = useState("AI Infrastructure Capex");
  const [generatedReport, setGeneratedReport] = useState(null);
  const [generating, setGenerating] = useState(false);
  const [error, setError] = useState(null);
  const [library, setLibrary] = useState([]);
  const [libraryLoading, setLibraryLoading] = useState(true);
  const reportRef = useRef(null);

  // Fetch report library on mount
  useEffect(() => {
    const fetchLibrary = async () => {
      try {
        const { data: reports, error: libErr } = await supabase
          .from("report_library")
          .select("id, report_type, subject, title, created_at")
          .order("created_at", { ascending: false })
          .limit(50);
        if (!libErr && reports) setLibrary(reports);
      } catch (e) { console.error("Library fetch error:", e); }
      finally { setLibraryLoading(false); }
    };
    fetchLibrary();
  }, []);

  // Load a saved report from library
  const loadReport = async (reportId) => {
    try {
      const { data: saved, error: loadErr } = await supabase
        .from("report_library")
        .select("*")
        .eq("id", reportId)
        .single();
      if (loadErr || !saved) throw new Error("Failed to load report");
      setGeneratedReport({
        success: true,
        reportType: saved.report_type,
        subject: saved.subject,
        report: saved.report_data,
        context: saved.context || {},
        generated_at: saved.created_at,
        report_id: saved.id,
      });
    } catch (e) { setError("Could not load report: " + e); }
  };

  // Delete a report from library
  const deleteReport = async (reportId, e) => {
    e.stopPropagation();
    try {
      await supabase.from("report_library").delete().eq("id", reportId);
      setLibrary(prev => prev.filter(r => r.id !== reportId));
      if (generatedReport?.report_id === reportId) setGeneratedReport(null);
    } catch (e) { console.error("Delete error:", e); }
  };

  const uniqueCompanies = useMemo(() => {
    const comps = new Set();
    data.forEach(item => { (item.companies || []).forEach(c => comps.add(c)); });
    return Array.from(comps).sort();
  }, [data]);

  const geographies = ["Nordics", "Europe", "North America", "Asia-Pacific", "Global"];
  const themes = ["AI Infrastructure Capex", "Financing & Credit", "Power & Energy", "Supply Chain", "Regulatory"];

  const generateReport = async () => {
    setGenerating(true);
    setError(null);
    setGeneratedReport(null);

    try {
      const payload = { reportType: "", subject: "", geography: "", theme: "" };
      if (reportType === "Company Profile") {
        if (!selectedCompany) { setError("Please select a company."); setGenerating(false); return; }
        payload.reportType = "company_profile";
        payload.subject = selectedCompany;
      } else if (reportType === "Geographic Market") {
        payload.reportType = "geographic_market";
        payload.geography = selectedGeography;
      } else if (reportType === "Thematic Brief") {
        payload.reportType = "thematic_brief";
        payload.theme = selectedTheme;
      } else {
        payload.reportType = "market_overview";
      }

      const resp = await fetch(`${SUPABASE_URL}/functions/v1/generate-report`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${SUPABASE_ANON_KEY}` },
        body: JSON.stringify(payload),
      });

      const result = await resp.json();
      if (result.error) throw new Error(result.error);
      setGeneratedReport(result);
      // Add to library list
      if (result.report_id) {
        const typeLabels = { company_profile: "Company Profile", geographic_market: "Geographic Market", thematic_brief: "Thematic Brief", market_overview: "Market Overview" };
        setLibrary(prev => [{
          id: result.report_id,
          report_type: result.reportType,
          subject: result.subject,
          title: `${typeLabels[result.reportType] || result.reportType} — ${result.subject}`,
          created_at: result.generated_at,
        }, ...prev]);
      }
    } catch (e) {
      setError(String(e));
    } finally {
      setGenerating(false);
    }
  };

  const exportPDF = async () => {
    if (!reportRef.current || !window.html2canvas || !window.jsPDF) { alert("PDF libraries not loaded."); return; }
    try {
      const canvas = await html2canvas(reportRef.current, { scale: 2, backgroundColor: '#FFFFFF' });
      const imgData = canvas.toDataURL('image/png');
      const pdf = new window.jsPDF.jsPDF('p', 'mm', 'a4');
      const imgWidth = 210;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      let heightLeft = imgHeight;
      let position = 0;
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= 297;
      while (heightLeft >= 0) { position = heightLeft - imgHeight; pdf.addPage(); pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight); heightLeft -= 297; }
      pdf.save(`NAIO_${reportType.replace(/\s+/g, "_")}_${selectedCompany || selectedGeography || selectedTheme || "Overview"}_${new Date().toISOString().split('T')[0]}.pdf`);
    } catch (e) { alert("PDF export failed: " + e); }
  };

  // ── Render helpers for different report types ──

  const renderMetricCard = (m, idx) => (
    <div key={idx} className="p-4 bg-gray-50 border border-gray-200 rounded-lg">
      <p className="text-[10px] text-gray-500 uppercase tracking-wider">{m.label}</p>
      <p className="text-xl font-bold text-gray-900 mt-1">{m.value}</p>
      {m.context && <p className="text-[10px] text-gray-500 mt-1">{m.context}</p>}
    </div>
  );

  const renderCompanyProfile = (r) => {
    const report = r.report;
    return (
      <div>
        <div className="flex items-center gap-2 mb-1">
          <div className="h-[3px] w-5 bg-cyan-500 rounded-full"/>
          <span className="text-[10px] font-bold tracking-[0.35em] text-gray-500 uppercase">NAIO Intelligence</span>
        </div>
        <div className="flex items-start justify-between mb-1">
          <div>
            <h1 className="text-2xl font-bold text-gray-900">Company Profile | {report.company_name || r.subject}</h1>
            <p className="text-sm text-gray-600 italic mt-1">{report.tagline}</p>
          </div>
          {report.heat_score && (
            <div className="flex-shrink-0 ml-4 text-center">
              <div className={`w-14 h-14 rounded-full flex items-center justify-center text-white font-bold text-lg ${report.heat_score >= 80 ? "bg-red-500" : report.heat_score >= 60 ? "bg-orange-500" : "bg-cyan-500"}`}>
                {report.heat_score}
              </div>
              <p className="text-[9px] text-gray-500 mt-1">Heat Score</p>
            </div>
          )}
        </div>
        <p className="text-[10px] text-gray-400 mb-6">Generated: {new Date(r.generated_at).toLocaleDateString("en-GB", {day:"numeric",month:"short",year:"numeric"})} | {r.context.items_in_db} intelligence items analyzed</p>

        {/* Overview + Differentiators side by side */}
        <div className="grid grid-cols-2 gap-6 mb-6">
          <div className="border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Company Overview</h2>
            {report.overview && (
              <div className="space-y-1.5 text-xs text-gray-700">
                {report.overview.founded && <p><span className="font-semibold">Founded:</span> {report.overview.founded} &nbsp;|&nbsp; <span className="font-semibold">HQ:</span> {report.overview.hq}</p>}
                {report.overview.ceo_leadership && <p><span className="font-semibold">Leadership:</span> {report.overview.ceo_leadership}</p>}
                {report.overview.ownership && <p><span className="font-semibold">Ownership:</span> {report.overview.ownership}</p>}
                {(report.overview.key_stats || []).map((s, i) => <p key={i} className="text-gray-600 pl-3 border-l-2 border-cyan-400">{s}</p>)}
              </div>
            )}
          </div>
          <div className="border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">{report.differentiators?.headline || "Key Differentiators"}</h2>
            <div className="space-y-1.5 text-xs text-gray-700">
              {(report.differentiators?.points || []).map((p, i) => <p key={i} className="pl-3 border-l-2 border-orange-400">{p}</p>)}
            </div>
          </div>
        </div>

        {/* Capital & Financing */}
        {report.capital_and_financing && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Capital & Financing</h2>
            <div className="grid grid-cols-3 gap-3 mb-3">
              {(report.capital_and_financing.metrics || []).map(renderMetricCard)}
            </div>
            {report.capital_and_financing.narrative && <p className="text-xs text-gray-600 leading-relaxed">{report.capital_and_financing.narrative}</p>}
          </div>
        )}

        {/* Market Intelligence */}
        {report.market_intelligence && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Market Intelligence</h2>
            <div className="space-y-2 mb-3">
              {(report.market_intelligence.recent_developments || []).map((d, i) => (
                <div key={i} className="flex items-start gap-2 text-xs">
                  <div className="w-1.5 h-1.5 rounded-full bg-cyan-500 mt-1.5 flex-shrink-0"/>
                  <p className="text-gray-700">{d}</p>
                </div>
              ))}
            </div>
            {report.market_intelligence.competitive_position && (
              <div className="bg-gray-50 rounded p-3 mb-2">
                <p className="text-[10px] font-semibold text-gray-500 uppercase mb-1">Competitive Position</p>
                <p className="text-xs text-gray-700">{report.market_intelligence.competitive_position}</p>
              </div>
            )}
            {report.market_intelligence.expansion_signals && (
              <div className="bg-gray-50 rounded p-3">
                <p className="text-[10px] font-semibold text-gray-500 uppercase mb-1">Expansion Signals</p>
                <p className="text-xs text-gray-700">{report.market_intelligence.expansion_signals}</p>
              </div>
            )}
          </div>
        )}

        {/* Customer Segments */}
        {report.customer_segments && report.customer_segments.length > 0 && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Customer Base</h2>
            <div className="grid grid-cols-4 gap-3">
              {report.customer_segments.map((seg, i) => (
                <div key={i} className="bg-gray-50 rounded-lg p-3 text-center">
                  <p className="text-xs font-bold text-gray-800">{seg.segment}</p>
                  <p className="text-[10px] text-gray-500 mt-1">{seg.description}</p>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Risk + Outlook */}
        <div className="grid grid-cols-2 gap-6 mb-6">
          {report.risk_factors && (
            <div className="border border-gray-200 rounded-lg p-4">
              <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Risk Factors</h2>
              <div className="space-y-1.5">
                {report.risk_factors.map((rf, i) => (
                  <div key={i} className="flex items-start gap-2 text-xs text-gray-700">
                    <span className="text-red-400 mt-0.5 flex-shrink-0">&#9679;</span>
                    <p>{rf}</p>
                  </div>
                ))}
              </div>
            </div>
          )}
          {report.outlook && (
            <div className="border border-gray-200 rounded-lg p-4">
              <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Outlook</h2>
              <p className="text-xs text-gray-700 leading-relaxed">{report.outlook}</p>
            </div>
          )}
        </div>
      </div>
    );
  };

  const renderGeographicReport = (r) => {
    const report = r.report;
    return (
      <div>
        <div className="flex items-center gap-2 mb-1">
          <div className="h-[3px] w-5 bg-cyan-500 rounded-full"/>
          <span className="text-[10px] font-bold tracking-[0.35em] text-gray-500 uppercase">NAIO Intelligence</span>
        </div>
        <h1 className="text-2xl font-bold text-gray-900">{report.region_name || r.subject} — Market Intelligence</h1>
        <p className="text-sm text-gray-600 italic mt-1">{report.tagline}</p>
        <p className="text-[10px] text-gray-400 mt-1 mb-6">Generated: {new Date(r.generated_at).toLocaleDateString("en-GB", {day:"numeric",month:"short",year:"numeric"})}</p>

        {/* Market Overview */}
        {report.market_overview && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Market Overview</h2>
            <div className="grid grid-cols-2 gap-3 mb-3">
              <div className="bg-gray-50 rounded p-3"><p className="text-[10px] text-gray-500 uppercase">Total Capacity</p><p className="text-lg font-bold text-gray-900">{report.market_overview.total_capacity_mw}</p></div>
              <div className="bg-gray-50 rounded p-3"><p className="text-[10px] text-gray-500 uppercase">Growth Rate</p><p className="text-lg font-bold text-gray-900">{report.market_overview.growth_rate}</p></div>
            </div>
            <div className="space-y-1.5">
              {(report.market_overview.key_stats || []).map((s, i) => <p key={i} className="text-xs text-gray-700 pl-3 border-l-2 border-cyan-400">{s}</p>)}
            </div>
          </div>
        )}

        {/* Key Players */}
        {report.key_players && report.key_players.length > 0 && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Key Players</h2>
            <table className="w-full text-xs">
              <thead><tr className="border-b border-gray-200"><th className="text-left py-2 text-gray-500 font-semibold">Company</th><th className="text-left py-2 text-gray-500 font-semibold">Presence</th><th className="text-right py-2 text-gray-500 font-semibold">Capacity</th></tr></thead>
              <tbody>
                {report.key_players.map((p, i) => (
                  <tr key={i} className="border-b border-gray-100"><td className="py-2 font-medium text-gray-900">{p.company}</td><td className="py-2 text-gray-600">{p.presence}</td><td className="py-2 text-right text-gray-600">{p.capacity_mw}</td></tr>
                ))}
              </tbody>
            </table>
          </div>
        )}

        {/* Supply Dynamics + Regulatory side by side */}
        <div className="grid grid-cols-2 gap-6 mb-6">
          {report.supply_dynamics && (
            <div className="border border-gray-200 rounded-lg p-4">
              <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Supply Dynamics</h2>
              <p className="text-xs text-gray-700 mb-2">{report.supply_dynamics.pipeline}</p>
              <p className="text-[10px] font-semibold text-gray-500 uppercase mt-2 mb-1">Constraints</p>
              {(report.supply_dynamics.constraints || []).map((c, i) => <p key={i} className="text-xs text-gray-600 pl-3 border-l-2 border-red-300">{c}</p>)}
              <p className="text-[10px] font-semibold text-gray-500 uppercase mt-2 mb-1">Power</p>
              <p className="text-xs text-gray-600">{report.supply_dynamics.power_situation}</p>
            </div>
          )}
          {report.regulatory_landscape && (
            <div className="border border-gray-200 rounded-lg p-4">
              <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Regulatory Landscape</h2>
              <p className="text-xs text-gray-700 mb-2">{report.regulatory_landscape.summary}</p>
              {(report.regulatory_landscape.key_policies || []).map((p, i) => <p key={i} className="text-xs text-gray-600 pl-3 border-l-2 border-orange-400">{p}</p>)}
              <p className="text-[10px] font-semibold text-gray-500 uppercase mt-2 mb-1">Outlook</p>
              <p className="text-xs text-gray-600">{report.regulatory_landscape.outlook}</p>
            </div>
          )}
        </div>

        {/* Financing + Demand Drivers */}
        {report.financing_environment && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Financing Environment</h2>
            <div className="grid grid-cols-2 gap-3 mb-2">
              <div className="bg-gray-50 rounded p-3"><p className="text-[10px] text-gray-500 uppercase">Spread Range</p><p className="text-sm font-bold text-gray-900">{report.financing_environment.spread_range}</p></div>
              <div className="bg-gray-50 rounded p-3"><p className="text-[10px] text-gray-500 uppercase">Investor Appetite</p><p className="text-xs text-gray-700">{report.financing_environment.investor_appetite}</p></div>
            </div>
            {(report.financing_environment.recent_deals || []).map((d, i) => (
              <div key={i} className="flex items-start gap-2 text-xs text-gray-700"><span className="text-cyan-500 mt-0.5">&#9679;</span><p>{d}</p></div>
            ))}
          </div>
        )}

        {/* Recent Developments */}
        {report.recent_developments && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Recent Developments</h2>
            <div className="space-y-2">
              {report.recent_developments.map((d, i) => (
                <div key={i} className="flex items-start gap-2 text-xs"><div className="w-1.5 h-1.5 rounded-full bg-cyan-500 mt-1.5 flex-shrink-0"/><p className="text-gray-700">{d}</p></div>
              ))}
            </div>
          </div>
        )}

        {/* Risk + Outlook */}
        <div className="grid grid-cols-2 gap-6 mb-6">
          <div className="border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Risk Factors</h2>
            {(report.risk_factors || []).map((rf, i) => <div key={i} className="flex items-start gap-2 text-xs text-gray-700 mb-1"><span className="text-red-400 mt-0.5">&#9679;</span><p>{rf}</p></div>)}
          </div>
          <div className="border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Outlook</h2>
            <p className="text-xs text-gray-700 leading-relaxed">{report.outlook}</p>
          </div>
        </div>
      </div>
    );
  };

  const renderThematicBrief = (r) => {
    const report = r.report;
    return (
      <div>
        <div className="flex items-center gap-2 mb-1">
          <div className="h-[3px] w-5 bg-cyan-500 rounded-full"/>
          <span className="text-[10px] font-bold tracking-[0.35em] text-gray-500 uppercase">NAIO Intelligence</span>
        </div>
        <h1 className="text-2xl font-bold text-gray-900">{report.theme_name || r.subject} — Thematic Brief</h1>
        <p className="text-sm text-gray-600 italic mt-1">{report.tagline}</p>
        <p className="text-[10px] text-gray-400 mt-1 mb-6">Generated: {new Date(r.generated_at).toLocaleDateString("en-GB", {day:"numeric",month:"short",year:"numeric"})}</p>

        {/* Executive Summary */}
        <div className="mb-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
          <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-2">Executive Summary</h2>
          <p className="text-sm text-gray-700 leading-relaxed">{report.executive_summary}</p>
        </div>

        {/* Key Metrics */}
        {report.key_metrics && (
          <div className="grid grid-cols-4 gap-3 mb-6">
            {report.key_metrics.map(renderMetricCard)}
          </div>
        )}

        {/* Key Developments */}
        {report.key_developments && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Key Developments</h2>
            <div className="space-y-3">
              {report.key_developments.map((d, i) => (
                <div key={i} className="flex gap-3 text-xs">
                  <div className="flex-shrink-0 w-20 text-gray-500 font-mono">{d.date}</div>
                  <div><p className="font-semibold text-gray-900">{d.headline}</p><p className="text-gray-600 mt-0.5">{d.detail}</p>{d.companies && <p className="text-[10px] text-cyan-600 mt-0.5">{d.companies.join(", ")}</p>}</div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Market Dynamics */}
        {report.market_dynamics && (
          <div className="grid grid-cols-3 gap-4 mb-6">
            <div className="border border-gray-200 rounded-lg p-4">
              <h2 className="text-xs font-bold text-green-700 uppercase tracking-wider mb-2">Trends</h2>
              {(report.market_dynamics.trends || []).map((t, i) => <p key={i} className="text-xs text-gray-700 mb-1 pl-3 border-l-2 border-green-400">{t}</p>)}
            </div>
            <div className="border border-gray-200 rounded-lg p-4">
              <h2 className="text-xs font-bold text-orange-700 uppercase tracking-wider mb-2">Challenges</h2>
              {(report.market_dynamics.challenges || []).map((c, i) => <p key={i} className="text-xs text-gray-700 mb-1 pl-3 border-l-2 border-orange-400">{c}</p>)}
            </div>
            <div className="border border-gray-200 rounded-lg p-4">
              <h2 className="text-xs font-bold text-cyan-700 uppercase tracking-wider mb-2">Opportunities</h2>
              {(report.market_dynamics.opportunities || []).map((o, i) => <p key={i} className="text-xs text-gray-700 mb-1 pl-3 border-l-2 border-cyan-400">{o}</p>)}
            </div>
          </div>
        )}

        {/* Company Positioning */}
        {report.company_positioning && report.company_positioning.length > 0 && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Company Positioning</h2>
            <div className="space-y-2">
              {report.company_positioning.map((cp, i) => (
                <div key={i} className="flex gap-3 text-xs"><span className="font-bold text-gray-900 flex-shrink-0 w-32">{cp.company}</span><span className="text-gray-600">{cp.position}</span></div>
              ))}
            </div>
          </div>
        )}

        {/* Risk + Outlook + Investment Implications */}
        <div className="grid grid-cols-2 gap-6 mb-6">
          <div className="border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Risk Factors</h2>
            {(report.risk_factors || []).map((rf, i) => <div key={i} className="flex items-start gap-2 text-xs text-gray-700 mb-1"><span className="text-red-400 mt-0.5">&#9679;</span><p>{rf}</p></div>)}
          </div>
          <div className="border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Outlook & Investment Implications</h2>
            <p className="text-xs text-gray-700 leading-relaxed mb-2">{report.outlook}</p>
            {report.investment_implications && <p className="text-xs text-gray-600 leading-relaxed bg-gray-50 rounded p-2 mt-2">{report.investment_implications}</p>}
          </div>
        </div>
      </div>
    );
  };

  const renderMarketOverview = (r) => {
    const report = r.report;
    return (
      <div>
        <div className="flex items-center gap-2 mb-1">
          <div className="h-[3px] w-5 bg-cyan-500 rounded-full"/>
          <span className="text-[10px] font-bold tracking-[0.35em] text-gray-500 uppercase">NAIO Intelligence</span>
        </div>
        <h1 className="text-2xl font-bold text-gray-900">{report.title || "Data Center Market Overview"}</h1>
        <p className="text-sm text-gray-600 italic mt-1">{report.tagline}</p>
        <p className="text-[10px] text-gray-400 mt-1 mb-6">Generated: {new Date(r.generated_at).toLocaleDateString("en-GB", {day:"numeric",month:"short",year:"numeric"})}</p>

        <div className="mb-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
          <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-2">Executive Summary</h2>
          <p className="text-sm text-gray-700 leading-relaxed">{report.executive_summary}</p>
        </div>

        {report.key_metrics && <div className="grid grid-cols-4 gap-3 mb-6">{report.key_metrics.map(renderMetricCard)}</div>}

        {/* Sector Heat */}
        {report.sector_heat && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Sector Heat</h2>
            <div className="space-y-2">
              {report.sector_heat.map((s, i) => (
                <div key={i} className="flex items-center gap-3">
                  <span className="text-xs font-semibold text-gray-700 w-28">{s.sector}</span>
                  <div className="flex-1 h-3 bg-gray-100 rounded-full overflow-hidden"><div className={`h-full rounded-full ${s.score >= 80 ? "bg-red-400" : s.score >= 60 ? "bg-orange-400" : "bg-cyan-400"}`} style={{width: s.score + "%"}}/></div>
                  <span className={`text-xs font-bold w-8 text-right ${s.score >= 80 ? "text-red-500" : s.score >= 60 ? "text-orange-500" : "text-cyan-500"}`}>{s.score}</span>
                  <span className="text-[10px] text-gray-500 flex-1">{s.assessment}</span>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Top Developments */}
        {report.top_developments && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Top Developments</h2>
            <div className="space-y-3">
              {report.top_developments.map((d, i) => (
                <div key={i} className="flex gap-3 text-xs">
                  <div className="flex-shrink-0 w-20 text-gray-500 font-mono">{d.date}</div>
                  <div className={`w-1 rounded-full flex-shrink-0 ${d.importance === "high" ? "bg-red-400" : "bg-orange-400"}`}/>
                  <div><p className="font-semibold text-gray-900">{d.headline}</p><p className="text-gray-600 mt-0.5">{d.detail}</p></div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Geographic Outlook */}
        {report.geographic_outlook && (
          <div className="mb-6 border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Geographic Outlook</h2>
            <div className="space-y-2">
              {report.geographic_outlook.map((g, i) => (
                <div key={i} className="flex items-center gap-3 text-xs">
                  <span className="font-semibold text-gray-900 w-28">{g.region}</span>
                  <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white text-[10px] font-bold ${g.heat_score >= 80 ? "bg-red-500" : g.heat_score >= 60 ? "bg-orange-500" : "bg-cyan-500"}`}>{g.heat_score}</div>
                  <span className="text-gray-600 flex-1">{g.key_development}</span>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Financing + Catalysts */}
        <div className="grid grid-cols-2 gap-6 mb-6">
          {report.financing_conditions && (
            <div className="border border-gray-200 rounded-lg p-4">
              <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Financing Conditions</h2>
              <p className="text-xs text-gray-700 mb-2">{report.financing_conditions.summary}</p>
              <p className="text-xs text-gray-600">{report.financing_conditions.spread_environment}</p>
            </div>
          )}
          {report.upcoming_catalysts && (
            <div className="border border-gray-200 rounded-lg p-4">
              <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Upcoming Catalysts</h2>
              {report.upcoming_catalysts.map((c, i) => <div key={i} className="flex items-start gap-2 text-xs text-gray-700 mb-1"><span className="text-cyan-500 mt-0.5">&#9679;</span><p>{c}</p></div>)}
            </div>
          )}
        </div>

        <div className="grid grid-cols-2 gap-6 mb-6">
          <div className="border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Risk Factors</h2>
            {(report.risk_factors || []).map((rf, i) => <div key={i} className="flex items-start gap-2 text-xs text-gray-700 mb-1"><span className="text-red-400 mt-0.5">&#9679;</span><p>{rf}</p></div>)}
          </div>
          <div className="border border-gray-200 rounded-lg p-4">
            <h2 className="text-xs font-bold text-gray-700 uppercase tracking-wider mb-3 pb-2 border-b border-gray-200">Outlook & Investment Implications</h2>
            <p className="text-xs text-gray-700 leading-relaxed mb-2">{report.outlook}</p>
            {report.investment_implications && <p className="text-xs text-gray-600 bg-gray-50 rounded p-2 mt-2">{report.investment_implications}</p>}
          </div>
        </div>
      </div>
    );
  };

  const renderReport = (r) => {
    if (!r || !r.report) return null;
    const rt = r.reportType;
    if (rt === "company_profile") return renderCompanyProfile(r);
    if (rt === "geographic_market") return renderGeographicReport(r);
    if (rt === "thematic_brief") return renderThematicBrief(r);
    return renderMarketOverview(r);
  };

  const typeIcons = { company_profile: "Building2", geographic_market: "Map", thematic_brief: "Layers", market_overview: "LayoutDashboard" };
  const typeColors = { company_profile: "text-naio-cyan", geographic_market: "text-naio-teal", thematic_brief: "text-naio-orange", market_overview: "text-naio-purple" };

  // Group library by type
  const libraryGrouped = useMemo(() => {
    const groups = {};
    library.forEach(r => {
      const label = { company_profile: "Company Profiles", geographic_market: "Geographic Markets", thematic_brief: "Thematic Briefs", market_overview: "Market Overviews" }[r.report_type] || "Other";
      if (!groups[label]) groups[label] = [];
      groups[label].push(r);
    });
    return groups;
  }, [library]);

  return (
    <div className="flex gap-6">
      {/* Main content */}
      <div className="flex-1 min-w-0 space-y-6">
      {/* Controls */}
      <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-6">
        <h2 className="text-sm font-semibold text-naio-cyan uppercase tracking-wider mb-4">AI Report Generator</h2>
        <p className="text-xs text-naio-text-muted mb-4">Select a report type and subject. NAIO will analyze your intelligence database and generate a comprehensive sell-side research-style report using AI.</p>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label className="text-xs text-naio-text-muted uppercase tracking-wider block mb-2">Report Type</label>
            <select value={reportType} onChange={e => setReportType(e.target.value)} className="w-full px-3 py-2 bg-naio-bg-surface border border-naio-border rounded-md text-sm text-naio-text-primary focus:outline-none focus:border-naio-cyan/50 appearance-none cursor-pointer">
              <option value="Company Profile">Company Profile</option>
              <option value="Geographic Market">Geographic Market</option>
              <option value="Thematic Brief">Thematic Brief</option>
              <option value="Market Overview">Market Overview</option>
            </select>
          </div>
          {reportType === "Company Profile" && (
            <div>
              <label className="text-xs text-naio-text-muted uppercase tracking-wider block mb-2">Company</label>
              <select value={selectedCompany} onChange={e => setSelectedCompany(e.target.value)} className="w-full px-3 py-2 bg-naio-bg-surface border border-naio-border rounded-md text-sm text-naio-text-primary focus:outline-none focus:border-naio-cyan/50 appearance-none cursor-pointer">
                <option value="">Select a company...</option>
                {uniqueCompanies.map(c => <option key={c} value={c}>{c}</option>)}
              </select>
            </div>
          )}
          {reportType === "Geographic Market" && (
            <div>
              <label className="text-xs text-naio-text-muted uppercase tracking-wider block mb-2">Region</label>
              <select value={selectedGeography} onChange={e => setSelectedGeography(e.target.value)} className="w-full px-3 py-2 bg-naio-bg-surface border border-naio-border rounded-md text-sm text-naio-text-primary focus:outline-none focus:border-naio-cyan/50 appearance-none cursor-pointer">
                {geographies.map(g => <option key={g} value={g}>{g}</option>)}
              </select>
            </div>
          )}
          {reportType === "Thematic Brief" && (
            <div>
              <label className="text-xs text-naio-text-muted uppercase tracking-wider block mb-2">Theme</label>
              <select value={selectedTheme} onChange={e => setSelectedTheme(e.target.value)} className="w-full px-3 py-2 bg-naio-bg-surface border border-naio-border rounded-md text-sm text-naio-text-primary focus:outline-none focus:border-naio-cyan/50 appearance-none cursor-pointer">
                {themes.map(t => <option key={t} value={t}>{t}</option>)}
              </select>
            </div>
          )}
        </div>
        <button onClick={generateReport} disabled={generating} className={`px-5 py-2.5 rounded-md text-sm font-semibold transition-colors flex items-center gap-2 ${generating ? "bg-naio-bg-surface text-naio-text-muted cursor-not-allowed" : "bg-naio-cyan text-naio-bg hover:bg-naio-cyan-light"}`}>
          {generating ? (
            <React.Fragment><svg className="animate-spin h-4 w-4" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>Generating with AI...</React.Fragment>
          ) : (
            <React.Fragment><Icon name="FileText" size={14}/>Generate Report</React.Fragment>
          )}
        </button>
        {error && <p className="mt-3 text-xs text-naio-red">{error}</p>}
      </div>

      {/* Generating state */}
      {generating && (
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-12 text-center">
          <svg className="animate-spin h-8 w-8 text-naio-cyan mx-auto mb-4" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
          <p className="text-sm text-naio-text-secondary">Analyzing intelligence database and generating report...</p>
          <p className="text-xs text-naio-text-muted mt-2">This typically takes 15-30 seconds</p>
        </div>
      )}

      {/* Generated Report */}
      {generatedReport && !generating && (
        <div>
          <div ref={reportRef} className="bg-white text-gray-900 rounded-lg overflow-hidden p-8">
            {renderReport(generatedReport)}
            <div className="text-center pt-6 mt-6 border-t border-gray-200">
              <p className="text-[9px] text-gray-400 uppercase tracking-wider">Confidential — For internal use only</p>
              <p className="text-[9px] text-gray-400 mt-1">Generated by NAIO Intelligence | {new Date(generatedReport.generated_at).toLocaleDateString("en-GB", {day:"numeric",month:"short",year:"numeric"})}</p>
            </div>
          </div>
          <div className="flex gap-3 mt-6">
            <button onClick={exportPDF} className="px-4 py-2 bg-naio-cyan text-naio-bg rounded-md text-sm font-semibold hover:bg-naio-cyan-light transition-colors flex items-center gap-2">
              <Icon name="FileText" size={14}/>Export as PDF
            </button>
            <button onClick={() => setGeneratedReport(null)} className="px-4 py-2 bg-naio-bg-surface border border-naio-border text-naio-text-secondary rounded-md text-sm hover:text-naio-text-primary transition-colors">
              Clear Report
            </button>
          </div>
        </div>
      )}
      </div>

      {/* Report Library sidebar */}
      <div className="w-64 flex-shrink-0">
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg overflow-hidden sticky top-6">
          <div className="px-4 py-3 border-b border-naio-border">
            <h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider flex items-center gap-2">
              <Icon name="Archive" size={14}/>
              Report Library
            </h3>
            <p className="text-[10px] text-naio-text-dim mt-1">{library.length} saved report{library.length !== 1 ? "s" : ""}</p>
          </div>
          <div className="max-h-[calc(100vh-220px)] overflow-y-auto">
            {libraryLoading ? (
              <div className="p-4 text-center"><p className="text-xs text-naio-text-muted animate-pulse-custom">Loading...</p></div>
            ) : library.length === 0 ? (
              <div className="p-4 text-center"><p className="text-xs text-naio-text-muted">No reports yet.</p><p className="text-[10px] text-naio-text-dim mt-1">Generate your first report above.</p></div>
            ) : (
              Object.entries(libraryGrouped).map(([groupLabel, reports]) => (
                <div key={groupLabel}>
                  <div className="px-4 py-2 bg-naio-bg-deep/50">
                    <p className="text-[10px] font-semibold text-naio-text-dim uppercase tracking-wider">{groupLabel}</p>
                  </div>
                  {reports.map(r => (
                    <button key={r.id} onClick={() => loadReport(r.id)}
                      className={`w-full text-left px-4 py-2.5 border-b border-naio-border/50 hover:bg-naio-bg-card-hover transition-colors group ${generatedReport?.report_id === r.id ? "bg-naio-bg-surface" : ""}`}>
                      <div className="flex items-start justify-between gap-1">
                        <div className="min-w-0">
                          <div className="flex items-center gap-1.5">
                            <span className={typeColors[r.report_type] || "text-naio-text-muted"}><Icon name={typeIcons[r.report_type] || "FileText"} size={12}/></span>
                            <p className="text-xs text-naio-text-primary font-medium truncate">{r.subject}</p>
                          </div>
                          <p className="text-[10px] text-naio-text-dim mt-0.5">{new Date(r.created_at).toLocaleDateString("en-GB", {day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})}</p>
                        </div>
                        <button onClick={(e) => deleteReport(r.id, e)} className="opacity-0 group-hover:opacity-100 text-naio-text-dim hover:text-naio-red transition-all flex-shrink-0 mt-0.5" title="Delete report">
                          <Icon name="X" size={12}/>
                        </button>
                      </div>
                    </button>
                  ))}
                </div>
              ))
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

function Sidebar({activeTab, onTabChange}) {
  return (
    <aside className="w-56 bg-naio-bg-deep border-r border-naio-border flex flex-col flex-shrink-0">
      <div className="px-5 py-5 border-b border-naio-border">
        <div className="flex items-center gap-2">
          <div className="h-[3px] w-5 bg-naio-cyan rounded-full"/>
          <span className="text-sm font-bold tracking-[0.35em] text-naio-text-primary">N A I O</span>
        </div>
        <p className="text-[10px] text-naio-text-muted mt-1.5 tracking-wider uppercase">Market Intelligence</p>
      </div>
      <nav className="flex-1 py-3 px-3 space-y-0.5 overflow-y-auto">
        {tabs.map(t => (
          <button key={t.id} onClick={()=>onTabChange(t.id)}
            className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-md text-sm transition-all duration-150 ${activeTab===t.id ? "bg-naio-bg-card text-naio-cyan border border-naio-border" : "text-naio-text-secondary hover:text-naio-text-primary hover:bg-naio-bg-card/50 border border-transparent"}`}>
            <span className={activeTab===t.id?"text-naio-cyan":"text-naio-text-muted"}><Icon name={t.icon} size={18}/></span>
            {t.label}
          </button>
        ))}
      </nav>
      <div className="px-4 py-3 border-t border-naio-border">
        <div className="flex items-center gap-2">
          <div className="w-2 h-2 rounded-full bg-naio-green animate-pulse-custom"/>
          <span className="text-[10px] text-naio-text-muted">Pipeline active</span>
        </div>
        <p className="text-[10px] text-naio-text-dim mt-1">Powered by Claude API</p>
      </div>
    </aside>
  );
}

function StatsBar({items}) {
  const stats = [
    {label:"Total Items",value:items.length,icon:"FileText",color:"text-naio-cyan"},
    {label:"High Priority",value:items.filter(i=>i.importance==="high").length,icon:"AlertTriangle",color:"text-naio-red"},
    {label:"Deals",value:items.filter(i=>i.type==="deal_synopsis").length,icon:"Handshake",color:"text-naio-blue-light"},
    {label:"Financing",value:items.filter(i=>i.type==="financing_event").length,icon:"Landmark",color:"text-naio-orange"},
    {label:"Power Signals",value:items.filter(i=>i.type==="power_demand_signal").length,icon:"Zap",color:"text-naio-green"},
  ];
  return (
    <div className="grid grid-cols-5 gap-4">
      {stats.map(s => (
        <div key={s.label} className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4">
          <div className="flex items-center justify-between">
            <span className={s.color}><Icon name={s.icon} size={16}/></span>
            <span className="text-3xl font-bold text-naio-text-primary">{s.value}</span>
          </div>
          <p className="text-xs uppercase tracking-wider text-naio-text-muted mt-1">{s.label}</p>
        </div>
      ))}
    </div>
  );
}

function IntelCard({item, onClick}) {
  return (
    <button onClick={onClick} className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4 text-left w-full hover:bg-naio-bg-card-hover hover:border-naio-border-light transition-all duration-200 group">
      <div className="flex items-center justify-between mb-2">
        <div className="flex items-center gap-2">
          <span className={`px-2 py-0.5 rounded-full text-[10px] font-semibold uppercase tracking-wider ${layerClass[item.layer]||""}`}>{layerLabels[item.layer]}</span>
          <span className="flex items-center gap-1.5 text-[11px] text-naio-text-muted"><Icon name={typeIconMap[item.type]} size={13}/>{typeLabels[item.type]}</span>
        </div>
        <div className="flex items-center gap-2">
          <div className={`w-1.5 h-1.5 rounded-full ${impDot[item.importance]}`}/>
          <span className="text-[11px] text-naio-text-dim">{relDate(item.date)}</span>
        </div>
      </div>
      <h3 className="text-sm font-semibold text-naio-text-primary leading-snug mb-1.5 group-hover:text-naio-cyan transition-colors">{item.headline}</h3>
      <p className="text-xs text-naio-text-secondary leading-relaxed line-clamp-2 mb-3">{item.summary}</p>
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2 flex-wrap">
          {item.companies.slice(0,3).map(c => <span key={c} className="px-2 py-0.5 rounded bg-naio-bg-surface text-[10px] text-naio-text-secondary">{c}</span>)}
          {item.companies.length>3 && <span className="text-[10px] text-naio-text-dim">+{item.companies.length-3}</span>}
          <span className="text-[10px] text-naio-text-dim ml-1">{item.region}</span>
        </div>
        <span className="text-naio-text-dim group-hover:text-naio-cyan transition-colors"><Icon name="ChevronRight" size={14}/></span>
      </div>
    </button>
  );
}

function IntelTable({items, onItemClick}) {
  const [tableSortCol, setTableSortCol] = useState("date");
  const [tableSortDir, setTableSortDir] = useState("desc");

  const sorted = useMemo(() => {
    let sorted = [...items];
    sorted.sort((a, b) => {
      let aVal, bVal;
      if (tableSortCol === "date") {
        aVal = new Date(a.date); bVal = new Date(b.date);
      } else if (tableSortCol === "importance") {
        const impOrder = {high: 3, medium: 2, low: 1};
        aVal = impOrder[a.importance] || 0; bVal = impOrder[b.importance] || 0;
      } else if (tableSortCol === "type") {
        aVal = a.type; bVal = b.type;
      } else if (tableSortCol === "region") {
        aVal = a.region; bVal = b.region;
      } else if (tableSortCol === "companies") {
        aVal = (a.companies || [])[0] || ""; bVal = (b.companies || [])[0] || "";
      } else {
        aVal = a[tableSortCol] || ""; bVal = b[tableSortCol] || "";
      }
      if (tableSortDir === "asc") return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
      return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
    });
    return sorted;
  }, [items, tableSortCol, tableSortDir]);

  const toggleSort = (col) => {
    if (tableSortCol === col) setTableSortDir(d => d === "asc" ? "desc" : "asc");
    else { setTableSortCol(col); setTableSortDir("desc"); }
  };

  const cols = [
    {key: "date", label: "Date", w: "w-24"},
    {key: "headline", label: "Headline", w: "flex-1"},
    {key: "type", label: "Type", w: "w-28"},
    {key: "importance", label: "Priority", w: "w-20"},
    {key: "region", label: "Region", w: "w-36"},
    {key: "companies", label: "Companies", w: "w-36"},
  ];

  const impBadge = {
    high: "bg-[#FF5252]/20 text-[#FF5252]",
    medium: "bg-[#FF9800]/20 text-[#FFB74D]",
    low: "bg-[#6B8FA3]/20 text-[#6B8FA3]"
  };

  return (
    <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg overflow-hidden">
      <div className="overflow-x-auto">
        <table className="w-full text-sm">
          <thead>
            <tr className="bg-[#122640] border-b border-naio-border">
              {cols.map(col => (
                <th key={col.key}
                  className={`px-4 py-3 text-left text-naio-cyan font-semibold text-[11px] uppercase tracking-wider cursor-pointer hover:bg-naio-bg-card/50 transition-colors ${col.w}`}
                  onClick={() => toggleSort(col.key)}>
                  <div className="flex items-center gap-1.5">
                    {col.label}
                    {tableSortCol === col.key && <span className="text-[10px]">{tableSortDir === "asc" ? "↑" : "↓"}</span>}
                  </div>
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {sorted.map((item, idx) => (
              <tr key={item.id}
                className={`border-b border-naio-border/50 cursor-pointer transition-colors ${idx % 2 === 0 ? "bg-[#0F2237]" : "bg-[#0D1F33]"} hover:bg-naio-bg-card-hover`}
                onClick={() => onItemClick(item)}>
                <td className="px-4 py-2.5 text-naio-text-dim text-xs font-mono whitespace-nowrap">{fmtDate(item.date)}</td>
                <td className="px-4 py-2.5">
                  <p className="text-naio-text-primary text-xs font-medium line-clamp-2">{item.headline}</p>
                </td>
                <td className="px-4 py-2.5">
                  <span className={`inline-block px-2 py-0.5 rounded text-[10px] font-semibold ${layerClass[item.layer] || "bg-naio-bg-surface text-naio-text-muted"}`}>
                    {typeLabels[item.type] || item.type}
                  </span>
                </td>
                <td className="px-4 py-2.5">
                  <span className={`inline-block px-2 py-0.5 rounded text-[10px] font-semibold capitalize ${impBadge[item.importance] || ""}`}>
                    {item.importance}
                  </span>
                </td>
                <td className="px-4 py-2.5 text-naio-text-muted text-xs">{item.region}</td>
                <td className="px-4 py-2.5 text-naio-text-muted text-[11px]">{(item.companies || []).slice(0, 2).join(", ")}{item.companies?.length > 2 ? ` +${item.companies.length - 2}` : ""}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      {sorted.length === 0 && <div className="text-center py-12 text-naio-text-muted"><p>No items match your filters.</p></div>}
    </div>
  );
}

function DetailRow({label,value}) { if(!value) return null; return <div className="flex items-start gap-3"><span className="text-[11px] text-naio-text-muted w-28 flex-shrink-0 pt-0.5">{label}</span><span className="text-sm text-naio-text-secondary">{value}</span></div>; }
function RatingBadge({agency,rating}) { return <div className="text-center"><p className="text-[10px] text-naio-text-dim">{agency}</p><p className="text-sm font-bold text-naio-text-primary">{rating}</p></div>; }

function DetailModal({item, onClose}) {
  const fd = item.full_data;
  useEffect(() => { const h = e => { if(e.key==="Escape") onClose(); }; document.addEventListener("keydown",h); return ()=>document.removeEventListener("keydown",h); }, [onClose]);

  return (
    <div className="fixed inset-0 z-50 flex items-start justify-end animate-fade-in">
      <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}/>
      <div className="relative w-full max-w-2xl h-full bg-naio-bg-deep border-l border-naio-border overflow-y-auto animate-slide-in">
        <div className="h-[2px] bg-gradient-to-r from-naio-cyan via-naio-teal to-transparent"/>
        <div className="sticky top-0 bg-naio-bg-deep/95 backdrop-blur-sm z-10 px-6 py-4 border-b border-naio-border">
          <div className="flex items-start justify-between">
            <div className="flex-1 mr-4">
              <div className="flex items-center gap-2 mb-2">
                <span className={`px-2 py-0.5 rounded-full text-[10px] font-semibold uppercase tracking-wider ${layerClass[item.layer]}`}>{layerLabels[item.layer]}</span>
                <span className="text-[11px] text-naio-text-muted">{typeLabels[item.type]}</span>
                <div className={`w-1.5 h-1.5 rounded-full ${impDot[item.importance]}`}/>
                <span className="text-[11px] text-naio-text-dim capitalize">{item.importance} priority</span>
              </div>
              <h2 className="text-lg font-semibold text-naio-text-primary leading-snug">{item.headline}</h2>
            </div>
            <button onClick={onClose} className="p-1.5 rounded hover:bg-naio-bg-card text-naio-text-muted hover:text-naio-text-primary transition-colors"><Icon name="X" size={18}/></button>
          </div>
        </div>
        <div className="px-6 py-5 space-y-6">
          <div className="flex flex-wrap gap-4 text-xs text-naio-text-muted">
            <span className="flex items-center gap-1"><Icon name="Calendar" size={12}/> {fmtDate(item.date)}</span>
            <span className="flex items-center gap-1"><Icon name="MapPin" size={12}/> {item.region}</span>
            <span className="flex items-center gap-1"><Icon name="Building2" size={12}/> {item.companies.join(", ")}</span>
          </div>
          <div><h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-2">Summary</h3><p className="text-sm text-naio-text-secondary leading-relaxed">{item.summary}</p></div>
          <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4">
            <h3 className="text-xs font-semibold text-naio-orange uppercase tracking-wider mb-2">Why This Matters</h3>
            <p className="text-sm text-naio-text-secondary">{item.importance_rationale}</p>
          </div>

          {item.type==="deal_synopsis" && fd.parties && <div>
            <h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-2">Deal Details</h3>
            <div className="space-y-2">
              <DetailRow label="Deal Type" value={fd.deal_type}/>
              <DetailRow label="Value" value={fd.deal_value}/>
              {fd.capacity_mw && <DetailRow label="Capacity" value={fd.capacity_mw+" MW"}/>}
              <div className="mt-3"><p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Parties</p>
                <div className="flex flex-wrap gap-2">{fd.parties.map((p,i)=><span key={i} className="px-2 py-1 rounded bg-naio-bg-card text-xs text-naio-text-secondary border border-naio-border">{p.name} <span className="text-naio-text-dim">({p.role})</span></span>)}</div>
              </div>
            </div>
          </div>}

          {item.type==="financing_event" && <div>
            <h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-2">Terms</h3>
            <div className="space-y-2">
              <DetailRow label="Type" value={fd.event_subtype}/>
              <DetailRow label="Amount" value={fd.amount}/>
              <DetailRow label="Tenor" value={fd.tenor_maturity}/>
              <DetailRow label="Coupon" value={fd.coupon_rate}/>
              <DetailRow label="Spread" value={fd.spread}/>
              {fd.rating && <div className="mt-3 bg-naio-bg-card/80 border border-naio-border rounded-lg p-3">
                <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-2">Credit Ratings</p>
                <div className="flex gap-4">{fd.rating.moodys&&<RatingBadge agency="Moody's" rating={fd.rating.moodys}/>}{fd.rating.sp&&<RatingBadge agency="S&P" rating={fd.rating.sp}/>}{fd.rating.fitch&&<RatingBadge agency="Fitch" rating={fd.rating.fitch}/>}</div>
                {fd.rating.outlook&&<p className="text-xs text-naio-text-muted mt-2">Outlook: <span className="text-naio-text-secondary capitalize">{fd.rating.outlook}</span></p>}
              </div>}
              <DetailRow label="Use of Proceeds" value={fd.use_of_proceeds}/>
              {fd.lead_arrangers&&<DetailRow label="Lead Arrangers" value={fd.lead_arrangers.join(", ")}/>}
            </div>
          </div>}

          {item.type==="capex_announcement" && fd.breakdown && <div>
            <h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-2">Capex Breakdown</h3>
            <div className="space-y-2">
              <DetailRow label="Total Spend" value={fd.announced_spend}/>
              <DetailRow label="Time Horizon" value={fd.time_horizon}/>
              <DetailRow label="Self-Build" value={fd.breakdown.self_build}/>
              <DetailRow label="Colo / Leasing" value={fd.breakdown.colo_leasing}/>
              <DetailRow label="Funding Source" value={fd.funding_source}/>
            </div>
            {fd.colo_signal && <div className="mt-3 bg-naio-bg-card/80 border border-naio-border rounded-lg p-3 border-l-2 border-l-naio-orange">
              <p className="text-[10px] text-naio-orange uppercase tracking-wider mb-1">Colo Signal</p>
              <p className="text-xs text-naio-text-secondary">{fd.colo_signal}</p>
            </div>}
          </div>}

          {item.type==="earnings_intelligence" && fd.key_metrics && <div>
            <h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-2">Key Metrics — {fd.period}</h3>
            <div className="grid grid-cols-2 gap-2">
              {Object.entries(fd.key_metrics).map(([k,v])=>v?<div key={k} className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-3"><p className="text-[10px] text-naio-text-muted uppercase">{k.replace(/_/g," ")}</p><p className="text-sm text-naio-text-primary font-medium mt-0.5">{v}</p></div>:null)}
            </div>
            {fd.demand_signals&&<div className="mt-3"><DetailRow label="Demand Signals" value={fd.demand_signals}/></div>}
            {fd.geographic_color&&<div className="mt-2"><DetailRow label="Geographic Color" value={fd.geographic_color}/></div>}
          </div>}

          {item.type==="power_demand_signal" && <div>
            <h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-2">Power Demand Details</h3>
            <div className="space-y-2">
              <DetailRow label="Utility / Grid" value={fd.utility_or_grid_operator}/>
              <DetailRow label="Signal Type" value={fd.signal_type}/>
              {fd.requested_capacity_mw&&<DetailRow label="Capacity" value={fd.requested_capacity_mw+" MW"}/>}
              <DetailRow label="DC Operator" value={fd.associated_dc_operator||fd.dc_operator}/>
              <DetailRow label="Timeline" value={fd.timeline}/>
            </div>
            {fd.utility_opportunity&&<div className="mt-3 bg-naio-bg-card/80 border border-naio-border rounded-lg p-3 border-l-2 border-l-naio-green">
              <p className="text-[10px] text-naio-green uppercase tracking-wider mb-1">Utility Opportunity</p>
              <p className="text-xs text-naio-text-secondary">{fd.utility_opportunity}</p>
            </div>}
          </div>}

          {item.type==="regulatory_update" && <div>
            <h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-2">Regulatory Details</h3>
            <div className="space-y-2">
              <DetailRow label="Jurisdiction" value={fd.jurisdiction}/>
              <DetailRow label="Body" value={fd.regulatory_body}/>
              <DetailRow label="Action" value={fd.action_type}/>
              <DetailRow label="Status" value={fd.status}/>
              {fd.affected_capacity_mw&&<DetailRow label="Affected Capacity" value={fd.affected_capacity_mw+" MW"}/>}
            </div>
          </div>}

          {fd.implications&&<div><h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-2">Market Implications</h3><p className="text-sm text-naio-text-secondary leading-relaxed">{fd.implications}</p></div>}
          {fd.comparable_context&&<div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4 border-l-2 border-l-naio-blue"><h3 className="text-xs font-semibold text-naio-blue-light uppercase tracking-wider mb-2">Comparable Context</h3><p className="text-sm text-naio-text-secondary leading-relaxed">{fd.comparable_context}</p></div>}
          {fd.credit_commentary&&<div><h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-2">Credit Commentary</h3><p className="text-sm text-naio-text-secondary leading-relaxed">{fd.credit_commentary}</p></div>}

          <div className="flex items-center gap-1.5 flex-wrap pt-2 border-t border-naio-border">
            <Icon name="Tag" size={12} className="text-naio-text-dim"/>
            {item.tags.map(t=><span key={t} className="px-2 py-0.5 rounded-full bg-naio-bg-card text-[10px] text-naio-text-muted border border-naio-border">{t}</span>)}
          </div>
          <a href={item.source_url || "#"} target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-xs text-naio-cyan hover:text-naio-cyan-light transition-colors">
            <Icon name="ExternalLink" size={12}/>
            <span>View source: {item.source_name} →</span>
          </a>
        </div>
      </div>
    </div>
  );
}

function TabAnalytics({items, layer}) {
  const chartRef = useRef(null);
  const chartInstance = useRef(null);

  // Aggregate items by month
  const monthlyData = useMemo(() => {
    const months = {};
    items.forEach(item => {
      const d = new Date(item.date + "T00:00:00");
      const key = d.toLocaleDateString("en-US", {month: "short", year: "2-digit"});
      if (!months[key]) months[key] = {total: 0, high: 0, types: {}};
      months[key].total++;
      if (item.importance === "high") months[key].high++;
      const t = typeLabels[item.type] || item.type;
      months[key].types[t] = (months[key].types[t] || 0) + 1;
    });
    // Sort by date
    const sorted = Object.entries(months).sort((a, b) => {
      const da = new Date("01 " + a[0]); const db = new Date("01 " + b[0]);
      return da - db;
    });
    return sorted;
  }, [items]);

  // Type distribution
  const typeDistribution = useMemo(() => {
    const dist = {};
    items.forEach(i => {
      const t = typeLabels[i.type] || i.type;
      dist[t] = (dist[t] || 0) + 1;
    });
    return Object.entries(dist).sort((a, b) => b[1] - a[1]);
  }, [items]);

  // Region distribution
  const regionDistribution = useMemo(() => {
    const dist = {};
    items.forEach(i => {
      const rg = getRegionGroup(i.region);
      dist[rg] = (dist[rg] || 0) + 1;
    });
    return Object.entries(dist).sort((a, b) => b[1] - a[1]);
  }, [items]);

  // Importance breakdown
  const importanceBreakdown = useMemo(() => {
    const high = items.filter(i => i.importance === "high").length;
    const medium = items.filter(i => i.importance === "medium").length;
    const low = items.filter(i => i.importance === "low").length;
    return {high, medium, low};
  }, [items]);

  // Extract quantitative data from full_data where available
  const quantData = useMemo(() => {
    let totalMW = 0;
    let totalDeals = 0;
    let totalFinancing = 0;
    let companies = new Set();
    items.forEach(i => {
      const fd = i.full_data || {};
      if (fd.capacity_mw) totalMW += Number(fd.capacity_mw) || 0;
      if (i.type === "deal_synopsis" || i.type === "capex_announcement") totalDeals++;
      if (fd.deal_value) {
        const val = String(fd.deal_value).replace(/[^0-9.]/g, "");
        if (val) totalFinancing += parseFloat(val) || 0;
      }
      (i.companies || []).forEach(c => companies.add(c));
    });
    return {totalMW, totalDeals, totalFinancing, companyCount: companies.size};
  }, [items]);

  // Timeline chart
  useEffect(() => {
    if (!chartRef.current || monthlyData.length === 0) return;
    if (chartInstance.current) chartInstance.current.destroy();

    const ctx = chartRef.current.getContext("2d");
    chartInstance.current = new Chart(ctx, {
      type: "bar",
      data: {
        labels: monthlyData.map(d => d[0]),
        datasets: [
          {
            label: "High Priority",
            data: monthlyData.map(d => d[1].high),
            backgroundColor: "rgba(255, 82, 82, 0.7)",
            borderRadius: 3,
          },
          {
            label: "Other",
            data: monthlyData.map(d => d[1].total - d[1].high),
            backgroundColor: "rgba(0, 188, 212, 0.4)",
            borderRadius: 3,
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: "top", labels: { color: "#6B8FA3", font: {size: 10}, boxWidth: 12, padding: 12 }},
          tooltip: { backgroundColor: "#0F2237", borderColor: "#1A3A5C", borderWidth: 1, titleColor: "#fff", bodyColor: "#B0C4D8" }
        },
        scales: {
          x: { stacked: true, grid: {display: false}, ticks: {color: "#6B8FA3", font: {size: 10}} },
          y: { stacked: true, grid: {color: "#1A3A5C"}, ticks: {color: "#6B8FA3", font: {size: 10}, stepSize: 1} }
        }
      }
    });

    return () => { if (chartInstance.current) chartInstance.current.destroy(); };
  }, [monthlyData]);

  const layerColors = {
    infrastructure: "#3B9FE3", chip: "#AB47BC", energy: "#00E676",
    financing: "#FF9800", supply_chain: "#00BFA6"
  };
  const accentColor = layerColors[layer] || "#00BCD4";

  return (
    <div className="mb-6">
      {/* Stats row */}
      <div className="grid grid-cols-4 gap-3 mb-4">
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-3">
          <p className="text-[10px] text-naio-text-dim uppercase tracking-wider">Total Items</p>
          <p className="text-xl font-bold text-naio-text-primary mt-1">{items.length}</p>
        </div>
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-3">
          <p className="text-[10px] text-naio-text-dim uppercase tracking-wider">High Priority</p>
          <p className="text-xl font-bold text-naio-red mt-1">{importanceBreakdown.high}</p>
        </div>
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-3">
          <p className="text-[10px] text-naio-text-dim uppercase tracking-wider">{quantData.totalMW > 0 ? "Tracked MW" : "Companies"}</p>
          <p className="text-xl font-bold mt-1" style={{color: accentColor}}>{quantData.totalMW > 0 ? quantData.totalMW.toLocaleString() + " MW" : quantData.companyCount}</p>
        </div>
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-3">
          <p className="text-[10px] text-naio-text-dim uppercase tracking-wider">Deals / Announcements</p>
          <p className="text-xl font-bold text-naio-text-primary mt-1">{quantData.totalDeals}</p>
        </div>
      </div>

      {/* Charts row */}
      <div className="grid grid-cols-3 gap-4">
        {/* Timeline */}
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4 col-span-1">
          <h3 className="text-[10px] text-naio-text-dim uppercase tracking-wider mb-3">Items Over Time</h3>
          <div className="h-36"><canvas ref={chartRef}/></div>
        </div>

        {/* Type Distribution */}
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4">
          <h3 className="text-[10px] text-naio-text-dim uppercase tracking-wider mb-3">By Type</h3>
          <div className="space-y-1.5">
            {typeDistribution.slice(0, 6).map(([type, count]) => {
              const pct = items.length > 0 ? (count / items.length) * 100 : 0;
              return (
                <div key={type} className="flex items-center gap-2">
                  <span className="text-[10px] text-naio-text-muted w-24 truncate">{type}</span>
                  <div className="flex-1 h-2 bg-naio-bg-surface rounded-full overflow-hidden">
                    <div className="h-full rounded-full" style={{width: pct + "%", backgroundColor: accentColor, opacity: 0.7}}/>
                  </div>
                  <span className="text-[10px] text-naio-text-dim w-6 text-right">{count}</span>
                </div>
              );
            })}
          </div>
        </div>

        {/* Region Distribution */}
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4">
          <h3 className="text-[10px] text-naio-text-dim uppercase tracking-wider mb-3">By Region</h3>
          <div className="space-y-1.5">
            {regionDistribution.slice(0, 6).map(([region, count]) => {
              const pct = items.length > 0 ? (count / items.length) * 100 : 0;
              return (
                <div key={region} className="flex items-center gap-2">
                  <span className="text-[10px] text-naio-text-muted w-24 truncate">{region}</span>
                  <div className="flex-1 h-2 bg-naio-bg-surface rounded-full overflow-hidden">
                    <div className="h-full rounded-full bg-naio-teal" style={{width: pct + "%", opacity: 0.7}}/>
                  </div>
                  <span className="text-[10px] text-naio-text-dim w-6 text-right">{count}</span>
                </div>
              );
            })}
          </div>
        </div>
      </div>
    </div>
  );
}

function HeatmapView({data}) {
  const max = Math.max(...data.map(d=>d.heat_score));
  return (
    <div className="space-y-3">
      {[...data].sort((a,b)=>b.heat_score-a.heat_score).map(m => {
        const pct = (m.heat_score/max)*100;
        const c = m.heat_score>=80?"from-[#FF5252]/40 to-[#FF9800]/20":m.heat_score>=60?"from-[#FF9800]/30 to-[#FF9800]/10":"from-[#00BCD4]/20 to-[#00BCD4]/5";
        const tc = m.heat_score>=80?"text-naio-red":m.heat_score>=60?"text-naio-orange":"text-naio-cyan";
        return (
          <div key={m.region} className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4">
            <div className="flex items-center justify-between mb-2">
              <div className="flex items-center gap-3"><h3 className="text-sm font-semibold text-naio-text-primary">{m.region}</h3><span className={`text-xs font-bold ${tc}`}>{m.heat_score}</span></div>
              <div className="flex items-center gap-4 text-[11px] text-naio-text-muted"><span>{m.news_count} news</span><span>{m.deal_count} deals</span><span>{m.total_mw.toLocaleString()} MW</span></div>
            </div>
            <div className="h-1.5 rounded-full bg-naio-bg-surface overflow-hidden"><div className={`h-full rounded-full bg-gradient-to-r ${c} transition-all duration-500`} style={{width:pct+"%"}}/></div>
          </div>
        );
      })}
    </div>
  );
}

function CompsTable({data, allData=[]}) {
  const [sortCol, setSortCol] = useState("date");
  const [sortDir, setSortDir] = useState("desc");
  const [selectedDeal, setSelectedDeal] = useState(null);

  const sorted = useMemo(() => {
    let items = [...data];
    items.sort((a, b) => {
      let aVal = a[sortCol];
      let bVal = b[sortCol];
      if(typeof aVal === 'string') {
        aVal = aVal.toLowerCase();
        bVal = bVal.toLowerCase();
      }
      if(sortDir === "asc") return aVal > bVal ? 1 : -1;
      return aVal < bVal ? 1 : -1;
    });
    return items;
  }, [sortCol, sortDir, data]);

  const toggleSort = (col) => {
    if(sortCol === col) {
      setSortDir(sortDir === "asc" ? "desc" : "asc");
    } else {
      setSortCol(col);
      setSortDir("asc");
    }
  };

  const getSpreadColor = (bps) => {
    if(bps < 175) return "text-naio-green";
    if(bps <= 225) return "text-naio-orange-light";
    return "text-naio-orange";
  };

  const getIntelligenceItem = (issuer) => {
    return allData.find(item =>
      item.type === "financing_event" &&
      (item.companies || []).some(c => c.toLowerCase() === issuer.toLowerCase())
    );
  };

  const columns = [
    {key: "issuer", label: "Issuer"},
    {key: "type", label: "Type"},
    {key: "amount", label: "Amount"},
    {key: "tenor", label: "Tenor"},
    {key: "coupon", label: "Coupon"},
    {key: "spread_bps", label: "Spread (bps)"},
    {key: "rating", label: "Rating"},
    {key: "date", label: "Date"},
    {key: "source", label: "Source"},
  ];

  return (
    <>
      <div className="overflow-x-auto">
        <table className="w-full text-sm">
          <thead>
            <tr className="bg-[#122640] border-b border-naio-border">
              {columns.map(col => (
                <th key={col.key} className="px-4 py-3 text-left text-naio-cyan font-semibold text-xs uppercase tracking-wider cursor-pointer hover:bg-naio-bg-card/50 transition-colors"
                  onClick={() => toggleSort(col.key)}>
                  <div className="flex items-center gap-2">
                    {col.label}
                    {sortCol === col.key && (
                      <span className="text-[10px]">{sortDir === "asc" ? "↑" : "↓"}</span>
                    )}
                  </div>
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {sorted.map((row, idx) => (
              <tr key={idx} className={`border-b border-naio-border ${idx % 2 === 0 ? "bg-[#0F2237]" : "bg-[#0D1F33]"} hover:bg-naio-bg-card-hover transition-colors cursor-pointer`}
                onClick={() => setSelectedDeal(row)}>
                <td className="px-4 py-3 text-naio-text-primary font-medium">{row.issuer}</td>
                <td className="px-4 py-3 text-naio-text-secondary text-xs">{row.type}</td>
                <td className="px-4 py-3 text-naio-text-secondary">{row.amount}</td>
                <td className="px-4 py-3 text-naio-text-muted text-xs">{row.tenor}</td>
                <td className="px-4 py-3 text-naio-text-secondary font-mono">{row.coupon}</td>
                <td className={`px-4 py-3 font-bold ${getSpreadColor(row.spread_bps)}`}>{row.spread_bps}</td>
                <td className="px-4 py-3 text-naio-text-muted text-xs">{row.rating}</td>
                <td className="px-4 py-3 text-naio-text-dim text-xs">{fmtDate(row.date)}</td>
                <td className="px-4 py-3 text-xs">
                  <a href={row.source_url || "#"} target="_blank" rel="noopener noreferrer" onClick={(e) => e.stopPropagation()} className="text-naio-cyan hover:text-naio-cyan-light flex items-center gap-1">
                    <Icon name="ExternalLink" size={12}/>
                    {row.source_name || "View"}
                  </a>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* Deal card modal */}
      {selectedDeal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center animate-fade-in">
          <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setSelectedDeal(null)}/>
          <div className="relative max-w-2xl w-11/12 bg-naio-bg-deep border border-naio-border rounded-lg overflow-hidden animate-slide-in max-h-[80vh] overflow-y-auto">
            <div className="h-[2px] bg-gradient-to-r from-naio-cyan via-naio-teal to-transparent"/>
            <div className="sticky top-0 bg-naio-bg-deep/95 backdrop-blur-sm z-10 px-6 py-4 border-b border-naio-border flex items-start justify-between">
              <div className="flex-1">
                <h2 className="text-lg font-semibold text-naio-text-primary">{selectedDeal.issuer}</h2>
                <p className="text-xs text-naio-text-muted mt-1">{selectedDeal.type} | {selectedDeal.amount}</p>
              </div>
              <button onClick={() => setSelectedDeal(null)} className="p-1.5 rounded hover:bg-naio-bg-card text-naio-text-muted flex-shrink-0"><Icon name="X" size={18}/></button>
            </div>
            <div className="px-6 py-5 space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Amount</p>
                  <p className="text-sm font-bold text-naio-cyan">{selectedDeal.amount}</p>
                </div>
                <div>
                  <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Type</p>
                  <p className="text-sm text-naio-text-secondary">{selectedDeal.type}</p>
                </div>
                <div>
                  <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Tenor</p>
                  <p className="text-sm text-naio-text-secondary">{selectedDeal.tenor}</p>
                </div>
                <div>
                  <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Coupon</p>
                  <p className="text-sm text-naio-text-secondary font-mono">{selectedDeal.coupon}</p>
                </div>
                <div>
                  <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Spread</p>
                  <p className={`text-sm font-bold ${getSpreadColor(selectedDeal.spread_bps)}`}>{selectedDeal.spread_bps} bps</p>
                </div>
                <div>
                  <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Rating</p>
                  <p className="text-sm text-naio-text-secondary">{selectedDeal.rating}</p>
                </div>
              </div>
              <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-3">
                <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-2">Date</p>
                <p className="text-sm text-naio-text-secondary">{fmtDate(selectedDeal.date)}</p>
              </div>
              <div>
                <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-2">Source</p>
                <a href={selectedDeal.source_url || "#"} target="_blank" rel="noopener noreferrer" className="text-sm text-naio-cyan hover:text-naio-cyan-light flex items-center gap-1">
                  <Icon name="ExternalLink" size={14}/>
                  {selectedDeal.source_name || "View source"}
                </a>
              </div>
            </div>
          </div>
        </div>
      )}
    </>
  );
}

const eventTypeConfig = {conference:{icon:"Globe",color:"text-naio-cyan"},earnings:{icon:"BarChart3",color:"text-naio-orange"},regulatory_deadline:{icon:"Scale",color:"text-naio-red"},bond_maturity:{icon:"Landmark",color:"text-naio-purple"},ipo:{icon:"Landmark",color:"text-naio-green"},other:{icon:"Calendar",color:"text-naio-text-muted"}};

function CalendarView({events}) {
  const sorted = [...events].sort((a,b)=>new Date(a.start_date)-new Date(b.start_date));
  const grouped = {};
  sorted.forEach(e=>{const m=new Date(e.start_date+"T00:00:00").toLocaleDateString("en-US",{month:"long",year:"numeric"});if(!grouped[m])grouped[m]=[];grouped[m].push(e);});
  return (
    <div className="space-y-8">
      {Object.entries(grouped).map(([month,evts])=>(
        <div key={month}>
          <h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-3">{month}</h2>
          <div className="space-y-2">{evts.map(ev=>{
            const cfg=eventTypeConfig[ev.event_type]||eventTypeConfig.other;
            return (
              <div key={ev.id} className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4 flex items-start gap-4 hover:bg-naio-bg-card-hover hover:border-naio-border-light transition-all duration-200">
                <div className="w-14 text-center flex-shrink-0"><p className="text-2xl font-bold text-naio-text-primary">{new Date(ev.start_date+"T00:00:00").getDate()}</p><p className="text-[10px] text-naio-text-muted uppercase">{new Date(ev.start_date+"T00:00:00").toLocaleDateString("en-US",{weekday:"short"})}</p></div>
                <div className="flex-1"><div className="flex items-center gap-2 mb-1"><span className={cfg.color}><Icon name={cfg.icon} size={14}/></span><span className="text-[10px] uppercase tracking-wider text-naio-text-dim">{ev.event_type.replace(/_/g," ")}</span></div><h3 className="text-sm font-semibold text-naio-text-primary">{ev.title}</h3><p className="text-xs text-naio-text-muted mt-0.5">{ev.description}{ev.location&&" — "+ev.location}</p>{ev.end_date&&ev.end_date!==ev.start_date&&<p className="text-[10px] text-naio-text-dim mt-1">{fmtDate(ev.start_date)} – {fmtDate(ev.end_date)}</p>}</div>
              </div>
            );
          })}</div>
        </div>
      ))}
    </div>
  );
}

// ─── COMPANY RESEARCH COMPONENT ────────────────────────
function CompanyResearch({data=[], fetchData}) {
  const [companyName, setCompanyName] = useState("");
  const [researching, setResearching] = useState(false);
  const [result, setResult] = useState(null);
  const [researchError, setResearchError] = useState(null);
  const [researchHistory, setResearchHistory] = useState([]);

  // Load research history from DB on mount
  useEffect(() => {
    const loadHistory = async () => {
      const { data: items } = await supabase
        .from('intelligence_items')
        .select('companies, date, source_name')
        .eq('source_name', 'Company Research (Claude)')
        .order('date', { ascending: false })
        .limit(100);
      if (items) {
        const companyMap = {};
        items.forEach(item => {
          (item.companies || []).forEach(c => {
            if (!companyMap[c]) companyMap[c] = { company: c, lastResearched: item.date, count: 0 };
            companyMap[c].count++;
          });
        });
        setResearchHistory(Object.values(companyMap).sort((a, b) => new Date(b.lastResearched) - new Date(a.lastResearched)));
      }
    };
    loadHistory();
  }, [result]);

  // Get unique companies from existing data for suggestions
  const knownCompanies = useMemo(() => {
    const compSet = new Set();
    data.forEach(item => (item.companies || []).forEach(c => compSet.add(c)));
    return [...compSet].sort();
  }, [data]);

  const [showSuggestions, setShowSuggestions] = useState(false);
  const filteredSuggestions = useMemo(() => {
    if (!companyName.trim()) return knownCompanies.slice(0, 10);
    const q = companyName.toLowerCase();
    return knownCompanies.filter(c => c.toLowerCase().includes(q)).slice(0, 8);
  }, [companyName, knownCompanies]);

  const handleResearch = async () => {
    if (!companyName.trim()) return;
    setResearching(true);
    setResearchError(null);
    setResult(null);
    try {
      const resp = await fetch(`${SUPABASE_URL}/functions/v1/generate-report`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${SUPABASE_ANON_KEY}` },
        body: JSON.stringify({ reportType: "company_research", subject: companyName.trim() }),
      });
      const data = await resp.json();
      if (data.error) throw new Error(data.error);
      setResult(data);
      setCompanyName("");
      if (fetchData) await fetchData();
    } catch (err) {
      console.error('Research error:', err);
      setResearchError(err.message || 'Research failed. Make sure the Edge Function is updated.');
    } finally {
      setResearching(false);
    }
  };

  return (
    <div className="max-w-4xl mx-auto">
      {/* Header */}
      <div className="mb-8">
        <h2 className="text-xl font-semibold text-naio-text-primary mb-2">Company Intelligence Research</h2>
        <p className="text-sm text-naio-text-muted">Enter a company name to generate 90 days of AI-powered intelligence. Claude will research the company and create detailed items covering deals, financing, capex, executive moves, regulatory developments, and more.</p>
      </div>

      {/* Search Input */}
      <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-6 mb-6">
        <div className="flex gap-3 items-start">
          <div className="flex-1 relative">
            <label className="text-xs text-naio-text-muted uppercase tracking-wider mb-2 block">Company Name</label>
            <input
              type="text"
              value={companyName}
              onChange={e => { setCompanyName(e.target.value); setShowSuggestions(true); }}
              onFocus={() => setShowSuggestions(true)}
              onBlur={() => setTimeout(() => setShowSuggestions(false), 200)}
              onKeyDown={e => { if (e.key === 'Enter' && companyName.trim() && !researching) handleResearch(); }}
              placeholder="e.g. Equinix, CoreWeave, Brookfield..."
              className="w-full px-4 py-3 bg-naio-bg-deep border border-naio-border rounded-md text-naio-text-primary placeholder-naio-text-dim focus:outline-none focus:border-naio-cyan/50 transition-colors text-sm"
              disabled={researching}
            />
            {showSuggestions && filteredSuggestions.length > 0 && companyName.length > 0 && (
              <div className="absolute z-20 w-full mt-1 bg-naio-bg-deep border border-naio-border rounded-md shadow-lg max-h-48 overflow-y-auto">
                {filteredSuggestions.map(c => (
                  <button key={c} onClick={() => { setCompanyName(c); setShowSuggestions(false); }}
                    className="w-full text-left px-4 py-2 text-sm text-naio-text-secondary hover:bg-naio-bg-card hover:text-naio-text-primary transition-colors">
                    {c}
                  </button>
                ))}
              </div>
            )}
          </div>
          <div className="pt-6">
            <button
              onClick={handleResearch}
              disabled={researching || !companyName.trim()}
              className="px-6 py-3 bg-naio-cyan/10 border border-naio-cyan/30 rounded-md text-sm text-naio-cyan hover:bg-naio-cyan/20 transition-colors disabled:opacity-50 flex items-center gap-2 whitespace-nowrap"
            >
              {researching ? (
                <>
                  <div className="w-4 h-4 border-2 border-naio-cyan border-t-transparent rounded-full animate-spin"/>
                  Researching...
                </>
              ) : (
                <>
                  <Icon name="Search" size={16}/>
                  Research Company
                </>
              )}
            </button>
          </div>
        </div>

        {researching && (
          <div className="mt-4 flex items-center gap-3 text-sm text-naio-text-muted">
            <div className="w-3 h-3 border-2 border-naio-cyan border-t-transparent rounded-full animate-spin"/>
            <span>Claude is researching {companyName}... This takes 15-30 seconds.</span>
          </div>
        )}

        {researchError && (
          <div className="mt-4 bg-naio-red/10 border border-naio-red/30 rounded-md p-3 text-sm text-naio-red">
            <p className="font-medium">Research failed</p>
            <p className="text-xs mt-1 opacity-80">{researchError}</p>
          </div>
        )}

        {result && (
          <div className="mt-4 bg-naio-green/10 border border-naio-green/30 rounded-md p-4">
            <div className="flex items-center gap-2 mb-1">
              <Icon name="CheckCircle" size={16} className="text-naio-green"/>
              <p className="text-sm font-medium text-naio-green">{result.message || `Research complete for ${result.subject}`}</p>
            </div>
            <p className="text-xs text-naio-text-muted mt-1">{result.items_created || 0} intelligence items generated and saved to database. Switch to any tab to see the new data.</p>
          </div>
        )}
      </div>

      {/* Research History */}
      <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-6">
        <h3 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-4">Previously Researched Companies</h3>
        {researchHistory.length === 0 ? (
          <p className="text-sm text-naio-text-dim">No companies researched yet. Enter a company name above to get started.</p>
        ) : (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
            {researchHistory.map(h => (
              <div key={h.company} className="bg-naio-bg-deep border border-naio-border rounded-md p-3 hover:border-naio-border-light transition-colors">
                <p className="text-sm font-medium text-naio-text-primary">{h.company}</p>
                <div className="flex items-center justify-between mt-1">
                  <span className="text-[10px] text-naio-text-dim">{h.count} items</span>
                  <span className="text-[10px] text-naio-text-dim">Last: {fmtDate(h.lastResearched)}</span>
                </div>
                <button
                  onClick={() => { setCompanyName(h.company); window.scrollTo(0, 0); }}
                  className="mt-2 text-[10px] text-naio-cyan hover:text-naio-cyan-light transition-colors"
                >
                  Research again
                </button>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* How it works */}
      <div className="mt-6 bg-naio-bg-card/50 border border-naio-border/50 rounded-lg p-5">
        <h3 className="text-xs font-semibold text-naio-text-muted uppercase tracking-wider mb-3">How it works</h3>
        <div className="grid grid-cols-1 sm:grid-cols-4 gap-4 text-xs text-naio-text-dim">
          <div className="flex items-start gap-2">
            <span className="text-naio-cyan font-bold">1.</span>
            <span>Enter a company name (DC operator, hyperscaler, PE firm, utility, etc.)</span>
          </div>
          <div className="flex items-start gap-2">
            <span className="text-naio-cyan font-bold">2.</span>
            <span>Claude researches the company and generates 8-12 intelligence items spanning the last 90 days</span>
          </div>
          <div className="flex items-start gap-2">
            <span className="text-naio-cyan font-bold">3.</span>
            <span>Items are saved to the database with full deal details, financing metrics, and analysis</span>
          </div>
          <div className="flex items-start gap-2">
            <span className="text-naio-cyan font-bold">4.</span>
            <span>New items appear across all tabs — Dashboard, News Feed, Financing, and more</span>
          </div>
        </div>
      </div>
    </div>
  );
}

// ─── DEMAND PIPELINE COMPONENT ─────────────────────────
function DemandPipeline() {
  const [sortCol, setSortCol] = useState("capacity_mw");
  const [sortDir, setSortDir] = useState("desc");
  const [selectedDeal, setSelectedDeal] = useState(null);
  const chartRef = useRef(null);
  const ppaChartRef = useRef(null);
  const chartInstance = useRef(null);
  const ppaChartInstance = useRef(null);

  const sorted = useMemo(() => {
    let items = [...demandPipelineData];
    items.sort((a, b) => {
      let aVal = a[sortCol];
      let bVal = b[sortCol];
      if(typeof aVal === 'string') {
        aVal = aVal.toLowerCase();
        bVal = bVal.toLowerCase();
      }
      if(sortDir === "asc") return aVal > bVal ? 1 : -1;
      return aVal < bVal ? 1 : -1;
    });
    return items;
  }, [sortCol, sortDir]);

  const toggleSort = (col) => {
    if(sortCol === col) {
      setSortDir(sortDir === "asc" ? "desc" : "asc");
    } else {
      setSortCol(col);
      setSortDir("asc");
    }
  };

  // Summary stats
  const totalMW = useMemo(() => demandPipelineData.reduce((sum, item) => sum + item.capacity_mw, 0), []);
  const uniqueRegions = useMemo(() => new Set(demandPipelineData.map(d => d.region)).size, []);
  const avgPrice = useMemo(() => {
    const prices = demandPipelineData
      .map(d => {
        const m = d.ppa_terms.match(/\$(\d+)|€(\d+)|£(\d+)/);
        return m ? parseInt(m[1] || m[2] || m[3]) : null;
      })
      .filter(Boolean);
    return prices.length > 0 ? Math.round(prices.reduce((a, b) => a + b, 0) / prices.length) : 0;
  }, []);

  // Capacity by region and status
  const capacityByRegion = useMemo(() => {
    const data = {};
    demandPipelineData.forEach(item => {
      if (!data[item.region]) data[item.region] = {Announced: 0, "Under Construction": 0, Delivered: 0, Planning: 0};
      data[item.region][item.status] = (data[item.region][item.status] || 0) + item.capacity_mw;
    });
    return Object.entries(data).sort((a, b) => {
      const totalA = Object.values(a[1]).reduce((sum, v) => sum + v, 0);
      const totalB = Object.values(b[1]).reduce((sum, v) => sum + v, 0);
      return totalB - totalA;
    });
  }, []);

  // PPA pricing by type
  const ppaPricingData = useMemo(() => {
    const types = {Nuclear: [], Renewable: [], Gas: [], Hydro: [], Solar: [], Wind: [], Mixed: []};
    demandPipelineData.forEach(item => {
      let type = "Mixed";
      if(item.ppa_terms.includes("Nuclear")) type = "Nuclear";
      else if(item.ppa_terms.includes("Renewable") || item.ppa_terms.includes("Hydro") || item.ppa_terms.includes("Solar") || item.ppa_terms.includes("Wind")) type = item.ppa_terms.includes("Hydro") ? "Hydro" : item.ppa_terms.includes("Solar") ? "Solar" : item.ppa_terms.includes("Wind") ? "Wind" : "Renewable";
      const m = item.ppa_terms.match(/\$(\d+)|€(\d+)|£(\d+)/);
      if (m) {
        const price = parseInt(m[1] || m[2] || m[3]);
        if(!types[type]) types[type] = [];
        types[type].push(price);
      }
    });
    return Object.entries(types)
      .filter(([_, prices]) => prices.length > 0)
      .map(([type, prices]) => ({
        type,
        avg: Math.round(prices.reduce((a, b) => a + b, 0) / prices.length),
        count: prices.length
      }))
      .sort((a, b) => a.avg - b.avg);
  }, []);

  // Stacked bar chart for capacity by region
  useEffect(() => {
    if (!chartRef.current || capacityByRegion.length === 0) return;
    if (chartInstance.current) chartInstance.current.destroy();

    const ctx = chartRef.current.getContext('2d');
    const regions = capacityByRegion.map(r => r[0]);
    const statuses = ["Announced", "Under Construction", "Delivered"];
    const colors = {Announced: "#3B9FE3", "Under Construction": "#FF9800", Delivered: "#00E676"};

    const datasets = statuses.map(status => ({
      label: status,
      data: capacityByRegion.map(r => r[1][status] || 0),
      backgroundColor: colors[status],
      borderRadius: 0,
      borderWidth: 0
    }));

    chartInstance.current = new Chart(ctx, {
      type: 'bar',
      data: {labels: regions, datasets},
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
          legend: {display: true, position: "top", labels: {color: "#B0C4D8", font: {size: 10}, padding: 12}},
          tooltip: {backgroundColor: "#0F2237", borderColor: "#1A3A5C", borderWidth: 1, titleColor: "#fff", bodyColor: "#B0C4D8", callbacks: {label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.x} MW`}}
        },
        scales: {
          x: {stacked: true, grid: {color: "#1A3A5C"}, ticks: {color: "#B0C4D8", font: {size: 10}, callback: v => v + " MW"}},
          y: {stacked: true, grid: {display: false}, ticks: {color: "#B0C4D8", font: {size: 10}}}
        }
      }
    });

    return () => {if (chartInstance.current) chartInstance.current.destroy();};
  }, [capacityByRegion]);

  // PPA pricing bar chart
  useEffect(() => {
    if (!ppaChartRef.current || ppaPricingData.length === 0) return;
    if (ppaChartInstance.current) ppaChartInstance.current.destroy();

    const ctx = ppaChartRef.current.getContext('2d');
    ppaChartInstance.current = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ppaPricingData.map(d => d.type),
        datasets: [{
          label: 'Avg Price ($/MWh equiv)',
          data: ppaPricingData.map(d => d.avg),
          backgroundColor: ppaPricingData.map(d => {
            if(d.type === "Nuclear") return "#FF5252";
            if(d.type === "Renewable" || d.type === "Hydro" || d.type === "Solar" || d.type === "Wind") return "#00E676";
            return "#FF9800";
          }),
          borderRadius: 3,
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {display: false},
          tooltip: {backgroundColor: "#0F2237", borderColor: "#1A3A5C", borderWidth: 1, titleColor: "#fff", bodyColor: "#B0C4D8", callbacks: {label: (ctx) => `$${ctx.parsed.y}/MWh`}}
        },
        scales: {
          x: {grid: {display: false}, ticks: {color: "#B0C4D8", font: {size: 10}}},
          y: {beginAtZero: true, max: 70, grid: {color: "#1A3A5C"}, ticks: {color: "#B0C4D8", font: {size: 10}, callback: v => `$${v}`}}
        }
      }
    });

    return () => {if (ppaChartInstance.current) ppaChartInstance.current.destroy();};
  }, [ppaPricingData]);

  const getStatusColor = (status) => {
    if(status === "Announced") return "bg-naio-blue/20 text-naio-blue-light";
    if(status === "Under Construction") return "bg-naio-orange/20 text-naio-orange-light";
    if(status === "Delivered") return "bg-naio-green/20 text-naio-green";
    return "bg-naio-text-muted/20 text-naio-text-muted";
  };

  const columns = [
    {key: "region", label: "Region"},
    {key: "operator", label: "Operator"},
    {key: "capacity_mw", label: "Capacity (MW)"},
    {key: "status", label: "Status"},
    {key: "ppa_terms", label: "PPA Terms"},
    {key: "grid", label: "Grid Connection"},
    {key: "timeline", label: "Timeline"},
    {key: "source", label: "Source"},
  ];

  return (
    <div className="space-y-6">
      {/* Summary stats */}
      <div className="grid grid-cols-4 gap-3">
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4">
          <p className="text-[10px] text-naio-text-dim uppercase tracking-wider">Total MW Tracked</p>
          <p className="text-2xl font-bold text-naio-cyan mt-1">{totalMW.toLocaleString()}</p>
        </div>
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4">
          <p className="text-[10px] text-naio-text-dim uppercase tracking-wider">Markets Covered</p>
          <p className="text-2xl font-bold text-naio-teal mt-1">{uniqueRegions}</p>
        </div>
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4">
          <p className="text-[10px] text-naio-text-dim uppercase tracking-wider">Avg PPA Price</p>
          <p className="text-2xl font-bold text-naio-orange-light mt-1">${avgPrice}/MWh</p>
        </div>
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4">
          <p className="text-[10px] text-naio-text-dim uppercase tracking-wider">Operators</p>
          <p className="text-2xl font-bold text-naio-green mt-1">{new Set(demandPipelineData.map(d => d.operator)).size}</p>
        </div>
      </div>

      {/* Charts */}
      <div className="grid grid-cols-2 gap-6">
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4">
          <h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-3">Capacity by Region (MW)</h3>
          <div className="h-96"><canvas ref={chartRef}/></div>
        </div>
        <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-4">
          <h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-3">PPA Pricing Trends ($/MWh)</h3>
          <div className="h-96"><canvas ref={ppaChartRef}/></div>
        </div>
      </div>

      {/* Demand Pipeline Table */}
      <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg overflow-hidden">
        <div className="px-6 py-4 border-b border-naio-border">
          <h3 className="text-sm font-semibold text-naio-cyan uppercase tracking-wider">Demand Pipeline Table</h3>
        </div>
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="bg-[#122640] border-b border-naio-border">
                {columns.map(col => (
                  <th key={col.key} className="px-4 py-3 text-left text-naio-cyan font-semibold text-xs uppercase tracking-wider cursor-pointer hover:bg-naio-bg-card/50 transition-colors"
                    onClick={() => toggleSort(col.key)}>
                    <div className="flex items-center gap-2">
                      {col.label}
                      {sortCol === col.key && <span className="text-[10px]">{sortDir === "asc" ? "↑" : "↓"}</span>}
                    </div>
                  </th>
                ))}
              </tr>
            </thead>
            <tbody>
              {sorted.map((row, idx) => (
                <tr key={idx} className={`border-b border-naio-border ${idx % 2 === 0 ? "bg-[#0F2237]" : "bg-[#0D1F33]"} hover:bg-naio-bg-card-hover transition-colors cursor-pointer`}
                  onClick={() => setSelectedDeal(row)}>
                  <td className="px-4 py-3 text-naio-text-primary font-medium text-xs">{row.region}</td>
                  <td className="px-4 py-3 text-naio-text-secondary text-xs">{row.operator}</td>
                  <td className="px-4 py-3 text-naio-text-secondary font-bold">{row.capacity_mw}</td>
                  <td className="px-4 py-3">
                    <span className={`inline-block px-2 py-0.5 rounded text-[10px] font-semibold ${getStatusColor(row.status)}`}>{row.status}</span>
                  </td>
                  <td className="px-4 py-3 text-naio-text-muted text-xs">{row.ppa_terms}</td>
                  <td className="px-4 py-3 text-naio-text-muted text-xs">{row.grid}</td>
                  <td className="px-4 py-3 text-naio-text-dim text-xs">{row.timeline}</td>
                  <td className="px-4 py-3 text-naio-text-dim text-xs">{row.source}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {/* Deal detail modal */}
      {selectedDeal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center animate-fade-in">
          <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setSelectedDeal(null)}/>
          <div className="relative max-w-2xl w-11/12 bg-naio-bg-deep border border-naio-border rounded-lg overflow-hidden animate-slide-in">
            <div className="h-[2px] bg-gradient-to-r from-naio-cyan via-naio-teal to-transparent"/>
            <div className="px-6 py-4 border-b border-naio-border flex items-start justify-between">
              <div>
                <h2 className="text-lg font-semibold text-naio-text-primary">{selectedDeal.region} — {selectedDeal.operator}</h2>
                <p className="text-xs text-naio-text-muted mt-1">{selectedDeal.capacity_mw} MW | {selectedDeal.status}</p>
              </div>
              <button onClick={() => setSelectedDeal(null)} className="p-1.5 rounded hover:bg-naio-bg-card text-naio-text-muted"><Icon name="X" size={18}/></button>
            </div>
            <div className="px-6 py-5 space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Capacity</p>
                  <p className="text-lg font-bold text-naio-cyan">{selectedDeal.capacity_mw} MW</p>
                </div>
                <div>
                  <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Status</p>
                  <p className={`text-sm font-semibold px-2 py-0.5 rounded inline-block ${getStatusColor(selectedDeal.status)}`}>{selectedDeal.status}</p>
                </div>
                <div>
                  <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">PPA Terms</p>
                  <p className="text-sm text-naio-text-secondary">{selectedDeal.ppa_terms}</p>
                </div>
                <div>
                  <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Grid Connection</p>
                  <p className="text-sm text-naio-text-secondary">{selectedDeal.grid}</p>
                </div>
              </div>
              <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-3">
                <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-1">Timeline</p>
                <p className="text-sm text-naio-text-secondary">{selectedDeal.timeline}</p>
              </div>
              <div>
                <p className="text-[10px] text-naio-text-muted uppercase tracking-wider mb-2">Source</p>
                <a href="#" className="text-xs text-naio-cyan hover:text-naio-cyan-light flex items-center gap-1">
                  <Icon name="ExternalLink" size={12}/>
                  {selectedDeal.source}
                </a>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ─── MAIN APP ────────────────────────────────────────────
function App() {
  const { data: liveData, calendarEvents, marketHeatmap, financingComps, loading, dataSource, lastRefresh, refreshing, error, fetchData, triggerPipeline } = useSupabaseData();
  const [activeTab, setActiveTab] = useState("dashboard");
  const [selectedItem, setSelectedItem] = useState(null);
  const [impFilter, setImpFilter] = useState("all");
  const [typeFilter, setTypeFilter] = useState("all");
  const [search, setSearch] = useState("");
  const [sortBy, setSortBy] = useState("date_newest");
  const [regionFilter, setRegionFilter] = useState("");
  const [viewMode, setViewMode] = useState("table");

  const tabTitles = {dashboard:"Dashboard",news:"News Feed",infrastructure:"DC Infrastructure",chip:"Chip / Compute",energy:"Energy",financing:"Financing & Credit",supply_chain:"Supply Chain",demand_pipeline:"Demand Pipeline",calendar:"Events & Earnings Calendar",heatmap:"Market Heatmap",comps:"Financing Comps",reports:"Reports",research:"Company Research"};
  const tabDescs = {dashboard:"High-priority intelligence across all layers",demand_pipeline:"DC power demand by region and operator",calendar:"Upcoming conferences, earnings, and regulatory deadlines",heatmap:"Activity density by geographic market",comps:"Recent financing transactions and comparables",reports:"Custom market intelligence reports",research:"Add a company and generate 90 days of AI-powered intelligence"};

  const filtered = useMemo(()=>{
    let items = [...liveData];
    if(activeTab!=="dashboard"&&activeTab!=="news"&&activeTab!=="calendar"&&activeTab!=="heatmap"&&activeTab!=="comps"&&activeTab!=="reports"&&activeTab!=="demand_pipeline"&&activeTab!=="research") items=items.filter(i=>i.layer===activeTab||i.layer==="cross-layer");
    if(impFilter!=="all") items=items.filter(i=>i.importance===impFilter);
    if(typeFilter!=="all") items=items.filter(i=>i.type===typeFilter);
    if(regionFilter) items=items.filter(i=>i.region.toLowerCase().includes(regionFilter.toLowerCase()));
    if(search.trim()){const q=search.toLowerCase();items=items.filter(i=>i.headline.toLowerCase().includes(q)||i.summary.toLowerCase().includes(q)||i.companies.some(c=>c.toLowerCase().includes(q))||i.region.toLowerCase().includes(q)||i.tags.some(t=>t.toLowerCase().includes(q)));}

    // Apply sorting
    if(sortBy === "date_newest") {
      items.sort((a,b)=>new Date(b.date)-new Date(a.date));
    } else if(sortBy === "date_oldest") {
      items.sort((a,b)=>new Date(a.date)-new Date(b.date));
    } else if(sortBy === "importance") {
      const impOrder = {high:0, medium:1, low:2};
      items.sort((a,b)=>(impOrder[a.importance]||3)-(impOrder[b.importance]||3) || new Date(b.date)-new Date(a.date));
    } else if(sortBy === "region") {
      items.sort((a,b)=>a.region.localeCompare(b.region));
    } else if(sortBy === "company") {
      items.sort((a,b)=>(a.companies[0]||"").localeCompare(b.companies[0]||""));
    }

    return items;
  },[liveData,activeTab,impFilter,typeFilter,search,sortBy,regionFilter]);

  // Group by region if region sort is selected
  const groupedItems = useMemo(()=>{
    if(sortBy !== "region") return {ungrouped: filtered};
    const grouped = {};
    filtered.forEach(item => {
      const group = getRegionGroup(item.region);
      if(!grouped[group]) grouped[group] = [];
      grouped[group].push(item);
    });
    return grouped;
  }, [filtered, sortBy]);

  const highPriority = useMemo(()=>liveData.filter(i=>i.importance==="high").sort((a,b)=>new Date(b.date)-new Date(a.date)),[liveData]);

  const handleMarketClick = (market) => {
    setRegionFilter(market.label);
    setActiveTab("news");
  };

  return (
    <div className="flex h-screen overflow-hidden font-sans">
      <Sidebar activeTab={activeTab} onTabChange={t=>{setActiveTab(t);setImpFilter("all");setTypeFilter("all");setSearch("");setSortBy("date_newest");setRegionFilter("");}}/>
      <main className="flex-1 overflow-hidden flex flex-col">
        <div className="h-[2px] bg-gradient-to-r from-naio-cyan via-naio-teal to-transparent"/>
        <header className="px-6 py-4 border-b border-naio-border flex items-center justify-between flex-shrink-0">
          <div>
            <h1 className="text-lg font-semibold text-naio-text-primary">{tabTitles[activeTab]}</h1>
            <p className="text-xs text-naio-text-muted mt-0.5">{tabDescs[activeTab]||filtered.length+" items"}</p>
          </div>
          <div className="flex items-center gap-3">
            {error && <div className="text-[10px] text-naio-red bg-naio-red/10 px-2 py-1 rounded">{error}</div>}
            <div className="flex items-center gap-1.5 text-[10px] text-naio-text-dim">
              <div className={`w-2 h-2 rounded-full ${dataSource==='supabase'?'bg-naio-green':'bg-naio-orange'}`}/>
              <span>{dataSource==='supabase'?'Live':'Local'}</span>
            </div>
            <div className="text-[10px] text-naio-text-dim uppercase tracking-widest">
              {lastRefresh ? lastRefresh.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"}) : '--:--'}
            </div>
            <button
              onClick={fetchData}
              disabled={loading}
              className="p-1.5 text-naio-text-dim hover:text-naio-cyan transition-colors disabled:opacity-50"
              title="Reload data from database"
            >
              <Icon name="RefreshCw" size={14} className={loading?'animate-spin':''}/>
            </button>
            <button
              onClick={triggerPipeline}
              disabled={refreshing}
              className="px-3 py-1.5 bg-naio-cyan/10 border border-naio-cyan/30 rounded-md text-xs text-naio-cyan hover:bg-naio-cyan/20 transition-colors disabled:opacity-50 flex items-center gap-1.5"
              title="Fetch new articles, process through AI, and update the database"
            >
              <Icon name="Zap" size={12} className={refreshing?'animate-pulse':''}/>
              {refreshing ? 'Updating...' : 'Update Intelligence'}
            </button>
          </div>
        </header>
        <div className="flex-1 overflow-y-auto">
          {loading && !liveData.length && (
            <div className="flex items-center justify-center h-full">
              <div className="text-center">
                <div className="w-8 h-8 border-2 border-naio-cyan border-t-transparent rounded-full animate-spin mx-auto mb-4"/>
                <p className="text-naio-text-secondary text-sm">Connecting to Supabase...</p>
                <p className="text-naio-text-dim text-xs mt-1">Falling back to local data if unavailable</p>
              </div>
            </div>
          )}
          {activeTab==="dashboard" && <div className="p-6">
            <StatsBar items={liveData}/>
            <div className="mt-6"><h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-4">Big 4 Combined Capex Trajectory</h2>
              <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-6 h-72">
                <CapexTrajectoryChart/>
              </div>
              <p className="text-xs text-naio-text-dim mt-2">Source: Company earnings reports & press releases. Data compiled Feb 7, 2026.</p>
            </div>
            <div className="mt-6"><h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-4">Individual Company Capex (2020-2026E)</h2>
              <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-6 h-72">
                <CompanyCapexChart/>
              </div>
              <p className="text-xs text-naio-text-dim mt-2">Source: Company earnings reports & press releases. Data compiled Feb 7, 2026.</p>
            </div>
            <div className="mt-6"><h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-4">Financing Spreads</h2>
              <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-6 h-72">
                <FinancingChart/>
              </div>
            </div>
            <div className="mt-8"><h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-4">High Priority</h2>
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">{highPriority.map(i=><IntelCard key={i.id} item={i} onClick={()=>setSelectedItem(i)}/>)}</div>
            </div>
            <div className="mt-8"><h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-4">Market Activity</h2>
              <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-6 mb-6">
                <MarketMap onMarketClick={handleMarketClick} mapHeight={300}/>
              </div>
            </div>
          </div>}
          {activeTab==="calendar" && <div className="p-6"><CalendarView events={calendarEvents}/></div>}
          {activeTab==="demand_pipeline" && <div className="p-6"><DemandPipeline/></div>}
          {activeTab==="heatmap" && <div className="p-6">
            <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg p-6 mb-6">
              <MarketMap onMarketClick={handleMarketClick}/>
            </div>
            <div><h2 className="text-sm font-semibold text-naio-text-secondary uppercase tracking-wider mb-4">Regional Heat Index</h2><HeatmapView data={marketHeatmap}/></div>
          </div>}
          {activeTab==="comps" && <div className="p-6">
            <div className="bg-naio-bg-card/80 border border-naio-border rounded-lg overflow-hidden">
              <CompsTable data={financingComps} allData={liveData}/>
            </div>
          </div>}
          {activeTab==="reports" && <div className="p-6"><ReportGenerator data={liveData} calendarEvents={calendarEvents} financingComps={financingComps} marketHeatmap={marketHeatmap}/></div>}
          {activeTab==="research" && <div className="p-6"><CompanyResearch data={liveData} fetchData={fetchData}/></div>}
          {activeTab!=="dashboard"&&activeTab!=="calendar"&&activeTab!=="heatmap"&&activeTab!=="comps"&&activeTab!=="reports"&&activeTab!=="research" && <div className="p-6">
            <div className="flex items-center gap-3 flex-wrap mb-4">
              <div className="relative flex-1 min-w-[200px] max-w-sm"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-naio-text-dim"><Icon name="Search" size={14}/></span><input type="text" placeholder="Search companies, regions, tags..." value={search} onChange={e=>setSearch(e.target.value)} className="w-full pl-9 pr-3 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-primary placeholder-naio-text-dim focus:outline-none focus:border-naio-cyan/50 transition-colors"/></div>
              <select value={impFilter} onChange={e=>setImpFilter(e.target.value)} className="px-3 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-secondary focus:outline-none focus:border-naio-cyan/50 appearance-none cursor-pointer"><option value="all">All Priority</option><option value="high">High</option><option value="medium">Medium</option><option value="low">Low</option></select>
              <select value={typeFilter} onChange={e=>setTypeFilter(e.target.value)} className="px-3 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-secondary focus:outline-none focus:border-naio-cyan/50 appearance-none cursor-pointer"><option value="all">All Types</option><option value="news_summary">News</option><option value="deal_synopsis">Deals</option><option value="capex_announcement">Capex</option><option value="financing_event">Financing</option><option value="earnings_intelligence">Earnings</option><option value="regulatory_update">Regulatory</option><option value="power_demand_signal">Power Demand</option><option value="executive_move">Exec Moves</option><option value="supply_chain_signal">Supply Chain</option></select>
              <select value={sortBy} onChange={e=>setSortBy(e.target.value)} className="px-3 py-2 bg-naio-bg-card border border-naio-border rounded-md text-sm text-naio-text-secondary focus:outline-none focus:border-naio-cyan/50 appearance-none cursor-pointer"><option value="date_newest">Date (newest first)</option><option value="date_oldest">Date (oldest first)</option><option value="importance">Importance (high → low)</option><option value="region">Region (A-Z)</option><option value="company">Company (A-Z)</option></select>
              {regionFilter && <div className="flex items-center gap-2 px-3 py-2 bg-naio-bg-surface border border-naio-border rounded-md text-sm"><span className="text-naio-text-secondary">Filtered: {regionFilter}</span><button onClick={()=>setRegionFilter("")} className="text-naio-text-dim hover:text-naio-text-primary"><Icon name="X" size={14}/></button></div>}
              <div className="flex items-center bg-naio-bg-card border border-naio-border rounded-md overflow-hidden">
                <button onClick={() => setViewMode("table")} className={`px-2.5 py-2 text-xs flex items-center gap-1 transition-colors ${viewMode === "table" ? "bg-naio-bg-surface text-naio-cyan" : "text-naio-text-dim hover:text-naio-text-secondary"}`}><Icon name="LayoutList" size={14}/></button>
                <button onClick={() => setViewMode("cards")} className={`px-2.5 py-2 text-xs flex items-center gap-1 transition-colors ${viewMode === "cards" ? "bg-naio-bg-surface text-naio-cyan" : "text-naio-text-dim hover:text-naio-text-secondary"}`}><Icon name="LayoutGrid" size={14}/></button>
              </div>
            </div>
            <TabAnalytics items={filtered} layer={activeTab}/>
            {viewMode === "table" ? (
              <IntelTable items={filtered} onItemClick={(i) => setSelectedItem(i)}/>
            ) : (
            <div className="space-y-6">
              {sortBy === "region" ? (
                Object.entries(groupedItems).map(([group, items]) => (
                  <div key={group}>
                    <h3 className="text-xs font-semibold text-naio-cyan uppercase tracking-wider mb-3 mt-6 flex items-center gap-2"><span className="h-px flex-1 bg-naio-border"/>{group} ({items.length})<span className="h-px flex-1 bg-naio-border"/></h3>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                      {items.map(i=><IntelCard key={i.id} item={i} onClick={()=>setSelectedItem(i)}/>)}
                    </div>
                  </div>
                ))
              ) : (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                  {filtered.map(i=><IntelCard key={i.id} item={i} onClick={()=>setSelectedItem(i)}/>)}
                </div>
              )}
              {filtered.length===0 && <div className="text-center py-20 text-naio-text-muted"><p className="text-lg">No intelligence items match your filters.</p><p className="text-sm mt-2">Try adjusting your search or filter criteria.</p></div>}
            </div>
            )}
          </div>}
        </div>
      </main>
      {selectedItem && <DetailModal item={selectedItem} onClose={()=>setSelectedItem(null)}/>}
    </div>
  );
}

ReactDOM.render(<App/>, document.getElementById("root"));
</script>
</body>
</html>
